<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pwncone</title>
    <link rel="stylesheet" href="../../css/style.css">
  </head>

<h1 id="malwaretech-challenges">MalwareTech Challenges</h1>
<p>12th May 2022<br><a href="https://www.malwaretech.com/challenges/windows-reversing">https://www.malwaretech.com/challenges/windows-reversing</a></p>
<h2 id="hide-and-seek">Hide and Seek</h2>
<h3 id="strings1">strings1</h3>
<blockquote>
<p>strings1.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>Visible in main() as a parameter for the md5_hash() function.<br><img src="img/strings1.png" alt="img"></p>
<h2 id="strings2">strings2</h2>
<blockquote>
<p>strings2.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>The flag is a stack string. Can use FLOSS or Ghidra/IDA to find it.<br><img src="img/strings2_ida.png" alt="img"></p>
<p><code>floss .\strings2.exe_</code><br><img src="img/strings2_floss.png" alt="img"></p>
<h2 id="strings3">strings3</h2>
<blockquote>
<p>strings3.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>From the dissebmbly you can see that it loads a resource <code>rc.rc</code> and loads a string from table entry number 272. I used Resource Hacker to find the string.</p>
<p><img src="img/strings3.png" alt="img"></p>
<h2 id="shellcode">Shellcode</h2>
<h3 id="shellcode1">shellcode1</h3>
<blockquote>
<p>shellcode1.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>You can see in IDA that the code calls <code>strlen</code> on a nonsensical string, <code>VirtualAlloc</code>s 13 bytes of PAGE_EXECUTE_READWRITE memory, <code>memcpy</code>s 13 bytes of junk (actually shellcode) to the executable region of memory and then calls it.<br><img src="img/shellcode1_ida.png" alt="img"></p>
<p>Press <code>c</code> to convert this region of data to code and you&#39;ll see the disassembly.<br><img src="img/shellcode1_raw.png" alt="img"><br><img src="img/shellcode1_disasm.png" alt="img"></p>
<p>It&#39;s looping through the string backwards and shifting the char&#39;s bits left 5 times. What doesn&#39;t make sense to me is why is that the string is only 41 bytes long yet it&#39;s grabbing the length of the string at <code>str[1]</code> which is 0x62 and looping backwards from there. Why? I don&#39;t get it. I don&#39;t know. I also don&#39;t know why I had to use IDA&#39;s <code>__ROL1__</code> and Microsoft&#39;s <code>_rotl</code> doesn&#39;t work.</p>
<p>Easiest way to decode the nonsensical string is by copy/pasting the pseudocode from IDA and reusing it :)<br>Here&#39;s my .cpp code to decode the flag.</p>
<pre><code class="lang-cpp">#include &lt;stdio.h&gt;
#include "defs.h" // IDA 7.6 defs.h file

void sub_404068(DWORD str_addr, char* str)
{
    int str_len = str[1];
    do
    {
        *(BYTE*)(str_addr + str_len - 1) = __ROL1__(*(BYTE*)(str_addr + str_len - 1), 5);
        --str_len;
    } while (str_len);
}

int main()
{
    char obfs[41] = "<span class="hljs-symbol">\x</span>32<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>3A<span class="hljs-symbol">\x</span>DB<span class="hljs-symbol">\x</span>9A<span class="hljs-symbol">\x</span>42<span class="hljs-symbol">\x</span>2A<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>1A<span class="hljs-symbol">\x</span>7A<span class="hljs-symbol">\x</span>22<span class="hljs-symbol">\x</span>2A<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>4A<span class="hljs-symbol">\x</span>9A<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>A2<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>52<span class="hljs-symbol">\x</span>AA<span class="hljs-symbol">\x</span>9A<span class="hljs-symbol">\x</span>A2<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>32<span class="hljs-symbol">\x</span>7A<span class="hljs-symbol">\x</span>92<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>2A<span class="hljs-symbol">\x</span>C2<span class="hljs-symbol">\x</span>82<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>7A<span class="hljs-symbol">\x</span>4A<span class="hljs-symbol">\x</span>A2<span class="hljs-symbol">\x</span>9A<span class="hljs-symbol">\x</span>EB<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00";

    sub_404068((DWORD)&amp;obfs, obfs);

    printf("<span class="hljs-variable">%s \n", obfs);
    return 0;
}</span>
</code></pre>
<h3 id="shellcode2">shellcode2</h3>
<blockquote>
<p>shellcode2.exe contains a flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>In main() the program builds a bogus stack string (our target flag) and then prepares for shellcode execution by storing the LoadLibraryA and GetProcAddresses plus a pointer to the stack string and its length on the heap.<br><img src="img/shellcode2_main.png" alt="img"></p>
<p>Function <code>sub_404040</code> contains the xor decryption of the stack string. It dynamically loads a few functions it needs (fseek, fread) and reads 38 bytes at offset 78 from its own exe - <code>shellcode2.exe_</code>. 
<img src="img/shellcode2_xor.png" alt="img"></p>
<p>Those bytes are the DOS header message.<br><img src="img/shellcode2_dosstr.png" alt="img"></p>
<p>The xor decryption in the pseudocode looks off to me so read the assembly instead because it&#39;s easier (annotated above). It xors each byte of the stack string with the corresponding byte in the dos string.</p>
<p>Here&#39;s my cpp code to decrypt the stack string.  </p>
<pre><code class="lang-cpp">#include &lt;stdio.h&gt;
#include "defs.h"

int main()
{
    char dosstr[78] = "<span class="hljs-symbol">\x</span>54<span class="hljs-symbol">\x</span>68<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>70<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>67<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>61<span class="hljs-symbol">\x</span>6D<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>63<span class="hljs-symbol">\x</span>61<span class="hljs-symbol">\x</span>6E<span class="hljs-symbol">\x</span>6E<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>74<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>62<span class="hljs-symbol">\x</span>65<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>72<span class="hljs-symbol">\x</span>75<span class="hljs-symbol">\x</span>6E<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>69<span class="hljs-symbol">\x</span>6E<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>44<span class="hljs-symbol">\x</span>4F<span class="hljs-symbol">\x</span>53<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>6D<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>64<span class="hljs-symbol">\x</span>65<span class="hljs-symbol">\x</span>2E<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>0D<span class="hljs-symbol">\x</span>0A<span class="hljs-symbol">\x</span>24<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>00<span class="hljs-symbol">\x</span>A3<span class="hljs-symbol">\x</span>5B<span class="hljs-symbol">\x</span>95<span class="hljs-symbol">\x</span>F4";
    char stackstr[41] = "<span class="hljs-symbol">\x</span>12<span class="hljs-symbol">\x</span>24<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>34<span class="hljs-symbol">\x</span>5B<span class="hljs-symbol">\x</span>23<span class="hljs-symbol">\x</span>26<span class="hljs-symbol">\x</span>20<span class="hljs-symbol">\x</span>35<span class="hljs-symbol">\x</span>37<span class="hljs-symbol">\x</span>4C<span class="hljs-symbol">\x</span>28<span class="hljs-symbol">\x</span>76<span class="hljs-symbol">\x</span>26<span class="hljs-symbol">\x</span>33<span class="hljs-symbol">\x</span>37<span class="hljs-symbol">\x</span>3A<span class="hljs-symbol">\x</span>27<span class="hljs-symbol">\x</span>3D<span class="hljs-symbol">\x</span>6E<span class="hljs-symbol">\x</span>25<span class="hljs-symbol">\x</span>48<span class="hljs-symbol">\x</span>6F<span class="hljs-symbol">\x</span>3C<span class="hljs-symbol">\x</span>58<span class="hljs-symbol">\x</span>3A<span class="hljs-symbol">\x</span>68<span class="hljs-symbol">\x</span>2C<span class="hljs-symbol">\x</span>43<span class="hljs-symbol">\x</span>73<span class="hljs-symbol">\x</span>10<span class="hljs-symbol">\x</span>0E<span class="hljs-symbol">\x</span>10<span class="hljs-symbol">\x</span>6B<span class="hljs-symbol">\x</span>10<span class="hljs-symbol">\x</span>6F";
    char out[41] = { 0 };

    for (int i = 0; i &lt; 41; i++)
        //out[i] = LOBYTE(dosstr[i]) ^ stackstr[i]; // LOBYTE not needed
        out[i] = dosstr[i] ^ stackstr[i];

    printf("<span class="hljs-variable">%s \n", out);
    return 0;
}</span>
</code></pre>
<h2 id="de-virtualization">De-virtualization</h2>
<h3 id="vm1">vm1</h3>
<blockquote>
<p>vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it. Can you figure out how the VM works and write your own to decrypt the flag? A copy of the VM’s RAM has been provided in ram.bin (this data is identical to the ram content of the malware’s VM before execution and contains both the custom assembly code and encrypted flag).</p>
</blockquote>
<p>I have no idea what a virtual machine is (still, after solving this challenge).</p>
<p>In main() the program copies 507 bytes of data at 0x404040 to the heap and loops over it.<br><img src="img/vm1_main.png" alt="img"></p>
<p>I copied these 507 bytes to a file and saved it as a .bin (used ghidra to copy because easier).</p>
<pre><code><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
DE <span class="hljs-number">7</span>E <span class="hljs-number">7</span>D <span class="hljs-number">55</span> <span class="hljs-number">1</span>E <span class="hljs-number">05</span> E6 <span class="hljs-number">9</span>F E4 A6 <span class="hljs-number">47</span> <span class="hljs-number">50</span> <span class="hljs-number">02</span> <span class="hljs-number">01</span> C7 FC 
CB <span class="hljs-number">60</span> <span class="hljs-number">09</span> C6 <span class="hljs-number">0</span>E <span class="hljs-number">2</span>E <span class="hljs-number">41</span> <span class="hljs-number">65</span> A4 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 
<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> 
<span class="hljs-number">1</span>D BD <span class="hljs-number">01</span> <span class="hljs-number">05</span> <span class="hljs-number">53</span> <span class="hljs-number">01</span> <span class="hljs-number">12</span> <span class="hljs-number">48</span> <span class="hljs-number">01</span> <span class="hljs-number">10</span> E6 <span class="hljs-number">01</span> <span class="hljs-number">13</span> <span class="hljs-number">8</span>A <span class="hljs-number">01</span> <span class="hljs-number">0</span>D 
<span class="hljs-number">47</span> <span class="hljs-number">01</span> <span class="hljs-number">16</span> <span class="hljs-number">13</span> <span class="hljs-number">01</span> <span class="hljs-number">0</span>A <span class="hljs-number">15</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">98</span> <span class="hljs-number">01</span> <span class="hljs-number">02</span> <span class="hljs-number">3</span>C <span class="hljs-number">01</span> <span class="hljs-number">18</span> D9 
<span class="hljs-number">01</span> <span class="hljs-number">1</span>A <span class="hljs-number">57</span> <span class="hljs-number">01</span> <span class="hljs-number">06</span> AB <span class="hljs-number">01</span> <span class="hljs-number">1</span>B C6 <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">32</span> <span class="hljs-number">01</span> <span class="hljs-number">17</span> <span class="hljs-number">20</span> <span class="hljs-number">01</span> 
<span class="hljs-number">15</span> <span class="hljs-number">6</span>F <span class="hljs-number">01</span> <span class="hljs-number">11</span> <span class="hljs-number">2</span>D <span class="hljs-number">01</span> <span class="hljs-number">08</span> C9 <span class="hljs-number">01</span> <span class="hljs-number">09</span> E7 <span class="hljs-number">01</span> <span class="hljs-number">03</span> <span class="hljs-number">12</span> <span class="hljs-number">01</span> <span class="hljs-number">0</span>C 
<span class="hljs-number">2</span>F <span class="hljs-number">01</span> <span class="hljs-number">0</span>E <span class="hljs-number">88</span> <span class="hljs-number">01</span> <span class="hljs-number">19</span> <span class="hljs-number">6</span>C <span class="hljs-number">01</span> <span class="hljs-number">04</span> <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">1</span>E AE <span class="hljs-number">01</span> <span class="hljs-number">14</span> <span class="hljs-number">59</span> 
<span class="hljs-number">01</span> <span class="hljs-number">1</span>F <span class="hljs-number">91</span> <span class="hljs-number">01</span> <span class="hljs-number">1</span>C <span class="hljs-number">5</span>D <span class="hljs-number">01</span> <span class="hljs-number">0</span>F AE <span class="hljs-number">01</span> <span class="hljs-number">0</span>B <span class="hljs-number">15</span> <span class="hljs-number">01</span> <span class="hljs-number">07</span> CC <span class="hljs-number">02</span> 
<span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">22</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">02</span> 
<span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">23</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">25</span> <span class="hljs-number">00</span> 
<span class="hljs-number">03</span> <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">26</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">27</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> 
<span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">29</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>A <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">0</span>A 
<span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>B <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">0</span>B <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>C <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">0</span>C <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>D <span class="hljs-number">00</span> 
<span class="hljs-number">03</span> <span class="hljs-number">0</span>D <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>E <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">0</span>E <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">2</span>F <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">0</span>F <span class="hljs-number">00</span> <span class="hljs-number">02</span> 
<span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">31</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">11</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">32</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">12</span> 
<span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">33</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">13</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">14</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">35</span> <span class="hljs-number">00</span> 
<span class="hljs-number">03</span> <span class="hljs-number">15</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">36</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">16</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">37</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">17</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> 
<span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
</code></pre><p>The loop starts at position 255 (0xff) and takes 3 sequential bytes from dat4040 and passes them to another function (that I&#39;ve called <code>veryswitch</code>).
<img src="img/vm1_loop.png" alt="img"></p>
<p>This switch function is operating on the bytes in dat4040.<br><img src="img/vm1_switch.png" alt="img"></p>
<p>If you look carefully at the bytes in dat4040 as groups of 3 starting from position 0xFF you&#39;ll see a pattern. These are instructions and operands. For example, the first 3 groups of 3 are:  </p>
<pre><code><span class="hljs-number">0x01</span>, <span class="hljs-number">0x1d</span>, <span class="hljs-number">0xbd</span>
<span class="hljs-number">0x01</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x53</span>
<span class="hljs-number">0x01</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x48</span>
</code></pre><p>0x01 copies byte3 to array[byte2] e.g. array[0x1d] = 0xbd<br>0x02 sets byte2 as the xor key<br>0x03 xor decrypts byte2  </p>
<p>Now with the knowledge above, if you look further at dat4040 you&#39;ll see a bunch of MOVs (0x01), followed by a series of 0x02 (grab XOR key) and 0x03 (xor decrypt). It&#39;s retrieving and decrypting the flag.</p>
<p>Here&#39;s my C code to get the flag.</p>
<pre><code class="lang-c">#include &lt;stdio.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;Windows.h&gt;

<span class="hljs-built_in">BYTE</span> xorkey = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

<span class="hljs-built_in">BYTE</span> dat4040[<span class="hljs-number">508</span>] = { 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xde</span>, <span class="hljs-number">0x7e</span>, 
    <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0xa6</span>, <span class="hljs-number">0x47</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xfc</span>, <span class="hljs-number">0xcb</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x09</span>, 
    <span class="hljs-number">0xc6</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x2e</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0xa4</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x1d</span>, <span class="hljs-number">0xbd</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0xe6</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0d</span>, 
    <span class="hljs-number">0x47</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x01</span>, 
    <span class="hljs-number">0x1a</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xab</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0xc6</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x6f</span>, 
    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0xe7</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0e</span>, 
    <span class="hljs-number">0x88</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x1e</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0x59</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x1f</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x01</span>, 
    <span class="hljs-number">0x1c</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0xcc</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x02</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x23</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x03</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, 
    <span class="hljs-number">0x06</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x03</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0a</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x2b</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x2c</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0c</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0d</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x2e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, 
    <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x11</span>, <span class="hljs-number">0x00</span>, 
    <span class="hljs-number">0x02</span>, <span class="hljs-number">0x32</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x14</span>, 
    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x37</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, 
    <span class="hljs-number">0x17</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> 
}<span class="hljs-comment">;</span>

/*
Virtual Machine takes <span class="hljs-number">3</span> bytes.
1<span class="hljs-built_in">st</span> <span class="hljs-built_in">byte</span> is the instruction.
2nd <span class="hljs-keyword">and</span> 3rd bytes are operands.

Returns false if instruction isn<span class="hljs-string">'t valid.
*/ 
bool vm(BYTE instr, BYTE operand1, BYTE operand2)
{    
    switch (instr)
    {
    // Copy byte3 to array[byte2]
    case 0x01:
        dat4040[operand1] = operand2;
        break;
    // Set array[byte2] as xor key
    case 0x02:
        xorkey = dat4040[operand1];
        break;
    // Xor decrypt array[byte2]
    case 0x03:
        dat4040[operand1] ^= xorkey;
        break;
    // Instruction invalid so return false
    default:
        return false;
    }

    return true;
}

int main()
{
    bool instr_valid = TRUE;
    // Start at position 0xff
    int i = 0xff;
    do 
    {
        BYTE instr = dat4040[i];
        BYTE operand1 = dat4040[i + 1];
        BYTE operand3 = dat4040[i + 2];
        instr_valid = vm(instr, operand1, operand3);        

        // Increment to next set of 3 bytes
        i += 3;    
    } while (instr_valid == true);

    printf("%s \n", (char*)dat4040);
    return 0;
}</span>
</code></pre>
<p>And the flag:<br><code>FLAG{VMS-ARE-FOR-MALWARE}</code></p>
<h2 id="ransomware">Ransomware</h2>
<h3 id="ransomware1">ransomware1</h3>
<blockquote>
<p>The administrator for FlagCorp was using an outdated Windows 7 system and got infected with some ransomware. We believe this variant was most likely written by a scriptkiddie due to the fact it was so badly designed it encrypted itself. One of our malware analysts was able to recover the encryption function from memory but doesn’t know much about cryptography. Can you find a way to decrypt flag.txt?</p>
</blockquote>
<p>The encryption is here (it&#39;s xor):<br><img src="img/ransomware1_func.png" alt="img"></p>
<p>Specifically this:<br><code>filebytes[i] ^= *(_BYTE *)(a2 + i % 0x20);</code><br>Loop through the file and xor each byte.</p>
<p>It&#39;s xor&#39;ing a the current byte in the file with a byte of the xor key.<br><code>(BYTE*)(i % 20)</code> is typecasting <code>i % 20</code> to a pointer.<br>And <code>*(BYTE*)(i % 20)</code> dereferences the pointer to grab the value at that location</p>
<p>For example:<br>i = 0x4<br>0x4 % 0x20 = 0x04<br>Do filebyte[0x04] ^= xorkey[0x04];</p>
<p>i = 0x22<br>0x22 % 0x20 = 0x02<br>Do filebyte[0x22] ^= xorkey[0x02];</p>
<p><code>a2</code> in the code above will have been a pointer to the xor key in the original program.<br>To throw you off, instead of passing a pointer to xor key to the decryption function the code has been compiled passing NULL. It&#39;s the same with the filename, which is passed as NULL too.<br><img src="img/ransomware1_main.png" alt="img"></p>
<p>Because the Windows 7 sample pictures are freely available online, we can use a known plaintext attack to retrieve the xor key.<br>I used Desert.jpg available here: <a href="https://archive.org/details/Chrysanthemum_20160913/Desert.jpg">https://archive.org/details/Chrysanthemum_20160913/Desert.jpg</a></p>
<p>Here&#39;s my C code which retrieves the xor key and decrypts a file.<br>It takes the file to decrypt as cmdline argument.</p>
<pre><code class="lang-c">#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;

#define Kill(...) { printf(__VA_ARGS__); exit(<span class="hljs-number">-1</span>); }

unsigned char xorkey[<span class="hljs-number">32</span>] = { <span class="hljs-number">0</span> };

void GetXorkey()
{
    unsigned char desert_plaintext[<span class="hljs-number">32</span>] = {
        <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xD8</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xE0</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>,
        <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xE1</span>, <span class="hljs-number">0x0F</span>, <span class="hljs-number">0x07</span>,
        <span class="hljs-number">0x45</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x4D</span>
    };

    unsigned char desert_encrypted[<span class="hljs-number">32</span>] = {
        <span class="hljs-number">0x91</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x14</span>, <span class="hljs-number">0xD3</span>, <span class="hljs-number">0xDF</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0x74</span>,
        <span class="hljs-number">0x82</span>, <span class="hljs-number">0xB5</span>, <span class="hljs-number">0x0E</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x3D</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0xA7</span>, <span class="hljs-number">0x1B</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x34</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x87</span>,
        <span class="hljs-number">0xEC</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0xE4</span>, <span class="hljs-number">0x4A</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x42</span>
    };

    for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++)
        xorkey[i] = desert_plaintext[i] ^ desert_encrypted[i];

    return;
}

int main(int argc, char* argv[])
{
    if (argc != <span class="hljs-number">2</span>)
    {
        printf(<span class="hljs-string">"- Need file to decrypt :/ <span class="hljs-subst">\n</span>"</span>);
        return <span class="hljs-number">-1</span>;
    }

    GetXorkey();
    for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++)
        printf(<span class="hljs-string">"%.02X "</span>, xorkey[i]);
    printf(<span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>);

    <span class="hljs-comment">// Remove "_encrypted" from filename</span>
    char* filename = argv[<span class="hljs-number">1</span>];
    char new_filename[MAX_PATH] = { <span class="hljs-number">0</span> };
    size_t ext_len = strlen(<span class="hljs-string">"_encrypted"</span>);
    memcpy_s(new_filename, MAX_PATH, filename, strlen(filename) - ext_len);

    HANDLE hcrypted = CreateFileA(
        filename, 
        GENERIC_ALL, 
        <span class="hljs-number">0</span>, 
        NULL, 
        OPEN_EXISTING, 
        FILE_ATTRIBUTE_NORMAL, 
        NULL
    );
    if (hcrypted == INVALID_HANDLE_VALUE)
        Kill(<span class="hljs-string">"- Failed to open %s: %d <span class="hljs-subst">\n</span>"</span>, filename, GetLastError());

    HANDLE hdecrypted = CreateFileA(
        new_filename,
        GENERIC_ALL,
        <span class="hljs-number">0</span>,
        NULL,
        CREATE_ALWAYS,
        FILE_ATTRIBUTE_NORMAL, 
        NULL
    );
    if (hdecrypted == INVALID_HANDLE_VALUE)
        Kill(<span class="hljs-string">"- Failed to create %s: %d <span class="hljs-subst">\n</span>"</span>, new_filename, GetLastError());

    DWORD bytes_read = <span class="hljs-number">0</span>;
    char filebytes[<span class="hljs-number">4100</span>] = { <span class="hljs-number">0</span> };
    do
    {
        BOOL b = ReadFile(hcrypted, filebytes, <span class="hljs-number">4096</span>, &amp;bytes_read, NULL);
        if (b == <span class="hljs-literal">FALSE</span>)
            Kill(<span class="hljs-string">"- Failed to read 4096 bytes from file: %d <span class="hljs-subst">\n</span>"</span>, GetLastError());

        for (DWORD i = <span class="hljs-number">0</span>; i &lt; bytes_read; i++)
            filebytes[i] ^= *(BYTE*)(xorkey + i % <span class="hljs-number">0x20</span>);

        b = WriteFile(hdecrypted, filebytes, bytes_read, &amp;bytes_read, NULL);
        if (b == <span class="hljs-literal">FALSE</span>)
            Kill(<span class="hljs-string">"- Failed to write 4096 bytes to new file: %d <span class="hljs-subst">\n</span>"</span>, GetLastError());
    } while (bytes_read == <span class="hljs-number">4096</span>);

    printf(<span class="hljs-string">"%s <span class="hljs-subst">\n</span>"</span>, filebytes);

    CloseHandle(hcrypted);
    CloseHandle(hdecrypted);

    return <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code>PS <span class="hljs-keyword">C</span>:\Users\Bob\source\repos\mt_decrypt\<span class="hljs-keyword">Debug</span>&gt; .\mt_decrypt.exe .\flag.txt_encrypted
<span class="hljs-number">6</span><span class="hljs-keyword">E</span> F7 <span class="hljs-number">9</span>B <span class="hljs-number">0</span><span class="hljs-keyword">E</span> <span class="hljs-number">45</span> <span class="hljs-number">55</span> <span class="hljs-number">5</span><span class="hljs-keyword">E</span> <span class="hljs-number">95</span> <span class="hljs-number">96</span> FE AB <span class="hljs-number">75</span> <span class="hljs-number">80</span> B4 <span class="hljs-number">0</span><span class="hljs-keyword">E</span> <span class="hljs-number">40</span> <span class="hljs-number">3</span><span class="hljs-keyword">D</span> F5 A7 <span class="hljs-number">1</span>B ED D5 <span class="hljs-number">5</span>B <span class="hljs-number">80</span> A9 D3 <span class="hljs-number">8</span><span class="hljs-keyword">D</span> <span class="hljs-number">2</span><span class="hljs-keyword">C</span> B8 <span class="hljs-number">0</span>A <span class="hljs-number">40</span> <span class="hljs-number">0</span>F
FLAG{XOR-MAKES-KNOWN-PLAINTEXT-AND-FREQUENCY-ANALYSIS-EASY}
</code></pre>