<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>IAT Hooking</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Import Address Table (IAT) Hooking</h1></strong><br />• <a href="https://relearex.wordpress.com/2017/12/26/hooking-series-part-i-import-address-table-hooking/">https://relearex.wordpress.com/2017/12/26/hooking-series-part-i-import-address-table-hooking/</a><br />• <a href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking#code">https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking#code</a><br />• <a href="http://bandido.ch/programming/Import_Address_Table_Hooking.pdf">http://bandido.ch/programming/Import_Address_Table_Hooking.pdf</a><br />• <a href="https://guidedhacking.com/threads/how-to-hook-import-address-table-iat-hooking.13555/">https://guidedhacking.com/threads/how-to-hook-import-address-table-iat-hooking.13555/</a><br /><br />Import Address Table (IAT) hooking is where you hook a function in a process by modifying its address in the Import Address Table.<br />e.g. you replace <code>MessageBoxA - 0x7ffbcf7a0010</code> with <code>MessageBoxA - 0x028132dc0000</code>.<br />Now whenever the process calls <code>MessageBoxA</code> it will jump to <code>0x028132dc0000</code> instead, which is the address of your hooked function.<br /><br />For Import Address Table hooking to be useful, you typically write the hook in a DLL and inject the DLL into a target process.<br />Your DLL will then modify the Import Address Table of the target process, and any time that target process calls one of the functions you&#39;ve hooked, your code will run.<br />Hooking the IAT of your own process isn&#39;t very useful, but this what most of the examples you will see online are.<br /><br /><strong><h2>## About the IAT</h2></strong><br />The Import Address Table (IAT) contains pointers to all the functions a PE file imports.<br />Here you can see <code>Notepad.exe</code>&#39;s Import Directory.<br /><a href=""><img src="images/1689-1.png" alt="images/1689-1.png" /></a><br /><br /> Notepad imports the modules (DLLs):<br />• <code>Kernel32.dll</code><br />• <code>GDI32.dll</code><br />• <code>USER32.dll</code><br />• etc.<br /><br />And specifically from the USER32.dll module shown above, it&#39;s imported the functions:<br />• <code>GetWindowTextW</code><br />• <code>EnableWindow</code><br />• <code>DrawTextExW</code><br />• <code>LoadIconW</code><br />• etc.<br /><br />At runtime, when the Windows loader loads the Notepad.exe PE file and executes it, <br />it will load all those modules listed above (<code>Kernel32.dll</code>, <code>User32.dll</code>) into Notepad&#39;s address space and then locate the address of each of the functions it&#39;s importing from these modules (<code>GetWindowTextW</code>, <code>EnableWindow</code>, etc.).<br /><br />Here we can that Notepad has the module <code>user32.dll</code> loaded at <code>0x7ffbcf7a0000</code><br /><a href=""><img src="images/1689-2.png" alt="images/1689-2.png" /></a><br /><br />Around that address - <code>0x7ffbcf7a0000</code> - will be our User32.dll functions - <code>GetWindowTextW</code>, <code>EnableWindow</code>, <code>DrawTextExW</code>, etc.<br />Therefore, after the Windows loader has loaded Notepad into memory and processed the Import Address Table, User32.dll in the Import Address Table might look like this:<br /><a href=""><img src="images/1689-3.png" alt="images/1689-3.png" /></a><br /><br /><strong><h2>## Hook the IAT</h2></strong><br />To hook the Import Address Table, we simply loop through it to find the function we want - e.g. <code>GetWindowTextW</code> - and replace that function&#39;s address with the address of our own hooked function.<br /><a href=""><img src="images/1689-4.png" alt="images/1689-4.png" /></a><br /><br />Now whenever <code>GetWindowTextW</code> is called inside the target process, it will jump to <code>0x028132dc0000</code> - our hooked function,<br />instead of <code>0x7ffbcf7a0010</code> - the address of the original <code>GetWindowTextW</code>.<br /><br />The diagrams above are abstracted versions of what the Import Address Table actually looks like.<br />They help to explain the concept of IAT hooking, but aren&#39;t an accurate depiction of the IAT itself.<br />For an in-depth look at the Import Address Table, I have a section on the PE format which you can read.<br /><br /></div>
</body>
</html>
