<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>TEB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># TEB - Thread Environment Block</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb</a><br />• <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">https://en.wikipedia.org/wiki/Win32_Thread_Information_Block</a><br />• <a href="https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/teb/index.htm">https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/teb/index.htm</a><br /><br />The TEB - Thread Environment Block - is an internal Windows data structure that contains information about a running process&#39;s thread.<br />Most of the struct is undocumented.<br /><br />If a process is running in usermode, it has a TEB.<br />The TEB contains the lowest-level amount of information about a running process in userland.<br /><br />For 32bit code, the TEB is stored in the <code>FS</code> register<br />For 64bit code, the TEB is stored in the <code>GS</code> register<br /><br />You would think you grab the TEB by referencing <code>fs:[0]</code>,<br />but you don&#39;t.<br /><br />The TEB contains a self-referencing pointer to itself at offset<br /><code>0x18</code> on 32bit<br /><code>0x30</code> on 64bit<br />(good description here: <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">https://en.wikipedia.org/wiki/Win32_Thread_Information_Block</a>)<br /><br />Therefore, you can find a pointer to the TEB at<br /><code>fs:[0x18]</code> on 32bit<br /><code>gs:[0x30]</code> on 64bit<br /><br /><strong><h2>## Grabbing the TEB</h2></strong><br /><br /><strong><h3>### via NtCurrentTeb</h3></strong><br />NtCurrentTeb returns a pointer to the TEB of the current thread<br /><a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/nf-winnt-ntcurrentteb">https://docs.microsoft.com/en-us/windows/win32/api/winnt/nf-winnt-ntcurrentteb</a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PTEB&nbsp;p_teb&nbsp;=&nbsp;NULL;<br />	p_teb&nbsp;=&nbsp;NtCurrentTeb();<br /><br />	printf(&quot;TEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb);<br />	printf(&quot;\t&nbsp;ProcessEnvironmentBlock:&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb-&gt;ProcessEnvironmentBlock);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### via intrinsics</h3></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />PTEB&nbsp;GrabTEB(void)<br />{<br />	PTEB&nbsp;p_teb&nbsp;=&nbsp;NULL;<br /><br />#ifdef&nbsp;_WIN64<br />	p_teb&nbsp;=&nbsp;(PTEB)__readgsqword(0x30);<br />#else<br />	p_teb&nbsp;=&nbsp;(PTEB)__readfsdword(0x18);<br />#endif<br /><br />	return&nbsp;p_teb;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PTEB&nbsp;p_teb&nbsp;=&nbsp;NULL;<br /><br />	p_teb&nbsp;=&nbsp;GrabTEB();<br />	printf(&quot;PTEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb);<br />	printf(&quot;\t&nbsp;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb-&gt;ProcessEnvironmentBlock);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
