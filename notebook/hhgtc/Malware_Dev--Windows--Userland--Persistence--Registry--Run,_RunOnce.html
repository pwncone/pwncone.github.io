<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Run, RunOnce</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Run &amp; RunOnce</h1></strong><br />• <a href="https://attack.mitre.org/beta/techniques/T1547/001/">https://attack.mitre.org/beta/techniques/T1547/001/</a><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys">https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys</a><br /><br />This persistence mechanism is super common.<br /><br /><code>Run</code> keys run on every boot.<br /><code>RunOnce</code> executes and then clears the registry key.<br /><br />Values in the <code>Software\Microsoft\Windows\CurrentVersion\Run</code> key run when a user logs in.<br /><a href=""><img src="images/1728-1.png" alt="images/1728-1.png" /></a><br /><br /><code>Run</code> keys exists in both <code>HKEY_LOCAL_MACHINE</code> and <code>HKEY_CURRENT_USER</code>.<br />Locations:<br /><div class="codebox"><div class="codebox">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br />HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce<br />HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run<br />HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</div></div><br /><br />HKEY_LOCAL_MACHINE has 32bit and 64bit registry sections.<br />• A 32bit exe on a 64bit system will write to: <br />   ◇ <code>HKEY_LOCAL_MACHINE\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</code><br />• A 64bit exe on 64bit system will write to:<br />   ◇ <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</code><br /><br /><code>Run</code> keys are ignored when the computer is started in safe mode.<br /><br /><strong><h2>## Observations</h2></strong><br />When set, the value can be found in the Windows 10 <code>Task Manager &gt; Start-up</code> tab.<br /><a href=""><img src="images/1728-2.png" alt="images/1728-2.png" /></a><br /><br /><strong><h2>## cmdline</h2></strong><br /><code>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot; /v &quot;Hello&quot; /t REG_SZ /d &quot;C:\Users\Bob\Desktop\hello_world.exe&quot; /f</code><br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">/*<br />Compiled&nbsp;on&nbsp;Windows&nbsp;10&nbsp;x64&nbsp;in&nbsp;Visual&nbsp;Studio&nbsp;2019&nbsp;as&nbsp;x64&nbsp;Release<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	LSTATUS&nbsp;lstat_ret&nbsp;=&nbsp;0;<br />	HKEY&nbsp;h_key&nbsp;=&nbsp;NULL;<br />	char&nbsp;exe_path[MAX_PATH]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	<br />	//&nbsp;get&nbsp;path&nbsp;to&nbsp;current&nbsp;exe<br />	GetModuleFileNameA(NULL,&nbsp;exe_path,&nbsp;MAX_PATH);<br /><br />	//&nbsp;create&nbsp;key<br />	lstat_ret&nbsp;=&nbsp;RegCreateKeyA(HKEY_CURRENT_USER,&nbsp;&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;,&nbsp;&amp;h_key);<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		return&nbsp;1;<br /><br />	//&nbsp;set&nbsp;Run&nbsp;key<br />	lstat_ret&nbsp;=&nbsp;RegSetValueExA(h_key,&nbsp;&quot;persist&quot;,&nbsp;0,&nbsp;REG_SZ,&nbsp;(BYTE*)exe_path,&nbsp;sizeof(exe_path));<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		return&nbsp;2;<br /><br />	printf(&quot;Hello,&nbsp;world!&nbsp;\n&quot;);<br />	getchar();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /><br /></div>
</body>
</html>
