<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Grab own PEB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Grabbing the PEB</h1></strong><br />There are many ways to grab the PEB.<br /><br /><strong><h2>## via the TEB</h2></strong><br />The TEB - Thread Environment Block - contains a pointer to the PEB called <code>ProcessEnvironmentBlock</code>.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb</a><br /><a href=""><img src="images/1538-1.png" alt="images/1538-1.png" /></a><br /><br />For 32bit code, the TEB is stored in the <code>fs</code> register.<br />For 64bit code, the TEB is stored in the <code>gs</code> register.<br /><br />In a 32bit TEB, the offset to <code>ProcessEnvironmentBlock</code> is <code>0x30</code>.<br />In a 64bit TEB, the offset to <code>ProcessEnvironmentBlock</code> is <code>0x60</code>. (pictured above)<br /><br />Therefore, <br />in 32bit code, we can grab a pointer to the PEB by referencing:<br /><code>fs:[0x30]</code><br /><br />in 64bit code, we can grab a pointer to the PEB by referencing:<br /><code>gs:[0x60]</code><br /><br /><strong><h3>### using instrinsics</h3></strong><br /><code>__readgsqword</code> (read GS register) and <code>__readfsdword</code> (read FS register) are compiler intrinsics.<br />They&#39;re functions intrinsic to the compiler.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />PPEB&nbsp;GrabPEB(void)<br />{<br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />#ifdef&nbsp;_WIN64<br />	p_peb&nbsp;=&nbsp;(PPEB)__readgsqword(0x60);<br />#else<br />	p_peb&nbsp;=&nbsp;(PPEB)__readfsdword(0x30);<br />#endif<br /><br />	return&nbsp;p_peb;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br />	<br />	p_peb&nbsp;=&nbsp;GrabPEB();<br />	printf(&quot;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_peb);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### Assembly</h3></strong><br />Example below is inline assembly.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />/*<br />32bit&nbsp;only&nbsp;because&nbsp;Visual&nbsp;Studio&nbsp;doesn&#39;t&nbsp;accept&nbsp;x64&nbsp;inline&nbsp;assembly.<br />*/<br />PPEB&nbsp;GrabPEB_InlineAsm(void)<br />{<br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />	_asm<br />	{<br />		xor&nbsp;eax,&nbsp;eax;			//&nbsp;clear&nbsp;eax<br />		mov&nbsp;eax,&nbsp;fs:[0x30];		//&nbsp;grab&nbsp;start&nbsp;of&nbsp;PEB<br />		mov&nbsp;p_peb,&nbsp;eax;			//&nbsp;move&nbsp;PEB&nbsp;pointer&nbsp;from&nbsp;EAX&nbsp;into&nbsp;variable<br />	}<br /><br />	return&nbsp;p_peb;<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />	p_peb&nbsp;=&nbsp;GrabPEB_InlineAsm();<br />	printf(&quot;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_peb);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### Grab TEB first -&gt; then grab ProcessEnvironmentBlock for PEB</h3></strong><br />Here we use <code>NtCurrentTeb</code> to grab the TEB (which just does <code>__readfsdword(0x18)</code>)<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PTEB&nbsp;p_teb&nbsp;=&nbsp;NULL;<br />	p_teb&nbsp;=&nbsp;NtCurrentTeb();<br /><br />	printf(&quot;TEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb);<br />	printf(&quot;\t&nbsp;ProcessEnvironmentBlock:&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_teb-&gt;ProcessEnvironmentBlock);<br /><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br />	p_peb&nbsp;=&nbsp;p_teb-&gt;ProcessEnvironmentBlock;<br /><br />	printf(&quot;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_peb);<br />	printf(&quot;\t&nbsp;BeingDebugged:&nbsp;%d&nbsp;\n&quot;,&nbsp;p_peb-&gt;BeingDebugged);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## via NtQueryInformationProcess</h2></strong><br /><code>NtQueryInformationProcess</code> retrieves information about a specified process.<br />We can request <code>ProcessBasicInformation</code> which returns a <code>PROCESS_BASIC_INFORMATION</code> struct.<br /><div class="codebox"><div class="codebox">typedef&nbsp;struct&nbsp;_PROCESS_BASIC_INFORMATION&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Reserved1;<br />&nbsp;&nbsp;&nbsp;&nbsp;PPEB&nbsp;PebBaseAddress;<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Reserved2[2];<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG_PTR&nbsp;UniqueProcessId;<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Reserved3;<br />}&nbsp;PROCESS_BASIC_INFORMATION;</div></div><br /><br />From the <code>PROCESS_BASIC_INFORMATION</code> struct, we can the grab the PEB from the <code>PebBaseAddress</code> entry.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Ntdll.lib&quot;)<br /><br />PPEB&nbsp;GrabPEB_NtQuery(void)<br />{<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;0;<br />	PROCESS_BASIC_INFORMATION&nbsp;pbi&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />	nt_status&nbsp;=&nbsp;NtQueryInformationProcess(GetCurrentProcess(),&nbsp;ProcessBasicInformation,&nbsp;&amp;pbi,&nbsp;sizeof(PROCESS_BASIC_INFORMATION),&nbsp;NULL);<br />	if&nbsp;(!NT_SUCCESS(nt_status))<br />		return&nbsp;NULL;<br />	<br />	p_peb&nbsp;=&nbsp;pbi.PebBaseAddress;<br /><br />	return&nbsp;p_peb;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />	p_peb&nbsp;=&nbsp;GrabPEB_NtQuery();<br />	printf(&quot;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;p_peb);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
