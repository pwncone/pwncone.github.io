<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RunOnceEx</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># RunOnceEx</h1></strong><br />• <a href="https://support.microsoft.com/en-gb/help/232487/description-of-the-runonceex-registry-key">https://support.microsoft.com/en-gb/help/232487/description-of-the-runonceex-registry-key</a><br />• <a href="https://oddvar.moe/2018/03/21/persistence-using-runonceex-hidden-from-autoruns-exe/">https://oddvar.moe/2018/03/21/persistence-using-runonceex-hidden-from-autoruns-exe/</a> - All credit goes here<br />• <a href="http://greatis.com/webhelp/regrun___detailed_instructions/start_control/runex_key.htm">http://greatis.com/webhelp/regrun___detailed_instructions/start_control/runex_key.htm</a> - documentation<br /><br /><code>RunOnceEx</code> is available on Windows Vista and newere, but is not created by default<br /><div class="codebox"><div class="codebox">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx&nbsp;</div></div><br /><br /><code>RunOnceEx</code> only executes for Administrators.<br /><br />The <code>Run</code> and <code>RunOnce</code> registry keys create separate processes<br />The <code>RunOnceEx</code> registry key does not create a separate processes. <br /><br /><code>RunOnceEx</code> supports a dependency list of DLLs that remain loaded while the sections are being processed.<br />If an exception occurs while calling a function in a DLL, the exception is caught and an error dialog box is displayed to the user. You can suppress this error dialog box by using a flag in the RunOnceEx registry key.<br /><br />Documentation (now removed from MSDN) looks like this:<br /><a href=""><img src="images/1729-1.png" alt="images/1729-1.png" /></a><br /><br /><strong><h2>## Run an executable</h2></strong><br />To run an executable, you write to the registry with the data:<br /><code>||C:\Users\Bob\Desktop\hello_world.exe</code><br /><br />Here&#39;s a powershell command that makes use of <code>`</code> to escape <code>&quot;</code><br /><code>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0003&quot; /v &quot;hello&quot; /t REG_SZ /d &quot;||C:\Users\Bob\Desktop\hello_world.exe&quot; /f</code><br /><br /><a href=""><img src="images/1729-2.png" alt="images/1729-2.png" /></a><br /><br />The specified executable will now run on system startup after a reboot.<br />Because this is a <code>RunOnce</code> key, the registry will be deleted when it&#39;s run.<br /><br />Alternatively, you can run the <code>RunOnce</code> key now with:<br /><code>runonce /Explrorer</code><br /><a href=""><img src="images/1729-3.png" alt="images/1729-3.png" /></a><br /><br /><strong><h2>## Run function from a DLL</h2></strong><br />You can run DLLs similar to how you run an executable.<br />The data should be:<br /><code>&quot;C:\Windows\system32\dll.dll|Function|parameters</code><br /><code>&quot;C:\Windows\system32\url.dll|OpenURL|&quot;http://www.google.com&quot;</code><br /><br />Here&#39;s a powershell command that uses <code>`</code> to escape the <code>&quot;</code> quotes<br /><code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001 /v &quot;OpenURL&quot; /d &quot;C:\Windows\system32\url.dll|OpenURL|`&quot;http://www.google.com`&quot;&quot;</code><br /><br />According to oddvar, the DLL you choose must be registered.<br /><br /><a href=""><img src="images/1729-4.png" alt="images/1729-4.png" /></a><br /><br /><strong><h2>## Load DLL as Dependency</h2></strong><br />Using <code>RunOnceEx</code>&#39;s <code>Depend</code> key, you can define a DLL to be loaded as a dependency.<br />This DLL doesn&#39;t have to be signed.<br /><br /><code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend /v 1 /d &quot;C:\Users\Bob\Desktop\hello_dll.dll&quot;</code><br /><br /><a href=""><img src="images/1729-5.png" alt="images/1729-5.png" /></a><br /><br /><a href=""><img src="images/1729-6.png" alt="images/1729-6.png" /></a><br /><br /></div>
</body>
</html>
