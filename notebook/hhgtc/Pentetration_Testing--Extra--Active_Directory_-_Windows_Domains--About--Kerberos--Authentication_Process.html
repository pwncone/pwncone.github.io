<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Authentication Process</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Kerberos - Keberos Authentication Process</h1></strong><br /><a href="https://adsecurity.org/?p=227">https://adsecurity.org/?p=227</a><br /><a href="https://www.roguelynn.com/words/explain-like-im-5-kerberos/">https://www.roguelynn.com/words/explain-like-im-5-kerberos/</a><br /><br />Kerberos authentication can be divided into 3 parts:<br />• Part 1 - Getting a TGT (to request a TGS)<br />• Part 2 - Getting a TGS (to access a service)<br />• Part 3 - Use TGS to Access Service<br /><br />A TL;DR version of the Kerberos authentication process goes like this:<br />1. Client requests TGT from Kerberos<br />2. Client requests TGS from Kerberos using TGT<br />3. Client sends TGS to service -&gt; request access to service<br />4. Service grants client access<br /><br /><strong><h2>## Part 1 - Getting a TGT</h2></strong><br /><strong><h3>### 1. AS-REQ</h3></strong><br />Client authenticates with Kerberos server<br />Client sends their username, password, and the current system time<br />- If pre-auth enabled? -&gt; data is encrypted with user&#39;s NTLM hash<br />- If pre-auth disabled? -&gt; data not encrypted<br /><br /><strong><h3>### 2. AS-REP</h3></strong><br /><strong>Verify</strong><br />Pre-auth enabled? -&gt; KDC decrypts AS_REQ with user&#39;s NTLM password hash <br />(which the KDC has in its database)<br />   ◇ KDC then verifies timestamp is within the valid time skew time (5 mins by default)<br />      <br /><strong>Reply</strong><br />• Kerberos replies to the client with<br />   ◇ A TGT -&gt; encrypted it with <code>krbtgt</code> account hash<br />   ◇ A TGS session key - indicates the TGT is valid to request a TGS for 20 minutes -&gt; encrypted with users&#39; NTLM password hash<br /><br /><strong><h2>## Part 2 - Getting a TGS Ticket for a Service</h2></strong><br />Client opens Outlook email -&gt; Client workstation finds the Outlook Exchange mailbox server and queries Active Directory for the SPN - Service Principle Name - of the user running the mail service<br /><br /><strong><h3>### 3. TGS-REQ</h3></strong><br />Client sends TGT, TGS session key, and target server SPN, <br />and requests a TGS ticket to access to the service<br /><br /><strong><h3>### 4. TGS-REP</h3></strong><br /><strong>Verify</strong><br />KDC verifies the TGS_REQ by decrypting the TGT with the <code>krbtgt</code> account hash<br />      <br /><strong>Reply</strong><br />• KDC replies to the client with<br />   ◇ A TGS -&gt; encrypted with NTLM password hash of target service (which the KDC has in its database)<br />      ▪ TGS includes: user&#39;s SID/group memberships<br />   ◇ A session key -&gt; encrypted with user&#39;s session key (???)<br /><br /><strong><h2>## Part 3 - Access Service</h2></strong><br /><strong><h3>### 5. AP-REQ</h3></strong><br />Client connects to service and presents its TGS<br /><br /><strong><h3>### 6. AP-REP</h3></strong><br /><strong>Verify</strong><br />Service decrypts the TGS with its own NTLM password hash.<br />Checks the user group membership&#39;s/SID inside the TGS to check if its allowed to access the service.<br />      <br /><strong>Reply</strong><br />Service replies to client with AP_REQ and grants client access to service.<br /><br /><strong><h2>## Diagrams</h2></strong><br /><a href=""><img src="images/421-1.png" alt="images/421-1.png" /></a><br /><br /><a href=""><img src="images/421-2.png" alt="images/421-2.png" /></a><br /><br />BEST VERSION:<br /><a href=""><img src="images/421-3.png" alt="images/421-3.png" /></a></div>
</body>
</html>
