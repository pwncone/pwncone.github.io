<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Watchdog</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Watchdog</h1></strong><br />A watchdog is a secondary process, or thread (, or mutex?) that watches your primary process and prevents tampering with it and restarts if it closes.<br /><br />Watchdogs aren&#39;t particulary effective at protecting processes because who watches your watchdog? If you can terminate the watchdog, you can then terminate the process it&#39;s protecting. <br />It just keeps going 1 level deeper.<br /><br />Examples<br />â€¢ <a href="http://www.rohitab.com/discuss/topic/41154-process-persistence/#entry10096756">http://www.rohitab.com/discuss/topic/41154-process-persistence/#entry10096756</a><br /><br /><strong><h2>## Simple Watchdog Demo</h2></strong><br />Here I have a watchdog that&#39;s checking for the <code>hello.exe</code> process every 10 seconds.<br /><code>hello.exe</code> prints <code>hello there!</code> in an infninite loop.<br />If <code>hello.exe</code> doesn&#39;t exist, the watchdog will start it.<br /><br /><a href=""><img src="images/1746-1.png" alt="images/1746-1.png" /></a><br /><br /><a href=""><img src="images/1746-2.png" alt="images/1746-2.png" /></a><br /><br /><strong><h3>### Code</h3></strong><br />Here&#39;s my simple hello program.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	while&nbsp;(TRUE)<br />	{<br />		printf(&quot;hello&nbsp;there!&nbsp;\n&quot;);<br />		Sleep(2000);<br />	}<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />And here&#39;s my watchdog code.<br />This watchdog code is ideally injected into a critical system process - like <code>explorer.exe</code> - to protect it and so that it&#39;s a pain to terminate.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;TlHelp32.h&gt;<br /><br />const&nbsp;wchar_t&nbsp;protected_process[]&nbsp;=&nbsp;L&quot;hello.exe&quot;;<br />char&nbsp;protected_process_path[]&nbsp;=&nbsp;&quot;C:\\Users\\Bob\\Desktop\\hello.exe&quot;;<br /><br />/*<br />Takes&nbsp;a&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;processes&nbsp;on&nbsp;the&nbsp;system&nbsp;every&nbsp;10&nbsp;seconds&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;protected&nbsp;process.<br />If&nbsp;the&nbsp;protected&nbsp;process&nbsp;isn&#39;t&nbsp;running,&nbsp;the&nbsp;watchdog&nbsp;will&nbsp;start&nbsp;it.<br />*/<br />void&nbsp;watchdog(void)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;process_running&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;h_snapshot&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;PROCESSENTRY32&nbsp;process&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;process.dwSize&nbsp;=&nbsp;sizeof(PROCESSENTRY32);<br />&nbsp;&nbsp;&nbsp;&nbsp;wchar_t&nbsp;process_name[]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;infinite&nbsp;loop.&nbsp;check&nbsp;processes&nbsp;every&nbsp;10&nbsp;seconds.<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(TRUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;process_running&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STARTUPINFOA&nbsp;si&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCESS_INFORMATION&nbsp;pi&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;get&nbsp;snapshot&nbsp;of&nbsp;processes&nbsp;&amp;&nbsp;grab&nbsp;first&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_snapshot&nbsp;=&nbsp;CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process32First(h_snapshot,&nbsp;&amp;process);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;loop&nbsp;through&nbsp;processes,&nbsp;looking&nbsp;for&nbsp;protected&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(wcscmp(process.szExeFile,&nbsp;protected_process)&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;process_running&nbsp;=&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(Process32Next(h_snapshot,&nbsp;&amp;process));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(process_running&nbsp;==&nbsp;TRUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;process&nbsp;is&nbsp;running!&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(process_running&nbsp;==&nbsp;FALSE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\t&nbsp;process&nbsp;not&nbsp;running...&nbsp;spawning&nbsp;it&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CreateProcessA(NULL,&nbsp;protected_process_path,&nbsp;NULL,&nbsp;NULL,&nbsp;FALSE,&nbsp;CREATE_NEW_CONSOLE,&nbsp;NULL,&nbsp;NULL,&nbsp;&amp;si,&nbsp;&amp;pi);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//ShellExecuteA(NULL,&nbsp;&quot;open&quot;,&nbsp;protected_process_path,&nbsp;NULL,&nbsp;NULL,&nbsp;SW_SHOW);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\t&nbsp;started&nbsp;process!&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(10000);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;watchdog();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
