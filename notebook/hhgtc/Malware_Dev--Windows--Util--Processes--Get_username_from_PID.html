<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Get username from PID</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Get username from PID</h1></strong><br />â€¢ <a href="https://github.com/umerov1999/metasploit-payloads/blob/e48f3432ff5b673c5b6bf1893c2cccf2974f084d/c/meterpreter/source/extensions/stdapi/server/sys/process/ps.c#L340">https://github.com/umerov1999/metasploit-payloads/blob/e48f3432ff5b673c5b6bf1893c2cccf2974f084d/c/meterpreter/source/extensions/stdapi/server/sys/process/ps.c#L340</a><br /><br /><code>OpenProcess</code> to get a handle to the process.<br /><code>OpenProcessToken</code> to get the process&#39; access token.<br /><code>GetTokenInformation</code> with TOKEN_USER to get the SID who owns the process.<br /><code>LookupAccountSidA</code> to convert the SID to a username.<br /><br /><div class="codebox"><div class="codebox">/*<br />Gets&nbsp;username&nbsp;from&nbsp;PID&nbsp;by&nbsp;opening&nbsp;the&nbsp;process,&nbsp;querying&nbsp;for&nbsp;its&nbsp;access&nbsp;token,&nbsp;<br />grabbing&nbsp;the&nbsp;SID&nbsp;from&nbsp;the&nbsp;token,&nbsp;and&nbsp;converting&nbsp;the&nbsp;SID&nbsp;to&nbsp;a&nbsp;username.<br /><br />`out_username`&nbsp;returns&nbsp;you&nbsp;the&nbsp;username.<br />`out_username_len`&nbsp;should&nbsp;be&nbsp;~256.<br /><br />Usage:<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;username[256]&nbsp;=&nbsp;{0};<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;username_len&nbsp;=&nbsp;sizeof(username);<br />&nbsp;&nbsp;&nbsp;&nbsp;GetUsernameFromPID(pid,&nbsp;username,&nbsp;username_len);<br />*/<br />BOOL&nbsp;GetUsernameFromPID(DWORD&nbsp;pid,&nbsp;char*&nbsp;out_username,&nbsp;DWORD&nbsp;out_username_len)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;TRUE;<br />	<br />	HANDLE&nbsp;h_process&nbsp;=&nbsp;NULL;<br />	HANDLE&nbsp;h_token&nbsp;=&nbsp;NULL;<br />	TOKEN_USER*&nbsp;token_useraccount&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;user_length&nbsp;=&nbsp;0;<br /><br />	char&nbsp;username[256]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	char&nbsp;domain_name[256]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	DWORD&nbsp;username_len&nbsp;=&nbsp;sizeof(username);<br />	DWORD&nbsp;domain_name_len&nbsp;=&nbsp;sizeof(domain_name);<br />	SID_NAME_USE&nbsp;sid&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	//&nbsp;open&nbsp;handle&nbsp;to&nbsp;process<br />	//&nbsp;if&nbsp;unable&nbsp;to&nbsp;open&nbsp;handle,&nbsp;none&nbsp;of&nbsp;the&nbsp;following&nbsp;functions&nbsp;will&nbsp;work<br />	h_process&nbsp;=&nbsp;OpenProcess(PROCESS_QUERY_INFORMATION,&nbsp;FALSE,&nbsp;pid);<br />	if&nbsp;(h_process&nbsp;==&nbsp;NULL)<br />	{<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br />	<br />	//&nbsp;open&nbsp;access&nbsp;token&nbsp;of&nbsp;process<br />	b_ret&nbsp;=&nbsp;OpenProcessToken(h_process,&nbsp;TOKEN_QUERY,&nbsp;&amp;h_token);<br />	<br />	//&nbsp;get&nbsp;size&nbsp;of&nbsp;TOKEN_USER&nbsp;struct&nbsp;and&nbsp;allocate&nbsp;space<br />	b_ret&nbsp;=&nbsp;GetTokenInformation(h_token,&nbsp;TokenUser,&nbsp;NULL,&nbsp;0,&nbsp;&amp;user_length);<br />	token_useraccount&nbsp;=&nbsp;(TOKEN_USER*)malloc(user_length);<br /><br />	//&nbsp;grab&nbsp;TOKEN_USER&nbsp;struct.&nbsp;inside&nbsp;it&nbsp;is&nbsp;the&nbsp;SID<br />	b_ret&nbsp;=&nbsp;GetTokenInformation(h_token,&nbsp;TokenUser,&nbsp;token_useraccount,&nbsp;user_length,&nbsp;&amp;user_length);<br />	<br />	//&nbsp;use&nbsp;SID&nbsp;to&nbsp;grab&nbsp;username&nbsp;that&nbsp;owns&nbsp;the&nbsp;process<br />	b_ret&nbsp;=&nbsp;LookupAccountSidA(NULL,&nbsp;token_useraccount-&gt;User.Sid,&nbsp;username,&nbsp;&amp;username_len,&nbsp;domain_name,&nbsp;&amp;domain_name_len,&nbsp;&amp;sid);<br /><br />	sprintf_s(out_username,&nbsp;out_username_len&nbsp;-&nbsp;1,&nbsp;&quot;%s&quot;,&nbsp;username);<br /><br />cleanup:<br />	if&nbsp;(token_useraccount)&nbsp;free(token_useraccount);<br />	if&nbsp;(h_token)&nbsp;CloseHandle(h_token);<br />	if&nbsp;(h_process)&nbsp;CloseHandle(h_process);<br /><br />	return&nbsp;okay;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
