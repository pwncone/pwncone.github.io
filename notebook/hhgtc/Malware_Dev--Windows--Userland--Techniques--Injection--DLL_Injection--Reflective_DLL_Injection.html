<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Reflective DLL Injection</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Reflective DLL Injection</h1></strong><br />• <a href="https://github.com/stephenfewer/ReflectiveDLLInjection">https://github.com/stephenfewer/ReflectiveDLLInjection</a> - original Author of technique - ALL CREDIT GOES HERE<br />• <a href="https://disman.tl/2015/01/30/an-improved-reflective-dll-injection-technique.html">https://disman.tl/2015/01/30/an-improved-reflective-dll-injection-technique.html</a><br />• <a href="https://zerosum0x0.blogspot.com/2017/07/threadcontinue-reflective-injection.html">https://zerosum0x0.blogspot.com/2017/07/threadcontinue-reflective-injection.html</a> - using SetThreadContext and NtContinue<br /><br />Reflective DLL injection is a DLL that maps itself.<br />You write your DLL into the target process and then pass execution to an exported ReflectiveLoader() function in the DLL that you&#39;ve injected which will:<br />• grab the current process&#39;s PEB, find Kernel32.dll and Ntdll.dll, and loop through those modules to find the function addresses it needs<br />• allocate memory in the target (now the current) process<br />• memory map itself (the DLL you&#39;ve injected) into the allocated memory<br />• fix its imports<br />• perform base relocations<br />• and pass execution to its own DllMain function. <br /><br />The DLL has now loaded itself and is executing.<br /><br />Reflective DLL injection is a stealthy technique because it avoids calling <code>LoadLibrary</code> and doesn&#39;t register your DLL with the target process.<br /><br /><a href=""><img src="images/1649-1.png" alt="images/1649-1.png" /></a><br /><br /><strong><h2>## Difficulties</h2></strong><br />One difficulty with Reflective DLL Injection is that the functions you use in your <code>ReflectiveLoader()</code> function have to be used dynamically, i.e. by their address.<br />e.g. if you want to use <code>VirtualAlloc</code> - you have to use it by its address in <code>Kernel32.dll</code> - which will be somewhere near <code>0x7ffbd0140000</code><br />This is because when our <code>ReflectiveLoader()</code> function is running inside the target, it doesn&#39;t know the addresses of the functions you&#39;re trying to use.<br />You don&#39;t want to hardcode these function addresses, like that of <code>VirtualAlloc</code>, because these addresses can change between Windows releases.<br /><br />To solve this problem, we can grab the PEB - the Process Environment Block - of the target process we&#39;re currently running inside.<br />The PEB contains a list of all current process&#39;s loaded modules.<br />We can then loop through this list of loaded modules to find the DLLs that contain the functions we want, in this case <code>Kernel32.dll</code> and <code>Ntdll.dll</code>.<br />We can then loop through <code>Kernel32.dll</code> and <code>Ntdll.dll</code> to find the addresses of the functions we need.<br /><br />In <code>Kernel32.dll</code> we find <code>LoadLibrary</code>, <code>GetProcAddress</code>, and <code>VirtualAlloc</code>: so that we can load extra libraries, find function addresses, and allocate memory.<br />And in <code>Ntdll.dll</code> we find <code>NtFlushInstructionCache</code>.<br /><br /><strong><h2>## Demo</h2></strong><br />Here&#39;s my Reflective DLL that I&#39;m injecting, with its exported <code>ReflectiveLoader()</code> function.<br /><a href=""><img src="images/1649-2.png" alt="images/1649-2.png" /></a><br /><br />I&#39;m injecting into Notepad, which has a PID of <code>17912</code><br /><a href=""><img src="images/1649-3.png" alt="images/1649-3.png" /></a><br /><br />I run my <code>injector.exe</code> in an Administrator PowerShell prompt, and inject my DLL into Notepad.<br />In Notepad we can see our injected window!<br /><a href=""><img src="images/1649-4.png" alt="images/1649-4.png" /></a><br /><br /><br /><strong><h2>## Code</h2></strong><br />My code is a simplified re-write of Stephen Fewer&#39;s origianl code - <a href="https://github.com/stephenfewer/ReflectiveDLLInjection">https://github.com/stephenfewer/ReflectiveDLLInjection</a> - done so that I could better learn the technique.<br />All credit goes there!<br /><br />All of the code is well commented.<br /><br /><strong><h3>### injector.exe</h3></strong><br /><br /><strong><h3>### reflective_dll.dll</h3></strong><br /><br /></div>
</body>
</html>
