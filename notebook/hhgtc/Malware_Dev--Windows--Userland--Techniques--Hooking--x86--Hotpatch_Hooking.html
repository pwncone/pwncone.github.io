<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Hotpatch Hooking</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># x86 Hotpatch Hooking</h1></strong><br /><strong>About Hotpatching</strong><br />• <a href="https://devblogs.microsoft.com/oldnewthing/20130102-00/?p=5663">https://devblogs.microsoft.com/oldnewthing/20130102-00/?p=5663</a><br />• <a href="https://docs.microsoft.com/en-gb/archive/blogs/freik/what-does-hot-patchability-mean-and-what-is-it-for">https://docs.microsoft.com/en-gb/archive/blogs/freik/what-does-hot-patchability-mean-and-what-is-it-for</a><br />• <a href="https://docs.microsoft.com/en-us/cpp/build/reference/hotpatch-create-hotpatchable-image?view=msvc-160">https://docs.microsoft.com/en-us/cpp/build/reference/hotpatch-create-hotpatchable-image?view=msvc-160</a><br />• <a href="https://www.codeproject.com/Articles/1043089/HotPatching-VERY-Deep-Inside">https://www.codeproject.com/Articles/1043089/HotPatching-VERY-Deep-Inside</a> - &quot;Patching a Function by Installing a Proxy&quot; is similar to what we&#39;re doing here (hotpatch hooking)<br />• <a href="https://jpassing.com/2011/05/03/windows-hotpatching-a-walkthrough/">https://jpassing.com/2011/05/03/windows-hotpatching-a-walkthrough/</a> - indepth about microsoft&#39;s hotpatching method<br />• <a href="https://stackoverflow.com/questions/20939554/hooking-hotpatching">https://stackoverflow.com/questions/20939554/hooking-hotpatching</a> - Very good explanation of hotpatch hooking<br /><br /><strong>Hooking Examples</strong><br />• <a href="https://www.codeproject.com/Articles/27339/API-hooking-for-hotpatchable-operating-systems">https://www.codeproject.com/Articles/27339/API-hooking-for-hotpatchable-operating-systems</a><br />• <a href="http://www.rohitab.com/discuss/topic/29465-api-hooking/#entry10033488">http://www.rohitab.com/discuss/topic/29465-api-hooking/#entry10033488</a> - good example<br /><br />Hotpatch hooking is where you use the hotpatch space before a function to write a jump to your hook code.<br /><br />This is different to inline hooking in that you don&#39;t overwrite any crucial function prologue code within the original function, and therefore don&#39;t need to use trampoline space to store the original bytes from the function; you can just jump straight to your hook code and don&#39;t have to implement a trampoline at all.<br /><br /><strong><h2>## About Hotpatching</h2></strong><br />Around the time of Vista and Server 2003, Microsoft introduced hotpatching,<br />which allowed for system patches to be installed without requiring a reboot. <br />This was useful for server admins installing security updates who didn&#39;t want to reboot their machines.<br /><br />Hotpatching adds before every function:<br />• 5 bytes of NOP space<br />• and a 2 byte mov edi, edi instruction (which is a two-byte NOP)<br /><br />This extra 7 bytes of space allowed for patches to be inserted which redirect old code to new code,<br />thus the system runs the new code without having to be rebooted.<br />Therefore is almost no performance penalty to this becauase only 1 extra instruction is being executed in the original function - mov edi, edi - which is just a 2 byte NOP.<br /><br />We can use these 7 bytes of extra space before the function to hook Windows APIs, <br />and redirect the API to our hooked function.<br /><br />Modules must be compiled with hotpatching enabled:<br />• <code>/HOTPATCH</code> (apprently only necessary in x86)<br />• <code>/FUNCTIONPADMIN:5</code> (x86) adds 5 bytes of NOP space<br />• <code>/FUNCTIONPADMIN:12</code> (x64) adds 12 bytes of NOP space<br /><br />A lot of modules are compiled with hotpatching enabled (Kernel32.dll, User32.dll, etc.)<br />According to this article, about 30% of x86 is hotpatchable and 100% of x64 is hotpatchable:<br /><a href="https://docs.microsoft.com/en-gb/archive/blogs/freik/what-does-hot-patchability-mean-and-what-is-it-for">https://docs.microsoft.com/en-gb/archive/blogs/freik/what-does-hot-patchability-mean-and-what-is-it-for</a><br /><br /><strong><h2>## Detection</h2></strong><br />• The .text of the PE in memory will be different to the one in disc<br />   ◇ scanning .text will detect this hook<br />• Scan for specific byte sequences: 5 byte jmp, 2 byte jmp back, etc.<br /><br /><strong><h2>## Notes / Warnings</h2></strong><br /><strong><h3>### Only certain components are hotpatched</h3></strong><br />Aparrently, only certain components of Windows are compiled with the /hotpatch switch.<br /><br />User32.dll is.<br />Kernel32.dll is.<br /><br />I don&#39;t know about others.</div>
</body>
</html>
