<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Hiding Crypto Away in a .c & .h File</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Hiding Crypto Away in a .c &amp; .h File</h1></strong><br />This was more of a pain than I thought it would be, so I&#39;m documentating it.<br />This guy did it well:<br />â€¢ <a href="https://github.com/maldevel/AES256/blob/59b4401c17e87b31386abb1c75918b5d0dae57c6/AES256/aes256.c#L59">https://github.com/maldevel/AES256/blob/59b4401c17e87b31386abb1c75918b5d0dae57c6/AES256/aes256.c#L59</a><br /><br /><strong><h2>main.c</h2></strong><br /><div class="codebox"><div class="codebox">HCRYPTKEY&nbsp;h_key&nbsp;=&nbsp;0;<br />HCRYPTPROV&nbsp;h_provider&nbsp;=&nbsp;0;<br />char&nbsp;password[]&nbsp;=&nbsp;&quot;Hello!&quot;;<br /><br />InitCrypto(&amp;h_key,&nbsp;&amp;h_provider);<br />DeriveKeyFromPassword(h_provider,&nbsp;&amp;h_key,&nbsp;password);<br />BurnCrypto(h_key,&nbsp;h_provider);</div></div><br /><br /><strong><h2>crypto.h</h2></strong><br /><div class="codebox"><div class="codebox">#pragma&nbsp;once<br /><br />#define&nbsp;CRYPTO_PROVIDER			MS_ENH_RSA_AES_PROV_A<br />#define&nbsp;CRYPTO_PROVIDER_TYPE	PROV_RSA_AES<br />#define&nbsp;HASH_ALGORITHM			CALG_SHA_256<br />#define&nbsp;KEY_ALGORITHM			CALG_AES_256<br />#define&nbsp;AES_KEYSIZE				32				//&nbsp;(not&nbsp;used)&nbsp;32&nbsp;bytes&nbsp;/&nbsp;256&nbsp;bits<br />#define&nbsp;AES_BLOCKSIZE			128<br /><br />BOOL&nbsp;InitCrypto(HCRYPTKEY*&nbsp;key,&nbsp;HCRYPTPROV*&nbsp;provider);<br />BOOL&nbsp;DeriveKeyFromPassword(HCRYPTPROV&nbsp;provider,&nbsp;HCRYPTKEY*&nbsp;key,&nbsp;char*&nbsp;password);<br />void&nbsp;BurnCrypto(HCRYPTKEY&nbsp;key,&nbsp;HCRYPTPROV&nbsp;provider);</div></div><br /><br /><strong><h2>crypto.c</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&quot;crypto.h&quot;<br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />BOOL&nbsp;InitCrypto(HCRYPTKEY*&nbsp;key,&nbsp;HCRYPTPROV*&nbsp;provider)<br />{<br />	BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br /><br />	//&nbsp;Try&nbsp;to&nbsp;grab&nbsp;handle&nbsp;to&nbsp;key&nbsp;container&nbsp;for&nbsp;specified&nbsp;CSP.<br />	//&nbsp;If&nbsp;key&nbsp;container&nbsp;can&#39;t&nbsp;be&nbsp;opened,&nbsp;create&nbsp;a&nbsp;NEWKEYSET<br />	b&nbsp;=&nbsp;CryptAcquireContextA(provider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;CRYPTO_PROVIDER_TYPE,&nbsp;0);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		if&nbsp;(GetLastError()&nbsp;==&nbsp;NTE_BAD_KEYSET)<br />		{<br />			b&nbsp;=&nbsp;CryptAcquireContextA(provider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;CRYPTO_PROVIDER_TYPE,&nbsp;CRYPT_NEWKEYSET);<br />			if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />				return&nbsp;FALSE;<br />		}<br />		else<br />			return&nbsp;FALSE;<br />	}<br /><br />	return&nbsp;TRUE;<br />}<br /><br />BOOL&nbsp;DeriveKeyFromPassword(HCRYPTPROV&nbsp;provider,&nbsp;HCRYPTKEY*&nbsp;key,&nbsp;char*&nbsp;password)<br />{<br />	BOOL&nbsp;ok&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br />	HCRYPTHASH&nbsp;hash&nbsp;=&nbsp;0;<br /><br />	//&nbsp;Grab&nbsp;handle&nbsp;to&nbsp;CSP&nbsp;for&nbsp;hashing&nbsp;and&nbsp;hash&nbsp;the&nbsp;password<br />	b&nbsp;=&nbsp;CryptCreateHash(provider,&nbsp;HASH_ALGORITHM,&nbsp;0,&nbsp;0,&nbsp;&amp;hash);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;CryptCreateHash&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	b&nbsp;=&nbsp;CryptHashData(hash,&nbsp;(BYTE*)password,&nbsp;strlen(password),&nbsp;0);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;CryptHashData&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Create&nbsp;a&nbsp;RC4&nbsp;session&nbsp;key&nbsp;using&nbsp;the&nbsp;hashed&nbsp;password<br />	b&nbsp;=&nbsp;CryptDeriveKey(provider,&nbsp;KEY_ALGORITHM,&nbsp;hash,&nbsp;CRYPT_EXPORTABLE,&nbsp;key);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;CryptDeriveKey&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />cleanup:<br />	if&nbsp;(hash)&nbsp;CryptDestroyHash(hash);	//&nbsp;Destroy&nbsp;the&nbsp;password&nbsp;hash&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;it&nbsp;anymore<br /><br />	return&nbsp;ok;<br />}<br /><br />void&nbsp;BurnCrypto(HCRYPTKEY&nbsp;key,&nbsp;HCRYPTPROV&nbsp;provider)<br /><span style="color:#000000;font-weight:400">{</span><br />	if&nbsp;(key)&nbsp;CryptDestroyKey(key);<br />	if&nbsp;(provider)&nbsp;CryptReleaseContext(provider,&nbsp;0);<br /><br />	return;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
