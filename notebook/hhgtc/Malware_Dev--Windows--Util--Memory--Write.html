<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Write</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Write to Memory</h1></strong><br /><br /><strong><h2>## Write to protected memory</h2></strong><br /><a href="https://gist.github.com/denikson/93ea22c1f4e79e68466a26cbfc58af05">https://gist.github.com/denikson/93ea22c1f4e79e68466a26cbfc58af05</a><br /><div class="codebox"><div class="codebox">//&nbsp;A&nbsp;helper&nbsp;function&nbsp;to&nbsp;write&nbsp;into&nbsp;protected&nbsp;memory<br />inline&nbsp;int&nbsp;vpmemcpy(void&nbsp;*dst,&nbsp;void&nbsp;*src,&nbsp;size_t&nbsp;sz)<br /><span style="color:#000000;font-weight:400">{</span><br />	DWORD&nbsp;oldp;<br />	//&nbsp;Make&nbsp;the&nbsp;memory&nbsp;page&nbsp;writeable<br />	if&nbsp;(!VirtualProtect(dst,&nbsp;sz,&nbsp;PAGE_READWRITE,&nbsp;&amp;oldp))<br />		return&nbsp;1;<br />	memcpy(dst,&nbsp;src,&nbsp;sz);<br />	//&nbsp;Restore&nbsp;the&nbsp;protection&nbsp;level<br />	VirtualProtect(dst,&nbsp;sz,&nbsp;oldp,&nbsp;&amp;oldp);<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Write to executable memory</h2></strong><br />You not supposed to be able to write to executable memory (I don&#39;t think).<br />Or it&#39;s the other way around - you&#39;re not able to execute writable memory.<br /><br />Original inspiration:<br /><a href="https://stackoverflow.com/a/60922300">https://stackoverflow.com/a/60922300</a><br /><br /><div class="codebox"><div class="codebox">/*<br />A&nbsp;wrapper&nbsp;(?)&nbsp;around&nbsp;WriteProcessMemory.<br />Sets&nbsp;memory&nbsp;to&nbsp;read/write/execute,&nbsp;runs&nbsp;WriteProcessMemory,&nbsp;then&nbsp;sets&nbsp;memory&nbsp;to&nbsp;read/write/execute&nbsp;again.<br />Should&nbsp;probably&nbsp;add&nbsp;error&nbsp;checking&nbsp;VirtualProtect&nbsp;functions.<br /><br />Parameters:<br />	HANDLE&nbsp;hProcess		-&nbsp;handle&nbsp;to&nbsp;the&nbsp;process&nbsp;to&nbsp;write&nbsp;to<br />	LPBYTE&nbsp;destination	-&nbsp;where&nbsp;you&nbsp;want&nbsp;to&nbsp;write&nbsp;to<br />	LPBYTE&nbsp;source		-&nbsp;what&nbsp;data&nbsp;you&nbsp;want&nbsp;to&nbsp;write<br />	DWORD&nbsp;size			-&nbsp;size&nbsp;of&nbsp;the&nbsp;data&nbsp;you&nbsp;want&nbsp;to&nbsp;write<br />Return&nbsp;value:<br />	On&nbsp;successful&nbsp;memory&nbsp;write,&nbsp;returns&nbsp;TRUE.<br />	On&nbsp;failure&nbsp;to&nbsp;write&nbsp;memory,&nbsp;returns&nbsp;FALSE.<br />*/<br />BOOL&nbsp;WriteToExecutableMemory(HANDLE&nbsp;hProcess,&nbsp;LPBYTE&nbsp;destination,&nbsp;LPBYTE&nbsp;source,&nbsp;DWORD&nbsp;size)<br /><span style="color:#000000;font-weight:400">{</span><br />	DWORD&nbsp;previousProtectionValue;<br /><br />	//&nbsp;set&nbsp;memory&nbsp;as&nbsp;read/write/executable<br />	VirtualProtectEx(hProcess,&nbsp;destination,&nbsp;source,&nbsp;PAGE_EXECUTE_READWRITE,&nbsp;&amp;previousProtectionValue);<br />	//&nbsp;write&nbsp;memory<br />	if&nbsp;(WriteProcessMemory(hProcess,&nbsp;destination,&nbsp;source,&nbsp;size,&nbsp;NULL)&nbsp;==&nbsp;0)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;to&nbsp;write&nbsp;section&nbsp;to&nbsp;hollowed&nbsp;process&nbsp;\n&quot;);<br />		DBUG&nbsp;fprintf(stderr,&nbsp;&quot;[debug]&nbsp;processHollowing_self():&nbsp;WriteProcessMemory()&nbsp;=&nbsp;%lu&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;FALSE;<br />	}<br />	//&nbsp;set&nbsp;memory&nbsp;as&nbsp;read/write/executable&nbsp;again<br />	VirtualProtectEx(hProcess,&nbsp;destination,&nbsp;source,&nbsp;previousProtectionValue,&nbsp;&amp;previousProtectionValue);<br />	<br />	return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />An alternative would be to VirtualAlloc <code>PAGE_READWRITE</code> permissions first, then VirtualProtect to <code>PAGE_EXECUTE_READWRITE</code> after you&#39;ve finished writing.<br /><br /></div>
</body>
</html>
