<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Set up kernel debug environment</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Set a up a kernel debug environment</h1></strong><br />Tools:<br />• <code>WinDbg</code> - actual debugger<br />• <code>DebugView</code> - view debug output<br />• <code>WinObj</code> - view loaded drivers<br /><br />You can&#39;t debug the kernel on your own machine. <br />You&#39;re debugging the kernel, which means that your whole system will pause.<br />Kernel debugging requires 2 computers.<br />Traditionally, 2 computers were hooked up by a serial port and 1 would debug the other.<br /><br />Nowadays, you can use virtual machines.<br /><br />If you don&#39;t have access to virtual machines, there are ways to debug the kernel on 1 machine:<br />• using <code>Livekd</code> by SysInternals - <a href="https://samsclass.info/126/proj/p12-kernel-debug-win2008.htm">https://samsclass.info/126/proj/p12-kernel-debug-win2008.htm</a><br />• open minidumps at <code>C:\Windows\Minidump</code> with WinDbg<br /><br /><strong><h2>## Use Livekd</h2></strong><br />• <a href="https://samsclass.info/126/proj/p12-kernel-debug-win2008.htm">https://samsclass.info/126/proj/p12-kernel-debug-win2008.htm</a><br /><br /><strong><h2>## Use a Virtual Machine</h2></strong><br />• <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/configuring-kernel-debugging-environment-with-kdnet-and-windbg-preview">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/configuring-kernel-debugging-environment-with-kdnet-and-windbg-preview</a><br />• <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically</a><br /><br />If you&#39;re already writing kernel drivers in a VM, or are planning to, just clone that VM.<br />Makes it easy because all the tools for debugging will already be on/configured for debuggee machine.<br /><br />• <code>debugger</code> machine - used for debugging (and probably where you write code oo)<br />• <code>debuggee</code> machine - runs your kernel driver and gets debugged<br /><br />On the debuggee machine, you use <code>kdnet.exe</code> to generate a connection command.<br />On the debugger machine, you connect to the debuggee&#39;s kernel using the connection command.<br /><br />You need <code>kdnet.exe</code>.<br /><code>kdnet.exe</code> comes packaged with the Windows SDK.<br /><br />On the debuggee machine, in an Admin prompt run<br /><code>kdnet &lt;ip of debugger machine&gt; 50001</code><br /><br />The <code>-k</code> is for kernel debugging<br /><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically</a><br /><br />This generates a cmd output with a key. <br />Note this down.<br /><br />On the debugger host, open WinDbg and attach to the kernel using your port and key<br /><a href=""><img src="images/1804-1.png" alt="images/1804-1.png" /></a><br /><br />You&#39;re now connected and can start debugging.<br /><br /><strong>TO RESTORE (disable Kernel Debugging)</strong><br />In Administrator prompt:<br /><code>bcdedit /debug off</code><br /><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--debug">https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--debug</a><br /><br /><strong><h2>## Enable DbgPrint output</h2></strong><br />Why this isn&#39;t enabled by default I have no idea<br /><br /><strong><h3>### in WinDbg</h3></strong><br /><code>ed kd_default_mask 0xf</code><br /><br /><strong><h3>### in DbgView</h3></strong><br />• <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/compiling-first-kernel-driver-kdprint-dbgprint-and-debugview#enable-dbgprint-monitoring-for-dbgview">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/compiling-first-kernel-driver-kdprint-dbgprint-and-debugview#enable-dbgprint-monitoring-for-dbgview</a><br /><br />RUN DBGVIEW AS ADMINISTRATOR TO CAPTURE KERNEL.<br /><br />Create a sub-key <code>Debug Print Filter</code> if it does not exist:<br /><code>Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Debug Print Filter</code><br /><br />Add a new DWORD value <code>DEFAULT</code> and set its Data field to <code>0xf</code><br /><a href=""><img src="images/1804-2.png" alt="images/1804-2.png" /></a><br /><br />Enable Kernel capture<br /><code>Capture &gt; Capture Kernel</code><br /><a href=""><img src="images/1804-3.png" alt="images/1804-3.png" /></a><br /><br />Set a filter so you don&#39;t catch everything<br /><code>Edit &gt; Filter</code><br /><a href=""><img src="images/1804-4.png" alt="images/1804-4.png" /></a><br /><br /></div>
</body>
</html>
