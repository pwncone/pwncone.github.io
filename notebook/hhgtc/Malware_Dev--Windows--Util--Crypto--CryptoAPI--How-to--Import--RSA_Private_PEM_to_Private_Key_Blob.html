<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RSA Private PEM to Private Key Blob</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># RSA Private PEM to Private Key Blob</h1></strong><br />• <a href="https://stackoverflow.com/questions/8412838/how-to-import-private-key-in-pem-format-using-wincrypt-and-c">https://stackoverflow.com/questions/8412838/how-to-import-private-key-in-pem-format-using-wincrypt-and-c</a><br />• <a href="https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-blueliv/research/cryptoapi-in-malware/">https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-blueliv/research/cryptoapi-in-malware/</a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;wincrypt.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Crypt32.lib&quot;)<br /><br />#define&nbsp;CRYPTO_PROVIDER			MS_ENH_RSA_AES_PROV_A<br />#define&nbsp;CRYPTO_PROVIDER_TYPE	PROV_RSA_AES<br />#define&nbsp;KEY_ALGORITHM			CALG_AES_256<br />#define&nbsp;AES256_KEYSIZE			32		//&nbsp;32&nbsp;bytes&nbsp;/&nbsp;256&nbsp;bits<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	int&nbsp;i&nbsp;=&nbsp;0;<br />	BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br /><br />	//&nbsp;Init&nbsp;RSA&nbsp;crypto<br />	HCRYPTKEY&nbsp;h_RSAkey&nbsp;=&nbsp;0;<br />	HCRYPTPROV&nbsp;h_RSAprovider&nbsp;=&nbsp;0;<br />	char&nbsp;rsa_private_der[2048]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	char*&nbsp;rsa_private_pem&nbsp;=&nbsp;&quot;-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----&quot;<br />		&quot;MIIEogIBAAKCAQEAwA0QE3gLfbPnhFepeKxkMAUSi+6cBE9narr7eiY9yVLVUlWG&quot;<br />		&quot;fHIHjRXSN0VB26Alz7pZc5ZUJlsegep82jND6sjDbthh8FixSc9npI3lDWqI6d2g&quot;<br />		&quot;Fw4sJVj+0H83vg1NOOyRrKKY9NXA8iXvGDMKY2+nhenQlDEjg+JBHiFs5fA38leF&quot;<br />		&quot;Moe26Qc+so1CRwHspgg7GHHC8DgV6+XbHQfAGA+nm8KBBp/vkJyw4ng58kVrRNpD&quot;<br />		&quot;lSHpjYXuzkDEfX2OOd6BgQRp1RpTLZ2UM2tNNEiJ6ITgCTbgFs8zGInoRnGh9vsq&quot;<br />		&quot;wkiCevro0yMUBSn+rVQ1Y2BzxAV8u4MZfJ/svQIDAQABAoIBAE9tF5j1rMrv/G/f&quot;<br />		&quot;UVd29HhnoKP+qsedj0e0zQxXhHYeq9rBRD1za2wN+kKhgfsy4HBowVXsdiDmzlcs&quot;<br />		&quot;gzY6vXv8S9cr5lVgWPINtO95P6GszbLq1aqzUc6gX8Ia2xLerXE9ZYHgPSIExSdg&quot;<br />		&quot;SOHZOhKlusLHUFv5dpa0m/m6GS9+0ZfYrmUnsZGkYDCqI0LS/skwFd9DY4hQXNkp&quot;<br />		&quot;fC1sM3kkxyobaw/ink5YmB7nBnBYOh1tvv3h922VCDXX1zCz3h7jYtTt2/6Sl9R5&quot;<br />		&quot;a4fA1zjQgtPh+b1DpjVH+JVIFFKV4RjGGWPAXQLvJxrOvV/7ce66mcWPV7RU0BgO&quot;<br />		&quot;eNyVqAECgYEA8Rz5pHVQFo3c3elIOXVgMjaU5ueQg/xc2YLLZ3ezh85mK80Wkv7a&quot;<br />		&quot;s0400nK6T2IRMR4bYAzVpnbSLj/yGypmfAkWinkYA2tKRL9Rao82c3iT8+nHMUID&quot;<br />		&quot;fNWjh4QOBzuXqtrGjeWbpr+NuHcwz+953DXgMSkf7qtcrPgIYft+PhECgYEAy+ic&quot;<br />		&quot;/N5BYsLuEDDXbygqU7VuMxn5GMJnIDZEQxIOsgqQ/787mP5FjgHPx4vbybNG3hCb&quot;<br />		&quot;j2Yip0lcgBNLNrGWekmNAuQZ4QG0CdSYU/HEH5yAVsjlcz5PKUpn/OjNsj69q7aV&quot;<br />		&quot;dhTzk3cBMXlcH/qNz9ut94glCqczMnm+3S4uB+0CgYAr3IuFYVnqYHA3ZkKfQTz4&quot;<br />		&quot;pXk88A8YE4aIgwShk+Ly55cqjKp4nygFykpNplVCL6LU/pcYR/1txNvDUhqm2nW+&quot;<br />		&quot;RqD1G8ZEiPX/v5X9/oN3Sg4QJwz3ZvzfbrXK5zjuE+cpS5cnJQfFs78COZyFlxjh&quot;<br />		&quot;+GMKTmLitgWr6YsM2AVFIQKBgCJWPXlng+M5qBUZ5G1Xeik2eCQqz4OX2P3XpY8V&quot;<br />		&quot;z1uz487tSP/ucZAERhT4PD6u7dQfP9LaBCPferAmj5faN9jH4fMGrkTxoHu3TR91&quot;<br />		&quot;qu0X0ZTLp7fMWlA9s10nZtwJLK9pw6lqxcmjVJQcN6M68f56o8T3LCWrGjf5wGZG&quot;<br />		&quot;jIHRAoGAJf7JhBvPzLhI1YtsDYHRGxPegr7/7R5VOv7IOPn3L/chvMwEn3z/uYmK&quot;<br />		&quot;o/zcKfiShwIeuHjJFDnWiifja9JzgTxruXFC004XzdIGTem2PNaZATrISZopzdt0&quot;<br />		&quot;Xw0cpudACCkO8SQ/84jiN408LuYJi17l1v9NEC3KEifL2ti5y3Y=&quot;<br />		&quot;-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----&quot;;<br /><br />	void*&nbsp;rsa_private_keyblob&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;rsa_private_keyblob_len&nbsp;=&nbsp;0;<br /><br />	b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_RSAprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;PROV_RSA_AES,&nbsp;CRYPT_VERIFYCONTEXT);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		if&nbsp;(GetLastError()&nbsp;==&nbsp;NTE_BAD_KEYSET)<br />		{<br />			b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_RSAprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;PROV_RSA_AES,&nbsp;CRYPT_VERIFYCONTEXT&nbsp;|&nbsp;CRYPT_NEWKEYSET);<br />			if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />			{<br />				i&nbsp;=&nbsp;1;<br />				goto&nbsp;cleanup;<br />			}<br />		}<br />		else<br />		{<br />			i&nbsp;=&nbsp;1;<br />			goto&nbsp;cleanup;<br />		}<br />	}<br /><br />	//&nbsp;Convert&nbsp;RSA&nbsp;PEM&nbsp;private&nbsp;key&nbsp;to&nbsp;DER<br />	DWORD&nbsp;rsa_der_len&nbsp;=&nbsp;2048;<br />	b&nbsp;=&nbsp;CryptStringToBinaryA(rsa_private_pem,&nbsp;0,&nbsp;CRYPT_STRING_BASE64HEADER,&nbsp;rsa_private_der,&nbsp;&amp;rsa_der_len,&nbsp;NULL,&nbsp;NULL);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;convert&nbsp;PEM&nbsp;to&nbsp;DER:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Decode&nbsp;DER&nbsp;to&nbsp;private&nbsp;key&nbsp;blob&nbsp;(1st&nbsp;to&nbsp;grab&nbsp;size&nbsp;of&nbsp;key&nbsp;blob,&nbsp;2nd&nbsp;to&nbsp;actually&nbsp;decode)<br />	b&nbsp;=&nbsp;CryptDecodeObjectEx(X509_ASN_ENCODING,&nbsp;PKCS_RSA_PRIVATE_KEY,&nbsp;rsa_private_der,&nbsp;rsa_der_len,&nbsp;0,&nbsp;NULL,&nbsp;NULL,&nbsp;&amp;rsa_private_keyblob_len);<br /><br />	rsa_private_keyblob&nbsp;=&nbsp;malloc(rsa_private_keyblob_len);<br />	memset(rsa_private_keyblob,&nbsp;0,&nbsp;rsa_private_keyblob_len);<br /><br />	b&nbsp;=&nbsp;CryptDecodeObjectEx(X509_ASN_ENCODING,&nbsp;PKCS_RSA_PRIVATE_KEY,&nbsp;rsa_private_der,&nbsp;rsa_der_len,&nbsp;0,&nbsp;NULL,&nbsp;rsa_private_keyblob,&nbsp;&amp;rsa_private_keyblob_len);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;decode&nbsp;DER&nbsp;to&nbsp;CERT_PUBLIC_KEY_INFO:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Import&nbsp;the&nbsp;key<br />	b&nbsp;=&nbsp;CryptImportKey(h_RSAprovider,&nbsp;rsa_private_keyblob,&nbsp;rsa_private_keyblob_len,&nbsp;0,&nbsp;0,&nbsp;&amp;h_RSAkey);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;import&nbsp;RSA&nbsp;public&nbsp;key:&nbsp;0x%x&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br />	<br />cleanup:<br />	if&nbsp;(h_RSAkey)&nbsp;CryptDestroyKey(h_RSAkey);<br />	if&nbsp;(h_RSAprovider)&nbsp;CryptReleaseContext(h_RSAprovider,&nbsp;0);<br />	if&nbsp;(rsa_private_keyblob)&nbsp;free(rsa_private_keyblob);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
