<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Check privilege</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Check privilege</h1></strong><br />â€¢ <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants</a><br /><br />Source:<br /><a href="https://0x00-0x00.github.io/research/2018/10/17/Windows-API-and-Impersonation-Part1.html#checking-privileges">https://0x00-0x00.github.io/research/2018/10/17/Windows-API-and-Impersonation-Part1.html#checking-privileges</a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />BOOL&nbsp;checkPrivilege(wchar_t&nbsp;privilege[])<br />{<br />	int&nbsp;iRet&nbsp;=&nbsp;0;<br />	BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br /><br />	//&nbsp;get&nbsp;current&nbsp;process&nbsp;token&nbsp;(which&nbsp;we&#39;ll&nbsp;adjust&nbsp;privileges&nbsp;of)<br />	HANDLE&nbsp;hToken;<br />	iRet&nbsp;=&nbsp;OpenProcessToken(GetCurrentProcess(),&nbsp;TOKEN_QUERY,&nbsp;&amp;hToken);<br />	if&nbsp;(iRet&nbsp;==&nbsp;0)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;OpenProcessToken:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;FALSE;<br />	}<br /><br />	//&nbsp;grab&nbsp;LUID&nbsp;of&nbsp;privilege&nbsp;specified&nbsp;in&nbsp;paramter<br />	LUID&nbsp;luid;<br />	iRet&nbsp;=&nbsp;LookupPrivilegeValueW(NULL,&nbsp;privilege,&nbsp;&amp;luid);<br />	if&nbsp;(iRet&nbsp;==&nbsp;0)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;LookupPrivilegeValueW:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		CloseHandle(hToken);<br />		return&nbsp;FALSE;<br />	}<br /><br />	//&nbsp;check&nbsp;the&nbsp;privilege<br />	PRIVILEGE_SET&nbsp;privs;<br />	privs.PrivilegeCount&nbsp;=&nbsp;1;<br />	privs.Control&nbsp;=&nbsp;PRIVILEGE_SET_ALL_NECESSARY;<br />	privs.Privilege[0].Luid&nbsp;=&nbsp;luid;<br />	privs.Privilege[0].Attributes&nbsp;=&nbsp;SE_PRIVILEGE_ENABLED;<br /><br />	BOOL&nbsp;bRet_temp;<br />	bRet_temp&nbsp;=&nbsp;PrivilegeCheck(hToken,&nbsp;&amp;privs,&nbsp;&amp;bRet);<br />	if&nbsp;(bRet_temp&nbsp;==&nbsp;0)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;PrivilegeCheck:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		CloseHandle(hToken);<br />		return&nbsp;FALSE;<br />	}<br /><br />	CloseHandle(hToken);<br /><br />	return&nbsp;bRet;<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;privilege&nbsp;=&nbsp;FALSE;<br />	BOOL&nbsp;privilege2&nbsp;=&nbsp;FALSE;<br />	<br />	privilege&nbsp;=&nbsp;checkPrivilege(L&quot;SeImpersonatePrivilege&quot;);<br />	privilege&nbsp;=&nbsp;checkPrivilege(SE_IMPERSONATE_NAME);<br />	<br />	printf(&quot;%d&nbsp;\n&quot;,&nbsp;privilege);<br />	printf(&quot;%d&nbsp;\n&quot;,&nbsp;privilege2);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
