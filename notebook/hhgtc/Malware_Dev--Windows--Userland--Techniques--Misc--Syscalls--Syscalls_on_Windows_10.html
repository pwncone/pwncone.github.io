<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Syscalls on Windows 10</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Syscalls on Windows 10</h1></strong><br />Syscalls work a little differently on Windows 10.<br />• <a href="https://www.fireeye.com/blog/threat-research/2020/11/wow64-subsystem-internals-and-hooking-techniques.html">https://www.fireeye.com/blog/threat-research/2020/11/wow64-subsystem-internals-and-hooking-techniques.html</a><br />• <a href="https://www.malwaretech.com/2015/07/windows-10-system-call-stub-changes.html">https://www.malwaretech.com/2015/07/windows-10-system-call-stub-changes.html</a><br /><br /><strong><h2>## Windows 10 x86</h2></strong><br />This is <code>NtCreateFile</code> on <code>Windows 10 x86</code>.<br />(credit to MalwareTech for the image)<br /><br />It moves the syscall value for NtCreateFile - <code>16Eh</code> - into eax,<br />and jumps to a stub just below the NtCreateFile function call<br />which executes <code>sysenter</code> to switch to kernel mode.<br /><a href="https://www.malwaretech.com/wp-content/uploads/2015/07/Windows10x86.png"><img src="images/1714-1.png" alt="images/1714-1.png" /></a><br /><br /><strong><h2>## Windows 10 x64</h2></strong><br />This is <code>NtCreateFile</code> on <code>Windows 10 x64 2004 19041.928</code><br /><br />It moves the syscall value for NtCreateFile - <code>55h</code> - into EAX <br />and then executes <code>syscall</code>.<br /><a href=""><img src="images/1714-2.png" alt="images/1714-2.png" /></a><br /><br /><strong><h2>## Windows 10 x64 (WoW64)</h2></strong><h2> </h2><br />This is the <code>32bit NtCreateFile</code> function from a <code>32bit Ntdll.dll</code> on a <code>64bit copy of Windows 10</code>,<br />version <code>Windows 10 x64 2004 19041.928</code>.<br /><br />(credit to MalwareTech for images)<br /><br />It moves the syscall value for NtCreateFile - <code>55h</code> - into eax<br />and calls a pointer to a function - <code>Wow64SystemServiceCall</code><br /><a href="https://www.malwaretech.com/wp-content/uploads/2015/07/Windows10WOW64.png"><img src="images/1714-3.png" alt="images/1714-3.png" /></a><br /><br /><code>Wow64SystemServiceCall</code> checks how it should execute the syscall.<br /><br /><code>test</code> ANDs against a flag in the PEB - offset <code>254h</code> - with <code>2</code><br />If the result is 0 (i.e. the flag isn&#39;t set to <code>2</code>) then it will perform the old syscall method.<br />If the flag is set to <code>2</code>, it will jump and perform the new syscall method with a jump to far ptr.<br /><a href="https://1.bp.blogspot.com/-dSlQxBhtyTA/Va_4KbX_EqI/AAAAAAAABJc/Vm01sx_cBsE/s1600/Wow64SystemServiceCall.png"><img src="images/1714-4.png" alt="images/1714-4.png" /></a><br /></div>
</body>
</html>
