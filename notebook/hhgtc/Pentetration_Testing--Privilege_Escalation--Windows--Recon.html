<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Recon</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Recon</h1></strong><br />This is all manual system recon that you can do in a shell.<br /><br /><strong><h2>## System Info</h2></strong><br />• Grab system info - <code>systeminfo</code><br />   ◇ OS<br />   ◇ Architecture<br />   ◇ etc.<br />• Check for installed hotfixes/updates<br />   ◇ <code>wmic qfe</code><br />• Any exploits?<br />   ◇ Windows XP<br />      ▪ MS11-080<br />   ◇ Windows Server 2003 SP1<br />      ▪ MS09-012<br />   ◇ Windows Server 2008 R2<br />      ▪ MS15-051<br />   ◇ Windows 7 Pro SP1<br />      ▪ MS15-077<br />   ◇ Windows 8.1<br />      ▪ MS16-135<br />• Grab hostname<br />   ◇ <code>echo %logonserver%</code> - show where user authenticates to log in (could be domain controller)<br />   ◇ <code>echo %hostname%</code> - show hostname<br />• Grab IP<br />   ◇ <code>ipconfig</code><br /><br /><strong><h3>### Check that shell matches architecture (PowerShell Only) </h3></strong><br />If your shell is 32bit and you&#39;re on 64bit machine, you&#39;ll want to migrate/send yourself a 64bit shell somehow.<br />You&#39;ll encounter a bunch of errors/false flags/results not showing up if you&#39;re running a 32bit shell on a 64bit machine.<br /><br />Check if 64bit OS<br /><code><span style="color:#0000ff;">[environment]::Is64BitOperatingSystem</span></code><br /><br />Check if your shell is 32bit or 64bit<br /><code><span style="color:#0000ff;">[environment]::Is64BitProcess</span></code><br /><br /><strong><h2>## Current user/you</h2></strong><br />• Who are you?<br />   ◇ <code>whoami</code> or <code>echo %username%</code> or <code>set</code> (and look for username)<br />   ◇ <code>whoami /priv</code><br />   ◇ <code>whoami /all</code> - show groups you&#39;re part of<br />      ▪ SeImpersonatePrivilege enabled? - <a href="Pentetration_Testing--Vulnerabilities--Web--Bypass_IP_Blocking.html">JuicyPotato</a> exploit<br />      ▪ Tokens that can be used to escalate privileges:<br />         - <div class="codebox"><div class="codebox">SeAssignPrimaryPrivilege,&nbsp;SeTcbPrivilege,&nbsp;SeBackupPrivilege,&nbsp;SeRestorePrivilege,&nbsp;SeCreateTokenPrivilege,&nbsp;SeLoadDriverPrivilege,&nbsp;SeTakeOwnershipPrivilege,&nbsp;SeDebugPrivilege</div></div><br />• Are you part of the Administrator group?<br />   ◇ <code>net localgroup Administrator</code><br />• What files have you got?<br />   ◇ Users<br />   ◇ Documents and Settings<br />   ◇ <code>tree /a /f</code><br />• Any private/interesting info in the environment?<br />   ◇ <code>set</code><br />• Anything weird in your PATH?<br />   ◇ <code>echo %path%</code><br />• Anything in the user&#39;s clipboard?<br />   ◇ <code>powershell -command &quot;Get-Clipboard&quot;</code><br />• <a href="Windows--Passwords_&_Hashes--Dumping_&_Cracking--Grab_Protected_Files--Volume_Shadow_Copy.html">PowerShell</a> history?<br />   ◇ <code>type C:\Users\Bob\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</code><br /><br /><strong><h2>## On an RDP Session?</h2></strong><br />• ENABLE HIDDEN FILES<br />• Check the user&#39;s email in outlook<br />• Check for network connected computers<br />• Check bottom right for services/programs<br />• Navigate to cmd → try right click &#39;open as administrator&#39;<br />• Look for RDP connection files<br />• Open all browsers<br />   ◇ what&#39;s their homepage? <br />   ◇ search history?<br /><br /><strong><h2>## Other users</h2></strong><br />See who else interacts with the system, who you might laterally priv-esc to, how the system gets used<br /><br />• Users on the system? Users on the domain?<br />   ◇ <code>net users</code><br />   ◇ <code>net users /domain</code><br />• Can you read their documents?<br />   ◇ <code>tree /a /f C:\Users</code><br />   ◇ <code>tree /a /f &quot;C:\Documents and Settings&quot;</code><br />• Currently logged-in users?<br />   ◇ <code>quser</code><br />   ◇ <code>qwinsta</code><br /><br /><strong><h2>## Groups</h2></strong><br />• Groups on system? Groups on the domain?<br />   ◇ <code>net localgroup</code><br />   ◇ <code>net groups /domain</code><br /><br /><strong><h2>## Dumb checks</h2></strong><br />• Can you access Administrator&#39;s documents?<br />   ◇ <code>dir /a C:\Users\Administrator</code><br />• Can you read the SAM and SYSTEM files or backups<br />   ◇ <code>dir %WINDIR\repair\SAM</code><br />   ◇ <code>dir %WINDIR\repair\SYSTEM</code><br />   ◇ <code>dir %WINDIR%\System32\config\RegBack\SAM</code><br />   ◇ <code>dir %WINDIR%\System32\config\RegBack\SYSTEM</code>   <br />   ◇ <code>dir %WINDIR%\System32\config\SAM</code><br />   ◇ <code>dir %WINDIR%\System32\config\SYSTEM</code><br />• Always install elevated?<br />   ◇ If yes, can install a .msi with admin privileges<br />   ◇ <code>reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</code><br />   ◇ <code>reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</code><br /><br /><strong><h2>## Files</h2></strong><br />• Any weird files/directories in C ?<br />   ◇ <code>dir /a C:\</code><br />• Any shares?f<br />   ◇ <code>net share</code> - check current system share<br />   ◇ <code>net view</code> - check what shares you can view on the network<br /><br /><strong><h2>## Installed Software</h2></strong><br />• <code>dir /b &quot;C:\Program Files&quot; &quot;C:\Program Files (x86)&quot; | sort</code><br />• Any exploits for any of the software?<br /><br /><strong><h2>## Processes</h2></strong><br />• <code>tasklist /sv</code><br /><br /><strong><h2>## Scheduled Tasks</h2></strong><br />• <code>schtasks /query /fo LIST /v</code><br /><br /><strong><h2>## Mounted Disks</h2></strong><br />• What disks are mounted? Have a look at anyting unordinary<br />   ◇ <code>wmic logicaldisk get deviceid, volumename, description</code><br />   ◇ <code>fsutil fsinfo drives</code><br /><br /><strong><h2>## Network Info</h2></strong><br />• Check for local ports<br />   ◇ Anything weird? Anything running on 127.0.0.1 or internl IP (i.e. only on localhost) is interesting<br />   ◇ <code>netstat -ano | findstr /i listen</code><br />• Talking to any other machines?<br />   ◇ <code>arp -a</code><br />• Any intesting custom hosts?<br />   ◇ <code>type C:\WINDOWS\System32\drivers\etc\hosts</code><br />• DNS cache?<br />   ◇ <code>ipconfig /displaydns</code><br />• Network adapters<br />   ◇ <code>ipconfig /all</code><br />• Any wifi profiles?<br />   ◇ <code>netsh wlan show profile</code><br />   ◇ Grab password with <code>netsh wlan show profile &lt;SSID&gt; key=clear</code><br />• Routes<br />   ◇ <code>route print</code><br />• Firewall enabled?<br />   ◇ <code>netsh firewall show state</code><br />   ◇ <code>netsh firewall show config</code><br /><br /><strong><h2>## System Info</h2></strong><br />• Any vulnerable drivers?<br />   ◇ <code>DRIVERQUERY</code><br /><br /><strong><h2>## Stored Credentials</h2></strong><br />• <a href="https://pentestlab.blog/2017/04/19/stored-credentials/">https://pentestlab.blog/2017/04/19/stored-credentials/</a><br /><br /><strong><h3>### Windows vault</h3></strong><br /><code>cmdkey /list</code><br /><br /><strong><h3>### IIS web.config</h3></strong><br /><code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</code><br /><code>C:\inetpub\wwwroot\web.config</code><br /><br /><strong><h3>### Windows AutoLogon</h3></strong><br /><code>reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</code><br /><br /><code>reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot; 2&gt;nul | findstr /i &quot;DefaultDomainName DefaultUserName DefaultPassword AltDefaultDomainName AltDefaultUserName AltDefaultPassword LastUsedUsername&quot;</code><br /><br /><strong><h3>### Group Policy Preferences</h3></strong><br />• Windows 2008 + <br />• User passwords for the domain are stored in Groups.xml<br />• Group Policy file<br />   ◇ <code>cd &quot;%SystemDrive%\Microsoft\Group Policy\history&quot;</code><br />   ◇ <code>dir /s/b Groups.xml == Services.xml == Scheduledtasks.xml == DataSources.xml == Printers.xml == Drives.xml</code><br />• Documents and Settings<br />   ◇ <code>cd &quot;%windir%\..\Documents and Settings\All Users\Application Data\Microsoft\Group Policy\history&quot;</code><br />   ◇ <code>dir /s/b Groups.xml == Services.xml == Scheduledtasks.xml == DataSources.xml == Printers.xml == Drives.xml</code><br /><br /><strong><h3>### Unattend files</h3></strong><br />These are used with Windows Deployment Services to create a Windows image and deploy this across a network. Unattend files store the settings. <br />It&#39;s common to Admin passwords here - either plaintext or base64 encoded<br /><div class="codebox"><div class="codebox">dir&nbsp;%WINDIR%\sysprep\sysprep.xml&nbsp;%WINDIR%\sysprep\sysprep.inf&nbsp;%WINDIR%\sysprep.inf&nbsp;%WINDIR%\Panther\Unattended.xml&nbsp;%WINDIR%\Panther\Unattend.xml&nbsp;%WINDIR%\Panther\Unattend\Unattend.xml&nbsp;%WINDIR%\Panther\Unattend\Unattended.xml&nbsp;%WINDIR%\System32\Sysprep\unattend.xml&nbsp;%WINDIR%\System32\Sysprep\unattended.xml&nbsp;%WINDIR%\..\unattend.txt&nbsp;%WINDIR%\..\unattend.inf</div></div><br /><br />Metasploit - <code>post/windows/gather/enum_unattend</code><br /><br /><strong><h3>### DPAPI Master Keys</h3></strong><br /><code>powershell -command &quot;Get-ChildItem %appdata%\Microsoft\Protect&quot;</code><br /><code>powershell -command &quot;Get-ChildItem %localappdata%\Microsoft\Protect&quot;</code><br /><br />Found master key? <br />Grab passwords from below and decrypt with mimikatz <code>dpapi::cred</code> and master key<br /><code>dir /b/a %appdata%\Microsoft\Credentials\</code><br /><code>dir /b/a %localappdata%\Microsoft\Credentials\</code><br /><br /><strong><h3>### Cloud Credentials</h3></strong><br />Users<br /><code>cd &quot;%SystemDrive%\Users&quot;</code><br /><code>dir /s/b .aws == credentials == gcloud == credentials.db == legacy_credentials == access_tokens.db == .azure == accessTokens.json == azureProfile.json</code><br /><br />Documents and Settings<br /><code>cd &quot;%windir%\..\Documents and Settings&quot;</code><br /><code>dir /s/b .aws == credentials == gcloud == credentials.db == legacy_credentials == access_tokens.db == .azure == accessTokens.json == azureProfile.json</code><br /><br /><strong><h3>### McAfee</h3></strong><br />McAfee password is stored encrypted in here<br /><code>type %AllUsersProfile%Application Data\McAfee\Common Framework\SiteList.xml</code><br /><br /><strong><h3>### VNC</h3></strong><br />RealVNC<br /><code>reg query &quot;HKCU\Software\ORL\WinVNC3\Password&quot;</code><br /><code>reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password</code><br /><br />TightVNC<br /><code>reg query HKCU\Software\TightVNC\Server</code><br /><br /><strong><h3>### Putty</h3></strong><br /><code>reg query&quot; HKCU\Software\SimonTatham\PuTTY\Sessions&quot;</code><br /><br /><strong><h3>### OpenSSH</h3></strong><br /><code>reg query HKCU\Software\OpenSSH\Agent\Keys /s</code><br /><br /><strong><h3>### SNMP</h3></strong><br /><code>reg query &quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;<br /></code><br /><strong><h3>### Search whole system for password string</h3></strong><br /><code>findstr /si password *.txt<br />findstr /si password *.xml<br />findstr /si password *.ini</code><br /><br /><strong><h3>### Search whole registry for password entry</h3></strong><br /><code>reg query HKLM /f password /t REG_SZ /s<br />reg query HKCU /f password /t REG_SZ /s</code><br /><br /><strong><h3>### FileZilla Credentials</h3></strong><br /><code>C:\&gt; type &quot;C:\Program Files (x86)\FileZilla Server\FileZilla Server Interface.xml&quot;</code><br />Passwords are MD5, easy to crack.<br /><br /><strong><h2>## Kerberos</h2></strong><br />• Any tickets?<br />   ◇ <code>klis</code><br /><br /><strong><h2>## Service Permissions</h2></strong><br />• List started services - <code>net start</code><br /><br /><strong><h3>### accesschk.exe</h3></strong><br />If accesschk is available, it&#39;s the easiest way of investigating service permissions.<br />If the user you&#39;re running as has any of the below permissions:<br />   ◇ <code>SERVICE_ALL_ACCESS</code><br />   ◇ <code>SERVICE_CHANGE_CONFIG</code> <br />   ◇ <code>WRITE_DAC</code><br />   ◇ <code>WRITE_OWNER</code><br />   ◇ <code>GENERIC_WRITE</code><br />   ◇ or <code>GENERIC_ALL</code><br />you can modify the binary that is going to be executed by the service and start/stop the service.<br /><code>accesschk.exe -uwcqv &quot;Authenticated Users&quot; * /accepteula</code><br /><br />Search for services with <code>EVERYONE</code> permissions<br /><code>accesschk.exe -uwcqv &quot;Everyone&quot; * /accepteula</code><br /><br />Search for services with <code>BUILTIN\User</code> permissions<br /><code>accesschk.exe -uwcqv &quot;BUILTIN\Users&quot; * /accepteula</code><br /><br />Search for services where you (your username) has permissions<br /><code>accesschk.exe -uwcqv %username% * /accepteula</code><br /><br />Search everything<br /><code>accesschk.exe -uwcqv * /accepteula</code><br /><br /><strong><h3>### wmic &amp; icacls</h3></strong><br />If accesschk.exe isn&#39;t available, you can use <code>wmic</code> and <code>icacls</code>.<br /><br />1. Grab a list of all the services<br /><code>for /f &quot;tokens=2 delims=&#39;=&#39;&quot; %a in (&#39;wmic service list full^|find /i &quot;pathname&quot;^|find /i /v &quot;system32&quot;&#39;) do @echo %a &gt;&gt; c:\windows\temp\permissions.txt</code><br /><br />2. Use icalcs to search permissions<br />icacls for Windows XP:<br /><code>for /f eol^=^&quot;^ delims^=^&quot; %a in (c:\windows\temp\permissions.txt) do cmd.exe /c cacls &quot;%a&quot;</code><br /><br />icacls for Windows Vista + above:<br /><code>for /f eol^=^&quot;^ delims^=^&quot; %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls &quot;%a&quot;</code><br /><br /><strong><h2>## Check for system security features</h2></strong><br /><strong><h3>### UAC</h3></strong><br /><code>0x1</code> means UAC is enabled.<br /><code>REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA</code><br /><br /><strong><h3>### WEF - Windows Event Forwarding</h3></strong><br /><code>REG QUERY HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\EventLog\EventForwarding\SubscriptionManager</code><br /><br /><strong><h3>### LAPS</h3></strong><br />LAPS makes priv-esc/lateral movement more difficult by forcing all local Administrator accounts to have unique, complex passwords<br /><code>REG QUERY &quot;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft Services\AdmPwd&quot; /v AdmPwdEnabled</code><br /><br /><strong><h3>### Credential Guard</h3></strong><br />Prevents retrieval of LSASS creds by running LSASS in a virtualized container not readable by SYSTEM<br /><code>REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA&quot; /v LsaCfgFlags</code><br /><br /><strong><h3>### LSA</h3></strong><br />Prevents mimikatz from reading LSASS creds by blocking acess to a certain space of memory<br /><code>REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA&quot; /v RunAsPPL</code><br /><br />Retrieve LSA creds with mimikatz - <code>sekurlsa::logonPasswords</code><br /><br /><strong><h3>### WDigest</h3></strong><br />WDigest was a protocol designed to be used with HTTP for authentication. <br />It stores plaintext passwords in LSASS memory.<br />Enabled by default on Windows XP &gt; Windows 8 and Windows Server 2003 &gt; Windows Server 2012<br /><br /><code>reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential</code><br /><br />Retrieve WDigest creds with mimikatz - <code>sekurlsa::wdigest</code><br /><br /><strong><h3>### Credential Caching</h3></strong><br />If the domain controller is unavailable, Windows will auth users to the system using cached creds<br /><br /><code>reg query &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v CACHEDLOGONSCOUNT</code><br /><br />Retrieve cached creds with mimikatz - <code>lsadump::cache</code></div>
</body>
</html>
