<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>EB F9</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># x86 Hotpatch Hook - EB F9 to jump 7 bytes back</h1></strong><br />You can use 2 byte EB F9 to overwrite the <code>mov edi, edi</code> hotpatch space.<br />EB F9 will jump 7 bytes back into hotpach space, and in there you can write a jump to your hook.<br /><br /><strong><h2>## MessageBoxA Demo</h2></strong><br />Here&#39;s MessageBoxA before the hook.<br />The function starts at address <code>0x7782ED60</code><br />There&#39;s 5 bytes of hotpatch space before the function,<br />and a 2 byte NOP - mov edi,edi - that we&#39;ll overwrite with EB F9 to jump 7 bytes back <br />into the hotpatch space.<br /><a href=""><img src="images/1679-1.png" alt="images/1679-1.png" /></a><br /><br />Here MessageBoxA has been hooked.<br />I&#39;ve replaced the first 2 bytes with EB F9 to jump 7 bytes back into hotpatch space.<br />In the hotpatch space I&#39;ve written a jump to my detour.<br /><a href=""><img src="images/1679-2.png" alt="images/1679-2.png" /></a><br /><br /><strong><h2>## Code</h2></strong><br />NOTE:<br />No atomic operations here. Not thread safe. Done to keep code simple.<br /><br /><div class="codebox"><div class="codebox">/*<br />x86&nbsp;hotpatch&nbsp;hooking&nbsp;<br />using&nbsp;an&nbsp;EB&nbsp;F9&nbsp;to&nbsp;jump&nbsp;7&nbsp;bytes&nbsp;back.<br />7&nbsp;bytes&nbsp;back,&nbsp;in&nbsp;the&nbsp;hotpatch&nbsp;space,&nbsp;is&nbsp;a&nbsp;jump&nbsp;to&nbsp;our&nbsp;detour.<br />*/<br /><br />#define&nbsp;_CRT_SECURE_NO_WARNING<br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;hook_size&nbsp;=&nbsp;7;<br /><br />int(__stdcall*&nbsp;orig_MessageBoxA)(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType);<br />int&nbsp;__stdcall&nbsp;hook_MessageBoxA(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType)<br />{<br />	printf(&quot;MessageBoxA&nbsp;intercepted!&nbsp;\n&quot;);<br />	printf(&quot;\t&nbsp;text:&nbsp;%s&nbsp;\n\t&nbsp;caption:&nbsp;%s&nbsp;\n\t&nbsp;type:&nbsp;%d&nbsp;\n&quot;,&nbsp;lpText,&nbsp;lpCaption,&nbsp;uType);<br /><br />	return&nbsp;orig_MessageBoxA(hWnd,&nbsp;lpText,&nbsp;lpCaption,&nbsp;uType);<br />}<br /><br />/*<br />Hook&nbsp;a&nbsp;function&nbsp;using&nbsp;hotpatch&nbsp;space.<br />Parameters:<br />	char*&nbsp;function&nbsp;-&nbsp;name&nbsp;of&nbsp;the&nbsp;function&nbsp;to&nbsp;hook<br />	char*&nbsp;dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;name&nbsp;of&nbsp;the&nbsp;DLL&nbsp;where&nbsp;the&nbsp;function&nbsp;resides<br />	void*&nbsp;detour&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;function&nbsp;to&nbsp;detour&nbsp;to<br />	void**&nbsp;p_orig&nbsp;&nbsp;-&nbsp;address&nbsp;of&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;original&nbsp;function<br />*/<br />BOOL&nbsp;HotpatchHook32(char*&nbsp;function,&nbsp;char*&nbsp;dll,&nbsp;void*&nbsp;detour,&nbsp;void**&nbsp;p_orig)<br />{<br />	BOOL&nbsp;ok&nbsp;=&nbsp;TRUE;<br /><br />	//&nbsp;Grab&nbsp;address&nbsp;of&nbsp;target&nbsp;function&nbsp;and&nbsp;allocate&nbsp;trampoline&nbsp;space<br />	void*&nbsp;orig_func&nbsp;=&nbsp;GetProcAddress(LoadLibraryA(dll),&nbsp;function);<br /><br />	/*<br />	Calculate&nbsp;E9&nbsp;relative&nbsp;jump&nbsp;to&nbsp;hook.<br />	Formula&nbsp;is:&nbsp;(target&nbsp;-&nbsp;current_addr)<br />	*/<br />	DWORD&nbsp;jmp_hook&nbsp;=&nbsp;(DWORD)detour&nbsp;-&nbsp;(DWORD)orig_func;<br /><br />	//&nbsp;Install&nbsp;hook&nbsp;at&nbsp;function<br />	DWORD&nbsp;old_protect&nbsp;=&nbsp;0;<br />	void*&nbsp;patch_addr&nbsp;=&nbsp;(void*)((DWORD)orig_func&nbsp;-&nbsp;5);<br />	VirtualProtect(patch_addr,&nbsp;hook_size,&nbsp;PAGE_READWRITE,&nbsp;&amp;old_protect);<br /><br />	memcpy((BYTE*)orig_func&nbsp;-&nbsp;5,&nbsp;&quot;\xE9&quot;,&nbsp;1);<br />	memcpy((BYTE*)orig_func&nbsp;-&nbsp;4,&nbsp;&amp;jmp_hook,&nbsp;4);<br />	memcpy(orig_func,&nbsp;&quot;\xEB\xF9&quot;,&nbsp;2);<br /><br />	VirtualProtect(patch_addr,&nbsp;hook_size,&nbsp;old_protect,&nbsp;&amp;old_protect);<br /><br />	/*<br />	Set&nbsp;pointer&nbsp;to&nbsp;original&nbsp;function&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;function&nbsp;+&nbsp;2.<br />	This&nbsp;dodges&nbsp;the&nbsp;EB&nbsp;F9&nbsp;which&nbsp;jumps&nbsp;into&nbsp;hotpatch&nbsp;space<br />	and&nbsp;executes&nbsp;the&nbsp;original&nbsp;function.<br />	*/<br />	*p_orig&nbsp;=&nbsp;(void*)((DWORD)orig_func&nbsp;+&nbsp;2);<br /><br />	FlushInstructionCache(GetCurrentProcess(),&nbsp;patch_addr,&nbsp;hook_size);<br />	return&nbsp;ok;<br />}<br /><br />/*<br />Unhook&nbsp;a&nbsp;function&nbsp;installed&nbsp;in&nbsp;hotpatch&nbsp;space.<br />Parameters:<br />	char*&nbsp;function&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;name&nbsp;of&nbsp;the&nbsp;function&nbsp;to&nbsp;unhook<br />	char*&nbsp;dll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;name&nbsp;of&nbsp;the&nbsp;DLL&nbsp;where&nbsp;the&nbsp;function&nbsp;resides<br />	void*&nbsp;trampoline&nbsp;&nbsp;-&nbsp;pointer&nbsp;to&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;trampoline&nbsp;space<br />*/<br />BOOL&nbsp;HotpatchUnhook32(char*&nbsp;function,&nbsp;char*&nbsp;dll)<br />{<br />	BOOL&nbsp;ok&nbsp;=&nbsp;FALSE;<br />	DWORD&nbsp;old_protect&nbsp;=&nbsp;0;<br /><br />	/*<br />	Grab&nbsp;address&nbsp;of&nbsp;original&nbsp;function,<br />	make&nbsp;it&nbsp;writable,<br />	set&nbsp;the&nbsp;hotpatch&nbsp;space&nbsp;back&nbsp;to&nbsp;NOPs&nbsp;and&nbsp;restore&nbsp;the&nbsp;`mov&nbsp;edi,&nbsp;edi`.<br />	*/<br />	void*&nbsp;orig_func&nbsp;=&nbsp;GetProcAddress(LoadLibraryA(dll),&nbsp;function);<br />	VirtualProtect(orig_func,&nbsp;hook_size,&nbsp;PAGE_READWRITE,&nbsp;&amp;old_protect);<br />	memcpy((BYTE*)orig_func&nbsp;-&nbsp;5,&nbsp;&quot;\xCC\xCC\xCC\xCC\xCC\x8B\xFF&quot;,&nbsp;7);<br />	VirtualProtect(orig_func,&nbsp;hook_size,&nbsp;old_protect,&nbsp;&amp;old_protect);<br /><br />	FlushInstructionCache(GetCurrentProcess(),&nbsp;orig_func,&nbsp;hook_size);<br /><br />	return&nbsp;ok;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	MessageBoxA(NULL,&nbsp;&quot;I&nbsp;think&nbsp;I&nbsp;should&nbsp;greet&nbsp;myself&quot;,&nbsp;&quot;Hmm...&quot;,&nbsp;MB_OK);<br /><br />	HotpatchHook32(&quot;MessageBoxA&quot;,&nbsp;&quot;User32.dll&quot;,&nbsp;&amp;hook_MessageBoxA,&nbsp;(void*)&amp;orig_MessageBoxA);<br />	MessageBoxA(NULL,&nbsp;&quot;Hello&quot;,&nbsp;&quot;Hi&nbsp;#1&quot;,&nbsp;MB_OK);<br />	MessageBoxA(NULL,&nbsp;&quot;Hello&nbsp;good&nbsp;sir!&quot;,&nbsp;&quot;Hi&nbsp;#2&quot;,&nbsp;MB_OK);<br /><br />	HotpatchUnhook32(&quot;MessageBoxA&quot;,&nbsp;&quot;User32.dll&quot;);<br />	MessageBoxA(NULL,&nbsp;&quot;Did&nbsp;he&nbsp;hear&nbsp;me&nbsp;ok?&quot;,&nbsp;&quot;Hmm...&quot;,&nbsp;MB_OK);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
