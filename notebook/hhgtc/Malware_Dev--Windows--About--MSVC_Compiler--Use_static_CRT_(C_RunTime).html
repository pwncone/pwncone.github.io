<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Use static CRT (C RunTime)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Use Custom &amp; Static CRT - msvcrt.dll</h1></strong><br />The CRT library - the C runtime library - implements the core functionality of the C programming language.<br /><br />The Visual Studio compiler flags <code>/MT</code> and <code>/MTd</code> statically link the CRT library into your finished binary.<br />If not statically linked, your binary will dynamically link against the Visual C++ runtime library that came with your Visual Studio install at runtime. This is ok for you, and your program will run, but it will render your executable non-portable as other systems (most likely) won&#39;t have this library installed and the binary will fail to run.<br /><br />When Visual Studio statically links the <code>*crt.lib</code> libraries against your binary it dramatically increases the size.<br />Malware needs to be small and portable.<br /><code>msvcrt.dll</code> is a copy of the C runtime library that exists on every Windows system since 95.<br />For programs using the CRT, you can drastically decrease the size of your binary by creating a custom version of the <code>msvcrt.dll</code> which contains just the function exports. This kills a lot of functionality in the CRT (security checks, CRT initialisation, etc.) but you can use its exported functions (printf, memcpy, etc.)<br /><br />Technique (All credit goes here)<br />• <a href="https://0xpat.github.io/Malware_development_part_4/#c-runtime-library-mt">https://0xpat.github.io/Malware_development_part_4/#c-runtime-library-mt</a><br />• <a href="https://stackoverflow.com/questions/437685/reduce-windows-executable-size/39737730#39737730">https://stackoverflow.com/questions/437685/reduce-windows-executable-size/39737730#39737730</a><br />• <a href="https://www.solomonsklash.io/smaller-c-payloads-on-windows.html">https://www.solomonsklash.io/smaller-c-payloads-on-windows.html</a><br />   ◇ <a href="https://gist.github.com/SolomonSklash/fc02b48a7a70ecb1508977a8e41d43e5">https://gist.github.com/SolomonSklash/fc02b48a7a70ecb1508977a8e41d43e5</a><br /><br /><strong><h2>## Create custom msvcrt.dll</h2></strong><br /><a href="https://gist.github.com/SolomonSklash/fc02b48a7a70ecb1508977a8e41d43e5">https://gist.github.com/SolomonSklash/fc02b48a7a70ecb1508977a8e41d43e5</a> &lt;-- All credit here!<br /><br />To create an x64 version, use <code>C:\Windows\System32\msvcrt.dll</code> from a 64bit Windows install<br />For x86, use <code>C:\Windows\SysWOW64\msvcrt.dll</code> from a 64bit Windows install<br /><br /><div class="codebox"><div class="codebox">#&nbsp;On&nbsp;Windows,&nbsp;within&nbsp;a&nbsp;VS&nbsp;developer&nbsp;prompt<br />#&nbsp;-----------------------------------------------<br />#&nbsp;Dump&nbsp;the&nbsp;exports&nbsp;of&nbsp;msvcrt.dll&nbsp;<br />dumpbin.exe&nbsp;/exports&nbsp;C:\Windows\System32\msvcrt.dll&nbsp;&gt;&nbsp;msvcrt.txt<br /><br />#&nbsp;Linux&nbsp;(copy&nbsp;msvcrt.txt&nbsp;to&nbsp;a&nbsp;Linux&nbsp;box)<br />#&nbsp;-----------------------------------------------<br />#&nbsp;Convert&nbsp;the&nbsp;file&nbsp;to&nbsp;Unix&nbsp;line&nbsp;endings<br />dos2unix&nbsp;msvcrt.txt<br /><br />#&nbsp;Remove&nbsp;the&nbsp;header&nbsp;from&nbsp;dumpbin<br />sed&nbsp;-i&nbsp;&#39;1,19d&#39;&nbsp;msvcrt.txt<br /><br />#&nbsp;Create&nbsp;msvcrt.def&nbsp;file&nbsp;and&nbsp;add&nbsp;the&nbsp;required&nbsp;&quot;EXPORTS&quot;&nbsp;line&nbsp;to&nbsp;the&nbsp;beginning<br />echo&nbsp;&quot;EXPORTS&quot;&nbsp;&gt;&nbsp;msvcrt.def<br /><br />#&nbsp;Get&nbsp;the&nbsp;list&nbsp;of&nbsp;functions&nbsp;and&nbsp;remove&nbsp;everything&nbsp;else,&nbsp;redirecting&nbsp;it&nbsp;to&nbsp;the&nbsp;.def&nbsp;file<br />awk&nbsp;&#39;{print&nbsp;$4}&#39;&nbsp;msvcrt.txt&nbsp;|&nbsp;sed&nbsp;&#39;/^[[:space:]]*$/d&#39;&nbsp;&gt;&gt;&nbsp;msvcrt.def<br /><br />#&nbsp;Windows&nbsp;(copy&nbsp;msvcrt.def&nbsp;to&nbsp;Windows&nbsp;in&nbsp;a&nbsp;developer&nbsp;prompt)<br />#&nbsp;-----------------------------------------------<br />#&nbsp;Create&nbsp;a&nbsp;.lib&nbsp;file&nbsp;from&nbsp;the&nbsp;.def&nbsp;file<br />lib.exe&nbsp;/def:msvcrt.def&nbsp;/out:msvcrt.lib&nbsp;/machine:x64		#&nbsp;x64<br />lib.exe&nbsp;/def:msvcrt.def&nbsp;/out:msvcrt.lib&nbsp;/machine:x86		#&nbsp;x86&nbsp;<span style="color:#000000;font-weight:400">(</span>might&nbsp;get&nbsp;errors<span style="color:#000000;font-weight:400">)</span></div></div><br /><br /><strong><h2>## Visual Studio Options</h2></strong><br />• Linker settings:<br />   ◇ Advanced -&gt; Entrypoint -&gt; something other than main/wmain/WinMain etc. (I&#39;m using <code>tinymain()</code>)<br />   ◇ Input -&gt; Ignore All Default Libraries -&gt; YES<br />   ◇ Input -&gt; Additional Dependencies -&gt; add the custom msvcrt.lib path,<br />• Compiler settings:<br />   ◇ Code Generation -&gt; Runtime Library -&gt; /MT<br />   ◇ Code Generation -&gt; /GS- (off)<br />   ◇ Advanced -&gt; Compile As -&gt; /TC (only if you’re using C and not C++)<br />   ◇ All Options -&gt; Basic Runtime Checks -&gt; Default<br /><br />Alternatively use the command line:<br /><code>cl.exe /MT /GS- /Tc myfile.c /link C:\path\to\msvcrt.lib &quot;kernel32.lib&quot; &quot;ntdll.lib&quot; /ENTRY:&quot;YourEntrypointFunction&quot; /NODEFAULTLIB</code><br /><br /><strong><h2>## Demo</h2></strong><br /><div class="codebox"><div class="codebox">#define&nbsp;_NO_CRT_STDIO_INLINE<br />#include&nbsp;&lt;stdio.h&gt;<br /><br />int&nbsp;tinymain(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	printf(&quot;Hello&nbsp;compiler&nbsp;options&nbsp;:)&nbsp;\n&quot;);<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />Compiling as Release x64.<br /><a href=""><img src="images/1550-1.png" alt="images/1550-1.png" /></a><br /><br />My file size is 4kb (compared to the 8/9kb it normally is)<br /><a href=""><img src="images/1550-2.png" alt="images/1550-2.png" /></a><br /><br />It runs.<br /><a href=""><img src="images/1550-3.png" alt="images/1550-3.png" /></a><br /><br />And the only function we&#39;ve imported is <code>printf</code>. No extra CRT functions are present.<br /><a href=""><img src="images/1550-4.png" alt="images/1550-4.png" /></a><br /><br /><strong><h2>## Problems</h2></strong><br />The standard CRT implements a lot of stuff (security checks, CRT initialisation before main(), etc.)<br />By using a custom CRT, you remove a lot of features (but can use its exported functions).<br /><br /><code>main</code> or <code>WinMain</code> entrypoints are used by the CRT.<br />Without the full CRT included, you can&#39;t use these function names as entry points.<br /><br />The CRT performs buffer overflow checks (amongst others).<br />Therefore, you need to disable Security Checks in the compiler options - <code>/GS-</code><br /><br />The CRT handles command line arguments (argc, argv, etc.)<br />To use command line arguments with the custom CRT, use <code>CommandLineToArgv</code><br /></div>
</body>
</html>
