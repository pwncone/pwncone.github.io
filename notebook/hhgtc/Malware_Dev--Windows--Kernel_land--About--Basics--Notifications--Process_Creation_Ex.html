<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Process Creation Ex</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Process Creation Ex</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutineex">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutineex</a><br />• <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_process_notify_routine_ex">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_process_notify_routine_ex</a><br /><br /><code>PsSetCreateProcessNotifyRoutineEx</code> notifies the driver about new &amp; terminated processes AND allows you to kill them before they can run.<br /><br />When loading the driver, you might get <code>Access Denied</code>.<br />To get <code>ProcessNotifyRoutineEx</code> to work, set the <code>/integritycheck</code> switch when you compile.<br /><a href=""><img src="images/1809-1.png" alt="images/1809-1.png" /></a><br /><br />A debuggee machine is running our driver.<br />A debugger machine is running WinDbg and is connected to the debuggee machine.<br /><br />On the debuggee machine I <code>Register Service</code> and <code>Start Service</code>.<br />Our driver is now running.<br /><a href=""><img src="images/1809-2.png" alt="images/1809-2.png" /></a><br /><br />On the debuggee machine, I run <code>notepad.exe</code> and it opens fine.<br /><a href=""><img src="images/1809-3.png" alt="images/1809-3.png" /></a><br /><br />Back on the debugger machine, we see that <code>explorer.exe</code> has created <code>notepad.exe</code><br /><a href=""><img src="images/1809-4.png" alt="images/1809-4.png" /></a><br /><br />Back on the debuggee machine, I run <code>Calculator</code><br /><a href=""><img src="images/1809-5.png" alt="images/1809-5.png" /></a><br /><br />It doesn&#39;t open at all.<br />On the debugging machine, we see that <code>svchost.exe</code> created <code>Calculator.exe</code>, and a denied message. We prevented the program from opening by setting the <code>CreationStatus</code> to <code>STATUS_ACCESS_DENIED</code>.<br /><a href=""><img src="images/1809-6.png" alt="images/1809-6.png" /></a><br /><br /><a href=""><img src="images/1809-7.png" alt="images/1809-7.png" /></a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />#define&nbsp;PREVENT_PROCESS&nbsp;L&quot;Calculator&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;works&nbsp;better&nbsp;with&nbsp;notepad<br /><br />/*<br />Routine&nbsp;that&nbsp;runs&nbsp;on&nbsp;process&nbsp;creation.<br />*/<br />void&nbsp;notify_CreateProcessEx(PEPROCESS&nbsp;process_info,&nbsp;HANDLE&nbsp;process_id,&nbsp;PPS_CREATE_NOTIFY_INFO&nbsp;creation_info)<br />{<br />	UNREFERENCED_PARAMETER(process_info);<br />	<br />	if&nbsp;(creation_info&nbsp;!=&nbsp;NULL)<br />	{		<br />		//&nbsp;grab&nbsp;parent&nbsp;info<br />		HANDLE&nbsp;parent_id&nbsp;=&nbsp;creation_info-&gt;CreatingThreadId.UniqueProcess;<br />		PEPROCESS&nbsp;parent_info&nbsp;=&nbsp;NULL;<br />		PUNICODE_STRING&nbsp;parent_name&nbsp;=&nbsp;NULL;<br />		<br />		PsLookupProcessByProcessId(parent_id,&nbsp;&amp;parent_info);<br />		SeLocateProcessImageName(parent_info,&nbsp;&amp;parent_name);<br />		<br />		//&nbsp;grab&nbsp;new&nbsp;process&nbsp;info<br />		PWCH&nbsp;process_name&nbsp;=&nbsp;creation_info-&gt;CommandLine-&gt;Buffer;<br /><br />		DbgPrint(&quot;[+]&nbsp;parent&nbsp;%d&nbsp;\n\t%wZ&nbsp;\n\tcreated&nbsp;child&nbsp;%d&nbsp;\n\t%ws&nbsp;\n&quot;,&nbsp;parent_id,&nbsp;parent_name,&nbsp;process_id,&nbsp;process_name);<br /><br />		//&nbsp;prevent&nbsp;process&nbsp;from&nbsp;running<br />		if&nbsp;(wcsstr(process_name,&nbsp;PREVENT_PROCESS)&nbsp;!=&nbsp;NULL)<br />		{<br />			creation_info-&gt;CreationStatus&nbsp;=&nbsp;STATUS_ACCESS_DENIED;<br />			DbgPrint(&quot;\t\t&nbsp;denied&nbsp;:)&nbsp;\n&quot;);<br />		}<br /><br />	}<br />	else&nbsp;if&nbsp;(creation_info&nbsp;==&nbsp;NULL)<br />	{<br />		DbgPrint(&quot;[-]&nbsp;process&nbsp;%d&nbsp;exited&nbsp;\n&quot;,&nbsp;process_id);<br />	}<br /><br />	return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />	UNREFERENCED_PARAMETER(DriverObject);<br /><br />	//&nbsp;remove&nbsp;set&nbsp;notifications<br />	PsSetCreateProcessNotifyRoutineEx(notify_CreateProcessEx,&nbsp;TRUE);<br /><br />	DbgPrint(&quot;[*]&nbsp;driver&nbsp;unloaded&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />	UNREFERENCED_PARAMETER(DriverObject);<br />	UNREFERENCED_PARAMETER(RegistryPath);<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />	DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />	//&nbsp;start<br />	DbgPrint(&quot;[*]&nbsp;driver&nbsp;loaded&nbsp;\n&quot;);<br /><br />	//&nbsp;notifications<br />	nt_status&nbsp;=&nbsp;PsSetCreateProcessNotifyRoutineEx(notify_CreateProcessEx,&nbsp;FALSE);<br /><br />	return&nbsp;nt_status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /></div>
</body>
</html>
