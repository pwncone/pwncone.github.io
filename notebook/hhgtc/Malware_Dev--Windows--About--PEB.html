<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PEB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># PEB - Process Environment Block</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a><br />• <a href="https://en.wikipedia.org/wiki/Process_Environment_Block">https://en.wikipedia.org/wiki/Process_Environment_Block</a><br />• <a href="https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/index.htm">https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/index.htm</a><br /><br />The PEB - Process Environment Block - is an internal Windows data structure that contains information about a running process.<br />Most of the struct is undocumented.<br />It&#39;s typically only supposed to be used internally by the operating system.<br /><br />If a process is running in userland, it has a PEB.<br />The PEB contains the lowest-level amount of information about a running process in userland.<br />For example:<br />• its <code>ImageBaseAddress</code><br />• whether it&#39;s being debugged<br />• its <code>ImageSubsystem</code> (console or GUI)<br />• the process&#39;s loaded DLLs - the <code>InMemoryOrderModuleList</code><br />• etc.<br /><br /><strong><h2>## Where is it</h2></strong><br />In 32bit code, the PEB can be found in the <code>FS</code> register at offset <code>0x30</code><br /><code>fs:[0x30]</code><br /><br />In 64bit code, the PEB can be found in the <code>GS</code> register at offset <code>0x60</code><br /><code>gs:[0x60]</code><br /><br />The FS/GS registers store the TEB - Thread Environment Block.<br />The TEB has contains a pointer to the PEB called <code>ProcessEnvironmentBlock</code>.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a><br />In a 32bit TEB, this is at offset <code>0x30</code><br />In a 64bit TEB, this is at offset <code>0x60</code><br /><br /><strong><h2>## What it looks like</h2></strong><br />• MSDN&#39;s documented version:<br />   ◇ <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a><br />• x64dbg&#39;s <code>ntdll.h</code><br />   ◇ This is a pretty good up-to-date documentation.<br />   ◇ <a href="https://github.com/x64dbg/x64dbg/blob/84c50b1fe939570f5f91342a940c7ddedb2a8263/src/dbg/ntdll/ntdll.h#L2540">https://github.com/x64dbg/x64dbg/blob/84c50b1fe939570f5f91342a940c7ddedb2a8263/src/dbg/ntdll/ntdll.h#L2540</a><br />• Geoff Chappel<br />   ◇ This is a good explanation of the PEB and its undocumented members<br />   ◇ <a href="https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/index.htm">https://www.geoffchappell.com/studies/windows/win32/ntdll/structs/peb/index.htm</a><br /><br />You can also see what the PEB looks like in WinDbg with:<br /><code>dt _peb</code><br /><a href=""><img src="images/1537-1.png" alt="images/1537-1.png" /></a><br /><br />or <code>!peb</code><br /><a href=""><img src="images/1537-2.png" alt="images/1537-2.png" /></a><br /><br /><strong><h2>## More information</h2></strong><br /><strong><h3>### Grab the ImageBaseAddress at Reserved3[1]</h3></strong><br />As of Windows 10 x64 (2004 19041.867),<br />you can grab the <code>ImageBaseAddress</code> at <code>peb-&gt;Reserved3[1]</code>.<br /><br />Means you don&#39;t have include undocumented structures in your code<br />or do arithmetic. Can just use <code>&lt;winternl.h&gt;</code><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br />#ifdef&nbsp;_WIN64<br />	p_peb&nbsp;=&nbsp;(PPEB)__readgsqword(0x60);<br />#else<br />	p_peb&nbsp;=&nbsp;(PPEB)__readfsdword(0x30);<br />#endif<br /><br />	void*&nbsp;pe_base&nbsp;=&nbsp;p_peb-&gt;Reserved3[1];<br />	printf(&quot;pe_base:&nbsp;0x%p&nbsp;\n&quot;,&nbsp;pe_base);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
