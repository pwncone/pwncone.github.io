<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Change file hash</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Change File Hash</h1></strong><br />Malware samples are typically identified by hash.<br />To change the file hash, you just need to change one byte in the file.<br /><br /><strong><h2>## GetTickCount</h2></strong><br />Declare a global var and seed it with <code>GetTickCount</code>.<br />Used by Zues banking malware from September 2007:<br /><a href="https://youtu.be/OeG4KBWB-EY?t=65">https://youtu.be/OeG4KBWB-EY?t=65</a><br /><br /><div class="codebox"><div class="codebox">int&nbsp;hash_me_if_you_can&nbsp;=&nbsp;12;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	hash_me_if_you_can&nbsp;=&nbsp;GetTickCount();<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />DOES THIS ACTUALLY WORK?<br />I don&#39;t think so. That doesn&#39;t make sense. That value will only change at runtime?<br />Would only change the hash of the dumped PE, not the PE on disk.<br />Maybe I&#39;m just misunderstanding.<br /><br /><strong><h2>## Add 00 Byte</h2></strong><br />As a psuedo-polymorphic solution, you could change the file hash of your file on startup by adding a <code>00</code> byte to the end of the file and writing it out to disk. This arguably pointless imo, it doesn&#39;t achieve much if anything.<br /><br />All credit goes here:<br />â€¢ <a href="https://0xpat.github.io/Malware_development_part_4/#changing-file-hash">https://0xpat.github.io/Malware_development_part_4/#changing-file-hash</a> <br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;Shlwapi.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Shlwapi.lib&quot;)<br /><br />//&nbsp;https://codereview.stackexchange.com/questions/29198/random-string-generator-in-c<br />void&nbsp;GenerateRandomString(char*&nbsp;str,&nbsp;int&nbsp;size)<br />{<br />	int&nbsp;i&nbsp;=&nbsp;0;<br />	int&nbsp;key&nbsp;=&nbsp;0;<br />	const&nbsp;char&nbsp;charset[]&nbsp;=&nbsp;&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&quot;;<br />	if&nbsp;(size)<br />	{<br />		--size;<br />		for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;size;&nbsp;i++)&nbsp;<br />		{<br />			key&nbsp;=&nbsp;rand()&nbsp;%&nbsp;(int)(sizeof&nbsp;charset&nbsp;-&nbsp;1);<br />			str[i]&nbsp;=&nbsp;charset[key];<br />		}<br />		str[size]&nbsp;=&nbsp;&#39;\0&#39;;<br />	}<br />	<br />	return;<br />}<br /><br />/*<br />Generates&nbsp;a&nbsp;random&nbsp;filename&nbsp;and&nbsp;writes&nbsp;a&nbsp;new&nbsp;.exe&nbsp;to&nbsp;disk.<br />Changes&nbsp;the&nbsp;file&nbsp;hash&nbsp;by&nbsp;adding&nbsp;a&nbsp;00&nbsp;byte&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.<br />*/<br />BOOL&nbsp;RandomFilenameAndChangeHash(void)<br />{<br />	BOOL&nbsp;ok&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />	char&nbsp;existing_ExePath[MAX_PATH]&nbsp;=&nbsp;{&nbsp;0&nbsp;};		//&nbsp;will&nbsp;be&nbsp;left&nbsp;as-is<br />	char&nbsp;old_ExePath[MAX_PATH]&nbsp;=&nbsp;{&nbsp;0&nbsp;};				//&nbsp;will&nbsp;have&nbsp;&#39;filename.exe&#39;&nbsp;removed&nbsp;from&nbsp;it<br />	char&nbsp;new_ExePath[MAX_PATH]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	char&nbsp;new_ExeName[8]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	HANDLE&nbsp;h_file&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;Grab&nbsp;current&nbsp;.exe&nbsp;path&nbsp;and&nbsp;remove&nbsp;&#39;\filename.exe&#39;<br />	GetModuleFileNameA(NULL,&nbsp;existing_ExePath,&nbsp;MAX_PATH);<br />	GetModuleFileNameA(NULL,&nbsp;old_ExePath,&nbsp;MAX_PATH);<br />	PathRemoveFileSpecA(old_ExePath);<br /><br />	//&nbsp;Generate&nbsp;new&nbsp;name&nbsp;for&nbsp;.exe&nbsp;and&nbsp;append&nbsp;strings&nbsp;to&nbsp;create&nbsp;path<br />	GenerateRandomString(new_ExeName,&nbsp;sizeof(new_ExeName));<br />	sprintf_s(new_ExePath,&nbsp;MAX_PATH,&nbsp;&quot;%s\\%s.exe&quot;,&nbsp;old_ExePath,&nbsp;new_ExeName);<br /><br />	//&nbsp;Create&nbsp;new&nbsp;.exe&nbsp;file<br />	b_ret&nbsp;=&nbsp;CopyFileA(existing_ExePath,&nbsp;new_ExePath,&nbsp;FALSE);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;[-]&nbsp;failed&nbsp;to&nbsp;copy&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Open&nbsp;file&nbsp;and&nbsp;add&nbsp;00&nbsp;byte&nbsp;to&nbsp;end&nbsp;of&nbsp;file&nbsp;to&nbsp;modify&nbsp;the&nbsp;file&nbsp;hash<br />	h_file&nbsp;=&nbsp;CreateFileA(new_ExePath,&nbsp;FILE_APPEND_DATA,&nbsp;FILE_SHARE_READ,&nbsp;NULL,&nbsp;OPEN_EXISTING,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />	if&nbsp;(h_file&nbsp;==&nbsp;INVALID_HANDLE_VALUE)<br />	{<br />		printf(&quot;[-]&nbsp;failed&nbsp;to&nbsp;create&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	SetFilePointer(h_file,&nbsp;0,&nbsp;NULL,&nbsp;FILE_END);<br />	b_ret&nbsp;=&nbsp;WriteFile(h_file,&nbsp;&quot;\x00&quot;,&nbsp;1,&nbsp;NULL,&nbsp;NULL);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;[-]&nbsp;failed&nbsp;to&nbsp;write&nbsp;00&nbsp;byte&nbsp;to&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		ok&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Modify&nbsp;persistence&nbsp;mechanisms&nbsp;to&nbsp;start&nbsp;new&nbsp;file<br /><br />	//&nbsp;Delete&nbsp;the&nbsp;old&nbsp;file&nbsp;(not&nbsp;possible&nbsp;because&nbsp;this&nbsp;.exe&nbsp;is&nbsp;currently&nbsp;running)<br />	b_ret&nbsp;=&nbsp;DeleteFileA(existing_ExePath);<br /><br />cleanup:<br />	if&nbsp;(h_file)&nbsp;CloseHandle(h_file);<br /><br />	return&nbsp;ok;<br />}<br /><br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	srand(GetTickCount());<br />	RandomFilenameAndChangeHash();<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
