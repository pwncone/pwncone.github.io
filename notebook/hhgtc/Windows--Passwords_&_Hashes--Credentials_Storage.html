<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Credentials Storage</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Credentials Storage</h1></strong><br />There are multiple places you can find passwords and/or password hashes on Windows.<br /><br /><strong><h2>## SAM - Security Account Manager</h2></strong><br /><a href="https://en.wikipedia.org/wiki/Security_Account_Manager">https://en.wikipedia.org/wiki/Security_Account_Manager</a><br />The Security Account Manager (SAM) is a database file that stores users&#39; passwords. <br />It&#39;s located here:<br /><code>C:\Windows\system32\config\SAM</code><br /><br />The user passwords are stored in a hashed format in a registry hive at:<br /><code>HKLM\SAM</code><br /><br /><strong><h3>### Protections</h3></strong><br /><strong>1. It&#39;s locked/protected</strong><br />The Windows kernel keeps a lock on the SAM database, which means that it can&#39;t be accessed while the system is running.<br />But there are several ways you can dump it :)<br /><br /><strong>2. Encrypted</strong><br />In an attempt to prevent offline cracking, the on-disk copy of the SAM file is encrypted with a SYSKEY<br /><br />To decrypt the SAM file, you can grab the SYSKEY from:<br /><code>C:\Windows\system32\config\SYSTEM</code><br />Which can be found in a registry hive at:<br /><code>HKLM\SYSTEM</code><br /><br /><strong><h3>### Dumping</h3></strong><br />Involves grabbing SAM and SYSTEM in some way or other, then cracking.<br /><br /><strong><h2>## LSASS</h2></strong><br />LSA is the <em>Local Security Authority</em>.<br />LSASS is the <em>Local Security Authority Subsystem Service</em>.<br />LSASS is a running executable on the system.<br /><br />LSASS:<br />• enforces local security policies,<br />• validates users for local and remote sign-ins<br />• handles password changes<br />• creates access tokens<br />• writes to the Windows Security Log<br /><br /><code>lsass.exe</code> is located in <code>C:\Windows\System32\lsass.exe</code><br /><br /><strong><h3>### Dumping</h3></strong><br />Because LSASS is used to validate local and remote users, LSASS memory contains cleartext user passwords and hashes.<br />LSASS memory can be dumped (by Mimikatz, mainly) to grab passwords &amp; hashes.<br />From Windows 8.1 and Server 2012 R2 onwards, you won&#39;t find passwords in cleartext anymore.<br /><br /><strong><h3>### LSA Protection</h3></strong><br />Windows 8.1 and Windows Server 2012 R2 introducted LSA Protection.<br />This involves enabling LSASS as a protected process, which means non-protected processes can&#39;t interact with LSASS.<br /><br />This prevents reading memory and code injection by non-protected processes.<br /><br />How to enable LSA Protection here:<br /><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn408187(v=ws.11)?redirectedfrom=MSDN#on-x86-based-or-x64-based-devices-using-secure-boot-and-uefi-or-not">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn408187(v=ws.11)?redirectedfrom=MSDN#on-x86-based-or-x64-based-devices-using-secure-boot-and-uefi-or-not</a><br /><br /><strong><h2>## Active Directory - NTDS.dit</h2></strong><br /><code>NTDS.dit</code> will only be found on Domain Controllers.<br />• It&#39;s the main Active Directory database file. <br />• It stores everything held in Active Directory - group policies, users, password hashes etc.<br />• It&#39;s basically the heart of Active Directory<br /><br />NTDS.dit is located at:<br /><code>C:\Windows\System32\NTDS\ntds.dit</code><br /><br /><code>NTDS.dit</code> is a protected file (constantly in use by the operating system) and therefore cannot be copied.<br /><br /><strong><h3>### NTDS.dit Internals</h3></strong><br /><a href="http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/">http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/</a><br /><code>NTDS.dit</code> is a database - an ESE <em>(Extensible Storage Engine)</em> - comprised of 3 tables:<br />   ◇ <strong>Data Table:</strong> Contains information about the objects (users, groups, etc.)<br />   ◇ <strong>Link Table:</strong> Contains information about relations between objects (member of, etc.)<br />   ◇ <strong>SD Table:</strong> Contains the security descriptors of each object<br /><br />Windows uses <code>Ntdsa.dll</code> to interact with <code>NTDS.dit</code>.<br /><code>NTDS.dit</code> also gets used by LSASS (to verify remote logons?).<br />Therefore, you often find cached logon credentials from NTDS.dit inside LSASS memory.<br /><br /><strong><h3>### Dumping</h3></strong><br />• Hashes inside NTDS.dit are cyphered with the PEK - <em>Password Encryption Key</em><br />• The PEK is the same value on every Domain Controller.<br />• However, inside <code>NTDS.dit</code>, the PEK is encrypted with the BOOTKEY from the <code>C:\Windows\System32\config\SYSTEM</code><br /><br />Therefore, to decrypt hashes in NTDS.dit, you also need the BOOTKEY from <br /><code>C:\Windows\System32\config\SYSTEM</code><br />found in the registry hive at<br /><code>HKLM\SYSTEM</code><br /><br /><br /></div>
</body>
</html>
