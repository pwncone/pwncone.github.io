<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Unicode Problem</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Windows - x86 - The Unicode Problem</h1></strong><br />• <a href="https://www.fuzzysecurity.com/tutorials/expDev/5.html">https://www.fuzzysecurity.com/tutorials/expDev/5.html</a><br /><br />ASCII is an 8 bit character set,<br />whereas Unicode is a 16-bit / 2-byte character set.<br /><br /><code>A</code> in ASCII is <code>0x41</code><br /><code>A</code> in Unicode = <code>0x0041</code><br /><br /><code>AB</code> in ASCII is <code>0x4142</code><br /><code>AB</code> in Unicode is <code>0x00410042</code><br /><br />When you exploit a program using unicode strings, the shellcode you submit will be converted into unicode before being passed to the stack. This will completely ruin your shellcode (because addresses and opcodes you write get transformed into something totally different).<br /><br /><strong><h2>## Unicode and SEH</h2></strong><br />Almost all Unicode exploits are SEH exploits.<br />In a normal SEH exploit, you overwrite nSEH with a <code>jmp short</code>.<br />In Unicode + SEH, this is impossible.<br /><br />ASCII = <code>0x41414141</code><br />Unicode = <code>0x0041004100410041</code><br /><br />When the Unicode above gets translated into instructions, it looks like this:<br /><div class="codebox"><div class="codebox">...<br />41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INC&nbsp;ECX<br />004100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[ECX],AL<br />41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INC&nbsp;ECX<br />004100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[ECX],AL<br />...</div></div><br /><br />1 byte remains intact (<code>41</code>),<br />whilst the following byte &#39;absorbs&#39; both <code>00</code>s.<br /><br />This means that:<br />• <code>004100</code> can be used for a useful instruction<br />• and <code>41</code> should be replaced with an instruction that does nothing (a Unicode NULL-byte of sorts), so that the shellcode doesn&#39;t get interupted<br /><br />Here are a few Unicode &#39;do nothing&#39; instructions (they won&#39;t always be suitable):<br /><div class="codebox"><div class="codebox">006E00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[ESI],CH<br />006F00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EDI],CH<br />007000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EAX],DH<br />007100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[ECX],DH<br />007200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EDX],DH<br />007300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EBX],DH</div></div><br /><br /><strong><h3>### pop; pop; ret</h3></strong><br />Find a Unicode compatible pop pop ret instruction with mona - <code>!mona seh -cp unicode</code><br />You&#39;ll have to test the pointers yourself. Only some will redirect to a pop pop ret, and only some of those won&#39;t be &#39;harmful&#39; (not sure what this means) after being converted to unicode.<br /><br /><br /><br /></div>
</body>
</html>
