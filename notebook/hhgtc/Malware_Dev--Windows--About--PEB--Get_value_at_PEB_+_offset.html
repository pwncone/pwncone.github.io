<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Get value at PEB + offset</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Get value at PEB + offset</h1></strong><br />This is useful for grabbing undocumented elements within the PEB structure of which you know the offset to, without needing to use a header file containing the undocumented elements.<br /><br />Offsets can usually be found here:<br /><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/index.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/index.htm</a><br /><br />For example, <code>ImageBaseAddress</code> in the PEB is at offset:<br />• <code>0x10</code> on 64bit<br />• <code>0x08</code> on 32bit<br /><br /><code>ImageBaseAddress</code> is undocumented, therefore I can&#39;t just do<br /><code>PEB-&gt;ImageBaseAddress</code><br />to retrieve it.<br /><br />Instead, we:<br />grab the PEB,<br />and do PEB + offset to grab a pointer to the undocumented member we want in the PEB.<br /><br />The key line is this (and the subsequent 32bit version):<br /><code>DWORD64 image_base = *(DWORD64*)((size_t)p_peb + </code><code><span style="color:#ff0044;">0x10</span></code><code>);</code><br /><br /><code>((size_t)p_peb + 0x10)</code> is the address of where the ImageBaseAddress value is.<br /><code>(DWORD64*)</code> - I&#39;m typecasting <code>(size_t)p_peb + 0x10</code> as a pointer to a DWORD64<br />The ImageBaseAddress value is a DWORD on 32bit (4 bytes), and DWORD64 (8 bytes) on 64bit<br /><code>*(DWORD64*)</code> - I&#39;m grabbing the value pointed to by the <code>DWORD64*</code> pointer<br /><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />#ifdef&nbsp;_WIN64<br />	p_peb&nbsp;=&nbsp;(PPEB)__readgsqword(0x60);<br />	DWORD64&nbsp;image_base&nbsp;=&nbsp;*(DWORD64*)((size_t)p_peb&nbsp;+&nbsp;0x10);<br />#else<br />	p_peb&nbsp;=&nbsp;(PPEB)__readfsdword(0x30);<br />	DWORD&nbsp;image_base&nbsp;=&nbsp;*(DWORD*)((size_t)p_peb&nbsp;+&nbsp;0x08);<br />#endif<br />	<br />	printf(&quot;0x%p&nbsp;\n&quot;,&nbsp;(void*)image_base);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
