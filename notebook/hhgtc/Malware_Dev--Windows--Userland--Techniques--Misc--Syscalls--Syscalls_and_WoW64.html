<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Syscalls and WoW64</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Syscalls and WoW64</h1></strong><br />Good stuff.<br /><br /><strong><h2>## About WoW64</h2></strong><br />• <a href="https://docs.microsoft.com/en-gb/windows/win32/winprog64/wow64-implementation-details?redirectedfrom=MSDN">https://docs.microsoft.com/en-gb/windows/win32/winprog64/wow64-implementation-details?redirectedfrom=MSDN</a><br />• <a href="https://www.fireeye.com/blog/threat-research/2020/11/wow64-subsystem-internals-and-hooking-techniques.html">https://www.fireeye.com/blog/threat-research/2020/11/wow64-subsystem-internals-and-hooking-techniques.html</a> - Good overview of WoW64<br /><br />WoW64 - Windows on Windows 64 - supports running 32bit processes on 64bit Windows.<br />It&#39;s implemented by a set of usermode DLLs:<br />• <code>Wow64.dll</code><br />• <code>Wow64Cpu.dll</code><br />• <code>Wow64Win.dll</code><br />• <code>IA32Exec.bin</code><br /><br />On 64bit Windows, everything is 64bit: <br />the kernel, the EPROCESS struct, the PEB, etc.<br /><br />The first piece of code to execute in *any* process is a 64bit copy of <code>Ntdll.dll</code>, <br />which initialises the process in userland as a 64bit process.<br /><br />If the process being loaded is 32bit, <br /><code>Wow64.dll</code> will then take over and load a 32bit copy of <code>Ntdll.dll</code> and all other required DLLs.<br /><br />As a result, there will be 2 copies of Ntdll.dll loaded into a 32bit WoW64 process:<br />• a 32bit Ntdll.dll<br />• and a 64bit Ntdll.dll<br /><br />For example, here&#39;s a 32bit Notepad.exe running on Windows 10 x64.<br />You can see the 2 copies of Ntdll.dll.<br /><a href=""><img src="images/1715-1.png" alt="images/1715-1.png" /></a><br /><br />As well as the WoW64 DLLs.<br /><a href=""><img src="images/1715-2.png" alt="images/1715-2.png" /></a><br /><br /><strong><h2>## Windows 7 SP1 x64 (WoW64)</h2></strong><br />Below is a <code>32bit Notepead.exe</code> running on <code>Windows 7 SP1 x64</code> calling <code>NtCreateThread</code>.<br /><br />Because this is a WoW64 process (a 32bit process running on 64bit Windows), <br />it will call <code>NtCreateThread</code> from the 32bit copy of Ntdll.dll that&#39;s loaded into its process <br />(because it is unable to access the 64bit one).<br /><br />Here is what the 32bit copy of NtCreateThread looks like.<br />It:<br />• moves the ordinal value for NtCreateThread (from the SSDT) into EAX<br />• and calls the code pointed to by <code>FS + 0x0C0</code><br /><a href=""><img src="images/1715-3.png" alt="images/1715-3.png" /></a><br /><br />The <code>FS</code> segment points to the WoW64 TEB - Thread Environment Block.<br /><code>FS + 0x0c0</code> will contain the address of <code>wow64cpu!X86SwitchTo64BitMode</code><br />which will switch the CPU into 64bit mode and enter the kernel.<br /><br />(credit to MalwareTech for image)<br /><a href="https://www.malwaretech.com/wp-content/uploads/2014/06/system-call-path-wow64-1024x284.png"><img src="images/1715-4.png" alt="images/1715-4.png" /></a><br /><br /><strong><h2>## Windows 10 x64 (WoW64)</h2></strong><h2> </h2><br />This is the <code>32bit NtCreateFile</code> function from a <code>32bit Ntdll.dll</code> on a <code>64bit copy of Windows 10</code>,<br />version <code>Windows 10 x64 2004 19041.928</code>.<br /><br />(credit to MalwareTech for images)<br /><br />It moves the syscall value for NtCreateFile - <code>55h</code> - into eax<br />and calls a pointer to a function - <code>Wow64SystemServiceCall</code><br /><a href="https://www.malwaretech.com/wp-content/uploads/2015/07/Windows10WOW64.png"><img src="images/1715-5.png" alt="images/1715-5.png" /></a><br /><br /><code>Wow64SystemServiceCall</code> checks how it should execute the syscall.<br /><br /><code>test</code> ANDs against a flag in the PEB - offset <code>254h</code> - with <code>2</code><br />If the result is 0 (i.e. the flag isn&#39;t set to <code>2</code>) then it will perform the old syscall method.<br />If the flag is set to <code>2</code>, it will jump and perform the new syscall method with a jump to far ptr.<br /><a href="https://1.bp.blogspot.com/-dSlQxBhtyTA/Va_4KbX_EqI/AAAAAAAABJc/Vm01sx_cBsE/s1600/Wow64SystemServiceCall.png"><img src="images/1715-6.png" alt="images/1715-6.png" /></a><br /></div>
</body>
</html>
