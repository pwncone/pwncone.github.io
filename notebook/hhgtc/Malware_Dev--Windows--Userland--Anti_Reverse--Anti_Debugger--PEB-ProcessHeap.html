<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PEB->ProcessHeap</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># PEB-&gt;ProcessHeap</h1></strong><br />• <a href="https://www.aldeid.com/wiki/PEB-Process-Environment-Block/ProcessHeap">https://www.aldeid.com/wiki/PEB-Process-Environment-Block/ProcessHeap</a><br /><br /><code>PEB-&gt;ProcessHeap</code> points to the start of the process&#39; heap.<br />The first heap contains a header with the fields:<br />• <code>ForceFlags</code><br />• <code>Flags</code><br />These fields are used to tell the kernel whether the heap was created within a debugger.<br /><br />• If the value of <code>ForceFlags != 0</code>, then the process in being debugged<br />• If the <code>Flags</code> field does not have the set <code>HEAP_GROWABLE (0x00000002)</code> flag, then the process is being debugged.<br /><br /><strong><h2>## Ways to get the start of the process heap</h2></strong><br />• <code>GetProcessHeap()</code><br />   ◇ reads directory from PEB-&gt;ProcessHeap<br />• <code>GetProcessHeaps()</code><br />   ◇ calls <code>RtlGetProcessHeaps()</code> - returns an array of the process heaps<br />• asm<br /><br />If you&#39;re looking in Visual Studio at the PEB struct, <code>Reserved4[1]</code> is the <code>ProcessHeap</code> value.<br />Found by cross examining x64dbg&#39;s documentation of the PEB struct with MSDN and also using <code>GetProcessHeap</code> to verify:<br />• <a href="https://github.com/x64dbg/x64dbg/blob/development/src/dbg/ntdll/ntdll.h">https://github.com/x64dbg/x64dbg/blob/development/src/dbg/ntdll/ntdll.h</a><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-getprocessheap">https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-getprocessheap</a><br /><br /><a href=""><img src="images/1778-1.png" alt="images/1778-1.png" /></a><br /><br /><strong><h2>## Code</h2></strong><br />COULDN&#39;T GET THIS ONE TO WORK :/<br /><code>flag</code> always seemed to return <code>2</code> - <code>HEAP_GROWABLE</code><br />and <code>ForceFlags</code> was a random value<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />/*<br />Pretty&nbsp;sure&nbsp;this&nbsp;is&nbsp;wrong.<br />Flags&nbsp;is&nbsp;the&nbsp;right&nbsp;value,<br />but&nbsp;I&nbsp;don&#39;t&nbsp;think&nbsp;ForceFlags&nbsp;is.<br />*/<br />BOOL&nbsp;DebugCheck_ProcessHeap(void)<br />{<br />	BOOL&nbsp;debugger_present&nbsp;=&nbsp;FALSE;<br />	HANDLE&nbsp;h_heap&nbsp;=&nbsp;NULL;<br />	PDWORD&nbsp;heap_ForceFlags&nbsp;=&nbsp;0;<br />	PDWORD&nbsp;heap_Flags&nbsp;=&nbsp;0;<br /><br />	//&nbsp;get&nbsp;start&nbsp;of&nbsp;heap<br />	h_heap&nbsp;=&nbsp;GetProcessHeap();<br /><br />	//&nbsp;calculate&nbsp;pointers&nbsp;to&nbsp;heap&nbsp;flags&nbsp;from&nbsp;start&nbsp;of&nbsp;heap<br />#ifdef&nbsp;_WIN64<br />	heap_ForceFlags&nbsp;=&nbsp;(PDWORD)((PBYTE)h_heap&nbsp;+&nbsp;0x18);		//&nbsp;64bit<br />	heap_Flags&nbsp;=&nbsp;(PDWORD)((PBYTE)h_heap&nbsp;+&nbsp;0x14);			//&nbsp;64bit<br />#else<br />	heap_ForceFlags&nbsp;=&nbsp;(PDWORD)((PBYTE)h_heap&nbsp;+&nbsp;0x10);		//&nbsp;32bit<br />	heap_Flags&nbsp;=&nbsp;(PDWORD)((PBYTE)h_heap&nbsp;+&nbsp;0x0c);			//&nbsp;32bit<br />#endif<br /><br />	printf(&quot;heap&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;h_heap);<br />	printf(&quot;\t&nbsp;ForceFlags:&nbsp;%d&nbsp;\n&quot;,&nbsp;*heap_ForceFlags);<br />	printf(&quot;\t&nbsp;Flags:&nbsp;%d&nbsp;\n&quot;,&nbsp;*heap_Flags);<br /><br />	//&nbsp;if&nbsp;ForceFlags&nbsp;!=&nbsp;0&nbsp;-&nbsp;there&#39;s&nbsp;a&nbsp;debuuger<br />	//&nbsp;if&nbsp;Flags&nbsp;does&nbsp;not&nbsp;have&nbsp;HEAP_GROWABLE&nbsp;set&nbsp;-&nbsp;there&#39;s&nbsp;a&nbsp;debugger<br />	if&nbsp;(*heap_ForceFlags&nbsp;!=&nbsp;0&nbsp;||&nbsp;*heap_Flags&nbsp;!=&nbsp;HEAP_GROWABLE)<br />		debugger_present&nbsp;=&nbsp;TRUE;<br /><br />	return&nbsp;debugger_present;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;debugger_present&nbsp;=&nbsp;FALSE;<br />	<br />	debugger_present&nbsp;=&nbsp;DebugCheck_ProcessHeap();<br />	if&nbsp;(debugger_present&nbsp;==&nbsp;TRUE)<br />		return&nbsp;1;<br /><br />	printf(&quot;hey&nbsp;:)&nbsp;\n&quot;);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
