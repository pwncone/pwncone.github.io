<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Create an Encryption Key</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Creating an Encryption Key</h1></strong><br />• <code>CryptGenKey</code> - to generate a random key<br />• <code>CryptImportKey</code> - to import from a (blob?)<br />• <code>CryptDeriveKey</code> - to derive from a hash<br /><br /><strong><h2>## From a password (hash password -&gt; CryptDeriveKey from hash)</h2></strong><br />This is a good and easy method.<br />Create a hash of a plaintext password, and then use the hash to derive a key for encryption/decryption.<br />Make sure<br />• the hash is available in the provider type<br />• the hash size is the same size as the key size (SHA256 for 256 bit key, MD5 for 128 bit key, etc.)<br /><br /><div class="codebox"><div class="codebox">/*&nbsp;<br />Hash&nbsp;&quot;Hello!&quot;&nbsp;to&nbsp;SHA256&nbsp;hash,&nbsp;and&nbsp;create&nbsp;AES256&nbsp;key&nbsp;from&nbsp;the&nbsp;hash<br />*/<br />BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br />HCRYPTKEY&nbsp;h_key&nbsp;=&nbsp;0;<br />HCRYPTPROV&nbsp;h_provider&nbsp;=&nbsp;0;<br />HCRYPTHASH&nbsp;hash&nbsp;=&nbsp;0;<br />char&nbsp;password[]&nbsp;=&nbsp;&quot;Hello!&quot;;<br /><br />//&nbsp;Initialise&nbsp;crypto<br />b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_provider,&nbsp;NULL,&nbsp;MS_ENH_RSA_AES_PROV_A,&nbsp;PROV_RSA_AES,&nbsp;0);<br />if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />{<br />	if&nbsp;(GetLastError()&nbsp;==&nbsp;NTE_BAD_KEYSET)<br />	{<br />		b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_provider,&nbsp;NULL,&nbsp;MS_ENH_RSA_AES_PROV_A,&nbsp;PROV_RSA_AES,&nbsp;CRYPT_NEWKEYSET);<br />		if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />			return&nbsp;1;<br />	}<br />	else<br />		return&nbsp;1;<br />}<br /><br /><br />//&nbsp;Define&nbsp;hash&nbsp;algorithm<br />CryptCreateHash(provider,&nbsp;CALG_SHA_256,&nbsp;0,&nbsp;0,&nbsp;&amp;hash);<br />//&nbsp;SHA256&nbsp;hash&nbsp;password<br />CryptHashData(hash,&nbsp;(BYTE*)password,&nbsp;strlen(password),&nbsp;0);<br />//&nbsp;Derive&nbsp;a&nbsp;AES256&nbsp;key&nbsp;using&nbsp;the&nbsp;hashed&nbsp;password<br />CryptDeriveKey(provider,&nbsp;CALG_AES_256,&nbsp;hash,&nbsp;CRYPT_EXPORTABLE,&nbsp;key);<br />//&nbsp;Destroy&nbsp;the&nbsp;password&nbsp;hash&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;it&nbsp;anymore<br />CryptDestroyHash(hash);</div></div><br /></div>
</body>
</html>
