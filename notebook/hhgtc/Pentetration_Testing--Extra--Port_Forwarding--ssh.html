<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ssh</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Port Forwarding - SSH</h1></strong><br /><a href="https://0xdf.gitlab.io/2018/06/10/intro-to-ssh-tunneling.html">https://0xdf.gitlab.io/2018/06/10/intro-to-ssh-tunneling.html</a><br /><br />• Local &amp; Remote Port Forwarding -&gt; Forwards traffic on 1 port to 1 port<br />• Dynamic Port Forwarding -&gt; Forwards traffic on all ports to all ports<br /><br /><strong><h2>## Local Port Forwarding</h2></strong><br /><code>ssh user@10.10.10.40 -L &lt;local port&gt;:&lt;remote ip&gt;:remote port&gt;</code><br /><br />• Listen on a <code>local port</code> - <code>-L</code><br />• Connect to a remote host (usually a target machine) - <code>ssh user@10.10.10.40</code><br />• Forward any traffic sent to <code>local port</code> through SSH connection to <code>[remote ip]:[remote port]</code><br />   ◇ This remote IP could be 127.0.0.1 - i.e. the SSH server you&#39;re connecting to<br />   ◇ Or a different remote IP that the SSH server can access<br /><br />Usually done from your attacking host.<br /><br /><strong><h3>### Example 1 - Forward traffic to an internally running service on the SSH host</h3></strong><br />• Bob has an internally running HTTP server on port 80 <br />• You want to access to it with your attack tools<br /><code>ssh bob@10.10.10.40 -L 9080:127.0.0.1:80</code><br /><br /><em>Listen locally on 9080.</em><br /><em>SSH into bob@10.10.10.40.</em><br /><em>Forward all traffic sent to 9080 via bob through to 127.0.0.1 port 80 (i.e. bob&#39;s own machine)</em><br /><br /><strong><h3>### Example 2 - Forward traffic to an external service running on a different subnet</h3></strong><br />• Bob is at <code>10.10.0.40</code> - which you can access<br />• Bob has access to a HTTP site on a subnet that you don&#39;t - <code>10.3.3.52</code><br /><br /><code>ssh bob@10.10.10.40 -L 9080:10.3.3.52:80</code><br /><br /><em>Listen locally on 9080.</em><br /><em>SSH into bob@10.10.10.40.</em><br /><em>Forward all traffic sent to 9080 via bob through to 10.3.3.52 port 80 (i.e. bob&#39;s own machine)</em><br /><br /><strong><h2>## Remote Port Forwarding</h2></strong><br /><code>ssh user@10.10.10.40 -R &lt;remote port&gt;:&lt;remote ip&gt;:remote port&gt;</code><br /><br />• Connect to remote host (usually your attacking machine) - <code>ssh user@10.10.10.40</code><br />• Listen on <code>-R &lt;port&gt;</code> on the remote host<br />• Forward all traffic sent to <code>-R</code> on remote host out through current SSH host to <code>[remote ip]:[remote port]</code><br /><br />Usually done from a compromised host SSH&#39;ing out to your attacking machine.<br /><br /><strong><h3>### Example 1 - Forward traffic to an internally running service on the compromised host</h3></strong><br />• Your attacking host is <code>10.11.0.184</code><br />• You&#39;re currently on <code>Mario - 10.3.3.42</code><br />• You want to access an internally running service on Mario - port 80<br /><br /><code>ssh root@10.11.0.184 -R 9080:127.0.0.1:80</code><br /><br /><em>Connect to root@10.11.0.184</em><br /><em>On 10.11.0.184, listen locally on port 9080</em><br /><em>Forward all traffic sent to 9080 on 10.11.0.184 through the current SSH host (Mario) out to 127.0.0.1 port 80 (i.e. Mario 10.3.3.42 port 80)</em><br /><br /><strong><h3>### Example 2 - Forward traffic to an external service running on a different subnet</h3></strong><br />• Your attacking host is <code>10.11.0.184</code><br />• You&#39;re currently on <code>Mario - 10.3.3.42</code><br />• You want to access port 80 on <code>Tricia - 10.3.3.34</code> , which Mario can access<br /><br />• You can&#39;t access Mario from your attacking host - <code>AttackHost → Mario</code> - X<br />• but you CAN access your attacking host from Mario <code>AttackHost ← Mario</code> - <h2>✓</h2><br /><br />Therefore, you run a remote port forward from Mario back to your attacking machine.<br /><br /><code>ssh root@10.11.0.184 -R 9080:10.3.3.34:80</code><br /><br /><em>Connect to root@10.11.0.184</em><br /><em>On 10.11.0.184, listen locally on port 9080</em><br /><em>Forward all traffic sent to 9080 on 10.11.0.184 through the current SSH host (Mario) out to Tricia on 10.3.3.34:80</em><br /><br /><strong><h2>## Dynamic Port Forwarding</h2></strong><br />A dynamic port forward understands what traffic is being sent and will redirect it to the correct port on the target.<br /><br />• Requires proxychains<br />   ◇ Use proxychains-ng - <a href="https://github.com/rofl0r/proxychains-ng">https://github.com/rofl0r/proxychains-ng</a><br /><br /><code>ssh user@10.10.10.40 -D 22001</code><br /><br />• Listen on local port 22001 - <code>-D 22001</code><br />• Connect to remote host - <code>user@10.10.10.40</code><br />• Configure proxychains to listen on local port<br />   ◇ <div class="codebox"><div class="codebox">nano&nbsp;/etc/proxychains.conf<br />[...]<br />socks4&nbsp;127.0.0.1&nbsp;22001</div></div><br />• Run your commands via proxychains<br />   ◇ <code>proxychains4 nmap -sT 10.10.10.50</code><br />• All traffic will now be sent via the remote host - <code>10.10.10.40</code> - to the target specified in your command - <code>10.10.10.50</code><br /><br /><strong><h3>### Example 1</h3></strong><br />1. Configure proxychains and create a SOCKS proxy (make sure to use proxychains-ng)<br /><code>nano /etc/proxychains.conf</code><br /><code>socks4 127.0.0.1 22001</code><br /><br />2. Dynamic port forward<br /><em>Open a dynamic port forward port on your current host at 22001.<br />All traffic sent to local host port 22001 will be proxied through 10.10.10.40</em><br /><code>ssh bob@10.10.10.40 -D 22001 -f -N</code><br /><br />3. Run applications over dynamic port forward via proxychains<br /><code>proxychains4 nmap -sT 10.10.1.40</code><br /><br /><strong><h3>### ssh</h3></strong><br /><code>-q</code> - suppress errors<br /><code>-f</code> - background the ssh connection<br /><code>-N</code> - don&#39;t spawn shell<br /><br /><strong><h3>### proxychains4</h3></strong><br /><code>-q</code> - for quiet mode<br /><br /><strong><h2>## Dynamic Port Forwarding - Double Port Forward</h2></strong><br />• You can access <code>10.11.1.251 - Sean</code><br />• <code>10.11.1.251 - Sean</code> can access <code>10.3.3.42 - Mario</code><br />• <code>10.3.3.42 - Mario</code> can access <code>10.3.3.34 - Tricia</code> &lt;-- this is what you want to access<br /><br />Port Forward Diagram:<br /><code>10.11.0.184 - Attacker</code> → <code>10.11.1.251 - Sean</code> → <code>10.3.3.42 - Mario</code><br />Then run commands via proxychains to attack <code>10.3.3.34 - Tricia</code><br /><br />For this to work, you need to already have SSH access on <code>10.11.1.251 - Sean</code> and <code>10.3.3.42 - Mario</code><br /><br /><strong>The command to run is this:</strong><br /><code>ssh sean@10.11.1.251 -D 22001 ssh mario@10.3.3.42 -p 222 -D 22002</code><br /><br />• Create local dyanmic port forward port on <code>port 22001</code><br />• Connect to <code>sean@10.11.1.251</code><br />• From <code>sean@10.11.1.251</code>, connect to <code>mario@10.3.3.42</code> and create a local dynamic port forward port on <code>10.11.1.251 - Sean port 22002</code><br /><br />• Configure proxychains like so:<br />   ◇ <div class="codebox"><div class="codebox">┌─[root@parrot]─[/oscp/admin_dept]<br />└──╼&nbsp;#nano&nbsp;/etc/proxychains.conf<br />[...]<br />#&nbsp;defaults&nbsp;set&nbsp;to&nbsp;&quot;tor&quot;<br />socks4&nbsp;127.0.0.1&nbsp;22001<br />socks4&nbsp;127.0.0.1&nbsp;22002</div></div><br /><br />• Now connect to <code>10.3.3.34 - Tricia</code> via proxychains<br />   ◇ proxychains forwards our traffic through 22001 (sean), then to 22002 (mario), and runs our commands as if they were coming from mario<br />   ◇ <code>proxychains4 &lt;command&gt;</code><br /><br /><strong>Problems:</strong><br />• Authentication prompts<br />   ◇ This command - <code>ssh sean@10.11.1.251 -D 22001 ssh mario@10.1.1.1 -p 222 -D 22002</code> - won&#39;t prompt us for a password on <code>mario</code>, and will error out<br />      ▪ The solution is to add <code>sean</code>&#39;s ssh public key to <code>mario</code>&#39;s <code>authorized_keys</code> file, so we can auth without being prompted for a password<br /><br /><strong><h3>### Other Double Port Forwards</h3></strong><br />(just examples I&#39;ve found for now)<br /><br />• Listen locally on port <code>22080</code><br />• Connect to <code>sean@10.11.1.251</code><br />• Forward all traffic to <code>port 22001 on attacking host</code> out to <code>10.11.1.251 port 8157</code><br />• Connect to <code>mario@10.1.1.1</code> via <code>sean@10.11.1.251</code> and create a dynamic port forward on <code>port 8157</code> on host <code>10.11.1.251 - Sean</code><br /><div class="codebox"><div class="codebox">ssh&nbsp;sean@10.11.1.251&nbsp;-L&nbsp;22001:127.0.01:8157&nbsp;ssh&nbsp;mario@10.1.1.1&nbsp;-p&nbsp;222&nbsp;-D&nbsp;8157<br />#&nbsp;set&nbsp;up&nbsp;proxychains&nbsp;to&nbsp;use&nbsp;our&nbsp;forwarded&nbsp;port&nbsp;22080:<br />#&nbsp;use&nbsp;strict_chain&nbsp;or&nbsp;dynamic_chain<br />nano&nbsp;/etc/proxychains.conf<br />socks4&nbsp;127.0.0.1&nbsp;22080</div></div><br /><br /></div>
</body>
</html>
