<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Thread Creation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Thread Creation</h1></strong><br />- <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreatethreadnotifyroutine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreatethreadnotifyroutine</a><br />- <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_thread_notify_routine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_thread_notify_routine</a><br /><br /><code>PsSetCreateThreadNotifyRoutine</code> notifies the driver when a new thread is created and subsequently deleted.<br /><br />A debuggee machine is running our driver.<br />A debugger machine is running WinDbg and is connected to the debuggee machine.<br /><br />I load the driver on the debuggee machine using OSR Driver Loader.<br /><a href=""><img src="images/1811-1.png" alt="images/1811-1.png" /></a><br /><br />Back on the debugger machine, we see the output from out kernel driver in WinDbg.<br /><a href=""><img src="images/1811-2.png" alt="images/1811-2.png" /></a><br /><br />Immediately we&#39;re able to see processes creating threads and threads exiting.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />/*<br />Routine&nbsp;that&nbsp;runs&nbsp;on&nbsp;thread&nbsp;creation.<br />*/<br />void&nbsp;notify_CreateThread(HANDLE&nbsp;process_id,&nbsp;HANDLE&nbsp;thread_id,&nbsp;BOOLEAN&nbsp;thread_created)<br />{<br />	if&nbsp;(thread_created&nbsp;==&nbsp;TRUE)<br />	{<br />		PEPROCESS&nbsp;process_info&nbsp;=&nbsp;NULL;<br />		PUNICODE_STRING&nbsp;process_name&nbsp;=&nbsp;NULL;<br /><br />		//&nbsp;grab&nbsp;name&nbsp;of&nbsp;process&nbsp;creating&nbsp;thread<br />		PsLookupProcessByProcessId(process_id,&nbsp;&amp;process_info);<br />		SeLocateProcessImageName(process_info,&nbsp;&amp;process_name);<br /><br />		DbgPrint(&quot;PROCESS&nbsp;%d&nbsp;%wZ&nbsp;CREATED&nbsp;THREAD&nbsp;%d&nbsp;\n&quot;,&nbsp;process_id,&nbsp;process_name,&nbsp;thread_id);<br />	}<br />	else&nbsp;if&nbsp;(thread_created&nbsp;==&nbsp;FALSE)<br />	{<br />		DbgPrint(&quot;PROCESS&nbsp;%d&nbsp;THREAD&nbsp;%d&nbsp;EXITED&nbsp;\n&quot;,&nbsp;process_id,&nbsp;thread_id);<br />	}<br /><br />	return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />	UNREFERENCED_PARAMETER(DriverObject);<br /><br />	//&nbsp;remove&nbsp;set&nbsp;notifications<br />	PsRemoveCreateThreadNotifyRoutine(notify_CreateThread);<br /><br />	DbgPrint(&quot;driver&nbsp;unloaded&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />	UNREFERENCED_PARAMETER(DriverObject);<br />	UNREFERENCED_PARAMETER(RegistryPath);<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />	DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />	//&nbsp;start<br />	DbgPrint(&quot;driver&nbsp;loaded&nbsp;\n&quot;);<br /><br />	//&nbsp;notifications<br />	nt_status&nbsp;=&nbsp;PsSetCreateThreadNotifyRoutine(notify_CreateThread);<br /><br />	return&nbsp;nt_status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
