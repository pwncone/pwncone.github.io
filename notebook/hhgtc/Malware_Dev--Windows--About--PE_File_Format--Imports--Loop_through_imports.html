<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Loop through imports</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Loop Through Imports</h1></strong><br />Grab the import directory:<br /><code>PIMAGE_IMPORT_DESCRIPTOR import_directory = IMAGE_NT_HEADER-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress)</code><br /><br />Grab the DLL name:<br /><code>char* dll_name = file_base + import_directory-&gt;Name;</code><br /><br />Grab the Import Lookup Table:<br /><code>PIMAGE_THUNK_DATA import_lookup_table = IMAGE_IMPORT_DESCRIPTOR-&gt;OriginalFirstThunk</code><br /><br />The Import Lookup Table stores imported functions from that DLL.<br /><br />Check if function is imported by ordinal:<br /><code>IMAGE_SNAP_BY_ORDINAL(import_lookup_table-&gt;u1.Ordinal);</code><br /><br />If a function is imported by name, you can grab a pointer to a struct containing the name:<br /><code>PIMAGE_IMPORT_BY_NAME import_name = file_buffer + import_lookup_table-&gt;u1.AddressOfData</code><br /><br />Name is located here:<br /><code>import_name-&gt;Name;</code><br /><br /><div class="codebox"><div class="codebox">PIMAGE_DOS_HEADER&nbsp;dos_header&nbsp;=&nbsp;NULL;<br />PIMAGE_NT_HEADERS&nbsp;pe_header&nbsp;=&nbsp;NULL;<br />PIMAGE_FILE_HEADER&nbsp;coff_header&nbsp;=&nbsp;NULL;<br />PIMAGE_OPTIONAL_HEADER&nbsp;pe_optional_header&nbsp;=&nbsp;NULL;<br /><br />PIMAGE_IMPORT_DESCRIPTOR&nbsp;import_directory&nbsp;=&nbsp;NULL;<br />PIMAGE_THUNK_DATA&nbsp;import_lookup_table&nbsp;=&nbsp;NULL;<br />PIMAGE_THUNK_DATA&nbsp;import_address_table&nbsp;=&nbsp;NULL;<br />PIMAGE_IMPORT_BY_NAME&nbsp;import_name&nbsp;=&nbsp;NULL;<br /><br />dos_header&nbsp;=&nbsp;file_buffer;<br />pe_header&nbsp;=&nbsp;(PIMAGE_NT_HEADERS)((DWORD_PTR)dos_header&nbsp;+&nbsp;(DWORD_PTR)dos_header-&gt;e_lfanew);<br />coff_header&nbsp;=&nbsp;&amp;pe_header-&gt;FileHeader;<br />pe_optional_header&nbsp;=&nbsp;&amp;pe_header-&gt;OptionalHeader;<br /><br />//&nbsp;-----&nbsp;IMPORT&nbsp;DIRECTORY&nbsp;-----<br />import_directory&nbsp;=&nbsp;(PIMAGE_IMPORT_DESCRIPTOR)((DWORD_PTR)file_buffer&nbsp;+&nbsp;rva2raw(file_buffer,&nbsp;pe_header-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress));<br />printf(&quot;import&nbsp;directory&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;import_directory);<br /><br />//&nbsp;loop&nbsp;through&nbsp;DLLs<br />while&nbsp;(import_directory-&gt;Name&nbsp;!=&nbsp;0)<br /><span style="color:#000000;font-weight:400">{</span><br />	char*&nbsp;dll_name&nbsp;=&nbsp;(char*)((DWORD_PTR)file_buffer&nbsp;+&nbsp;rva2raw(file_buffer,&nbsp;import_directory-&gt;Name));<br />	printf(&quot;\t&nbsp;%s&nbsp;\n&quot;,&nbsp;dll_name);<br /><br />	import_lookup_table&nbsp;=&nbsp;(PIMAGE_THUNK_DATA)((DWORD_PTR)file_buffer&nbsp;+&nbsp;rva2raw(file_buffer,&nbsp;import_directory-&gt;OriginalFirstThunk));<br />	import_address_table&nbsp;=&nbsp;(PIMAGE_THUNK_DATA)((DWORD_PTR)file_buffer&nbsp;+&nbsp;rva2raw(file_buffer,&nbsp;import_directory-&gt;FirstThunk));<br /><br />	//&nbsp;loop&nbsp;through&nbsp;imported&nbsp;functions&nbsp;in&nbsp;DLLs<br />	while&nbsp;(import_lookup_table-&gt;u1.AddressOfData&nbsp;!=&nbsp;0)<br />	{<br />		//&nbsp;if&nbsp;import&nbsp;by&nbsp;ordinal<br />		if&nbsp;(IMAGE_SNAP_BY_ORDINAL(import_lookup_table-&gt;u1.Ordinal))<br />		{<br />			printf(&quot;\t\t&nbsp;import&nbsp;by&nbsp;ordinal:&nbsp;%llu&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;import_lookup_table-&gt;u1.Ordinal,&nbsp;import_lookup_table-&gt;u1.Function);<br />		}<br />		//&nbsp;if&nbsp;import&nbsp;by&nbsp;name<br />		else<br />		{<br />			//&nbsp;grab&nbsp;import&nbsp;name&nbsp;from&nbsp;IMAGE_IMPORT_NAME&nbsp;struct<br />			import_name&nbsp;=&nbsp;(PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)file_buffer&nbsp;+&nbsp;rva2raw(file_buffer,&nbsp;import_lookup_table-&gt;u1.AddressOfData));<br />			printf(&quot;\t\t&nbsp;import&nbsp;by&nbsp;name:&nbsp;%s&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;import_name-&gt;Name,&nbsp;import_lookup_table-&gt;u1.Function);<br />		}<br />		<br />		import_lookup_table++;<br />		import_address_table++;<br />	}<br />	<br />	import_directory++;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
