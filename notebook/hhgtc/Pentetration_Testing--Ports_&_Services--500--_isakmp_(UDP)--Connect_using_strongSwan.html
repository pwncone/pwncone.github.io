<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Connect using strongSwan</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Connect using strongSwan</h1></strong><br />• <a href="https://www.strongswan.org/">https://www.strongswan.org/</a><br />strongSwan is an IPsec VPN implementation that supports Linux.<br /><br />Install it with <code>apt install strongswan</code>.<br /><div class="codebox"><div class="codebox">apt&nbsp;install&nbsp;strongswan&nbsp;-y</div></div><br /><br />There are 2 configuration files you need to set up:<br />• <code>/etc/ipsec.conf</code> - the VPN connection settings<br />• <code>/etc/ipsec.secrets</code> - passwords/keys<br /><br /><strong><h2>## etc/ipsec.conf</h2></strong><br />Edit <code>/etc/ipsec.conf</code> to configure the VPN connection parameters.<br />The information filled you need to fill in here you can get from ike-scan.<br />strongSwan&#39;s <code>ipsec.conf</code> man page is here - <a href="https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection">https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection</a> (for more info)<br /><br /><div class="codebox"><div class="codebox">nano&nbsp;/etc/ipsec.conf</div></div><br /><br /><em><strong>Example configuration from hackthebox Conceal</strong></em><br /><div class="codebox"><div class="codebox">[...]<br />#htb&nbsp;Conceal&nbsp;connection<br />conn&nbsp;conceal<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auto=add<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=transport<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keyexchange=ikev1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragmentation=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ike=3des-sha1-modp1024<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp=3des-sha1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authby=psk<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;left=10.10.14.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftprotoport=tcp<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right=10.10.10.116<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rightprotoport=tcp</div></div><br /><br /><strong><h3>### Explanation of settings</h3></strong><br /><strong>auto=add</strong><br />   ◇ <code>auto</code> defines what happens when you start the connection by running <code>ipsec</code><br />   ◇ <code>start</code> means that connection will connect automatically when you <code>ipsec start</code><br />   ◇ <code>add</code> means that connection will load a connection but not start it<br /><strong>type=transport</strong><br />   ◇ the type of connection<br />   ◇ If type is the 1st value in the config, the connection will fail, so I put it 2nd<br />   ◇ <code>transport</code> = host-to-host transport mode<br />   ◇ <code>tunnel</code> = host-to-host, host-to-subnet or subnet-to-subnet<br />         - <code>tunnel</code> requires defining IPs and subnets to connect to.<br />         - If you find subnets when running ike-scan or snmp-check, then you&#39;ll probably need tunnel mode<br />   ◇ <code>passthrough</code> = no IPsec processing should be done at all<br />   ◇ <code>drop</code> = packets should be discarded<br /><strong>keyexchange=ikev1</strong><br />   ◇ We know the keyexchange is ikev1 from ike-scan and the Nmap script scan of port 500<br />      ▪ ike-scan - <code>VID=e3a5966a76379fe707228231e5ce8652 (IKE CGA version 1)</code><br />      ▪ nmap - <code>IKE CGA version 1</code><br /><strong>fragmentation=yes</strong><br />   ◇ if ike supports fragmentation, use it!<br />   ◇ oversized messages will be sent in fragments (makes sending large amounts of data e.g. easier/more stable)<br />   ◇ ike-scan reported that Conceal does support ike fragmentation - <code>VID=4048b7d56ebce88525e7de7f00d6c2d3 (IKE Fragmentation)</code><br /><strong>ike=3des-sha1-modp1024 </strong><br />   ◇ <code>ike</code> defines the Ike key<br />   ◇ This can be found in the ike-scan output - <code>Enc=3DES Hash=SHA1 Group=2:modp1024</code><br />   ◇ This is phase 1 of IKE authentication/key exchange (useful to know for debugging vpn connection)<br /><strong>esp=3des-sha1</strong><br />   ◇ <code>esp</code> stands for Encapsulating Security Payload<br />   ◇ <code>esp</code> specifies the cipher suite, in the format <code>encryption-hashtype</code><br />   ◇ You can retrieve this info from ike-scan - <code>Enc=3DES Hash=SHA1</code><br />   ◇ This is phase 2 of IKE authentication/key exchange<br /><strong>authby=psk </strong><br />   ◇ <code>authby</code> defines IKE&#39;s authentication method<br />   ◇ You should get this info from ike-scan - <code>Auth=PSK</code><br /><strong>left=10.10.14.25</strong><br />   ◇ <code>left</code> is where you&#39;re connecting from/source IP<br /><strong>leftprotoport=tcp</strong><br />   ◇ <code>leftprotoport</code> defines the source port you&#39;re connecting via<br />   ◇ If TCP fails, try UDP<br /><strong>right=10.10.10.116</strong><br />   ◇ <code>right</code> is where you&#39;re connecting to/destination IP<br /><strong>rightprotoport=tcp </strong><br />   ◇ <code>rightprotoport</code> defines the destination port you&#39;re connecting to<br />   ◇ If TCP fails, try UDP<br /><br /><strong><h2>## /etc/ipsec.secrets</h2></strong><br /><code>/etc/ipsec.secrets</code> stores the VPN authentication keys/passwords.<br />ike-scan reported that Conceal uses PSK (pre-shared key) authentication, but you&#39;ll need to find a key from somehwere (from the box, or hidden somewhere etc. whatever).<br /><br />The format in <code>/etc/ipsec.secrets</code> is <code>&lt;source&gt; &lt;destination&gt; : PSK “&lt;password&gt;”</code>.<br /><br /><em><strong>Example configuration from hackthebox Conceal</strong></em><br />My IP when doing this machine was 10.10.14.25, so my <code>ipsec.secrets</code> entry looked like this:<br /><code>10.10.14.25 10.10.10.116 : PSK “Dudecake1!”</code><br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;nano&nbsp;/etc/ipsec.secrets<br />[...]<br />#&nbsp;this&nbsp;file&nbsp;is&nbsp;managed&nbsp;with&nbsp;debconf&nbsp;and&nbsp;will&nbsp;contain&nbsp;the&nbsp;automatically&nbsp;created&nbsp;private&nbsp;key<br />include&nbsp;/var/lib/strongswan/ipsec.secrets.inc<br /><br />10.10.14.25&nbsp;10.10.10.116&nbsp;:&nbsp;PSK&nbsp;&quot;Dudecake1!&quot;</div></div><br /><br /><strong><h2>## Connect</h2></strong><br />Run <code>ipsec stop</code> to kill any related processes, and then <code>ipsec start</code> to start IPsec and load any connections.<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ipsec&nbsp;stop<br />root@gotham:~/ctf/conceal#&nbsp;ipsec&nbsp;start<br />Starting&nbsp;strongSwan&nbsp;5.8.0&nbsp;IPsec&nbsp;[starter]...<br />root@gotham:~/ctf/conceal#</div></div><br /><br />To start the connection to Conceal, run <code>ipsec up &lt;config name&gt;</code><br />In the output, look for <code>&lt;connection name&gt; established</code>  to check that you&#39;ve connected successfully with no errors.<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ipsec&nbsp;up&nbsp;conceal<br />[...]<br />generating&nbsp;QUICK_MODE&nbsp;request&nbsp;4281661862&nbsp;[&nbsp;HASH&nbsp;]<br />sending&nbsp;packet:&nbsp;from&nbsp;10.10.14.25[500]&nbsp;to&nbsp;10.10.10.116[500]&nbsp;(60&nbsp;bytes)<br />connection&nbsp;&#39;conceal&#39;&nbsp;established&nbsp;successfully</div></div><br /><br />You can also run <code>ipsec status</code> to double-check.<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ipsec&nbsp;status<br />Security&nbsp;Associations&nbsp;(1&nbsp;up,&nbsp;0&nbsp;connecting):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conceal[1]:&nbsp;ESTABLISHED&nbsp;101&nbsp;seconds&nbsp;ago,&nbsp;10.10.14.25[10.10.14.25]...10.10.10.116[10.10.10.116]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conceal{1}:&nbsp;&nbsp;INSTALLED,&nbsp;TRANSPORT,&nbsp;reqid&nbsp;1,&nbsp;ESP&nbsp;SPIs:&nbsp;cba40473_i&nbsp;011b6740_o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conceal{1}:&nbsp;&nbsp;&nbsp;10.10.14.25/32[tcp]&nbsp;===&nbsp;10.10.10.116/32[tcp]</div></div><br /><br /><strong><h2>## Troubleshooting</h2></strong><br />strongSwan can be a pain...<br /><br /><strong><h3>### Connection Errors</h3></strong><br />If you encounter errors, best place to troubleshoot according to IppSec is netgate, who make PfSense (an OpenBSD firewall) - <br /><a href="https://docs.netgate.com/pfsense/en/latest/vpn/ipsec/ipsec-troubleshooting.html">https://docs.netgate.com/pfsense/en/latest/vpn/ipsec/ipsec-troubleshooting.html</a><br />- and search for the error message you get.<br /><br /><strong><h3>### Data/packet loss errors/weird issues</h3></strong><br />If you&#39;re connected but suspect your data isn&#39;t being completely sent/having weird issues, try lowering your MTU - the Maximum Transmission Unit.<br />1000 is low but it should work (need to learn more about this).<br /><code>ifconfig &lt;interface&gt; mtu 100</code><br /><code>ifconfig tun0 mtu 1000</code><br /></div>
</body>
</html>
