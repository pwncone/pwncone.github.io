<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Demo #2 - Hooking MessageBoxA</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Demo #2 - Hooking MessageBoxA</h1></strong><br />This 2nd demo hooks MessageBoxA.<br />We&#39;re running on <code>Windows 10 2004 19041.630</code> and all of the code is compiled as x64.<br />This includes:<br />• the target program<br />• the DLL to inject<br />• the DLL injector<br /><br /><strong><h2>## Setup/Code</h2></strong><br />My DLL injection code can be found above.<br /><br />Here&#39;s my target program.<br />It spawns a MessageBox every 3 seconds welcoming the user to our tour.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	while&nbsp;(TRUE)<br />	{<br />		printf(&quot;[+]&nbsp;spawning&nbsp;MessageBoxA...&nbsp;\n&quot;);<br />		MessageBoxA(NULL,&nbsp;&quot;hi!&nbsp;my&nbsp;name&#39;s&nbsp;MessageBoxA&nbsp;and&nbsp;welcome&nbsp;to&nbsp;our&nbsp;tour!&nbsp;...&quot;,&nbsp;&quot;welcome!&quot;,&nbsp;MB_OK);<br />		<br />		Sleep(3000);<br />	}<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />The program won&#39;t continue until <code>OK</code> is pressed.<br /><a href=""><img src="images/1691-1.png" alt="images/1691-1.png" /></a><br /><br />And here is my IAT hook.<br />This is a DLL that will be injected into the target process and hook <code>MessageBoxA</code>.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />//&nbsp;typedefs&nbsp;of&nbsp;hooked&nbsp;functions<br />typedef&nbsp;int(__stdcall*&nbsp;t_MessageBoxA)(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType);<br />t_MessageBoxA&nbsp;og_MessageBoxA;<br /><br />int&nbsp;hooked_MessageBoxA(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType)<br />{<br />	MessageBoxW(NULL,&nbsp;L&quot;hi,&nbsp;i&#39;m&nbsp;MessageBoxW&nbsp;and&nbsp;i&#39;ll&nbsp;be&nbsp;your&nbsp;tour&nbsp;guide&nbsp;for&nbsp;today.&nbsp;MessageBoxA&nbsp;is&nbsp;off&nbsp;sick&quot;,&nbsp;L&quot;MessageBoxA&nbsp;hooked!&quot;,&nbsp;MB_OK);<br />	return&nbsp;og_MessageBoxA(hWnd,&nbsp;lpText,&nbsp;lpCaption,&nbsp;uType);<br />}<br /><br />void&nbsp;HookFunctionsInIAT(void)<br />{<br />	LPVOID&nbsp;image_base&nbsp;=&nbsp;NULL;<br /><br />	PIMAGE_DOS_HEADER&nbsp;dos_header&nbsp;=&nbsp;NULL;<br />	PIMAGE_NT_HEADERS&nbsp;pe_header&nbsp;=&nbsp;NULL;<br />	PIMAGE_IMPORT_DESCRIPTOR&nbsp;import_directory&nbsp;=&nbsp;NULL;<br />	PIMAGE_THUNK_DATA&nbsp;import_lookup_table&nbsp;=&nbsp;NULL;<br />	PIMAGE_THUNK_DATA&nbsp;import_address_table&nbsp;=&nbsp;NULL;<br />	PIMAGE_IMPORT_BY_NAME&nbsp;import_name&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;old_protect&nbsp;=&nbsp;0;<br /><br />	//&nbsp;grab&nbsp;base&nbsp;address,&nbsp;DOS&nbsp;header,&nbsp;and&nbsp;PE&nbsp;header&nbsp;of&nbsp;host&nbsp;process<br />	image_base&nbsp;=&nbsp;(LPVOID)GetModuleHandleA(NULL);<br />	dos_header&nbsp;=&nbsp;(PIMAGE_DOS_HEADER)image_base;<br />	pe_header&nbsp;=&nbsp;(PIMAGE_NT_HEADERS)((DWORD_PTR)dos_header&nbsp;+&nbsp;(DWORD_PTR)dos_header-&gt;e_lfanew);<br />	import_directory&nbsp;=&nbsp;(PIMAGE_IMPORT_DESCRIPTOR)((DWORD_PTR)image_base&nbsp;+&nbsp;pe_header-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);<br /><br />	//&nbsp;loop&nbsp;through&nbsp;DLLs&nbsp;in&nbsp;Import&nbsp;Directory<br />	while&nbsp;(import_directory-&gt;Name&nbsp;!=&nbsp;0)<br />	{<br />		import_lookup_table&nbsp;=&nbsp;(PIMAGE_THUNK_DATA)((DWORD_PTR)image_base&nbsp;+&nbsp;import_directory-&gt;OriginalFirstThunk);<br />		import_address_table&nbsp;=&nbsp;(PIMAGE_THUNK_DATA)((DWORD_PTR)image_base&nbsp;+&nbsp;import_directory-&gt;FirstThunk);<br /><br />		//&nbsp;loop&nbsp;through&nbsp;imported&nbsp;functions&nbsp;in&nbsp;DLL<br />		while&nbsp;(import_lookup_table-&gt;u1.AddressOfData&nbsp;!=&nbsp;0)<br />		{<br />			//&nbsp;if&nbsp;import&nbsp;by&nbsp;ordinal<br />			if&nbsp;(IMAGE_SNAP_BY_ORDINAL(import_lookup_table-&gt;u1.Ordinal))<br />			{<br />				continue;<br />			}<br />			//&nbsp;if&nbsp;import&nbsp;by&nbsp;name<br />			else<br />			{<br />				//&nbsp;grab&nbsp;import&nbsp;name&nbsp;from&nbsp;IMAGE_IMPORT_NAME&nbsp;struct<br />				import_name&nbsp;=&nbsp;(PIMAGE_IMPORT_BY_NAME)((DWORD_PTR)image_base&nbsp;+&nbsp;import_lookup_table-&gt;u1.AddressOfData);<br /><br />				//&nbsp;if&nbsp;we&#39;ve&nbsp;found&nbsp;MessageBoxA<br />				if&nbsp;(strcmp(import_name-&gt;Name,&nbsp;&quot;MessageBoxA&quot;)&nbsp;==&nbsp;0)<br />				{<br />					//&nbsp;save&nbsp;the&nbsp;function&nbsp;address<br />					og_MessageBoxA&nbsp;=&nbsp;(t_MessageBoxA)import_address_table-&gt;u1.Function;<br /><br />					//&nbsp;make&nbsp;writable&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;function&nbsp;in&nbsp;the&nbsp;Import&nbsp;Address&nbsp;Table<br />#ifdef&nbsp;_WIN64<br />					VirtualProtect(&amp;import_address_table-&gt;u1.Function,&nbsp;sizeof(ULONGLONG),&nbsp;PAGE_READWRITE,&nbsp;&amp;old_protect);<br />#else<br />					VirtualProtect(&amp;import_address_table-&gt;u1.Function,&nbsp;sizeof(DWORD),&nbsp;PAGE_READWRITE,&nbsp;&amp;old_protect);<br />#endif<br /><br />					//&nbsp;write&nbsp;address&nbsp;of&nbsp;hooked_MessageBoxA&nbsp;function&nbsp;into&nbsp;IAT<br />					import_address_table-&gt;u1.Function&nbsp;=&nbsp;(DWORD_PTR)hooked_MessageBoxA;<br /><br />					//&nbsp;revert&nbsp;Import&nbsp;Address&nbsp;Table&nbsp;back&nbsp;to&nbsp;original&nbsp;state<br />#ifdef&nbsp;_WIN64<br />					VirtualProtect(&amp;import_address_table-&gt;u1.Function,&nbsp;sizeof(ULONGLONG),&nbsp;old_protect,&nbsp;&amp;old_protect);<br />#else<br />					VirtualProtect(&amp;import_address_table-&gt;u1.Function,&nbsp;sizeof(DWORD),&nbsp;old_protect,&nbsp;&amp;old_protect);<br />#endif<br /><br />					break;<br />				}<br />			}<br /><br />			import_lookup_table++;<br />			import_address_table++;<br />		}<br /><br />		import_directory++;<br />	}<br /><br />	return;<br />}<br /><br />BOOL&nbsp;WINAPI&nbsp;DllMain(HINSTANCE&nbsp;hinstDLL,&nbsp;DWORD&nbsp;fdwReason,&nbsp;LPVOID&nbsp;lpReserved)<br /><span style="color:#000000;font-weight:400">{</span><br />	switch&nbsp;(fdwReason)<br />	{<br />	case&nbsp;DLL_PROCESS_ATTACH:<br />		HookFunctionsInIAT();<br />		break;<br />	case&nbsp;DLL_THREAD_ATTACH:<br />		break;<br />	case&nbsp;DLL_THREAD_DETACH:<br />		break;<br />	case&nbsp;DLL_PROCESS_DETACH:<br />		break;<br />	}<br /><br />	return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Demo</h2></strong><br />I run my target program.<br /><code>MessageBoxA</code> introduces itself and welcomes us on our tour.<br /><a href=""><img src="images/1691-2.png" alt="images/1691-2.png" /></a><br /><br />Next I inject my MessageBoxA IAT hook in the target process using my injector.<br /><a href=""><img src="images/1691-3.png" alt="images/1691-3.png" /></a><br /><br />And now, the next MessageBoxA is called in the target process, we get a different message!<br />Our MessageBoxA hook was successful.<br /><a href=""><img src="images/1691-4.png" alt="images/1691-4.png" /></a><br /><br />From Process Hacker we can see that our malicious DLL is loaded in the target process.<br /><a href=""><img src="images/1691-5.png" alt="images/1691-5.png" /></a><br /></div>
</body>
</html>
