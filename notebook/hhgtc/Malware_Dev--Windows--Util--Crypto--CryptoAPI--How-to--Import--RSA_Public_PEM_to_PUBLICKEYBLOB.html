<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RSA Public PEM to PUBLICKEYBLOB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># RSA Public PEM to PUBLICKEYBLOB</h1></strong><br />• <a href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/28a78f5b-759b-42a7-9004-ccbbe469cffb/how-do-i-import-a-public-key-for-encryption-in-c?forum=vcgeneral">https://social.msdn.microsoft.com/Forums/vstudio/en-US/28a78f5b-759b-42a7-9004-ccbbe469cffb/how-do-i-import-a-public-key-for-encryption-in-c?forum=vcgeneral</a><br />• <a href="https://stackoverflow.com/questions/34324466/crypto-api-rsa-public-key-can-decrypt-data-is-not-asymmetric-as-expected">https://stackoverflow.com/questions/34324466/crypto-api-rsa-public-key-can-decrypt-data-is-not-asymmetric-as-expected</a><br /><br /><code>CryptStringToBinaryA</code> - to convert from PEM format to DER format (removes header and decodes from base64)<br /><code>CryptDecodeObjectEx</code> - to decode from DER to CERT_PUBLIC_KEY_INFO<br /><code>CryptImportPublicKeyInfo</code> - to import the key<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;wincrypt.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Crypt32.lib&quot;)<br /><br />#define&nbsp;CRYPTO_PROVIDER			MS_ENH_RSA_AES_PROV_A<br />#define&nbsp;CRYPTO_PROVIDER_TYPE	PROV_RSA_AES<br />#define&nbsp;KEY_ALGORITHM			CALG_AES_256<br />#define&nbsp;AES256_KEYSIZE			32		//&nbsp;32&nbsp;bytes&nbsp;/&nbsp;256&nbsp;bits<br /><br />int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br /><span style="color:#000000;font-weight:400">{</span><br />	int&nbsp;i&nbsp;=&nbsp;0;<br />	BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br /><br />	//&nbsp;Init&nbsp;RSA&nbsp;crypto<br />	HCRYPTKEY&nbsp;h_RSAkey&nbsp;=&nbsp;0;<br />	HCRYPTPROV&nbsp;h_RSAprovider&nbsp;=&nbsp;0;<br />	char&nbsp;rsa_public_der[2048]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	DWORD&nbsp;rsa_der_len&nbsp;=&nbsp;2048;<br />	char*&nbsp;rsa_public_pem&nbsp;=&nbsp;&quot;-----BEGIN&nbsp;PUBLIC&nbsp;KEY-----&quot;<br />		&quot;MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwA0QE3gLfbPnhFepeKxk&quot;<br />		&quot;MAUSi+6cBE9narr7eiY9yVLVUlWGfHIHjRXSN0VB26Alz7pZc5ZUJlsegep82jND&quot;<br />		&quot;6sjDbthh8FixSc9npI3lDWqI6d2gFw4sJVj+0H83vg1NOOyRrKKY9NXA8iXvGDMK&quot;<br />		&quot;Y2+nhenQlDEjg+JBHiFs5fA38leFMoe26Qc+so1CRwHspgg7GHHC8DgV6+XbHQfA&quot;<br />		&quot;GA+nm8KBBp/vkJyw4ng58kVrRNpDlSHpjYXuzkDEfX2OOd6BgQRp1RpTLZ2UM2tN&quot;<br />		&quot;NEiJ6ITgCTbgFs8zGInoRnGh9vsqwkiCevro0yMUBSn+rVQ1Y2BzxAV8u4MZfJ/s&quot;<br />		&quot;vQIDAQAB&quot;<br />		&quot;-----END&nbsp;PUBLIC&nbsp;KEY-----&quot;;<br /><br />	b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_RSAprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;PROV_RSA_AES,&nbsp;CRYPT_VERIFYCONTEXT);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		if&nbsp;(GetLastError()&nbsp;==&nbsp;NTE_BAD_KEYSET)<br />		{<br />			b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_RSAprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;PROV_RSA_AES,&nbsp;CRYPT_VERIFYCONTEXT&nbsp;|&nbsp;CRYPT_NEWKEYSET);<br />			if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />			{<br />				i&nbsp;=&nbsp;1;<br />				goto&nbsp;cleanup;<br />			}<br />		}<br />		else<br />		{<br />			i&nbsp;=&nbsp;1;<br />			goto&nbsp;cleanup;<br />		}<br />	}<br /><br />	//&nbsp;Convert&nbsp;RSA&nbsp;PEM&nbsp;public&nbsp;key&nbsp;to&nbsp;DER<br />	b&nbsp;=&nbsp;CryptStringToBinaryA(rsa_public_pem,&nbsp;0,&nbsp;CRYPT_STRING_BASE64HEADER,&nbsp;rsa_public_der,&nbsp;&amp;rsa_der_len,&nbsp;NULL,&nbsp;NULL);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;convert&nbsp;PEM&nbsp;to&nbsp;DER:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Decode&nbsp;DER&nbsp;to&nbsp;CERT_PUBLIC_KEY_INFO<br />	PCERT_PUBLIC_KEY_INFO&nbsp;rsa_public_info&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;rsa_public_info_len&nbsp;=&nbsp;sizeof(CERT_PUBLIC_KEY_INFO);<br />	b&nbsp;=&nbsp;CryptDecodeObjectEx(X509_ASN_ENCODING,&nbsp;X509_PUBLIC_KEY_INFO,&nbsp;rsa_public_der,&nbsp;rsa_der_len,&nbsp;CRYPT_ENCODE_ALLOC_FLAG,&nbsp;NULL,&nbsp;&amp;rsa_public_info,&nbsp;&amp;rsa_public_info_len);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;decode&nbsp;DER&nbsp;to&nbsp;CERT_PUBLIC_KEY_INFO:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Import&nbsp;the&nbsp;key<br />	b&nbsp;=&nbsp;CryptImportPublicKeyInfo(h_RSAprovider,&nbsp;X509_ASN_ENCODING,&nbsp;rsa_public_info,&nbsp;&amp;h_RSAkey);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;import&nbsp;RSA&nbsp;public&nbsp;key:&nbsp;0x%x&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />cleanup:<br />	if&nbsp;(h_RSAkey)&nbsp;CryptDestroyKey(h_RSAkey);<br />	if&nbsp;(h_RSAprovider)&nbsp;CryptReleaseContext(h_RSAprovider,&nbsp;0);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
