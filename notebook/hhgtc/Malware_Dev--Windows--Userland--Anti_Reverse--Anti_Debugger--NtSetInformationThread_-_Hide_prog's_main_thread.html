<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NtSetInformationThread - Hide prog's main thread</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># NtSetInformationThread - Hide prog&#39;s main thread</h1></strong><br />• <a href="https://ntquery.wordpress.com/2014/03/29/anti-debug-ntsetinformationthread/">https://ntquery.wordpress.com/2014/03/29/anti-debug-ntsetinformationthread/</a><br />• <a href="https://github.com/cetfor/AntiDBG/blob/89f8fb7fb572aae326c2b0538e9e2b2cf56cf102/antidbg/antidbg.c#L293">https://github.com/cetfor/AntiDBG/blob/89f8fb7fb572aae326c2b0538e9e2b2cf56cf102/antidbg/antidbg.c#L293</a><br />• <a href="https://guidedhacking.com/threads/how-to-find-hidden-threads-threadhidefromdebugger-antidebug-trick.14281/">https://guidedhacking.com/threads/how-to-find-hidden-threads-threadhidefromdebugger-antidebug-trick.14281/</a><br /><br />NtSetInformationThread sets the priority of a thread.<br />It takes a value from the <code>THREADINFOCLASS</code> structure.<br />THREADINFOCLASS contains an undocumented member call <code>ThreadHideFromDebugger</code> - <code>0x11</code><br /><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/api/ps/psquery/class.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/api/ps/psquery/class.htm</a><br /><br />You can hide your program&#39;s main thread from the debugger.<br />After it&#39;s hidden, the debugger will close/crash.<br /><br /><code>ThreadHideFromDebugger</code> exists because:<br />when you attach a debugger to a process, a new thread gets created.<br />If this thread isn&#39;t hidden from the debugger, the debugger will begin debugging its own debugging thread, and be caught in an endless loop.<br />Therfore, when the debugging thread is created, Windows calls <code>NtSetInformationThread</code> and <code>ThreadHideFromDebugger</code> is set.<br /><br />Plugins to hide the debugger don&#39;t work against this method (so far. only tested x64dbg).<br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />typedef&nbsp;NTSTATUS(__stdcall*&nbsp;t_NtSetInformationThread)(<br />	HANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThreadHandle,<br />	THREADINFOCLASS&nbsp;ThreadInformationClass,<br />	PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThreadInformation,<br />	ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThreadInformationLength<br />);<br /><br />/*<br />Hide&nbsp;the&nbsp;main&nbsp;thread&nbsp;from&nbsp;the&nbsp;debugger.<br />Any&nbsp;attempt&nbsp;to&nbsp;control&nbsp;the&nbsp;process&nbsp;afer&nbsp;this&nbsp;call&nbsp;will&nbsp;end&nbsp;the&nbsp;debugging&nbsp;session.<br />*/<br />void&nbsp;AntiDebugger_HideMainThread(void)<br />{<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;0;<br />	DWORD&nbsp;ThreadHideFromDebugger&nbsp;=&nbsp;0x11;<br /><br />	t_NtSetInformationThread&nbsp;d_NtSetInformationThread&nbsp;=&nbsp;(t_NtSetInformationThread)GetProcAddress(GetModuleHandleA(&quot;Ntdll.dll&quot;),&nbsp;&quot;NtSetInformationThread&quot;);<br />	nt_status&nbsp;=&nbsp;d_NtSetInformationThread(GetCurrentThread(),&nbsp;ThreadHideFromDebugger,&nbsp;0,&nbsp;0);<br />	if&nbsp;(!NT_SUCCESS(nt_status))<br />		printf(&quot;[-]&nbsp;failed&nbsp;to&nbsp;hide&nbsp;thread&nbsp;from&nbsp;debugger&nbsp;\n&quot;);<br />	<br />	return;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	AntiDebugger_HideMainThread();<br />	printf(&quot;hey&nbsp;:)&nbsp;\n&quot;);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Demo</h2></strong><br />If we set a breakpoint just before <code>NtSetInformationThread</code> is run, <br />we can see that the program is running fine.<br /><a href=""><img src="images/1779-1.png" alt="images/1779-1.png" /></a><br /><br />Now we step forward 1 instruction, <code>NtSetInformationThread</code> runs, and the debugging session closes.<br /><a href=""><img src="images/1779-2.png" alt="images/1779-2.png" /></a><br /><br />Sometimes the program crashes, sometimes it says the thread exited.<br />But debugging stops.<br /><br /><strong><h2>## Bypass</h2></strong><br />• <code>nop</code> the <code>NtSetInformationThread</code> function that hides the thread<br />• replace int3 with a nop?<br />• Hook <code>NtSetInformationThread</code><br /><br />We&#39;ve set a breakpoint on the call to <code>NtSetInformationThread</code><br /><a href=""><img src="images/1779-3.png" alt="images/1779-3.png" /></a><br /><br />Just fill it with NOPs.<br />The call to <code>NtSetInformationThread</code> won&#39;t happen and code execution will just continue.<br /><a href=""><img src="images/1779-4.png" alt="images/1779-4.png" /></a><br /><br /><a href=""><img src="images/1779-5.png" alt="images/1779-5.png" /></a><br /><br />However, if there was error checking on the <code>NtSetInformationThread</code> code<br />i.e. if <code>NtSetInformationThread</code> fails, exit the program, then you would need to handle the exit too.</div>
</body>
</html>
