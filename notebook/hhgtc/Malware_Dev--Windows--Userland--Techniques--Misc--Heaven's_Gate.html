<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Heaven's Gate</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Heaven&#39;s Gate / 0x33 Segment Selctor</h1></strong><br /><strong>Heaven&#39;s Gate</strong><br />• Original author - Roy G. Biv<br />   ◇ <a href="https://vxug.fakedoma.in/archive/VxHeaven/lib/vrg02.html">https://vxug.fakedoma.in/archive/VxHeaven/lib/vrg02.html</a><br />   ◇ <a href="https://github.com/darkspik3/Valhalla-ezines/blob/master/Valhalla%20%231/articles/HEAVEN.TXT">https://github.com/darkspik3/Valhalla-ezines/blob/master/Valhalla%20%231/articles/HEAVEN.TXT</a><br />• <a href="https://www.alex-ionescu.com/?p=300">https://www.alex-ionescu.com/?p=300</a> - Very very good overview<br />• <a href="http://rce.co/knockin-on-heavens-gate-dynamic-processor-mode-switching/">http://rce.co/knockin-on-heavens-gate-dynamic-processor-mode-switching/</a> - Explanation and how-to<br />• <a href="https://www.malwaretech.com/2013/06/rise-of-dual-architecture-usermode.html">https://www.malwaretech.com/2013/06/rise-of-dual-architecture-usermode.html</a> - About syscalls/WoW64 and touches on heaven&#39;s gate<br />• <a href="https://www.malwaretech.com/2014/02/the-0x33-segment-selector-heavens-gate.html">https://www.malwaretech.com/2014/02/the-0x33-segment-selector-heavens-gate.html</a> - Low level analysis #2<br /><br /><strong>Example Implementations</strong><br />• <a href="http://blog.rewolf.pl/blog/?p=102">http://blog.rewolf.pl/blog/?p=102</a><br />• <a href="https://github.com/JustasMasiulis/wow64pp">https://github.com/JustasMasiulis/wow64pp</a><br />• <a href="https://int0h.wordpress.com/2009/12/24/the-power-of-wow64/">https://int0h.wordpress.com/2009/12/24/the-power-of-wow64/</a><br />• <a href="https://github.com/georgenicolaou/W64oWoW64">https://github.com/georgenicolaou/W64oWoW64</a> - Library<br /><br /><strong><h2>## About Heaven&#39;s Gate</h2></strong><br />Heaven&#39;s Gate is the name for a technique where,<br />in 32bit processes running on 64bit Windows (WoW64 processes),<br />you shift into 64bit mode and execute 64bit code inside of a 32bit process.<br /><br />This is mostly used for stealth purposes:<br />to evade hooks, to make debugging difficult, to inject into 64bit processes, etc.<br /><br />Most implementations of Heaven&#39;s Gate will switch into 64bit mode,<br />and then load a 64bit Kernel32.dll so that they can do further things / load more DLLs.<br /><br /><strong>NOTE</strong><br />Heaven&#39;s Gate is effectively dead on Windows 10 because of CFG - Control Flow Guard.<br />But NOT according to this guy? - <a href="https://github.com/dadas190/Heavens-Gate-2.0">https://github.com/dadas190/Heavens-Gate-2.0</a><br /><br /><strong>Alternatives</strong><br />• Hook Heaven&#39;s Gate (refer to Hooking &gt; Hooking WoW64 node)<br /><br /><strong><h2>## Uses</h2></strong><br /><strong><h3>### Bypass Hooks on 32bit Ntdll.dll in WoW64 Process</h3></strong><br />Antivirus solutions, sandboxes, and Microsoft&#39;s EMET<br />typically only hook the 32bit Ntdll.dll in a WoW64 process<br />because it assumes that the 64bit Ntdll.dll can&#39;t be reached (because it&#39;s a 32bit process)<br /><br />By shifting into 64bit mode whilst in a WoW64 process,<br />you can evade hooks by antivirus.<br /><br />Examples<br />• <a href="https://duo.com/assets/pdf/wow-64-and-so-can-you.pdf">https://duo.com/assets/pdf/wow-64-and-so-can-you.pdf</a><br />• <a href="https://docplayer.net/30633034-Phenom-bypassing-antiviruses.html">https://docplayer.net/30633034-Phenom-bypassing-antiviruses.html</a> - Phenom malware<br />• <a href="https://int0xcc.svbtle.com/notes-on-vawtrak-banking-malware">https://int0xcc.svbtle.com/notes-on-vawtrak-banking-malware</a> - Vawtrak banking malware<br /><br /><strong><h3>### Evade 32bit Debuggers with a 32bit .exe and WoW64 Code</h3></strong><br />When debugging a 32bit application in a 64bit debugger on Windows x64,<br />you&#39;re forced to use manual commands and extensions to investigate the 32bit state.<br /><br />To solve this, Microsoft recommends using 32bit WinDBG which will show the 32bit state of the process.<br />Other 32bit debuggers behave the same.<br /><br />However, if you&#39;re using Heaven&#39;s Gate,<br />these 32bit debuggers will miss the 64bit heaven&#39;s gate code<br />(or it will be obfuscated)<br /><br />Examples:<br />• <a href="https://scrammed.blogspot.com/2014/10/code-obfunscation-mixing-32-and-64-bit.html">https://scrammed.blogspot.com/2014/10/code-obfunscation-mixing-32-and-64-bit.html</a><br /><br /><strong><h3>### Misdirect / Cause emulation engines to ignore code</h3></strong><br />Emulation engines will try to emulate the x86 instructions.<br />If it sees x64 instructions, it will ignore them because it never exepcts them to be executed.<br />If you&#39;re using Heaven&#39;s Gate, this can leave any x86 code you write to be dummy code to<br />researchers looking at your file.<br /><br />Examples:<br />• <a href="http://www.hexacorn.com/blog/2015/10/26/heavens-gate-and-a-chameleon-code-x8664/">http://www.hexacorn.com/blog/2015/10/26/heavens-gate-and-a-chameleon-code-x8664/</a><br /><br /><strong><h2>## Mitigations</h2></strong><br />Defenses against Heaven&#39;s Gate.<br /><br /><strong><h3>### Control Flow Guard on Windows 10</h3></strong><br /><a href="https://www.alex-ionescu.com/?p=300">https://www.alex-ionescu.com/?p=300</a><br /><br />About CFG:<br />• <a href="http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf">http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf</a><br />• <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Zhang-Bypass-Control-Flow-Guard-Comprehensively-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Zhang-Bypass-Control-Flow-Guard-Comprehensively-wp.pdf</a></div>
</body>
</html>
