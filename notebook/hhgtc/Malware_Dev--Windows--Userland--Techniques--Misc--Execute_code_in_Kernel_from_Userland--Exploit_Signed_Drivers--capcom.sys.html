<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>capcom.sys</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1># Capcom.sys</h1><br />• <a href="https://www.youtube.com/watch?v=pJZjWXxUEl4">https://www.youtube.com/watch?v=pJZjWXxUEl4</a> - Good explanation/demo/video<br />• <a href="https://www.fuzzysecurity.com/tutorials/28.html">https://www.fuzzysecurity.com/tutorials/28.html</a> - PowerShell code?! But good explanations<br />• <a href="https://github.com/tandasat/ExploitCapcom">https://github.com/tandasat/ExploitCapcom</a><br />• <a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/189625-capcom-sys-usage-example.html">https://www.unknowncheats.me/forum/general-programming-and-reversing/189625-capcom-sys-usage-example.html</a><br />• <a href="https://securelist.com/elevation-of-privileges-in-namco-driver/83707/">https://securelist.com/elevation-of-privileges-in-namco-driver/83707/</a> - Explanation of bandainamcoonline.sys which is compiled from the same source as capcom.sys<br /><br />The capcom.sys driver allows you to execute kernel code from userland.<br /><br /><strong><h2>## Explanation</h2></strong><br />The capcom driver when sent IOCTL <code>0xAA013044</code> (<code>0xAA012044 on x86</code>) <br />• disables SMEP<br />• takes a pointer to userland memory<br />and then executes that memory.<br /><br />SMEP stands for Supervisor Mode Execution Protection.<br />It&#39;s a kernel mode protection which prevents kerneland code from executing userland memory pages.<br />In short, it verifies that kernel drivers can only execute kernel land code in kernel land memory pages.<br /><br />By disabling SMEP, you allow kernel code to execute code in userland memory pages.<br /><a href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/02/07163819/180201-Elevation-of-Privileges-in-Namco-6.png"><img src="images/1724-1.png" alt="images/1724-1.png" /></a><br /><br /><strong><h3>### Bugs</h3></strong><br />The capcom.sys driver also has a bug which prevents the capcom.sys exploit<br />from working on Windows 10 x64 20H2 because Driver Verifier.<br /><br />• <a href="https://github.com/tandasat/ExploitCapcom/issues/3">https://github.com/tandasat/ExploitCapcom/issues/3</a><br />At the end of its IRP_MJ_DEVICE_CONTROL function <br />it tries to return the status value in Irp-&gt;IoStatus.Status but Irp struct the line before.<br />Therefore on return it crashes.<br /><div class="codebox"><div class="codebox">&nbsp;&nbsp;//&nbsp;..<br />&nbsp;&nbsp;IofCompleteRequest(Irp,&nbsp;0);		//&nbsp;Frees&nbsp;Irp<br />&nbsp;&nbsp;return&nbsp;Irp-&gt;IoStatus.Status;&nbsp;&nbsp;&nbsp;//&nbsp;Tries&nbsp;to&nbsp;return&nbsp;value&nbsp;from&nbsp;Irp<br />}</div></div><br /><br />There&#39;s a fix for this which uses shellcode<br />(as far as I can make sense it clears the Irp pointer so that the return will return NULL)<br />• <a href="https://github.com/tandasat/ExploitCapcom/pull/4">https://github.com/tandasat/ExploitCapcom/pull/4</a><br /><br /><h2>## Modern Day</h2><br />• <a href="https://www.unknowncheats.me/forum/2502644-post4.html">https://www.unknowncheats.me/forum/2502644-post4.html</a><br /><br />As of June 2019, the Capcom.sys driver is potentially blacklisted by Microsoft.<br />It potentially won&#39;t even load.</div>
</body>
</html>
