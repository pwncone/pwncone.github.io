<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Syscalls</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Syscalls</h1></strong><br /><strong>Links:</strong><br />• <a href="https://en.wikipedia.org/wiki/System_call">https://en.wikipedia.org/wiki/System_call</a><br />• <a href="https://jhalon.github.io/utilizing-syscalls-in-csharp-1/">https://jhalon.github.io/utilizing-syscalls-in-csharp-1/</a> - Good explanation of syscalls but C# implementation<br />• <a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/">https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/</a> - Good explanation, goes in-depth<br />• <a href="https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs">https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs</a> - A how-to about using syscalls<br />• <a href="https://medium.com/@fsx30/hooking-heavens-gate-a-wow64-hooking-technique-5235e1aeed73">https://medium.com/@fsx30/hooking-heavens-gate-a-wow64-hooking-technique-5235e1aeed73</a> - About heaven&#39;s gate but covers syscalls too<br />• <a href="https://www.malwaretech.com/2013/06/rise-of-dual-architecture-usermode.html">https://www.malwaretech.com/2013/06/rise-of-dual-architecture-usermode.html</a> - About syscalls/WoW64 and touches on heaven&#39;s gate<br /><br />Easy clear to read articles:<br />• <a href="https://www.malwaretech.com/2014/06/usermode-system-call-hooking-betabo.html">https://www.malwaretech.com/2014/06/usermode-system-call-hooking-betabo.html</a><br />• <a href="https://www.malwaretech.com/2015/07/windows-10-system-call-stub-changes.html">https://www.malwaretech.com/2015/07/windows-10-system-call-stub-changes.html</a><br /><br /><strong>Libraries:</strong><br />• <a href="https://github.com/JustasMasiulis/inline_syscall">https://github.com/JustasMasiulis/inline_syscall</a><br />   ◇ scrapes the in-memory NTDLL module in order to extract the raw syscall numbers<br />   ◇ can&#39;t be compiled with msvc or gcc (use mingw. don&#39;t know of other compilers)<br />   ◇ example: <a href="https://iwantmore.pizza/posts/PEzor.html#shellcode-injection-with-syscall-inlining">https://iwantmore.pizza/posts/PEzor.html#shellcode-injection-with-syscall-inlining</a><br /><br />By using the <code>syscall</code> instruction, you can bypass calling Windows APIs.<br />This can have a variety of benefits:<br />• bypass userland hooks (because you&#39;re not calling the API function)<br />• hide your imports (because you&#39;re not calling any Windows APIs)<br /><br /><strong><h2>## About System Calls</h2></strong><br />Userland APIs provide access to a number of useful functions, such as:<br />• <code>CreateProcess</code> for spawning processes<br />• <code>CreateFile</code> for saving/creating files<br /><br />However, these functions are privileged instructions.<br />This is because they require access to the kernel.<br /><br />Privileged instructions might require access to the kernel for a multitude reasons, like:<br />• using kernel data structures - like the <code>EPROCESS</code> list in <code>NtCreateProcess</code><br />• accessing hardware - like writing files to disk in <code>NtWriteFile</code><br /><br />A system call is how a userland program requests access to the kernel,<br />and a system call instruction is how the CPU switches from Ring 3 (userland) to Ring 0 (kernel mode).<br />• <code>sysenter</code> on x86<br />• <code>syscall</code> on x64<br /><br />With the CPU in ring 0 (kernel mode), <br />it will be able to access kernel mode structures and do kernel things (access hardware, etc.)<br /><br /><strong><h3>### Userland API -&gt; Native API -&gt; ntoskrnl.exe</h3></strong><br />The Userland APIs - <code>CreateProcess</code>, <code>CreateFile</code> -<br />set up parameters on the stack and pass execution to the Native API.<br /><br />The Native API in Ntdll.dll - <code>NtCreateProcess</code>, <code>NtCreateFile</code> -<br />switches the CPU into kernel mode.<br /><br />Now in kernel mode, <code>ntoskrnl.exe</code> will call further internal kernel functions<br />to carry out the function call - <code>IopCreateFile</code><br /><br /><strong><h3>### ntoskrnl.exe</h3></strong><br /><code>Ntdll.dll</code> exports all of <code>ntoskrnl.exe</code>&#39;s functions and handles syscalls into the kernel.<br /><code>ntoskrnl.exe</code> is where the code for all of the internal Windows API functions code actually lives.<br /><br /><strong><h2>## NtCreateFile Example</h2></strong><br /><strong><h3>### Ntdll.dll</h3></strong><br />Here&#39;s <code>NtCreateFile</code> from <code>Ntdll.dll</code> on <code>Windows 10 x64</code><br />It&#39;s moving the syscall value for NtCreateFile - <code>55h</code> - into EAX and then executing <code>syscall</code>.<br />The CPU&#39;s execution mode will jump into kernel mode.<br /><div class="codebox"><div class="codebox">lkd&gt;&nbsp;uf&nbsp;ntdll!NtCreateFile<br />ntdll!NtCreateFile:<br />00007ffe`cdaaca40&nbsp;4c8bd1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r10,rcx<br />00007ffe`cdaaca43&nbsp;b855000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,55h<br />00007ffe`cdaaca48&nbsp;f604250803fe7f01&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[SharedUserData+0x308&nbsp;(00000000`7ffe0308)],1<br />00007ffe`cdaaca50&nbsp;7503&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntdll!NtCreateFile+0x15&nbsp;(00007ffe`cdaaca55)&nbsp;&nbsp;Branch<br /><br />ntdll!NtCreateFile+0x12:<br />00007ffe`cdaaca52&nbsp;0f05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;syscall<br />00007ffe`cdaaca54&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret</div></div><br /><br /><strong><h3>### ntoskrnl.exe</h3></strong><br />Here&#39;s <code>NtCreateFile</code> from <code>ntoskrnl.exe</code><br />The CPU is now executing in kernel mode.<br />NtCreateFile sets up the parameters on the stack and then calls further internel kernel functions to create the file.<br /><div class="codebox"><div class="codebox">lkd&gt;&nbsp;uf&nbsp;nt!NtCreateFile<br />nt!NtCreateFile:<br />fffff802`08c6ccb0&nbsp;4881ec88000000&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsp,88h<br />fffff802`08c6ccb7&nbsp;33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax<br />fffff802`08c6ccb9&nbsp;4889442478&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[rsp+78h],rax<br />fffff802`08c6ccbe&nbsp;c744247020000000&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[rsp+70h],20h<br />...<br />...<br />...<br />...<br />fffff802`08c6cd24&nbsp;e817000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;nt!IopCreateFile&nbsp;(fffff802`08c6cd40)<br />fffff802`08c6cd29&nbsp;4881c488000000&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsp,88h<br />fffff802`08c6cd30&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret</div></div><br /><br /><strong><h2>## NtWriteFile Example</h2></strong><br />Here&#39;s a great diagram from <code>outflank.nl</code> about the calling process for Notepad calling <code>WriteFile</code>:<br />1. <code>WriteFile</code> called<br />2. <code>NtWriteFile</code> from ntdll.dll executes syscall<br />3. The CPU is now running in kernel mode and <code>ntoskrnl.exe</code> calls <code>NtWriteFile</code> to create the file<br /><a href=""><img src="images/1712-1.png" alt="images/1712-1.png" /></a><br /><br />By executing what Ntdll.dll basically does, and copying the syscall value for the function you want into EAX and calling <code>syscall</code>, you can bypass calling any Windows APIs and subvert monitoring of your code.</div>
</body>
</html>
