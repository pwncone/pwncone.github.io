<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Assess IKE</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Assess IKE</h1></strong><br /><code>Nmap</code> can be used to retrieve initial information about the VPN service, <br />but <code>ike-scan</code> is more in-depth.<br /><br /><strong><h2>## Nmap</h2></strong><br />Just use service enumeration <code>-sV</code> and default scripts <code>-sC</code> against the port.<br /><code>-sU</code> for UDP<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;nmap&nbsp;-p&nbsp;500&nbsp;-sU&nbsp;-sV&nbsp;-sC&nbsp;10.10.10.116<br />...<br />PORT&nbsp;&nbsp;&nbsp;&nbsp;STATE&nbsp;SERVICE&nbsp;VERSION<br />500/udp&nbsp;open&nbsp;&nbsp;isakmp&nbsp;&nbsp;Microsoft&nbsp;Windows&nbsp;8<br />|&nbsp;ike-version:&nbsp;<br />|&nbsp;&nbsp;&nbsp;vendor_id:&nbsp;Microsoft&nbsp;Windows&nbsp;8<br />|&nbsp;&nbsp;&nbsp;attributes:&nbsp;<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MS&nbsp;NT5&nbsp;ISAKMPOAKLEY<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RFC&nbsp;3947&nbsp;NAT-T<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;draft-ietf-ipsec-nat-t-ike-02\n<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IKE&nbsp;FRAGMENTATION<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MS-Negotiation&nbsp;Discovery&nbsp;Capable<br />|_&nbsp;&nbsp;&nbsp;&nbsp;IKE&nbsp;CGA&nbsp;version&nbsp;1<br />Service&nbsp;Info:&nbsp;OS:&nbsp;Windows&nbsp;8;&nbsp;CPE:&nbsp;cpe:/o:microsoft:windows:8,&nbsp;cpe:/o:microsoft:windows</div></div><br /><br />The output is more readble than ike-scan, to be honest.<br /><br /><strong><h2>## ike-scan</h2></strong><br /><code>ike-scan</code> supports IKE but has limited IKEv2 support (as of December 2016).<br /><br />This technique will identify most IPsec servers, but can fail if the IKE service honors only requests from specific addresses or expects certain <em>transform</em> <em>sets</em>. An IKE <em>transform set</em> defines the encryption algorithm, integrity algorithm, authentication mode, and Diffie-Hellman (DH) group used during key exchange<br /><br /><code>-M</code> = multiline/tabbed output (easier to read)<br /><br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ike-scan&nbsp;-M&nbsp;10.10.10.116<br />Starting&nbsp;ike-scan&nbsp;1.9.4&nbsp;with&nbsp;1&nbsp;hosts&nbsp;(http://www.nta-monitor.com/tools/ike-scan/)<br />10.10.10.116	Main&nbsp;Mode&nbsp;Handshake&nbsp;returned<br />	HDR=(CKY-R=ca0a7c616a6bb432)<br />	SA=(Enc=3DES&nbsp;Hash=SHA1&nbsp;Group=2:modp1024&nbsp;Auth=PSK&nbsp;LifeType=Seconds&nbsp;LifeDuration(4)=0x00007080)<br />	VID=1e2b516905991c7d7c96fcbfb587e46100000009&nbsp;(Windows-8)<br />	VID=4a131c81070358455c5728f20e95452f&nbsp;(RFC&nbsp;3947&nbsp;NAT-T)<br />	VID=90cb80913ebb696e086381b5ec427b1f&nbsp;(draft-ietf-ipsec-nat-t-ike-02\n)<br />	VID=4048b7d56ebce88525e7de7f00d6c2d3&nbsp;(IKE&nbsp;Fragmentation)<br />	VID=fb1de3cdf341b7ea16b7e5be0855f120&nbsp;(MS-Negotiation&nbsp;Discovery&nbsp;Capable)<br />	VID=e3a5966a76379fe707228231e5ce8652&nbsp;(IKE&nbsp;CGA&nbsp;version&nbsp;1)<br /><br />Ending&nbsp;ike-scan&nbsp;1.9.4:&nbsp;1&nbsp;hosts&nbsp;scanned&nbsp;in&nbsp;0.046&nbsp;seconds&nbsp;(21.70&nbsp;hosts/sec).&nbsp;&nbsp;1&nbsp;returned&nbsp;handshake;&nbsp;0&nbsp;returned&nbsp;notify</div></div><br /><br /><strong><h3>### IKE service fingerprinting</h3></strong><br />The <code>ike-scan</code> utility identifies IPsec implementations through analysis of the vendor ID value and IKE backoff pattern.<br /><br /><code>-o</code> = Display the backoff fingerprint table and IPsec implementation guess (based on backoff pattern)<br />        default wait time after receiving last packet is 60 seconds<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ike-scan&nbsp;-M&nbsp;-o&nbsp;10.10.10.116<br />...<br />IKE&nbsp;Backoff&nbsp;Patterns:<br /><br />IP&nbsp;Address	No.	Recv&nbsp;time		Delta&nbsp;Time<br />10.10.10.116	1	1568122921.084773	0.000000<br />10.10.10.116	Implementation&nbsp;guess:&nbsp;Linksys&nbsp;Etherfast</div></div><br /><br /><strong><h3>### Transform Set Enumeration</h3></strong><br />An IKE <em>transform set</em> defines the encryption algorithm, integrity algorithm (hash type), authentication mode, and Diffie-Hellman (DH) group used during key exchange. You can use <code>ike-scan</code> with a specified transform set.<br /><br />This line from the original scan:<br /><code>SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK</code> - identifies the Security Assosciation&#39;s transform set.<br /><br />There are 2 ways to specify a <em>transform set</em> in ike-scan:<br />• <code>--trans</code> - the new way (where specify attribute=&lt;value&gt;, e.g. attribute 2 = 4 which means Hash type = SHA-256)<br />   ◇ <code>--trans=&quot;(1=5,2=2,3=1,4=2)&quot;</code><br />   ◇ <code>ike-scan -M --trans=&quot;(1=5,2=2,3=1,4=2)&quot; -o 10.10.10.116</code><br />• <code>-a</code> - the old way<br />   ◇ <code>-a 5,2,1,2</code><br />   ◇ <code>ike-scan -M -a 5,2,1,2 -o 10.10.10.116</code><br /><br />1st value = Encryption algorithm - <code>Enc=3DES</code><br />2nd value = Hash type - <code>Hash=SHA1</code><br />3rd value = Authentication method - <code>Auth=PSK</code><br />4th value = Diffie-Hellman key exchange group - <code>Group=2:modp1024</code><br /><br /><em><strong>IKE transform fields and common values are as follows:</strong></em><br /><em>• Encryption algorithms</em><br />   ◇ 1 (DES), 5 (3DES), 7/128 (AES-128), and 7/256 (AES-256)<br /><em>• Integrity algorithms (hash type)</em><br />   ◇ 1 (MD5) and 2 (SHA-1), 4 (SHA-256), 5 (SHA-384), and 6 (SHA-512)<br /><em>• Authentication methods</em><br />   ◇ 1 (PSK), 3 (RSA), and 65001 (XAUTH)<br /><em>• DH groups</em><br />   ◇ 1 (768-bit), 2 (1,024-bit), and 5 (1,536-bit), 14 (2,048-bit), and 15 (3,072-bit)<br /><br /><em><strong>Examples</strong></em><br /><code>-a</code> Old Way<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ike-scan&nbsp;-M&nbsp;-a&nbsp;5,2,1,2&nbsp;-o&nbsp;10.10.10.116<br />Starting&nbsp;ike-scan&nbsp;1.9.4&nbsp;with&nbsp;1&nbsp;hosts&nbsp;(http://www.nta-monitor.com/tools/ike-scan/)<br />10.10.10.116	Main&nbsp;Mode&nbsp;Handshake&nbsp;returned<br />	HDR=(CKY-R=9d22de37b84ed547)<br />	SA=(Enc=3DES&nbsp;Hash=SHA1&nbsp;Group=2:modp1024&nbsp;Auth=PSK&nbsp;LifeType=Seconds&nbsp;LifeDuration(4)=0x00007080)<br />	VID=1e2b516905991c7d7c96fcbfb587e46100000009&nbsp;(Windows-8)<br />	VID=4a131c81070358455c5728f20e95452f&nbsp;(RFC&nbsp;3947&nbsp;NAT-T)<br />	VID=90cb80913ebb696e086381b5ec427b1f&nbsp;(draft-ietf-ipsec-nat-t-ike-02\n)<br />	VID=4048b7d56ebce88525e7de7f00d6c2d3&nbsp;(IKE&nbsp;Fragmentation)<br />	VID=fb1de3cdf341b7ea16b7e5be0855f120&nbsp;(MS-Negotiation&nbsp;Discovery&nbsp;Capable)<br />	VID=e3a5966a76379fe707228231e5ce8652&nbsp;(IKE&nbsp;CGA&nbsp;version&nbsp;1)<br /><br />IKE&nbsp;Backoff&nbsp;Patterns:<br /><br />IP&nbsp;Address	No.	Recv&nbsp;time		Delta&nbsp;Time<br />10.10.10.116	1	1568124055.680942	0.000000<br />10.10.10.116	Implementation&nbsp;guess:&nbsp;Linksys&nbsp;Etherfast<br /><br />Ending&nbsp;ike-scan&nbsp;1.9.4:&nbsp;1&nbsp;hosts&nbsp;scanned&nbsp;in&nbsp;60.067&nbsp;seconds&nbsp;(0.02&nbsp;hosts/sec).&nbsp;&nbsp;1&nbsp;returned&nbsp;handshake;&nbsp;0&nbsp;returned&nbsp;notify</div></div><br /><br /><code>--trans</code> New Way<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ike-scan&nbsp;-M&nbsp;--trans=&quot;(1=5,2=2,3=1,4=2)&quot;&nbsp;-o&nbsp;10.10.10.116<br />Starting&nbsp;ike-scan&nbsp;1.9.4&nbsp;with&nbsp;1&nbsp;hosts&nbsp;(http://www.nta-monitor.com/tools/ike-scan/)<br />10.10.10.116	Main&nbsp;Mode&nbsp;Handshake&nbsp;returned<br />	HDR=(CKY-R=3657a4ee454e10ab)<br />	SA=(Enc=3DES&nbsp;Hash=SHA1&nbsp;Group=2:modp1024&nbsp;Auth=PSK)<br />	VID=1e2b516905991c7d7c96fcbfb587e46100000009&nbsp;(Windows-8)<br />	VID=4a131c81070358455c5728f20e95452f&nbsp;(RFC&nbsp;3947&nbsp;NAT-T)<br />	VID=90cb80913ebb696e086381b5ec427b1f&nbsp;(draft-ietf-ipsec-nat-t-ike-02\n)<br />	VID=4048b7d56ebce88525e7de7f00d6c2d3&nbsp;(IKE&nbsp;Fragmentation)<br />	VID=fb1de3cdf341b7ea16b7e5be0855f120&nbsp;(MS-Negotiation&nbsp;Discovery&nbsp;Capable)<br />	VID=e3a5966a76379fe707228231e5ce8652&nbsp;(IKE&nbsp;CGA&nbsp;version&nbsp;1)<br /><br />IKE&nbsp;Backoff&nbsp;Patterns:<br /><br />IP&nbsp;Address	No.	Recv&nbsp;time		Delta&nbsp;Time<br />10.10.10.116	1	1568124230.839437	0.000000<br />10.10.10.116	Implementation&nbsp;guess:&nbsp;Linksys&nbsp;Etherfast<br /><br />Ending&nbsp;ike-scan&nbsp;1.9.4:&nbsp;1&nbsp;hosts&nbsp;scanned&nbsp;in&nbsp;60.059&nbsp;seconds&nbsp;(0.02&nbsp;hosts/sec).&nbsp;&nbsp;1&nbsp;returned&nbsp;handshake;&nbsp;0&nbsp;returned&nbsp;notify</div></div><br /><br />If the transform set is wrong, you&#39;ll just not get any information back<br /><div class="codebox"><div class="codebox">root@gotham:~/ctf/conceal#&nbsp;ike-scan&nbsp;-M&nbsp;--trans=&quot;(1=4,2=2,3=1,4=2)&quot;&nbsp;-o&nbsp;10.10.10.116<br />Starting&nbsp;ike-scan&nbsp;1.9.4&nbsp;with&nbsp;1&nbsp;hosts&nbsp;(http://www.nta-monitor.com/tools/ike-scan/)<br />10.10.10.116	Notify&nbsp;message&nbsp;14&nbsp;(NO-PROPOSAL-CHOSEN)<br />	HDR=(CKY-R=7b4d440e94aae4c1,&nbsp;msgid=38f8e804)<br /><br />Ending&nbsp;ike-scan&nbsp;1.9.4:&nbsp;1&nbsp;hosts&nbsp;scanned&nbsp;in&nbsp;0.043&nbsp;seconds&nbsp;(23.22&nbsp;hosts/sec).&nbsp;&nbsp;0&nbsp;returned&nbsp;handshake;&nbsp;1&nbsp;returned&nbsp;notify</div></div><br /></div>
</body>
</html>
