<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Writing Loader Shellcode in C in Visual Studio</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Writing Loader Shellcode in C in Visual Studio</h1></strong><br />If you&#39;re writing loader shellcode,<br />you don&#39;t want any excess overhead<br />and you don&#39;t want any of the CRT (C runtime) code.<br /><br /><strong><h2>## Disabling CRT</h2></strong><br /><a href="https://stackoverflow.com/questions/39217241/visual-studio-2015-compile-c-c-without-a-runtime-library">https://stackoverflow.com/questions/39217241/visual-studio-2015-compile-c-c-without-a-runtime-library</a><br /><br />By not using the CRT, you can&#39;t use function names like <code>main()</code> or <code>WinMain()</code><br />Create a function named something different<br />e.g.<br /><code>void tinymain(void)</code><br /><br />In your Visual Studio Compiler settings:<br />• <code>Linker</code> settings:<br />   ◇ Advanced -&gt; Entrypoint -&gt; something other than main/wmain/WinMain etc. (e.g. <code>tinymain</code>)<br />      ▪ so it doesn&#39;t try to find main() and execute<br />   ◇ Input -&gt; Ignore All Default Libraries -&gt; YES<br />      ▪ don&#39;t include CRT<br />   ◇ Manifest File &gt; Generate Manifest &gt; No (/MANIFEST:NO)<br />      ▪ gets rid of the &lt;xml content in .rsrc section (results in no .rsrc section)<br />   ◇ Optimization &gt; References &gt; No(/OPT:NOREF)<br />   ◇ Optimization &gt; Link Time Code Generator &gt; /LTCG<br />      ▪ /OPT:NOREF and /LTCG helps remove debug directory<br />   ◇ Op<br />   ◇ Command Line &gt; Additional Options<br />      ▪ <code>/DEBUG:NONE /EMITPOGOPHASEINFO</code><br />      ▪ These 2 options together remove the debug data from the Debug Directory in .rdata<br />      ▪ <code>/NOCOFFGRPINFO</code>  with /OPT:NOREF and /LTCG removes the TimeDateStamp from the Debug Directory<br />• <code>C/C++</code> Compiler settings:<br />   ◇ Code Generation -&gt; Runtime Library -&gt; /MT<br />      ▪ use the multithread, static version of the run-time library<br />   ◇ Code Generation -&gt; /GS- (off)<br />      ▪ CRT does buffer overflow checks. Disable them<br />   ◇ Advanced -&gt; Compile As -&gt; /TC (only if you’re using C and not C++)<br />   ◇ All Options -&gt; Basic Runtime Checks -&gt; Default<br />      ▪ CRT does runtime checks e.g. <code>__RTC__CheckESP</code> - want to disable these<br /><br />This should compile a function to raw shellcode wrapped around a PE file.<br />You CAN use header files and jumps to other functions.<br />I don&#39;t really understand why.<br />I thought this shellcode was supposed to be position independent.<br />Is it position independent if you&#39;re jumping to other functions??? :shrug: (I don&#39;t know asm enough)</div>
</body>
</html>
