<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Loaded DLLs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Loaded DLLs</h1></strong><br />- <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetloadimagenotifyroutine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetloadimagenotifyroutine</a><br />- <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pload_image_notify_routine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pload_image_notify_routine</a><br /><br /><code>PsSetLoadImageNotifyRoutine</code> notifies the driver when a DLL is laoded (or mapped into memory).<br /><br />A debuggee machine is running our driver.<br />A debugger machine is running WinDbg and is connected to the debuggee machine.<br /><br />On the debuggee machine running our driver I run <code>notepad</code>.<br /><a href=""><img src="images/1810-1.png" alt="images/1810-1.png" /></a><br /><br />Back on the debugger machine, we see the output from our kernel driver in WinDbg.<br /><a href=""><img src="images/1810-2.png" alt="images/1810-2.png" /></a><br /><br /><code>notepad.exe</code>, with PID <code>6332</code>, has loaded a bunch of DLLs.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />/*<br />Routine&nbsp;that&nbsp;runs&nbsp;on&nbsp;DLL&nbsp;being&nbsp;loaded.<br />*/<br />void&nbsp;notify_LoadedDLL(PUNICODE_STRING&nbsp;full_image_name,&nbsp;HANDLE&nbsp;process_id,&nbsp;PIMAGE_INFO&nbsp;image_info)<br />{<br />	UNREFERENCED_PARAMETER(image_info);<br />	PEPROCESS&nbsp;process_info&nbsp;=&nbsp;NULL;<br />	PUNICODE_STRING&nbsp;process_name&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;grab&nbsp;name&nbsp;of&nbsp;process&nbsp;that&nbsp;loaded&nbsp;the&nbsp;DLL<br />	PsLookupProcessByProcessId(process_id,&nbsp;&amp;process_info);<br />	SeLocateProcessImageName(process_info,&nbsp;&amp;process_name);<br /><br />	DbgPrint(&quot;%d&nbsp;%wZ&nbsp;LOADED&nbsp;%wZ&nbsp;\n&quot;,&nbsp;process_id,&nbsp;process_name,&nbsp;full_image_name);<br /><br />	return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />	UNREFERENCED_PARAMETER(DriverObject);<br />	PsRemoveLoadImageNotifyRoutine(notify_LoadedDLL);<br />	DbgPrint(&quot;driver&nbsp;unloaded&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />	UNREFERENCED_PARAMETER(DriverObject);<br />	UNREFERENCED_PARAMETER(RegistryPath);<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />	DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />	//&nbsp;start<br />	DbgPrint(&quot;driver&nbsp;loaded&nbsp;\n&quot;);<br /><br />	//&nbsp;notifications<br />	nt_status&nbsp;=&nbsp;PsSetLoadImageNotifyRoutine(notify_LoadedDLL);<br /><br />	return&nbsp;nt_status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
