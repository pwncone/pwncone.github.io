<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PiDDBCacheTable</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1># PiDDBCacheTable</h1><br />• <a href="https://github.com/BadPlayer555/TraceCleaner">https://github.com/BadPlayer555/TraceCleaner</a> - Source<br />• <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/324665-clearing-piddbcachetable.html">https://www.unknowncheats.me/forum/anti-cheat-bypass/324665-clearing-piddbcachetable.html</a> - About + source<br />• <a href="https://github.com/vectless/kernelmode-driver/blob/0ab324dd7dcf519697472cb56a5c23f0602abc6e/kernelmode/clear.cpp#L367">https://github.com/vectless/kernelmode-driver/blob/0ab324dd7dcf519697472cb56a5c23f0602abc6e/kernelmode/clear.cpp#L367</a> - Source<br />• <a href="https://guidedhacking.com/threads/how-to-clear-piddbcache-table-piddblock.16034/">https://guidedhacking.com/threads/how-to-clear-piddbcache-table-piddblock.16034/</a> - Explanation + source<br />• <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/402755-piddbcachetable-signature-windows.html">https://www.unknowncheats.me/forum/anti-cheat-bypass/402755-piddbcachetable-signature-windows.html</a><br /><br />DDB stands for Defective Driver Database.<br />I don&#39;t understand its purpose. There&#39;s lots of refernces to &quot;blocked&quot; drivers in the XP source leak.<br /><br />Regardless, the DDB cache keeps a list of drivers on the sytem.<br />It seems like when a new driver is loaded it adds that driver to the DDB cache.<br />Remove yourself from that list to erase traces of your driver.<br /><br />In the Windows XP source leak, DDB cache stuff can be found in<br /><code>NT\base\ntos\io\pnpmgr\ppdrvdb.c</code><br /><br />If in IDA, open up ntoskrnl.exe and press <code>G</code> and jump to <code>PiDDBCacheTable</code>.<br />X for cross refernces and you&#39;ll find the Pi functions.<br /><br /><strong><h2>## Verify Addresses</h2></strong><br />You can verify the addresses of PiDDBCacheTable and PiDDBLock <br />on your version of Windows using WinDbg.<br /><a href=""><img src="images/1832-1.png" alt="images/1832-1.png" /></a><br /><br /><h2>## Demo</h2><br />I first list the drivers in the DDB cache. It&#39;s order alphatically.<br />You can see our driver at item #16.<br /><a href=""><img src="images/1832-2.png" alt="images/1832-2.png" /></a><br /><br />The total number of drivers in the cache is 144 (starting from 0)<br /><a href=""><img src="images/1832-3.png" alt="images/1832-3.png" /></a><br /><br />I then clear our driver from the cache.<br /><a href=""><img src="images/1832-4.png" alt="images/1832-4.png" /></a><br /><br />And list the drivers again.<br />You can see our driver has been removed from the list (item #16 is now the next driver)<br /><a href=""><img src="images/1832-5.png" alt="images/1832-5.png" /></a><br /><br />We can also see the total number of drivers has decreased by 1.<br /><a href=""><img src="images/1832-6.png" alt="images/1832-6.png" /></a><br /><br /><h2>## Code</h2><br /><div class="codebox"><div class="codebox">/*<br />DDB&nbsp;stands&nbsp;for&nbsp;Defective&nbsp;Driver&nbsp;Database.<br />I&nbsp;don&#39;t&nbsp;understand&nbsp;its&nbsp;purpose.&nbsp;Lots&nbsp;of&nbsp;refernces&nbsp;to&nbsp;&quot;blocked&quot;&nbsp;drivers.<br />Regardless,&nbsp;the&nbsp;DDB&nbsp;cache&nbsp;keeps&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers&nbsp;on&nbsp;the&nbsp;sytem.<br />Remove&nbsp;yourself&nbsp;from&nbsp;that&nbsp;list&nbsp;to&nbsp;erase&nbsp;traces&nbsp;of&nbsp;yourself.<br />*/<br /><br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;windef.h&gt;<br />#include&nbsp;&lt;ntimage.h&gt;<br /><br />#include&nbsp;&quot;nt.h&quot;<br /><br />#define&nbsp;Dbg(...)&nbsp;DbgPrintEx(&nbsp;DPFLTR_SYSTEM_ID,&nbsp;DPFLTR_ERROR_LEVEL,&nbsp;&quot;[piddb]&nbsp;&quot;&nbsp;__VA_ARGS__&nbsp;)<br /><br />typedef&nbsp;struct&nbsp;_DDBCACHE_ENTRY<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY		List;<br />&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING	DriverName;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG			TimeDateStamp;<br />&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS		LoadStatus;<br />&nbsp;&nbsp;&nbsp;&nbsp;char			_0x0028[16];&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Data&nbsp;from&nbsp;the&nbsp;shim&nbsp;engine,&nbsp;or&nbsp;uninitialized&nbsp;memory&nbsp;for&nbsp;custom&nbsp;drivers<br />}&nbsp;DDBCACHE_ENTRY,&nbsp;*&nbsp;PDDBCACHE_ENTRY;<br /><br /><br />//&nbsp;---------------------------------------------------------<br />//&nbsp;Util<br />//&nbsp;---------------------------------------------------------<br />PVOID&nbsp;FindModuleBase(char*&nbsp;module_name)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;module_base&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;buffer_size&nbsp;=&nbsp;8;<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;info_buffer&nbsp;=&nbsp;ExAllocatePool2(POOL_FLAG_NON_PAGED,&nbsp;buffer_size,&nbsp;&#39;1luL&#39;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Enumerate&nbsp;the&nbsp;loaded&nbsp;modules&nbsp;on&nbsp;the&nbsp;system<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;return_len&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;status&nbsp;=&nbsp;ZwQuerySystemInformation(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemModuleInformation,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info_buffer,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;return_len<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(status&nbsp;==&nbsp;STATUS_INFO_LENGTH_MISMATCH)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Resize&nbsp;buffer&nbsp;to&nbsp;store&nbsp;returned&nbsp;information<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;and&nbsp;try&nbsp;again<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExFreePool(info_buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size&nbsp;=&nbsp;return_len;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info_buffer&nbsp;=&nbsp;ExAllocatePool2(POOL_FLAG_NON_PAGED,&nbsp;buffer_size,&nbsp;&#39;2luL&#39;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;ZwQuerySystemInformation(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemModuleInformation,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info_buffer,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;return_len<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!NT_SUCCESS(status))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExFreePool(info_buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Loop&nbsp;through&nbsp;modules&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;PRTL_PROCESS_MODULES&nbsp;modules&nbsp;=&nbsp;(PRTL_PROCESS_MODULES)info_buffer;<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(ULONG&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;modules-&gt;NumberOfModules;&nbsp;i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;name&nbsp;=&nbsp;(char*)modules-&gt;Modules[i].FullPathName&nbsp;+&nbsp;modules-&gt;Modules[i].OffsetToFileName;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strcmp(name,&nbsp;module_name)&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;we&#39;ve&nbsp;found&nbsp;the&nbsp;desired&nbsp;module,&nbsp;save&nbsp;its&nbsp;base&nbsp;address<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;module_base&nbsp;=&nbsp;modules-&gt;Modules[i].ImageBase;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;ExFreePool(info_buffer);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;module_base;<br />}<br /><br />BOOL&nbsp;CheckMask(PCHAR&nbsp;base,&nbsp;PCHAR&nbsp;pattern,&nbsp;PCHAR&nbsp;mask)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(*mask&nbsp;!=&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(*mask&nbsp;==&nbsp;&#39;x&#39;&nbsp;&amp;&amp;&nbsp;*base&nbsp;!=&nbsp;*pattern)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++base;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++pattern;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++mask;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br />}<br /><br />PVOID&nbsp;FindPattern(PCHAR&nbsp;base,&nbsp;DWORD&nbsp;length,&nbsp;PCHAR&nbsp;pattern,&nbsp;PCHAR&nbsp;mask)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;length&nbsp;-=&nbsp;(DWORD)strlen(mask);<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(DWORD&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;length;&nbsp;++i)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;addr&nbsp;=&nbsp;&amp;base[i];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(CheckMask(addr,&nbsp;pattern,&nbsp;mask)&nbsp;==&nbsp;TRUE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;addr;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;<br />}<br /><br />PVOID&nbsp;FindPatternInModule(PCHAR&nbsp;module_base,&nbsp;PCHAR&nbsp;pattern,&nbsp;PCHAR&nbsp;mask)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;pattern_addr&nbsp;=&nbsp;NULL;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Grab&nbsp;sections&nbsp;in&nbsp;module&nbsp;and&nbsp;loop&nbsp;through<br />&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_NT_HEADERS&nbsp;nt_header&nbsp;=&nbsp;(PIMAGE_NT_HEADERS)(module_base&nbsp;+&nbsp;((PIMAGE_DOS_HEADER)module_base)-&gt;e_lfanew);<br />&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_SECTION_HEADER&nbsp;section&nbsp;=&nbsp;IMAGE_FIRST_SECTION(nt_header);<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(DWORD&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;nt_header-&gt;FileHeader.NumberOfSections;&nbsp;i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(*(PINT)section-&gt;Name&nbsp;==&nbsp;&#39;EGAP&#39;&nbsp;||&nbsp;memcmp(section-&gt;Name,&nbsp;&quot;.text&quot;,&nbsp;5)&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;we&#39;ve&nbsp;found&nbsp;the&nbsp;.text&nbsp;section,&nbsp;search&nbsp;for&nbsp;our&nbsp;pattern<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern_addr&nbsp;=&nbsp;FindPattern(module_base&nbsp;+&nbsp;section-&gt;VirtualAddress,&nbsp;section-&gt;Misc.VirtualSize,&nbsp;pattern,&nbsp;mask);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pattern_addr&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Advance&nbsp;to&nbsp;next&nbsp;section<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;section&nbsp;+=&nbsp;1;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pattern_addr;<br />}<br /><br />/*<br />A&nbsp;RIP&nbsp;relative&nbsp;address&nbsp;is&nbsp;@&nbsp;RIP&nbsp;+&nbsp;relative_address.<br />RIP&nbsp;points&nbsp;to&nbsp;the&nbsp;next&nbsp;instruction,&nbsp;so&nbsp;do<br />current_address&nbsp;+&nbsp;current_instruction_size&nbsp;to&nbsp;find&nbsp;RIP,&nbsp;and&nbsp;then&nbsp;add&nbsp;the&nbsp;relative&nbsp;address.<br /><br />Params:<br />&nbsp;&nbsp;&nbsp;&nbsp;base_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Start&nbsp;of&nbsp;the&nbsp;instruction&nbsp;in&nbsp;which&nbsp;the&nbsp;relative&nbsp;address&nbsp;is<br />&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Offset&nbsp;to&nbsp;the&nbsp;relative&nbsp;address&nbsp;from&nbsp;the&nbsp;base_addr<br />&nbsp;&nbsp;&nbsp;&nbsp;instruction_size&nbsp;-&nbsp;Size&nbsp;of&nbsp;the&nbsp;instruction&nbsp;@&nbsp;base_addr.&nbsp;Grab&nbsp;with&nbsp;IDA/x64dbg/etc.<br />*/<br />PVOID&nbsp;ResolveRelativeAddress(DWORD64&nbsp;base_addr,&nbsp;int&nbsp;offset,&nbsp;int&nbsp;instruction_size)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD64&nbsp;rip&nbsp;=&nbsp;base_addr&nbsp;+&nbsp;instruction_size;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD32&nbsp;relative_addr&nbsp;=&nbsp;*(PDWORD32)(base_addr&nbsp;+&nbsp;offset);<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;absolute_addr&nbsp;=&nbsp;(PVOID)(rip&nbsp;+&nbsp;relative_addr);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;absolute_addr;<br />}<br /><br />//&nbsp;---------------------------------------------------------<br />//&nbsp;Main<br />//&nbsp;---------------------------------------------------------<br />void&nbsp;FindDDBCacheAndLock(OUT&nbsp;PERESOURCE*&nbsp;PiDDBLock,&nbsp;PRTL_AVL_TABLE*&nbsp;PiDDBCacheTable)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;ntoskrnl_base&nbsp;=&nbsp;FindModuleBase(&quot;ntoskrnl.exe&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;SIGNATURES&nbsp;ARE&nbsp;FOR&nbsp;Windows&nbsp;10&nbsp;x64&nbsp;20H2&nbsp;19042.1052<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;PiDDBLock_tmp&nbsp;=&nbsp;FindPatternInModule(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntoskrnl_base,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x4C\x8B\x8C&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;xxx????x????xxx&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;PiDDBCacheaTable_tmp&nbsp;=&nbsp;FindPatternInModule(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ntoskrnl_base,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x66\x03\xD2\x48\x8D\x0D&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;xxxxxx&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;PiDDBLock_addr&nbsp;=&nbsp;ResolveRelativeAddress((DWORD64)PiDDBLock_tmp,&nbsp;3,&nbsp;7);<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;PiDDBCacheTable_addr&nbsp;=&nbsp;ResolveRelativeAddress((DWORD64)PiDDBCacheaTable_tmp,&nbsp;6,&nbsp;10);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;*PiDDBLock&nbsp;=&nbsp;(PERESOURCE)PiDDBLock_addr;<br />&nbsp;&nbsp;&nbsp;&nbsp;*PiDDBCacheTable&nbsp;=&nbsp;(PRTL_AVL_TABLE)PiDDBCacheTable_addr;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;*&nbsp;PiDDBLock&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;PiDDBLock_addr);<br />&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;*&nbsp;PiDDBCacheTable&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;PiDDBCacheTable_addr);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />}<br /><br />void&nbsp;ListDDBCache(PERESOURCE&nbsp;PiDDBLock,&nbsp;PRTL_AVL_TABLE&nbsp;PiDDBCacheTable)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Lock&nbsp;DDB&nbsp;access<br />&nbsp;&nbsp;&nbsp;&nbsp;KeEnterCriticalRegion();<br />&nbsp;&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusiveLite(PiDDBLock,&nbsp;TRUE);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Enumerate&nbsp;all&nbsp;entries&nbsp;in&nbsp;DDB&nbsp;cache<br />&nbsp;&nbsp;&nbsp;&nbsp;PDDBCACHE_ENTRY&nbsp;entry&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry&nbsp;=&nbsp;(PDDBCACHE_ENTRY)RtlEnumerateGenericTableAvl(PiDDBCacheTable,&nbsp;TRUE);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry&nbsp;!=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry&nbsp;=&nbsp;(PDDBCACHE_ENTRY)RtlEnumerateGenericTableAvl(PiDDBCacheTable,&nbsp;FALSE)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;DDB&nbsp;entry&nbsp;#%d&nbsp;[name]&nbsp;%wZ&nbsp;\n&quot;,&nbsp;i,&nbsp;entry-&gt;DriverName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Unlock&nbsp;DDB&nbsp;access<br />&nbsp;&nbsp;&nbsp;&nbsp;ExReleaseResourceLite(PiDDBLock);<br />&nbsp;&nbsp;&nbsp;&nbsp;KeLeaveCriticalRegion();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />}<br /><br />void&nbsp;RemoveDriverFromDDBCache(PRTL_AVL_TABLE&nbsp;PiDDBCacheTable,&nbsp;PERESOURCE&nbsp;PiDDBLock,&nbsp;const&nbsp;wchar_t*&nbsp;driver_name)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Build&nbsp;a&nbsp;cache&nbsp;entry&nbsp;about&nbsp;our&nbsp;driver<br />&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;name&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;RtlInitUnicodeString(&amp;name,&nbsp;driver_name);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;DDBCACHE_ENTRY&nbsp;search&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;search.DriverName&nbsp;=&nbsp;name;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Lock&nbsp;DDB&nbsp;access<br />&nbsp;&nbsp;&nbsp;&nbsp;KeEnterCriticalRegion();<br />&nbsp;&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusiveLite(PiDDBLock,&nbsp;TRUE);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;PDDBCACHE_ENTRY&nbsp;driver_entry&nbsp;=&nbsp;(PDDBCACHE_ENTRY)RtlLookupElementGenericTableAvl(PiDDBCacheTable,&nbsp;&amp;search);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(driver_entry&nbsp;!=&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Unlink&nbsp;and&nbsp;delete&nbsp;AVL&nbsp;node<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemoveEntryList(&amp;driver_entry-&gt;List);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlDeleteElementGenericTableAvl(PiDDBCacheTable,&nbsp;driver_entry);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;+&nbsp;Cleared&nbsp;%wZ&nbsp;from&nbsp;PiDDBCacheTable&nbsp;\n&quot;,&nbsp;name);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;find&nbsp;%wZ&nbsp;in&nbsp;PiDDBCacheTable&nbsp;\n&quot;,&nbsp;name);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Unlock&nbsp;DDB&nbsp;access<br />&nbsp;&nbsp;&nbsp;&nbsp;ExReleaseResourceLite(PiDDBLock);<br />&nbsp;&nbsp;&nbsp;&nbsp;KeLeaveCriticalRegion();<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Nothing&nbsp;to&nbsp;delete<br />&nbsp;&nbsp;&nbsp;&nbsp;UNREFERENCED_PARAMETER(DriverObject);<br />&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;+&nbsp;Unloaded&nbsp;driver&nbsp;\n&quot;);<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;UNREFERENCED_PARAMETER(RegistryPath);<br />&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Not&nbsp;creating&nbsp;an&nbsp;io&nbsp;device&nbsp;and&nbsp;symbolic&nbsp;link<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;because&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;access&nbsp;from&nbsp;userland<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;PERESOURCE&nbsp;PiDDBLock&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;PRTL_AVL_TABLE&nbsp;PiDDBCacheTable&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;FindDDBCacheAndLock(&amp;PiDDBLock,&nbsp;&amp;PiDDBCacheTable);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(PiDDBLock&nbsp;==&nbsp;NULL&nbsp;||&nbsp;PiDDBCacheTable&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;find&nbsp;PiDDBLock&nbsp;(0x%p)&nbsp;or&nbsp;PiDDBCacheTable&nbsp;(0x%p)&nbsp;\n&quot;,&nbsp;PiDDBLock,&nbsp;PiDDBCacheTable);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0x0;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;ListDDBCache(PiDDBLock,&nbsp;PiDDBCacheTable);<br />&nbsp;&nbsp;&nbsp;&nbsp;RemoveDriverFromDDBCache(PiDDBCacheTable,&nbsp;PiDDBLock,&nbsp;L&quot;clear_PiDDBCache.sys&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;ListDDBCache(PiDDBLock,&nbsp;PiDDBCacheTable);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;status;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
