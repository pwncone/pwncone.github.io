<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Grab PEB of Other Processes</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Grabbing the PEB of Other Processes</h1></strong><br />When you want to grab the PEB of external processes. Not your own.<br /><br /><strong><h2>## NtQueryInformationProcess</h2></strong><br />â€¢ <a href="https://stackoverflow.com/questions/59514542/imagebaseaddress-in-peb-is-wrong">https://stackoverflow.com/questions/59514542/imagebaseaddress-in-peb-is-wrong</a><br /><br />Query the external process for a <code>PROCESS_BASIC_INFORMATION</code> struct,<br />and <code>ReadProcessMemory</code> in the external process at its <code>PebBaseAddress</code> to grab its PEB.<br /><br />If you&#39;re querying a 64bit process -&gt; MAKE SURE YOUR PROCESS IS 64BIT TOO.<br />Likewise for 32bit also.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Ntdll.lib&quot;)<br /><br />PEB&nbsp;GrabExternalPEB_NtQuery(HANDLE&nbsp;h_target_process)<br />{<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;0;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;TRUE;<br />	PROCESS_BASIC_INFORMATION&nbsp;pbi&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	PEB&nbsp;peb&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	//&nbsp;grab&nbsp;PROCESS_BASIC_INFORMATION&nbsp;of&nbsp;target&nbsp;process&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;grab&nbsp;the&nbsp;PEB<br />	nt_status&nbsp;=&nbsp;NtQueryInformationProcess(h_target_process,&nbsp;ProcessBasicInformation,&nbsp;&amp;pbi,&nbsp;sizeof(PROCESS_BASIC_INFORMATION),&nbsp;NULL);<br />	if&nbsp;(!NT_SUCCESS(nt_status))<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;NtQuery&nbsp;\n&quot;);<br />		return&nbsp;peb;<br />	}<br /><br />	printf(&quot;target&nbsp;PEB&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;pbi.PebBaseAddress);<br />	<br />	//&nbsp;read&nbsp;PEB&nbsp;from&nbsp;target&nbsp;process<br />	b_ret&nbsp;=&nbsp;ReadProcessMemory(h_target_process,&nbsp;pbi.PebBaseAddress,&nbsp;&amp;peb,&nbsp;sizeof(PEB),&nbsp;NULL);<br /><br />	return&nbsp;peb;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	DWORD&nbsp;target_pid&nbsp;=&nbsp;4140;			//&nbsp;explorer.exe<br />	HANDLE&nbsp;h_target_process&nbsp;=&nbsp;NULL;<br />	PEB&nbsp;target_peb&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	h_target_process&nbsp;=&nbsp;OpenProcess(PROCESS_ALL_ACCESS,&nbsp;FALSE,&nbsp;target_pid);<br />	if&nbsp;(h_target_process&nbsp;==&nbsp;NULL)<br />		return&nbsp;1;<br />	<br />	target_peb&nbsp;=&nbsp;GrabExternalPEB_NtQuery(h_target_process);<br />	printf(&quot;\t&nbsp;ImageBaseAddress&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;target_peb.Reserved3[1]);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
