<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Manually</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Infecting PE Files - Add new section -&gt; write shellcode - Manual</h1></strong><br />The PE file I&#39;m using as my dummy program in this demo is <code>putty.exe</code><br /><br /><strong><h3>Overview</h3></strong><br />1. Prepare shellcode<br />2. Open in CFF Explorer<br />   1) Add new section<br />   2) Set section size to be large-enough to store shellcode<br />   3) Set section as read/write/execute (do all 3 just in case, instructions like xor need write perms I think?)<br />   4) From your new section, grab<br />      - VirtualAddress - so that you can modify the entry point<br />      - RawAddress - so that you know at what offset to write your shellcode in HxD<br />   6) Change AddressOfEntry point to VirtualAddress of your newly created section<br />3. Open in HxD<br />   7) Write shellcode into new section -&gt; save<br /><br /><strong>Software:</strong><br />• HxD<br />• CFF Explorer<br /><br /><strong><h2>1. Prepare shellcode</h2></strong><br />Bad bytes on Windows are always: <code>0x00 0x0a 0xad</code><br /><br /><strong><h3>1a) Generate shellcode</h3></strong><br />To get shellcode as raw bytes, pipe to <code>xxd</code>:<br /><code>msfvenom ... | xxd -p</code><br />Or if you want the ASCII and addresses too, pipe to <code>hexdump -C</code>:<br /><code>msfvenom ... | hexdump -C</code><br /><br />The shellcode I&#39;ve generated here spawns <code>calc.exe</code>:<br /><div class="codebox"><div class="codebox">┌─[horace@parrot]─[~]<br />└──╼&nbsp;$msfvenom&nbsp;-p&nbsp;windows/exec&nbsp;cmd=calc.exe&nbsp;-b&nbsp;&#39;0x00&nbsp;0x0a&nbsp;0xad&#39;&nbsp;|&nbsp;xxd&nbsp;-p<br />[...]<br />Payload&nbsp;size:&nbsp;220&nbsp;bytes<br /><br />be9ddef3d0d9ecd97424f4582bc9b13131701383e8fc0370923c062c4442<br />e9cd94236328a56317389553536c191f3185aa6d9eaa1bdbf8859c703887<br />1e8b6d671f44606658b9893a31b53cab3683fc40040585b5dc24a46b577f<br />668db40b2f95d936f92e29ccf8e6602d56c74ddca60f693fdd798ac2e6bd<br />f118622651ead482603f82416ef4c00e720b04258e80abea07d28f2e4c80<br />ae772867ce6893d86ae2390c07a957d395d715d3a5d709bc945cc6bb28b7<br />a334639a85dc2a4e9480cca4dabc4e4da23a4e24a707c8d4d518bdda4a18<br />94b80d8a7411a82a1e6d</div></div><br /><br /><strong><h3>1b) Modify</h3></strong><br />Add <code>0x60 0x9c</code> to the start of your shellcode.<br /><br />These are the <code>pushad</code> and <code>pushaf</code> instructions.<br /><code>0x60</code> - <code>pushad</code> - push all general purpose registers to stack<br /><code>0x9c</code> - <code>pushfd</code> - push EFLAGS to stack<br /><br />Shellcode doesn&#39;t seem to execute properly without them.<br /><br />Final shellcode:<br /><div class="codebox"><div class="codebox">609cbe9ddef3d0d9ecd97424f4582bc9b13131701383e8fc0370923c062c4442<br />e9cd94236328a56317389553536c191f3185aa6d9eaa1bdbf8859c703887<br />1e8b6d671f44606658b9893a31b53cab3683fc40040585b5dc24a46b577f<br />668db40b2f95d936f92e29ccf8e6602d56c74ddca60f693fdd798ac2e6bd<br />f118622651ead482603f82416ef4c00e720b04258e80abea07d28f2e4c80<br />ae772867ce6893d86ae2390c07a957d395d715d3a5d709bc945cc6bb28b7<br />a334639a85dc2a4e9480cca4dabc4e4da23a4e24a707c8d4d518bdda4a18<br />94b80d8a7411a82a1e6d</div></div><br /><br /><strong><h3>1c) Calculate shellcode size</h3></strong><br />Grab the size of the shellcode in both decimal and hex values.<br />We will need them later.<br /><a href="https://www.rapidtables.com/convert/number/decimal-to-hex.html?x=222">https://www.rapidtables.com/convert/number/decimal-to-hex.html</a><br /><br />Above shellcode size:<br />• Decimal - <code>222</code><br />• Hex - <code>DE</code><br /><br /><strong><h2>2. Edit in CFF Explorer</h2></strong><br />I&#39;ll make a new section called <code>.pwn</code> to store my shellcode.<br /><br /><strong><h3>2a) Add new section</h3></strong><br /><code>Section Headers &gt; Right click &gt; Add Section (Empty Space)</code><br /><a href=""><img src="images/1851-1.png" alt="images/1851-1.png" /></a><br /><br />Set the size of the section to your shellcode size, plus a little wiggle room (like 30 bytes or so).<br />My shellcode is <code>222</code> bytes, so I&#39;ve set my section size to <code>250</code> (<code>FA</code> in hex).<br /><a href=""><img src="images/1851-2.png" alt="images/1851-2.png" /></a><br /><br />Set a name your new section for your section as well - mine is <code>.pwn</code><br />(can&#39;t be more than 8 chars long)<br /><a href=""><img src="images/1851-3.png" alt="images/1851-3.png" /></a><br /><br />Here I&#39;ve created a new a section called <code>.pwn</code> that&#39;s 250 bytes (FA) large.<br /><br /><strong><h3>2b) Set section as read/write/execute </h3></strong><br />We need to set our new section as executable so that we can execute the shellcode that we place in it.<br /><br />However, in my experience it&#39;s safer to set the section as all 3 - read/write/execute.<br />Instructions like <code>xor</code> need write permissions in order to run (I think).<br /><br /><code>Right click &gt; Change Section Flags</code><br /><a href=""><img src="images/1851-4.png" alt="images/1851-4.png" /></a><br /><br /><a href=""><img src="images/1851-5.png" alt="images/1851-5.png" /></a><br /><br /><strong><h3>2c) Grab values</h3></strong><br />Before moving on, it&#39;s important to explain a few key concepts and grab some values that we need for later.<br /><br /><strong>ImageBase</strong><br />When an executable starts, Windows loads the program into memory.<br /><br /><code>ImageBase</code> is the base address of the program once loaded into memory.<br />For 32-bit exeuctables, this is usually at memory address <code>0x00400000</code><br /><a href=""><img src="images/1851-6.png" alt="images/1851-6.png" /></a><br /><br /><strong>Offsets</strong><br />Offsets are values which are <em>offset</em>ted from the program&#39;s base address.<br />For example, an offset of:<br /><code>0x00111000</code><br />means that the absolute address is:<br /><code>ImageBase</code>   + <code>Offset</code>         = <code>Absolute Address</code><br /><code>0x00400000</code> + <code>0x00111000</code> = <code>0x00511000</code><br /><br /><strong>Entry Point</strong><br />Programs have entry points.<br />The entry point is the first function that will be executed once the executable has been fully loaded into memory.<br />It can be found in <code>Optional Header &gt; AddressOfEntryPoint</code><br /><a href=""><img src="images/1851-7.png" alt="images/1851-7.png" /></a><br /><br />This value - <code>0006fe96</code> - is an offset.<br />Therefore, the absoluate address of the first function that will be executed is:<br /><code>ImageBase</code>   + <code>AddressOfEntryPoint</code> = <code>Aboslute address of entry point</code><br /><code>0x00400000</code> + <code>0x0006fe96</code>                   = <code>0x0046fe96</code><br /><br /><strong>Sections - RawAddress and VirtualAddress</strong><br />PE file sections have 2 different addresses:<br />• the <code>RawAddress</code> - which is the start address of the section on disk<br />• the <code>VirtualAddress</code> - which is the offset to the start of the section once the executable is loaded into memory<br /><br />We need the <code>RawAddress</code> to know where to write our shellcode into the file.<br />We need the <code>VirtualAddress</code> to set the entry point of our program to our new .pwn section.<br /><br /><strong>Grab Values</strong><br /><code>RawAddress</code> - <code>0x00107c00</code><br /><code>VirtualAddress</code> - <code>0x00111000</code> (offset)<br /><a href=""><img src="images/1851-8.png" alt="images/1851-8.png" /></a><br /><br /><strong><h3>2c) Change entry point</h3></strong><br />Our shellcode will be injected into the start of our new section.<br /><br />To make sure our shellcode executes first instead of the legitimate program, <br />change the entry point of the program to be the start of our new <code>.pwn</code> section (which is where our shellcode will be).<br /><br />Navigate to<br /><code>Optional Header &gt; AddressOfEntryPoint</code><br /><br />and input the <code>VirtualAddress</code> of your new section.<br />In my case this is <code>00111000</code><br /><br />If the VirtualAddress is correct, the entry point will now read <code>.pwn</code> - our new section.<br /><a href=""><img src="images/1851-9.png" alt="images/1851-9.png" /></a><br /><br /><strong><h3>2d) Save</h3></strong><br />We&#39;ve finished setting up the file and are now ready to inject our shellcode.<br />Save the file and exit.<br /><br /><strong><h2>3) HxD - Inject shellcode</h2></strong><br />Now we can inject our shellcode.<br /><br />Open your modified PE file in <code>HxD</code>, a hex editor.<br />Press <code>Ctrl+G</code> for <code>Go to</code>, and input the RawAddress of your new section.<br />In my case that&#39;s <code>00107c00</code><br /><a href=""><img src="images/1851-10.png" alt="images/1851-10.png" /></a><br /><br />This is the start of our new section - <code>.pwn</code><br />There will be junk here, but we can overwrite it.<br /><br />Our shellcode size is <code>DE</code> (222 bytes), so highilght <code>DE</code> bytes and copy/paste your shellcode in<br /><a href=""><img src="images/1851-11.png" alt="images/1851-11.png" /></a><br /><br />And save the file :)<br /><a href=""><img src="images/1851-12.png" alt="images/1851-12.png" /></a><br /><br /><strong><h3>4) Test</h3></strong><br />We&#39;re done!<br />We&#39;ve added a new section, changed the entry point to our new section, and injected our shellcode.<br />Our dummy file should now execute our shellcode instead of the legitimate program.<br /><br />Here <code>calc.exe</code> runs intead of <code>putty</code>:<br /><a href=""><img src="images/1851-13.png" alt="images/1851-13.png" /></a><br /></div>
</body>
</html>
