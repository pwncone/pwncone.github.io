<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>CheckRemoteDebuggerPresent</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># CheckRemoteDebuggerPresent</h1></strong><br />Another winAPI function.<br />It checks if there&#39;s a debugger running in a separate parallel process.<br />If you want to check whether your calling process is running under the debugger, use <code>IsDebuggerPresent</code>.<br /><br />If a debugger exists, the function will set the value pointed to by <code>pbDebuggerPresent</code> to <code>0xffffffff</code><br />(source: <a href="https://ctf-wiki.github.io/ctf-wiki/reverse/windows/anti-debug/checkremotedebuggerpresent)">https://ctf-wiki.github.io/ctf-wiki/reverse/windows/anti-debug/checkremotedebuggerpresent)</a><br /><br />Internally this function calls <code>NtQueryInformationProcess</code><br />(source: <a href="https://ctf-wiki.github.io/ctf-wiki/reverse/windows/anti-debug/checkremotedebuggerpresent)">https://ctf-wiki.github.io/ctf-wiki/reverse/windows/anti-debug/checkremotedebuggerpresent)</a><br /><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-checkremotedebuggerpresent">https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-checkremotedebuggerpresent</a><br />• <a href="https://www.aldeid.com/wiki/CheckRemoteDebuggerPresent">https://www.aldeid.com/wiki/CheckRemoteDebuggerPresent</a><br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />	BOOL&nbsp;debugger_present&nbsp;=&nbsp;FALSE;<br /><br />	b_ret&nbsp;=&nbsp;CheckRemoteDebuggerPresent(GetCurrentProcess(),&nbsp;&amp;debugger_present);<br />	if&nbsp;(debugger_present&nbsp;==&nbsp;TRUE)<br />		return&nbsp;1;<br /><br />	printf(&quot;hey&nbsp;:)&nbsp;\n&quot;);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Bypass</h2></strong><br /><code>cmp rsp+20</code> to <code>1</code> is the <code>CheckRemoteDebuggerPresent</code> check.<br />The next instruction, <code>jne</code> - jump if not equal - will jump to our <code>printf(&quot;hey :) \n&quot;)</code> code if the value at <code>rsp+20</code> is not equal to 1.<br /><a href=""><img src="images/1774-1.png" alt="images/1774-1.png" /></a><br /><br />The value in RSP is <code>0000001417B8FB60</code><br /><a href=""><img src="images/1774-2.png" alt="images/1774-2.png" /></a><br /><br />We want to look at this in the dump.<br />Right click in the dump &gt; Go to &gt; Expression<br /><a href=""><img src="images/1774-3.png" alt="images/1774-3.png" /></a><br /><br />Enter <code>rsp + 20</code> and hit OK<br />We see the dump jump to <code>0000001417B8FB80</code><br /><a href=""><img src="images/1774-4.png" alt="images/1774-4.png" /></a><br /><br />The value is <code>01</code><br /><code>1</code> is equal to <code>1</code>, meaning that the jump to our <code>printf</code> code won&#39;t happen.<br />Double click <code>01</code> and modify it to <code>00</code><br /><a href=""><img src="images/1774-5.png" alt="images/1774-5.png" /></a><br /><br />If we F8 (step over) our code, we&#39;ll see the jump to our <code>printf</code> is taken and we&#39;ve bypassed <code>CheckRemoteDebuggerPresent</code><br /><a href=""><img src="images/1774-6.png" alt="images/1774-6.png" /></a><br /><br /></div>
</body>
</html>
