<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Get process SID from PID</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Get process SID from PID</h1></strong><br /><code>OpenProcess</code> to get a handle to the process<br /><code>OpenProcessToken</code> to get a handle to the process&#39;s access token.<br /><code>GetTokenInformation</code> to grab the TOKEN_USER struct containing the SID.<br /><code>ConvertSidToString</code> to convert the sid to a string that we can return.<br /><br /><div class="codebox"><div class="codebox">/*<br />Gets&nbsp;SID&nbsp;from&nbsp;PID&nbsp;by&nbsp;opening&nbsp;the&nbsp;process,&nbsp;querying&nbsp;for&nbsp;its&nbsp;access&nbsp;token,&nbsp;and&nbsp;grabbing&nbsp;the&nbsp;SID&nbsp;from&nbsp;the&nbsp;token.<br /><br />`out_sid`&nbsp;returns&nbsp;you&nbsp;the&nbsp;SID.<br />`out_sid_len`&nbsp;should&nbsp;be&nbsp;~256.<br />*/<br />BOOL&nbsp;GetProcessSID(DWORD&nbsp;pid,&nbsp;char*&nbsp;out_sid,&nbsp;DWORD&nbsp;out_sid_len)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;TRUE;<br /><br />	HANDLE&nbsp;h_process&nbsp;=&nbsp;NULL;<br />	HANDLE&nbsp;h_token&nbsp;=&nbsp;NULL;<br />	TOKEN_USER*&nbsp;token_useraccount&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;user_length&nbsp;=&nbsp;0;<br /><br />	char&nbsp;username[256]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	char&nbsp;domain_name[256]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	DWORD&nbsp;username_len&nbsp;=&nbsp;sizeof(username);<br />	DWORD&nbsp;domain_name_len&nbsp;=&nbsp;sizeof(domain_name);<br />	SID_NAME_USE&nbsp;sid&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	char*&nbsp;sid_string&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;open&nbsp;handle&nbsp;to&nbsp;process<br />	//&nbsp;if&nbsp;unable&nbsp;to&nbsp;open&nbsp;handle,&nbsp;none&nbsp;of&nbsp;the&nbsp;following&nbsp;functions&nbsp;will&nbsp;work<br />	h_process&nbsp;=&nbsp;OpenProcess(PROCESS_QUERY_INFORMATION,&nbsp;FALSE,&nbsp;pid);<br />	if&nbsp;(h_process&nbsp;==&nbsp;NULL)<br />	{<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;open&nbsp;access&nbsp;token&nbsp;of&nbsp;process<br />	b_ret&nbsp;=&nbsp;OpenProcessToken(h_process,&nbsp;TOKEN_QUERY,&nbsp;&amp;h_token);<br /><br />	//&nbsp;get&nbsp;size&nbsp;of&nbsp;TOKEN_USER&nbsp;struct&nbsp;and&nbsp;allocate&nbsp;space<br />	b_ret&nbsp;=&nbsp;GetTokenInformation(h_token,&nbsp;TokenUser,&nbsp;NULL,&nbsp;0,&nbsp;&amp;user_length);<br />	token_useraccount&nbsp;=&nbsp;(TOKEN_USER*)malloc(user_length);<br /><br />	//&nbsp;grab&nbsp;TOKEN_USER&nbsp;struct.&nbsp;inside&nbsp;it&nbsp;is&nbsp;the&nbsp;SID<br />	b_ret&nbsp;=&nbsp;GetTokenInformation(h_token,&nbsp;TokenUser,&nbsp;token_useraccount,&nbsp;user_length,&nbsp;&amp;user_length);<br />	b_ret&nbsp;=&nbsp;ConvertSidToStringSidA(token_useraccount-&gt;User.Sid,&nbsp;&amp;sid_string);<br />	<br />	sprintf_s(out_sid,&nbsp;out_sid_len&nbsp;-&nbsp;1,&nbsp;&quot;%s&quot;,&nbsp;sid_string);<br /><br />cleanup:<br />	LocalFree(sid_string);<br />	if&nbsp;(token_useraccount)&nbsp;free(token_useraccount);<br />	if&nbsp;(h_token)&nbsp;CloseHandle(h_token);<br />	if&nbsp;(h_process)&nbsp;CloseHandle(h_process);<br /><br />	return&nbsp;okay;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
