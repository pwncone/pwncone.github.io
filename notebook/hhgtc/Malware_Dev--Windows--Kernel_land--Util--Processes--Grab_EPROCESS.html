<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Grab EPROCESS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1># Grab EPROCESS</h1><br />The EPROCESS struct for a process is often needed.<br /><br /><div class="codebox"><div class="codebox">PEPROCESS&nbsp;GetEProcess(wchar_t*&nbsp;process_name)<br /><span style="color:#000000;font-weight:400">{</span><br />	PEPROCESS&nbsp;eproc&nbsp;=&nbsp;NULL;<br />	SYSTEM_PROCESS_INFORMATION*&nbsp;info&nbsp;=&nbsp;NULL;<br />	<br />	//&nbsp;Get&nbsp;size<br />	ULONG&nbsp;size_needed&nbsp;=&nbsp;0;<br />	NTSTATUS&nbsp;status&nbsp;=&nbsp;ZwQuerySystemInformation(SystemProcessInformation,&nbsp;NULL,&nbsp;0,&nbsp;&amp;size_needed);<br />	if&nbsp;(status&nbsp;==&nbsp;(NTSTATUS)0xC0000004L)&nbsp;{&nbsp;//&nbsp;STATUS_INFO_LENGTH_MISMATCH<br />		info&nbsp;=&nbsp;ExAllocatePool2(POOL_FLAG_NON_PAGED,&nbsp;size_needed,&nbsp;&#39;1gaT&#39;);<br />	}<br />	else&nbsp;if&nbsp;(!NT_SUCCESS(status))&nbsp;{<br />		Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;ZwQuerySystemInformation:&nbsp;0x%lx&nbsp;(%d)&nbsp;\n&quot;,&nbsp;status,&nbsp;size_needed);<br />		return&nbsp;NULL;<br />	}<br /><br />	//&nbsp;Query&nbsp;system&nbsp;for&nbsp;processes<br />	if&nbsp;(info&nbsp;==&nbsp;NULL)&nbsp;return&nbsp;0;<br />	status&nbsp;=&nbsp;ZwQuerySystemInformation(SystemProcessInformation,&nbsp;info,&nbsp;size_needed,&nbsp;&amp;size_needed);<br />	if&nbsp;(!NT_SUCCESS(status))&nbsp;{<br />		Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;ZwQuerySystemInformation:&nbsp;0x%lx&nbsp;(%d)&nbsp;\n&quot;,&nbsp;status,&nbsp;size_needed);<br />		ExFreePool(info);<br />		return&nbsp;NULL;<br />	}<br /><br />	SYSTEM_PROCESS_INFORMATION*&nbsp;process&nbsp;=&nbsp;(SYSTEM_PROCESS_INFORMATION*)((size_t)info&nbsp;+&nbsp;info-&gt;NextEntryOffset);<br />	do<br />	{<br />		if&nbsp;(_wcsicmp(process-&gt;ImageName.Buffer,&nbsp;process_name)&nbsp;==&nbsp;0)&nbsp;{<br />			eproc&nbsp;=&nbsp;PsLookupProcessByProcessId(process-&gt;UniqueProcessId,&nbsp;&amp;eproc);<br />			Dbg(&quot;Found&nbsp;%ws:&nbsp;%lld&nbsp;\n&quot;,&nbsp;process-&gt;ImageName.Buffer,&nbsp;(DWORD64)process-&gt;UniqueProcessId);<br />			break;<br />		}<br /><br />		//&nbsp;Advance&nbsp;to&nbsp;next&nbsp;process<br />		//&nbsp;For&nbsp;the&nbsp;last&nbsp;item&nbsp;in&nbsp;the&nbsp;array,&nbsp;NextEntryOffset&nbsp;is&nbsp;0<br />		process&nbsp;=&nbsp;(SYSTEM_PROCESS_INFORMATION*)((size_t)process&nbsp;+&nbsp;process-&gt;NextEntryOffset);<br />	}&nbsp;while&nbsp;(process-&gt;NextEntryOffset&nbsp;!=&nbsp;0);<br /><br />	ExFreePool(info);<br />	return&nbsp;eproc;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><h2>## Local<br /></h2><h3>### IoGetCurrentProcess</h3><br /><div class="codebox"><div class="codebox">PEPROCESS&nbsp;curr_eproc&nbsp;=&nbsp;IoGetCurrentProcess();</div></div><br /><br /><h2>## Remote</h2><br /><h3>### PsLookupProcessByProcessId</h3><br /><div class="codebox"><div class="codebox">PEPROCESS&nbsp;tgt_eproc&nbsp;=&nbsp;NULL;<br />PsLookupProcessByProcessId((HANDLE)read-&gt;process_id,&nbsp;&amp;tgt_eproc);</div></div><br /></div>
</body>
</html>
