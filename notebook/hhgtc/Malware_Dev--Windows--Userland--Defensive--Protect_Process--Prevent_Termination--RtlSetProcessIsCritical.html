<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RtlSetProcessIsCritical</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># RtlSetProcessIsCritical</h1></strong><br />This is an undocumented kernel function.<br />It sets your process to system critical status, meaning that your process is &quot;critical&quot; to the running of Windows.<br />If your process is terminated, Windows will terminate too and blue screen.<br /><br />The advantage of this is that &quot;critical&quot; processes can only be terminated by Admins.<br />However, if a &quot;critical&quot; process is terminated it causes a BSOD.<br />This is a fairly noisy error message that you&#39;d probably want to avoid.<br /><br /><strong>Links</strong><br />• <a href="https://www.codeproject.com/Articles/43405/Protecting-Your-Process-with-RtlSetProcessIsCriti">https://www.codeproject.com/Articles/43405/Protecting-Your-Process-with-RtlSetProcessIsCriti</a><br />• <a href="https://github.com/quasar/Quasar/issues/81">https://github.com/quasar/Quasar/issues/81</a><br /><br /><strong><h2>## Demo of Simple Version</h2></strong><br />Running on Windows 10 2004, if the user tries to terminate a critical process they get a message saying that Windows might &quot;become unstable&quot; if we terminate this process.<br /><br />My user is an Adminstator (which means I can terminate this critical process).<br />Here I&#39;ve run my code as Administrator and:<br />• enabled SeDebugPrivilege<br />• run RtlSetProcessIsCritical to define my process as critical to the running of windows<br />• spawned a MessageBox<br />• and tried to terminate my program via Task Manager<br /><br /><a href=""><img src="images/1745-1.png" alt="images/1745-1.png" /></a><br /><br />If we check <code>Abandon unsaved data and shut down</code>, the system will BSOD.<br /><br />This code MUST BE RUN AS ADMINISTRATOR otherwise the process isn&#39;t set to critical.<br /><br /><strong><h3>### Code</h3></strong><br /><code><span style="color:#990000;">RtlSetProcessIsCritical(TRUE, NULL, FALSE)</span></code> - set process as critical<br /><code><span style="color:#990000;">RtlSetProcessIsCritical(FALSE, NULL, FALSE)</span></code> - return process to normal<br /><br />The <code>SeDebugPrivilege</code> privilege has to be enabled first before <code>RtlSetProcessIsCritical</code> can be run.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />typedef&nbsp;NTSTATUS(*t_RtlSetProcessIsCritical)(BOOL&nbsp;bNew,&nbsp;BOOL*&nbsp;pbOld,&nbsp;BOOL&nbsp;bNeedScb);<br />t_RtlSetProcessIsCritical&nbsp;d_RtlSetProcessIsCritical&nbsp;=&nbsp;NULL;<br /><br />BOOL&nbsp;EnablePrivilege(char*&nbsp;privilege)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;TRUE;<br />	HANDLE&nbsp;h_token&nbsp;=&nbsp;NULL;<br />	LUID&nbsp;luid&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	TOKEN_PRIVILEGES&nbsp;token_privs&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	//&nbsp;get&nbsp;access&nbsp;token&nbsp;of&nbsp;current&nbsp;process&nbsp;(which&nbsp;we&#39;ll&nbsp;adjust&nbsp;privileges&nbsp;of)<br />	b_ret&nbsp;=&nbsp;OpenProcessToken(GetCurrentProcess(),&nbsp;TOKEN_ADJUST_PRIVILEGES&nbsp;|&nbsp;TOKEN_QUERY,&nbsp;&amp;h_token);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;open&nbsp;process&nbsp;token:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;grab&nbsp;LUID&nbsp;of&nbsp;requested&nbsp;privilege<br />	b_ret&nbsp;=&nbsp;LookupPrivilegeValueA(NULL,&nbsp;privilege,&nbsp;&amp;luid);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;grab&nbsp;LUID&nbsp;of&nbsp;requested&nbsp;privilege:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;enable&nbsp;the&nbsp;privilege<br />	token_privs.PrivilegeCount&nbsp;=&nbsp;1;<br />	token_privs.Privileges[0].Luid&nbsp;=&nbsp;luid;<br />	token_privs.Privileges[0].Attributes&nbsp;=&nbsp;SE_PRIVILEGE_ENABLED;<br /><br />	b_ret&nbsp;=&nbsp;AdjustTokenPrivileges(h_token,&nbsp;FALSE,&nbsp;&amp;token_privs,&nbsp;sizeof(token_privs),&nbsp;NULL,&nbsp;NULL);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;enable&nbsp;privilege:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />cleanup:<br />	if&nbsp;(h_token)&nbsp;CloseHandle(h_token);<br /><br />	return&nbsp;okay;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />	<br />	b_ret&nbsp;=&nbsp;EnablePrivilege(&quot;SeDebugPrivilege&quot;);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />		return&nbsp;EXIT_FAILURE;<br />	else<br />		printf(&quot;[+]&nbsp;enabled&nbsp;SeDebugPrivilege&nbsp;\n&quot;);<br /><br />	d_RtlSetProcessIsCritical&nbsp;=&nbsp;(t_RtlSetProcessIsCritical)GetProcAddress(GetModuleHandleA(&quot;Ntdll.dll&quot;),&nbsp;&quot;RtlSetProcessIsCritical&quot;);<br />	d_RtlSetProcessIsCritical(TRUE,&nbsp;NULL,&nbsp;FALSE);<br /><br />	printf(&quot;[+]&nbsp;set&nbsp;process&nbsp;as&nbsp;critical&nbsp;:O&nbsp;\n&quot;);<br />	<br />	MessageBoxA(NULL,&nbsp;&quot;try&nbsp;to&nbsp;terminate&nbsp;me&quot;,&nbsp;&quot;hi!&quot;,&nbsp;MB_OK);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Demo of Better Version - Disable Critical Status at Shutdown</h2></strong><br />If our program is running with critical status and the user shuts down the computer, the computer will blue screen. To prevent this, we can watch for <code>WM_ENDSESSION</code> messages (shutdown messages) being sent to an invisible window we control and disable the critical status of our process when a user tries to shut down the machine. This will prevent a BSOD.<br /><br />Inspiration:<br />• <a href="http://www.rohitab.com/discuss/topic/41154-process-persistence/#entry10096806">http://www.rohitab.com/discuss/topic/41154-process-persistence/#entry10096806</a><br /><br />Here I&#39;ve started a process that spawns a MessageBox asking to terminate me.<br />• In <code>WinLister</code> you can see our invisible window - <code>invisible</code> - which is watching for WM_ENDSESSION messages. (got to Options &gt; Display Invisiable Windows to show it)<br />• In Task Manager, I&#39;ve tried to terminate the process. We get a message saying it&#39;s critical. If we shut down anyway, the system will blue screen. If we shutdown normally (via start), our code will catch the WM_ENDSESSION message sent to all windows and remove the critical status of our process. Windows will then shut down cleanly.<br /><br /><a href=""><img src="images/1745-2.png" alt="images/1745-2.png" /></a><br /><br /><strong><h3>### Code</h3></strong><br /><div class="codebox"><div class="codebox">/*<br />Watches&nbsp;for&nbsp;shutdown&nbsp;messages&nbsp;sent&nbsp;to&nbsp;an&nbsp;invisible&nbsp;window&nbsp;it&nbsp;has&nbsp;created.<br />Upon&nbsp;shutdown&nbsp;message,&nbsp;it&nbsp;deletes&nbsp;its&nbsp;critical&nbsp;status&nbsp;so&nbsp;that&nbsp;Windows&nbsp;will&nbsp;shut&nbsp;down&nbsp;properly&nbsp;without&nbsp;BSOD.<br /><br />Compile&nbsp;as&nbsp;GUI&nbsp;subsystem.<br />Run&nbsp;as&nbsp;Administrator&nbsp;to&nbsp;enable&nbsp;SeDebugPrivilege&nbsp;and&nbsp;set&nbsp;process&nbsp;to&nbsp;critical.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />typedef&nbsp;NTSTATUS(*t_RtlSetProcessIsCritical)(BOOL&nbsp;bNew,&nbsp;BOOL*&nbsp;pbOld,&nbsp;BOOL&nbsp;bNeedScb);<br />t_RtlSetProcessIsCritical&nbsp;d_RtlSetProcessIsCritical&nbsp;=&nbsp;NULL;<br /><br />BOOL&nbsp;EnablePrivilege(char*&nbsp;privilege)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;TRUE;<br />	HANDLE&nbsp;h_token&nbsp;=&nbsp;NULL;<br />	LUID&nbsp;luid&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	TOKEN_PRIVILEGES&nbsp;token_privs&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br /><br />	//&nbsp;get&nbsp;access&nbsp;token&nbsp;of&nbsp;current&nbsp;process&nbsp;(which&nbsp;we&#39;ll&nbsp;adjust&nbsp;privileges&nbsp;of)<br />	b_ret&nbsp;=&nbsp;OpenProcessToken(GetCurrentProcess(),&nbsp;TOKEN_ADJUST_PRIVILEGES&nbsp;|&nbsp;TOKEN_QUERY,&nbsp;&amp;h_token);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;open&nbsp;process&nbsp;token:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;grab&nbsp;LUID&nbsp;of&nbsp;requested&nbsp;privilege<br />	b_ret&nbsp;=&nbsp;LookupPrivilegeValueA(NULL,&nbsp;privilege,&nbsp;&amp;luid);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;grab&nbsp;LUID&nbsp;of&nbsp;requested&nbsp;privilege:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;enable&nbsp;the&nbsp;privilege<br />	token_privs.PrivilegeCount&nbsp;=&nbsp;1;<br />	token_privs.Privileges[0].Luid&nbsp;=&nbsp;luid;<br />	token_privs.Privileges[0].Attributes&nbsp;=&nbsp;SE_PRIVILEGE_ENABLED;<br /><br />	b_ret&nbsp;=&nbsp;AdjustTokenPrivileges(h_token,&nbsp;FALSE,&nbsp;&amp;token_privs,&nbsp;sizeof(token_privs),&nbsp;NULL,&nbsp;NULL);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[-]&nbsp;failed&nbsp;to&nbsp;enable&nbsp;privilege:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		goto&nbsp;cleanup;<br />	}<br /><br />cleanup:<br />	if&nbsp;(h_token)&nbsp;CloseHandle(h_token);<br /><br />	return&nbsp;okay;<br />}<br /><br />LRESULT&nbsp;CALLBACK&nbsp;WindowProc(HWND&nbsp;hwnd,&nbsp;UINT&nbsp;uMsg,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br />{<br />	switch&nbsp;(uMsg)<br />	{<br />	case&nbsp;WM_QUERYENDSESSION:<br />		d_RtlSetProcessIsCritical(FALSE,&nbsp;NULL,&nbsp;FALSE);		//&nbsp;set&nbsp;process&nbsp;as&nbsp;non-critical<br />		return&nbsp;TRUE;										//&nbsp;return&nbsp;1&nbsp;to&nbsp;WM_QUERYENDSESSION&nbsp;to&nbsp;allow&nbsp;system&nbsp;shutdown<br />	default:<br />		return&nbsp;DefWindowProc(hwnd,&nbsp;uMsg,&nbsp;wParam,&nbsp;lParam);<br />	}<br /><br />	return&nbsp;0;<br />}<br /><br />int&nbsp;WINAPI&nbsp;WinMain(HINSTANCE&nbsp;hInstance,&nbsp;HINSTANCE&nbsp;hPrevInstance,&nbsp;LPSTR&nbsp;lpCmdLine,&nbsp;int&nbsp;nCmdShow)<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br /><br />	//&nbsp;create&nbsp;window&nbsp;class<br />	HWND&nbsp;hwnd&nbsp;=&nbsp;NULL;<br />	const&nbsp;wchar_t&nbsp;class_name[]&nbsp;=&nbsp;L&quot;invisible&quot;;<br /><br />	WNDCLASS&nbsp;wc&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	wc.lpfnWndProc&nbsp;=&nbsp;WindowProc;<br />	wc.hInstance&nbsp;=&nbsp;hInstance;<br />	wc.lpszClassName&nbsp;=&nbsp;class_name;<br /><br />	RegisterClassW(&amp;wc);<br />	hwnd&nbsp;=&nbsp;CreateWindowW(class_name,&nbsp;L&quot;invisible&quot;,&nbsp;WS_OVERLAPPEDWINDOW,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;CW_USEDEFAULT,&nbsp;NULL,&nbsp;NULL,&nbsp;hInstance,&nbsp;NULL);<br />	ShowWindow(hwnd,&nbsp;SW_HIDE);		//&nbsp;hide&nbsp;window<br />	UpdateWindow(hwnd);<br /><br />	//&nbsp;enable&nbsp;SeDebugPrivilege<br />	b_ret&nbsp;=&nbsp;EnablePrivilege(&quot;SeDebugPrivilege&quot;);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />		return&nbsp;EXIT_FAILURE;<br /><br />	//&nbsp;set&nbsp;process&nbsp;as&nbsp;critical<br />	d_RtlSetProcessIsCritical&nbsp;=&nbsp;(t_RtlSetProcessIsCritical)GetProcAddress(GetModuleHandleA(&quot;Ntdll.dll&quot;),&nbsp;&quot;RtlSetProcessIsCritical&quot;);<br />	d_RtlSetProcessIsCritical(TRUE,&nbsp;NULL,&nbsp;FALSE);<br /><br />	MessageBoxA(NULL,&nbsp;&quot;try&nbsp;to&nbsp;terminate&nbsp;me&quot;,&nbsp;&quot;hi!&quot;,&nbsp;MB_OK);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
