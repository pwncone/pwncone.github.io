<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>iptables</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Linux - iptables</h1></strong><br /><br /><strong><h2>## Chains</h2></strong><br />iptables has 3 different chains<br /><br />• <strong>Input</strong> - controls incoming connections<br />• <strong>Forward</strong> - controls incoming connections to be forwarded elsewhere <br />   ◇ (used on routers, not your user PC)<br />   ◇ to check if you need the forward chain, run <code>iptables -L -v</code> and check how many packets/bytes have passed through it<br />• <strong>Output</strong> - controls outgoing connections<br />   ◇ but keep in mind that to return data the input chain needs to be open too<br />   ◇ e.g.<br />      ▪ output chain allows pinging external hosts<br />      ▪ input chain for ping needs to be open as well so that you see the response<br />   ◇ e.g. SSH needs to be in the input chain and output chain to both send and receive data<br /><br /><strong><h2>## Rules</h2></strong><br />• <strong>Accept</strong> - allow the conneciton<br />• <strong>Drop</strong> - drop the connection / act like it never happened. Best if you don&#39;t want the source to realise your system exists<br />• <strong>Reject</strong> - don&#39;t allow the connection, but send back an error<br /><br />Here&#39;s what each of those look like with <code>ping</code>...<br /><br />Allow<br /><a href=""><img src="images/945-1.png" alt="images/945-1.png" /></a><br /><br />Drop<br /><a href=""><img src="images/945-2.png" alt="images/945-2.png" /></a><br /><br />Reject<br /><a href=""><img src="images/945-3.png" alt="images/945-3.png" /></a><br /><br /><strong><h2>## Connection States</h2></strong><br />If you want to allow SSH connections to your system, the input and  output chains are going to need a rule added to them. But, what if you only want SSH coming into your system to be allowed? Won’t adding a rule  to the output chain also allow outgoing SSH attempts?<br /><br />That’s where connection states come in.<br /><br />Incoming SSH connections from 10.11.0.184 are allowed<br /><code>iptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -m state --state NEW,ESTABLISHED -j ACCEPT</code><br /><br />Outgoing SSH traffic to destination 10.11.0.184 is allowed IF the connection is already established.<br /><code>iptables -A OUTPUT -p tcp --sport 22 -d 10.10.10.10 -m state --state ESTABLISHED -j ACCEPT</code><br /><br />This blocks outgoing SSH connections over the whole system, but allows for outgoing SSH data when someone has already established an SSH connection from 10.11.0.184.<br /><br /><strong><h2>## Commands</h2></strong><br />• When a connection is made, iptables goes through the list of rules 1 by 1 until it find a rule that matches the connection<br />   ◇ you can insert rules above or below one another<br /><br /><code>-A</code> - append rule to end of specified chain<br /><code>-I [chain] [number]</code> - Insert a rule at a specified place in a chain<br /><br /><code>iptables -L</code> - View current rules<br /><code>iptables -L -v</code> - View total amount of data gone through each chain<br /><code>iptables -F</code> - flush (clear) all the currently configured rules<br /><br /><strong>Dropping</strong><br />Drop all incomoing connections from a single IP<br /><code>iptables -A INPUT -s 10.11.0.184 -j DROP</code><br />Drop all incoming SSH connections from a single IP<br /><code>iptables - A INPUT -p tcp --dport ssh -s 10.11.0.184 -j DROP</code><br />Drop all incoming SSH connections from <em>every</em> IP<br /><code>iptables -A INPUT -p tcp --dport ssh -j DROP</code><br /><br /><strong><h2>## Saving Changes</h2></strong><br />The changes that you make to your iptables rules will be scrapped the next time that the iptables service gets restarted unless you execute a command to save the changes.<br /><br />Ubuntu<br /><code>sudo /sbin/iptables-save</code><br />Red Hat / CentOS:<br /><code>/sbin/service iptables save</code><br />Or<br /><code>/etc/init.d/iptables save</code><br /><br /></div>
</body>
</html>
