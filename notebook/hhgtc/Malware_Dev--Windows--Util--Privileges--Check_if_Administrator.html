<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Check if Administrator</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Check if Administrator</h1></strong><br />Apparently it&#39;s possible to drop privileges if you already have them:<br /><a href="https://stackoverflow.com/a/6419772">https://stackoverflow.com/a/6419772</a><br /><br /><strong><h2>## IsUserAnAdmin()</h2></strong><br /><a href="https://docs.microsoft.com/en-gb/windows/win32/api/shlobj_core/nf-shlobj_core-isuseranadmin">https://docs.microsoft.com/en-gb/windows/win32/api/shlobj_core/nf-shlobj_core-isuseranadmin</a><br />Function is deprecated - might get altered or become unavailable at any point.<br /><br /><code>IsUserAnAdmin()</code> is a wrapper around <code>CheckTokenMembership</code>.<br />MSDN recommendeds to call that function directly to determine Administrator group status rather than calling <code>IsUserAnAdmin</code>.<br /><br />MSDN says that <code>IsUserAnAdmin</code> &quot;tests whether the current user is a member of the Administrator&#39;s group&quot;, but I think that&#39;s wrong.<br />Because it&#39;s a wrapper around CheckTokenMembership, it simply checks if it has Administrator-only tokens enabled. Therefore, this function will only return TRUE if run inside of an Administrator command prompt.<br /><br />For example,<br /><code>Bob</code> is an Administrator.<br /><code>Bob</code> runs a non-Administrator cmd -&gt; <code>IsUserAnAdmin()</code> returns FALSE.<br /><code>Bob</code> runs <code>cmd</code> as Administrator -&gt; <code>IsUserAnAdmin()</code> returns TRUE because Administrator-only tokens are now available to him.<br /><br /><strong><h3>Code</h3></strong><h3> </h3><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;ShlObj.h&gt;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;admin&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;admin&nbsp;=&nbsp;IsUserAnAdmin();<br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%d&nbsp;\n&quot;,&nbsp;admin);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>Demo</h3></strong><br />I&#39;m logged in as <code>Bob</code> - a local Administrator.<br /><code>admin_check.exe</code> is run under a non-Administrator cmd prompt.<br /><code>admin_check.exe</code> returns FALSE, we&#39;re not an Administrator.<br />If we check our privileges, they look like a normal user&#39;s privileges.<br /><a href=""><img src="images/1567-1.png" alt="images/1567-1.png" /></a><br /><br />Now we run <code>admin_check.exe</code> under an Administrator cmd prompt.<br /><code>admin_check.exe</code> returns TRUE, we&#39;re an Administrator.<br />If we check our privileges, we have Administrator-only privileges now available to us.<br /><a href=""><img src="images/1567-2.png" alt="images/1567-2.png" /></a><br /><br /><strong><h2>## CheckTokenMembership</h2></strong><br /><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-checktokenmembership">https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-checktokenmembership</a><br />Code for checking if Administrator is in MSDN example above.<br /><br /><strong><h2>## TOKEN_ELEVATION.TokenIsElevated</h2></strong><br />Don&#39;t fully understand what this code does.<br />Open token on current process &gt; get token info &gt; query <code>TokenIsElevated</code> element from <code>TOKEN_ELEVATION</code> struct, which returns TRUE or FALSE.<br /><br />Source: <a href="https://stackoverflow.com/a/8196291">https://stackoverflow.com/a/8196291</a><br /><div class="codebox"><div class="codebox">BOOL&nbsp;IsElevated(&nbsp;)&nbsp;<span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;fRet&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hToken&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;OpenProcessToken(&nbsp;GetCurrentProcess(&nbsp;),TOKEN_QUERY,&amp;hToken&nbsp;)&nbsp;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TOKEN_ELEVATION&nbsp;Elevation;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;cbSize&nbsp;=&nbsp;sizeof(&nbsp;TOKEN_ELEVATION&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;GetTokenInformation(&nbsp;hToken,&nbsp;TokenElevation,&nbsp;&amp;Elevation,&nbsp;sizeof(&nbsp;Elevation&nbsp;),&nbsp;&amp;cbSize&nbsp;)&nbsp;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fRet&nbsp;=&nbsp;Elevation.TokenIsElevated;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;hToken&nbsp;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(&nbsp;hToken&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fRet;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## AccessCheck</h2></strong><br /><a href="https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-accesscheck">https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-accesscheck</a><br />Haven&#39;t tested.<br />Apparently you can use it to check if Admin. Source: <a href="https://stackoverflow.com/a/26231282">https://stackoverflow.com/a/26231282</a><br />Uses tokens.<br /><br /></div>
</body>
</html>
