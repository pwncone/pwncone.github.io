<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DLLs</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># DLLs</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain">https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain</a><br /><br /><strong><h2>## Debugging</h2></strong><br />• <a href="https://blog.nviso.eu/2020/08/04/debugging-dlls-3-techniques-to-help-you-get-started/">https://blog.nviso.eu/2020/08/04/debugging-dlls-3-techniques-to-help-you-get-started/</a><br /><br /><strong><h3>### Use DbgView</h3></strong><br />You will have to enable to DbgView output first<br />• <a href="https://stackoverflow.com/questions/12494300/no-output-from-debugview">https://stackoverflow.com/questions/12494300/no-output-from-debugview</a><br /><br />To print to DbgView with userland APIs you use <code>OutputDebugString</code><br />So that you can use formatted strings, create a macro<br />• <a href="https://stackoverflow.com/questions/29049686/is-there-a-better-way-to-pass-formatted-output-to-outputdebugstring">https://stackoverflow.com/questions/29049686/is-there-a-better-way-to-pass-formatted-output-to-outputdebugstring</a><br /><div class="codebox"><div class="codebox">#define&nbsp;DbgViewPrint(...)&nbsp;{char&nbsp;str[512];&nbsp;sprintf_s(str,&nbsp;512,&nbsp;__VA_ARGS__);&nbsp;&nbsp;OutputDebugStringA(str);}<br /><br />DbgViewPrint(&quot;[smile]&nbsp;found&nbsp;DOS&nbsp;header&nbsp;@&nbsp;0x%p&nbsp;=&nbsp;0x%x&quot;,&nbsp;(LPVOID)current_address,&nbsp;dos_header-&gt;e_magic);</div></div><br /><br />DbgView gets filled with a lot of other program&#39;s prints, so use a filter<br /><a href=""><img src="images/1533-1.png" alt="images/1533-1.png" /></a><br /><br /><strong><h3>### Create a loader that loads the DLL into itself, then use printf</h3></strong><br />• [Debugging method 2: using Printf] - <a href="https://blog.nviso.eu/2020/08/04/debugging-dlls-3-techniques-to-help-you-get-started/">https://blog.nviso.eu/2020/08/04/debugging-dlls-3-techniques-to-help-you-get-started/</a><br /><br /><strong><h2>## Running/testing DLLs</h2></strong><br />You can run/test a dll using the command <code>rundll32.exe</code>.<br />• <a href="https://ss64.com/nt/rundll32.html">https://ss64.com/nt/rundll32.html</a><br />• <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/rundll32">https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/rundll32</a><br /><br /><code>rundll32.exe my.dll &lt;function&gt;</code><br /><code>rundll32.exe my.dll DllMain</code><br /><code>rundll32.exe user32.dll, LockWorkStation</code><br /><br />If you&#39;re on a 64bit machine, there are 2 versions of rundll:<br />• 64-bit: <code>C:\Windows\System32\rundll32.exe</code> - can run 32bit and 64bit DLLs<br />• 32-bit: <code>C:\Windows\SysWOW64\rundll32.exe</code> - can only run 32bit DLLs<br /><br /><strong><h2>## Create exported function</h2></strong><br />• <a href="https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport?view=msvc-160">https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport?view=msvc-160</a><br /><br />You create an exported function with:<br /><code>__declspec(dllexport)</code><br />e.g.<br /><code>__declspec(dllexport) BOOL __cdecl SayHello(void)</code><br /><br />• <code>__declspec(dllexport)</code> defines it as an export<br />• <code>__cdecl</code> specifies to use the default calling convention for C and C++ programs.<br />   ◇ not necessary<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />#include&nbsp;&quot;main.h&quot;<br /><br />__declspec(dllexport)&nbsp;BOOL&nbsp;__cdecl&nbsp;SayHello(void)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(NULL,&nbsp;&quot;hey&nbsp;smile&nbsp;:)&quot;,&nbsp;&quot;title&quot;,&nbsp;MB_OK);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;okay;<br />}<br /><br />BOOL&nbsp;WINAPI&nbsp;DllMain(HINSTANCE&nbsp;hinstDLL,&nbsp;DWORD&nbsp;fdwReason,&nbsp;LPVOID&nbsp;lpReserved)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(fdwReason)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(NULL,&nbsp;&quot;hey!&nbsp;i&#39;ve&nbsp;been&nbsp;attached&nbsp;:)&quot;,&nbsp;&quot;smile&quot;,&nbsp;MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br />You then typically create a header file that stores prototypes for your exported functions.<br />MSDN recommends to use <code>#define DllExport __declspec(dllexport)</code> to make your code cleaner.<br /><div class="codebox"><div class="codebox">#pragma&nbsp;once<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />#define&nbsp;DllExport&nbsp;__declspec(dllexport)<br />DllExport&nbsp;BOOL&nbsp;__cdecl&nbsp;SayHello(void);</div></div><br /><br />Your function will now show up as an exported function<br /><a href=""><img src="images/1533-2.png" alt="images/1533-2.png" /></a><br /><br />And you can execute it with <code>rundll32.exe</code><br /><a href=""><img src="images/1533-3.png" alt="images/1533-3.png" /></a><br /><br /><br /><br /></div>
</body>
</html>
