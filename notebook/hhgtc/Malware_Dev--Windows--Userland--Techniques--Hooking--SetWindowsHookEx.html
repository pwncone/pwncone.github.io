<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SetWindowsHookEx</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># SetWindowsHookEx Hooking</h1></strong><br /><code>SetWindowsHookEx</code> is the official way to install hooks using the Windows API.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures">https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures</a><br /><br />You won&#39;t be able to hook individual Windows APIs with SetWindowsHookEx,<br />instead it hooks things like window messages, keyboard/mouse events, etc.<br />Here are the hook types you can set:<br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/about-hooks#hook-types">https://docs.microsoft.com/en-us/windows/win32/winmsg/about-hooks#hook-types</a><br /><br />Hook procedures are the code that runs when the hooked function is called.<br /><br />Hooks are installed in chains.<br />When a hooked function is called, it will pass the message to each hook procedure in the chain 1 by 1.<br /><br />Hooks installed with <code>SetWindowsHookEx</code> are installed at the beginning of the chain.<br />A hook procedure can pass the message to the next hook in the chain using <code>CallNextHookEx</code>.<br /><br /><strong><h2>## How-to</h2></strong><br />This is the most common way to install hooks using SetWindowsHookEx, and is the one outlined on MSDN.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures">https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures</a><br /><br />You create:<br />• a DLL containing an exported hook procedure (the code that will run when a hooked event occurs),<br />• an installer program which install the hook into the target process (or globally)<br /><br />Your hook installer program will:<br />• <code>LoadLibrary</code> - retrieve a handle to the DLL containing the hook procedure<br />• <code>GetProcAddress</code> - get the address of the hook procedure in the DLL<br />• <code>SetWindowsHookEx</code> - call SetWindowsHookEx and specify the hook type, the address of the hook procedure function, a handle to the DLL containing my hook procedure, and the thread to target<br />   ◇ if <code>dwThreadId</code> is set to <code>0</code>, the hook will target all threads i.e. the hook will be global<br /><br /><code>SetWindowsHookEx</code> will then load the library (DLL) into the target process using <code>LoadLibrary</code>.<br /><br />To remove the hook, call <code>UnhookWindowsHookEx</code> in the installer.<br />This won&#39;t, however, free the library from the target process.<br /><br /><strong><h2>## Demo - Hook Installer + DLL - Hooking WH_GETMESSAGE</h2></strong><br />I&#39;ll set my installer to hook <code>WH_GETMESSAGE</code><br />Hooking WH_GETMESSAGE isn&#39;t particularly useful, I&#39;m just showing you how for the sake of a demo.<br /><br /><strong><h3>### DLL</h3></strong><br />This is a DLL containing an exported hook procedure.<br />This DLL will be injected into other processes.<br /><br />Here, my hook procedure (hook function) is called <code>hook_WH_GETMESSAGE</code>.<br />This is the code that will run whenever a message is sent to my target process&#39;s window.<br /><a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/about-hooks#wh_getmessage">https://docs.microsoft.com/en-us/windows/win32/winmsg/about-hooks#wh_getmessage</a><br /><br />The function will spawn a MessageBox, and then proceed to the next hook.<br /><div class="codebox"><div class="codebox">/*<br />DLL&nbsp;to&nbsp;be&nbsp;injected&nbsp;into&nbsp;applications&nbsp;by&nbsp;hook&nbsp;installer.<br />*/<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />__declspec(dllexport)&nbsp;LRESULT&nbsp;CALLBACK&nbsp;hook_WH_GETMESSAGE(int&nbsp;nCode,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(NULL,&nbsp;&quot;you&nbsp;have&nbsp;a&nbsp;message&nbsp;:)&quot;,&nbsp;&quot;hi&quot;,&nbsp;MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CallNextHookEx(NULL,&nbsp;nCode,&nbsp;wParam,&nbsp;lParam);<br />}<br /><br />BOOL&nbsp;WINAPI&nbsp;DllMain(HINSTANCE&nbsp;hinstDLL,&nbsp;DWORD&nbsp;fdwReason,&nbsp;LPVOID&nbsp;lpReserved)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(fdwReason)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(NULL,&nbsp;&quot;hey!&nbsp;i&#39;ve&nbsp;been&nbsp;attached&nbsp;:)&quot;,&nbsp;&quot;smile&quot;,&nbsp;MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### Installer</h3></strong><br />Here is my hook installer program.<br />I&#39;m targetting Notepad.exe<br /><div class="codebox"><div class="codebox">/*<br />Hook&nbsp;installer&nbsp;that&nbsp;targets&nbsp;a&nbsp;Notepad&nbsp;window.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />BOOL&nbsp;InstallHook(void)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />	<br />	HWND&nbsp;h_target_wnd&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;target_pid&nbsp;=&nbsp;0;<br />	DWORD&nbsp;target_tid&nbsp;=&nbsp;0;<br /><br />	HMODULE&nbsp;hmod_dll&nbsp;=&nbsp;NULL;<br />	HHOOK&nbsp;h_hook&nbsp;=&nbsp;NULL;<br /><br />	char&nbsp;target_window_name[]&nbsp;=&nbsp;&quot;Untitled&nbsp;-&nbsp;Notepad&quot;;<br />	char&nbsp;dll_path[]&nbsp;=&nbsp;&quot;C:\\Users\\bob\\source\\example_code\\hooking\\SetWindowsHookEx\\dllinjectme\\x64\\Release\\dllinjectme.dll&quot;;<br />	char&nbsp;hook_function[]&nbsp;=&nbsp;&quot;hook_WH_GETMESSAGE&quot;;<br />	HOOKPROC&nbsp;hook_function_addr&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;get&nbsp;process&nbsp;ID&nbsp;and&nbsp;thread&nbsp;ID&nbsp;of&nbsp;target&nbsp;process<br />	h_target_wnd&nbsp;=&nbsp;FindWindowA(NULL,&nbsp;target_window_name);<br />	if&nbsp;(h_target_wnd&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;find&nbsp;window&nbsp;\&quot;%s\&quot;:&nbsp;%d&nbsp;\n&quot;,&nbsp;target_window_name,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;found&nbsp;target&nbsp;process:&nbsp;%s&nbsp;\n&quot;,&nbsp;target_window_name);<br /><br />	target_tid&nbsp;=&nbsp;GetWindowThreadProcessId(h_target_wnd,&nbsp;&amp;target_pid);<br /><br />	//&nbsp;load&nbsp;DLL&nbsp;containing&nbsp;hook<br />	hmod_dll&nbsp;=&nbsp;LoadLibraryA(dll_path);<br />	if&nbsp;(hmod_dll&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;load&nbsp;DLL:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;loaded&nbsp;DLL&nbsp;\n&quot;);<br />	<br />	//&nbsp;retrieve&nbsp;address&nbsp;of&nbsp;exported&nbsp;hook&nbsp;function&nbsp;in&nbsp;DLL<br />	hook_function_addr&nbsp;=&nbsp;(HOOKPROC)GetProcAddress(hmod_dll,&nbsp;hook_function);<br />	if&nbsp;(hook_function_addr&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;find&nbsp;addr&nbsp;of&nbsp;exported&nbsp;HookMe&nbsp;function:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;found&nbsp;%s&nbsp;function&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;hook_function,&nbsp;hook_function_addr);<br /><br />	/*<br />	Install&nbsp;the&nbsp;hook&nbsp;into&nbsp;the&nbsp;target&nbsp;process.<br />	If&nbsp;SetWindowHookEx&#39;s&nbsp;dwThreadId&nbsp;is&nbsp;set&nbsp;to&nbsp;0,&nbsp;this&nbsp;hook&nbsp;will&nbsp;be&nbsp;global&nbsp;and&nbsp;SetWindowsHookEx&nbsp;will&nbsp;inject&nbsp;your&nbsp;DLL&nbsp;into&nbsp;all&nbsp;processes.<br />	*/<br />	h_hook&nbsp;=&nbsp;SetWindowsHookExA(WH_GETMESSAGE,&nbsp;hook_function_addr,&nbsp;hmod_dll,&nbsp;target_tid);<br />	if&nbsp;(h_hook&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;set&nbsp;hook:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;set&nbsp;hook&nbsp;\n&quot;);<br /><br />	//&nbsp;pause&nbsp;execution&nbsp;of&nbsp;this&nbsp;hook&nbsp;installer&nbsp;program.&nbsp;upon&nbsp;key&nbsp;press,&nbsp;remove&nbsp;hook<br />	printf(&quot;\npress&nbsp;any&nbsp;key&nbsp;to&nbsp;unhook&nbsp;\n&quot;);<br />	system(&quot;pause&nbsp;&gt;&nbsp;nul&quot;);<br /><br />	b_ret&nbsp;=&nbsp;UnhookWindowsHookEx(h_hook);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;remove&nbsp;hook:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;hook&nbsp;removed!&nbsp;\n&quot;);<br /><br />	return&nbsp;okay;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	InstallHook();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### Demo</h3></strong><br />Both the DLL and hook installer programs above are compiled as x64 Release.<br />Running on Windows 10 x64 2004.<br /><br />I&#39;ve started a 64bit Notepad process and run my installer.<br />We see that the hook has been set and that in Notepad&#39;s <code>Modules</code> that our DLL is present - <code>dllinjectme.dll</code><br /><br />Within Notepad we see that a MessageBox has spawned telling me that Notepad has received a window message.<br /><a href=""><img src="images/1670-1.png" alt="images/1670-1.png" /></a><br /><br /></div>
</body>
</html>
