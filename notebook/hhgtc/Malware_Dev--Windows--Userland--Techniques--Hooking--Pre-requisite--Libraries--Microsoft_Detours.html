<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Microsoft Detours</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Microsoft Detours</h1></strong><br />A Microsoft library that hooks functions. Is good. Current version is 4.0.<br />3.0 only supported x86 detours. You had to pay for the professional edition for x64 detours.<br />In 4.0 everything is now free.<br /><br />• <a href="https://guidedhacking.com/threads/how-to-use-ms-detours-microsoft-detours-tutorial.13553/">https://guidedhacking.com/threads/how-to-use-ms-detours-microsoft-detours-tutorial.13553/</a><br />• <a href="https://www.codeproject.com/Articles/30140/API-Hooking-with-MS-Detours">https://www.codeproject.com/Articles/30140/API-Hooking-with-MS-Detours</a><br />• <a href="https://github.com/microsoft/Detours/wiki/Using-Detours">https://github.com/microsoft/Detours/wiki/Using-Detours</a> - Use the official Microsoft Detours wiki!<br /><br /><strong><h2>## x64 Example<br /></h2></strong><strong><h3>### Set up and use Detours</h3></strong><strong><br /></strong>Download x64 detours with <code>vcpkg</code>:<br /><div class="codebox"><div class="codebox">mkdir&nbsp;C:\dev<br />cd&nbsp;C:\dev<br />git&nbsp;clone&nbsp;https://github.com/microsoft/vcpkg<br />.\vcpkg\bootstrap-vcpkg.bat<br />.\vcpkg\vcpkg&nbsp;install&nbsp;detours:x64-windows</div></div><br /><br />The header file will be in:<br /><code>C:\dev\vcpkg\packages\detours_x64-windows\include\detours\detours.h</code><br />And the .lib file will be in:<br /><code>C:\dev\vcpkg\packages\detours_x64-windows\lib\detours.lib</code><br /><br />In Visual Studio:<br />1. Set project to x64<br />2. Make sure to include the header.<br />3. Navigate to <code>Project &gt; Properties &gt; Linker &gt; Input &gt; Additional Dependencies &gt; Edit</code> <br />and add the path to <code>detours.lib</code> into Additional Dependencies.<strong><br /></strong><strong><br /></strong><strong><h3>### MessageBoxA Detours Demo</h3></strong><strong><br /></strong>Here&#39;s MessageBoxA before hooking:<br /><a href=""><img src="images/1666-1.png" alt="images/1666-1.png" /></a><br /><br />And here Detours has hooked it.<br /><a href=""><img src="images/1666-2.png" alt="images/1666-2.png" /></a><br /><br />Here&#39;s the trampoline:<br /><a href=""><img src="images/1666-3.png" alt="images/1666-3.png" /></a><br /><br />And here&#39;s the code at <code>orig_MessageBoxA</code>.<br />This is the function prologue code in MessageBoxA that the detour overwrote.<br /><a href=""><img src="images/1666-4.png" alt="images/1666-4.png" /></a><br /><strong><br /></strong><strong><h3>### Code</h3></strong><br /><div class="codebox"><div class="codebox">/*<br />x64&nbsp;function&nbsp;hooking&nbsp;with&nbsp;Microsoft&#39;s&nbsp;Detours.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&quot;C:\dev\vcpkg\packages\detours_x64-windows\include\detours\detours.h&quot;<br /><br />int(WINAPI*&nbsp;orig_MessageBoxA)(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType)&nbsp;=&nbsp;MessageBoxA;<br />int&nbsp;WINAPI&nbsp;hook_MessageBoxA(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType)<br />{<br />	printf(&quot;MessageBoxA&nbsp;intercepted!&nbsp;\n&quot;);<br />	printf(&quot;\t&nbsp;text:&nbsp;%s&nbsp;\n\t&nbsp;caption:&nbsp;%s&nbsp;\n\t&nbsp;type:&nbsp;%d&nbsp;\n&quot;,&nbsp;lpText,&nbsp;lpCaption,&nbsp;uType);<br /><br />	return&nbsp;orig_MessageBoxA(hWnd,&nbsp;lpText,&nbsp;lpCaption,&nbsp;uType);<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	MessageBoxA(NULL,&nbsp;&quot;I&nbsp;think&nbsp;I&nbsp;should&nbsp;greet&nbsp;myself&quot;,&nbsp;&quot;Hmm...&quot;,&nbsp;MB_OK);<br /><br />	//&nbsp;Install&nbsp;MS&nbsp;Detours&nbsp;hook<br />	DetourRestoreAfterWith();<br />	DetourTransactionBegin();<br />	DetourUpdateThread(GetCurrentThread());<br />	DetourAttach(&amp;(void*&amp;)orig_MessageBoxA,&nbsp;hook_MessageBoxA);<br />	DetourTransactionCommit();<br /><br />	MessageBoxA(NULL,&nbsp;&quot;Hello&quot;,&nbsp;&quot;Hi&nbsp;#1&quot;,&nbsp;MB_OK);<br />	MessageBoxA(NULL,&nbsp;&quot;Hello&nbsp;good&nbsp;sir!&quot;,&nbsp;&quot;Hi&nbsp;#2&quot;,&nbsp;MB_OK);<br /><br />	//&nbsp;Remove&nbsp;MS&nbsp;Detours&nbsp;hook<br />	DetourTransactionBegin();<br />	DetourUpdateThread(GetCurrentThread());<br />	DetourDetach(&amp;(PVOID&amp;)orig_MessageBoxA,&nbsp;hook_MessageBoxA);<br />	DetourTransactionCommit();<br />	<br />	MessageBoxA(NULL,&nbsp;&quot;Did&nbsp;he&nbsp;hear&nbsp;me&nbsp;ok?&quot;,&nbsp;&quot;Hmm...&quot;,&nbsp;MB_OK);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
