<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Export Key to PLAINTEXTKEYBLOB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Export Key to PLAINTEXTKEYBLOB</h1></strong><br />â€¢ <a href="https://stackoverflow.com/a/29589430">https://stackoverflow.com/a/29589430</a><br /><br /><div class="codebox"><div class="codebox">/*<br />Generates&nbsp;a&nbsp;random&nbsp;AES256&nbsp;key&nbsp;and&nbsp;exports&nbsp;it&nbsp;to&nbsp;plaintext.<br />PLAINTEXTKEYBLOB&nbsp;struct&nbsp;is&nbsp;here:<br />https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/jj650836(v%3Dvs.85)<br />BLOBHEADER&nbsp;struct&nbsp;is&nbsp;here:<br />https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/jj650836(v%3Dvs.85)<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;wincrypt.h&gt;<br /><br />#pragma&nbsp;comment(lib,&nbsp;&quot;Crypt32.lib&quot;)<br /><br />#define&nbsp;CRYPTO_PROVIDER			MS_ENH_RSA_AES_PROV_A<br />#define&nbsp;CRYPTO_PROVIDER_TYPE	PROV_RSA_AES<br />#define&nbsp;KEY_ALGORITHM			CALG_AES_256<br />#define&nbsp;AES256_KEYSIZE			32		//&nbsp;32&nbsp;bytes&nbsp;/&nbsp;256&nbsp;bits<br /><br />typedef&nbsp;struct&nbsp;KEYBLOB_&nbsp;{<br />	BLOBHEADER&nbsp;hdr;<br />	DWORD&nbsp;key_size;<br />	BYTE&nbsp;rgbKeyData[AES256_KEYSIZE];<br />}&nbsp;KEYBLOB;<br /><br />int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br /><span style="color:#000000;font-weight:400">{</span><br />	int&nbsp;i&nbsp;=&nbsp;0;<br />	BOOL&nbsp;b&nbsp;=&nbsp;FALSE;<br />	HCRYPTKEY&nbsp;h_AESkey&nbsp;=&nbsp;0;<br />	HCRYPTPROV&nbsp;h_AESprovider&nbsp;=&nbsp;0;<br /><br />	b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_AESprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;CRYPTO_PROVIDER_TYPE,&nbsp;0);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		if&nbsp;(GetLastError()&nbsp;==&nbsp;NTE_BAD_KEYSET)<br />		{<br />			b&nbsp;=&nbsp;CryptAcquireContextA(&amp;h_AESprovider,&nbsp;NULL,&nbsp;CRYPTO_PROVIDER,&nbsp;CRYPTO_PROVIDER_TYPE,&nbsp;CRYPT_NEWKEYSET);<br />			if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />			{<br />				i&nbsp;=&nbsp;1;<br />				goto&nbsp;cleanup;<br />			}<br />		}<br />		else<br />		{<br />			i&nbsp;=&nbsp;1;<br />			goto&nbsp;cleanup;<br />		}<br />	}<br /><br />	//&nbsp;Generate&nbsp;a&nbsp;random&nbsp;AES256&nbsp;key<br />	b&nbsp;=&nbsp;CryptGenKey(h_AESprovider,&nbsp;CALG_AES_256,&nbsp;CRYPT_EXPORTABLE,&nbsp;&amp;h_AESkey);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;generate&nbsp;random&nbsp;AES&nbsp;key:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	//&nbsp;Export&nbsp;the&nbsp;AES&nbsp;key&nbsp;to&nbsp;a&nbsp;BLOB<br />	KEYBLOB&nbsp;aes_keyblob&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	DWORD&nbsp;aes_keyblob_size&nbsp;=&nbsp;sizeof(KEYBLOB);<br />	b&nbsp;=&nbsp;CryptExportKey(h_AESkey,&nbsp;0,&nbsp;PLAINTEXTKEYBLOB,&nbsp;0,&nbsp;(BYTE*)&amp;aes_keyblob,&nbsp;&amp;aes_keyblob_size);<br />	if&nbsp;(b&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;-&nbsp;failed&nbsp;to&nbsp;export&nbsp;AES&nbsp;key:&nbsp;%d&nbsp;(%d)&nbsp;\n&quot;,&nbsp;GetLastError(),&nbsp;aes_keyblob_size);<br />		i&nbsp;=&nbsp;1;<br />		goto&nbsp;cleanup;<br />	}<br /><br />	printf(&quot;aes&nbsp;key:&nbsp;&quot;);<br />	for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;AES256_KEYSIZE;&nbsp;i++)<br />		printf(&quot;\\x%.2x&quot;,&nbsp;aes_keyblob.rgbKeyData[i]);<br />	printf(&quot;\n&quot;);<br /><br />	//&nbsp;Copy&nbsp;AES&nbsp;key&nbsp;into&nbsp;buffer&nbsp;to&nbsp;work&nbsp;with<br />	char&nbsp;aes256key_raw[AES256_KEYSIZE&nbsp;+&nbsp;1]&nbsp;=&nbsp;{&nbsp;0&nbsp;};<br />	strncpy_s(aes256key_raw,&nbsp;AES256_KEYSIZE&nbsp;+&nbsp;1,&nbsp;aes_keyblob.rgbKeyData,&nbsp;AES256_KEYSIZE);<br />	printf(&quot;aes256key_raw:&nbsp;%s&nbsp;\n&quot;,&nbsp;aes256key_raw);<br /><br />cleanup:<br />	if&nbsp;(h_AESkey)&nbsp;CryptDestroyKey(h_AESkey);<br />	if&nbsp;(h_AESprovider)&nbsp;CryptReleaseContext(h_AESprovider,&nbsp;0);<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div></div>
</body>
</html>
