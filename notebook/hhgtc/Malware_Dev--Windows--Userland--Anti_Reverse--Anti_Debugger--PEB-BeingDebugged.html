<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PEB->BeingDebugged</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># PEB-&gt;BeingDebugged</h1></strong><br />You can manually check the PEB&#39;s <code>BeingDebugged</code> flag yourself<br />(think this is what IsDebuggerPresent does, not sure)<br /><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</a><br /><br /><code>BeingDebugged</code> is set to 1 if process is being debugged, 0 if not.<br /><code>BeingDebugged</code> is a documented member of the PEB on MSDN, so you don&#39;t need to grab a complete PEB struct from anywhere for this.<br /><br /><strong><h2>## Code</h2></strong><br /><strong><h3>### c</h3></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h.&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;winternl.h&gt;<br /><br />BOOLEAN&nbsp;CheckPEB_BeingDebugged()<br />{<br />	BOOLEAN&nbsp;being_debugged&nbsp;=&nbsp;FALSE;<br />	PPEB&nbsp;p_peb&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;grab&nbsp;PEB&nbsp;of&nbsp;current&nbsp;process<br />#ifdef&nbsp;_WIN64<br />	p_peb&nbsp;=&nbsp;(PPEB)__readgsqword(0x60);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;TEB&nbsp;+&nbsp;0x60<br />#else<br />	p_peb&nbsp;=&nbsp;(PPEB)__readfsdword(0x30);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;TEB&nbsp;+&nbsp;0x30<br />#endif<br /><br />	if&nbsp;(p_peb-&gt;BeingDebugged&nbsp;==&nbsp;0)<br />		being_debugged&nbsp;=&nbsp;FALSE;<br />	else&nbsp;if&nbsp;(p_peb-&gt;BeingDebugged&nbsp;==&nbsp;1)<br />		being_debugged&nbsp;=&nbsp;TRUE;<br /><br />	return&nbsp;being_debugged;<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOLEAN&nbsp;being_debugged&nbsp;=&nbsp;FALSE;<br />	<br />	being_debugged&nbsp;=&nbsp;CheckPEB_BeingDebugged();<br />	if&nbsp;(being_debugged&nbsp;==&nbsp;TRUE)<br />		return&nbsp;1;<br /><br />	printf(&quot;hey&nbsp;:)&nbsp;\n&quot;);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### asm</h3></strong><br /><a href="https://github.com/cetfor/AntiDBG/blob/89f8fb7fb572aae326c2b0538e9e2b2cf56cf102/antidbg/antidbg.c#L43">https://github.com/cetfor/AntiDBG/blob/89f8fb7fb572aae326c2b0538e9e2b2cf56cf102/antidbg/antidbg.c#L43</a><br /><div class="codebox"><div class="codebox">/*<br />32bit&nbsp;only&nbsp;because&nbsp;Visual&nbsp;Studio&nbsp;doesn&#39;t&nbsp;accept&nbsp;x64&nbsp;inline&nbsp;assembly.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />BOOL&nbsp;asm_BeingDebuggedPEB(void)<br />{<br />	BOOL&nbsp;debugger_present&nbsp;=&nbsp;FALSE;<br /><br />	_asm<br />	{<br />		xor&nbsp;eax,&nbsp;eax;				//&nbsp;clear&nbsp;eax<br />		mov&nbsp;eax,&nbsp;fs:[0x30];			//&nbsp;grab&nbsp;start&nbsp;of&nbsp;PEB&nbsp;(FS&nbsp;register&nbsp;on&nbsp;32bit&nbsp;stores&nbsp;the&nbsp;TEB.&nbsp;TEB&nbsp;+&nbsp;0x30&nbsp;=&nbsp;PEB&nbsp;-&nbsp;https://en.wikipedia.org/wiki/Win32_Thread_Information_Block&nbsp;)<br />		mov&nbsp;eax,&nbsp;[eax&nbsp;+&nbsp;0x02];		//&nbsp;move&nbsp;PEB+2&nbsp;(location&nbsp;of&nbsp;BeingDebugged)&nbsp;into&nbsp;eax<br />		and&nbsp;eax,&nbsp;0x000000ff;		//&nbsp;grab&nbsp;1&nbsp;byte&nbsp;of&nbsp;eax<br />		mov&nbsp;debugger_present,&nbsp;eax;	//&nbsp;copy&nbsp;value&nbsp;in&nbsp;eax&nbsp;into&nbsp;debugger_present&nbsp;variable<br />	}<br /><br />	return&nbsp;debugger_present;<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	BOOL&nbsp;debugger_present&nbsp;=&nbsp;FALSE;<br />	<br />	debugger_present&nbsp;=&nbsp;asm_BeingDebuggedPEB();<br />	if&nbsp;(debugger_present&nbsp;==&nbsp;TRUE)<br />		return&nbsp;1;<br /><br />	printf(&quot;hey&nbsp;\n&quot;);<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /><strong><h2>## Bypass</h2></strong><br />• <a href="https://www.aldeid.com/wiki/PEB-Process-Environment-Block/BeingDebugged">https://www.aldeid.com/wiki/PEB-Process-Environment-Block/BeingDebugged</a><br /><br />(i&#39;m a noob)<br />Open in x64dbg.<br />Debug &gt; Run to user code<br />Right click in the disassembly pane &gt; Search for &gt; Current module &gt; Strings<br /><a href=""><img src="images/1773-1.png" alt="images/1773-1.png" /></a><br /><br />Double click to ollow the reference to <code>&quot;hey :) \n&quot;</code><br /><a href=""><img src="images/1773-2.png" alt="images/1773-2.png" /></a><br /><br />On the highlighted line we see our debug check.<br />It compares the value at <code>RAX + 2</code> to <code>1</code><br />The next instruction is <code>jne</code> - jump if not equal<br />If the value at <code>RAX + 2</code> is not equal to <code>1</code>, we jump to our <code>printf(&quot;hey \n&quot;)</code> code.<br /><a href=""><img src="images/1773-3.png" alt="images/1773-3.png" /></a><br /><br />Set a breakpoint at the <code>cmp</code> instruction and run.<br /><a href=""><img src="images/1773-4.png" alt="images/1773-4.png" /></a><br /><br />We hit the breakpoint.<br />RAX points to <code>0000001D7A1AF000</code><br />Therefore <code>RAX+2</code> will point to <code>0000001D7A1AF002</code><br /><a href=""><img src="images/1773-5.png" alt="images/1773-5.png" /></a><br /><br />Right click &gt; Follow in Dump on the value in RAX<br /><a href=""><img src="images/1773-6.png" alt="images/1773-6.png" /></a><br /><br />In the dump, <code>RAX+2</code> is highlighted.<br />The value at <code>RAX+2</code> is <code>1</code>, meaning that the above <code>jne</code> won&#39;t be taken and our code will exit without printing <code>hey :)</code><br /><a href=""><img src="images/1773-7.png" alt="images/1773-7.png" /></a><br /><br />Double click the <code>01</code>, modify it to <code>00</code><br /><a href=""><img src="images/1773-8.png" alt="images/1773-8.png" /></a><br /><br />Now if we F8 (step over) our code a few times, we see that the <code>jne</code> instruction jumps successfully and we hit our <code>printf(&quot;hey \n&quot;)</code> code.<br /><a href=""><img src="images/1773-9.png" alt="images/1773-9.png" /></a><br /><br />We&#39;ve successfully defeated checking the value in the <code>PEB-&gt;BeingDebugged</code> to evade debuggers!<br /><br />NOTE:<br />We can also see that <code>0000001D7A1AF000</code> in the Memory Map view corresponds to the process&#39;s PEB,<br />which is what we&#39;ve just modified.<br /><a href=""><img src="images/1773-10.png" alt="images/1773-10.png" /></a><br /><br />YOU CAN <code>NOP</code> ALL OF THE COMPARISON INSTRUCTIONS IF YOU WANT. THAT WORKS TOO<br /><a href=""><img src="images/1773-11.png" alt="images/1773-11.png" /></a><br /><br /></div>
</body>
</html>
