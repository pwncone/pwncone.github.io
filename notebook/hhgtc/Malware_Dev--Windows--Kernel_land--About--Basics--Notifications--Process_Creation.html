<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Process Creation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Process Creation</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutine</a><br />• <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_process_notify_routine">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nc-ntddk-pcreate_process_notify_routine</a><br /><br /><code>PsSetCreateProcessNotifyRoutine</code> notifies the driver about new &amp; terminated processes.<br /><br />A debuggee machine is running our driver.<br />A debugger machine is running WinDbg and is connected to the debuggee machine.<br /><br />On the debuggee machine running our driver I start <code>powershell</code> and run <code>whoami</code><br /><a href=""><img src="images/1808-1.png" alt="images/1808-1.png" /></a><br /><br />Back on the debugger machine, we see the output from our kernel driver in WinDbg.<br /><a href=""><img src="images/1808-2.png" alt="images/1808-2.png" /></a><br /><br />PID <code>2320</code> named <code>explorer.exe</code> created the process <code>6344</code> named <code>powershell.exe</code>.<br />This is me starting PowerShell. (ignore conhost)<br />Then, PID <code>6344</code> - <code>powershell.exe</code> - creates process <code>6296</code> named <code>whoami.exe</code>.<br /><br />We can monitor all of this as a result of <code>PsSetCreateProcessNotifyRoutine</code>.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;ntifs.h&gt;<br />#include&nbsp;&lt;ntddk.h&gt;<br />#include&nbsp;&lt;wdf.h&gt;<br /><br />/*<br />Routine&nbsp;that&nbsp;runs&nbsp;on&nbsp;process&nbsp;creation.<br />*/<br />void&nbsp;notify_CreateProcess(HANDLE&nbsp;parent_id,&nbsp;HANDLE&nbsp;process_id,&nbsp;BOOLEAN&nbsp;process_created)<br />{<br />	if&nbsp;(process_created&nbsp;==&nbsp;TRUE)<br />	{<br />		PEPROCESS&nbsp;process_info&nbsp;=&nbsp;NULL;<br />		PUNICODE_STRING&nbsp;parent_name&nbsp;=&nbsp;NULL;<br />		PUNICODE_STRING&nbsp;process_name&nbsp;=&nbsp;NULL;<br /><br />		//&nbsp;parent<br />		//&nbsp;grab&nbsp;EPROCESS&nbsp;struct<br />		PsLookupProcessByProcessId(parent_id,&nbsp;&amp;process_info);<br />		//&nbsp;grab&nbsp;process&nbsp;name&nbsp;from&nbsp;EPROCESS&nbsp;struct&nbsp;(undocumented)<br />		SeLocateProcessImageName(process_info,&nbsp;&amp;parent_name);<br /><br />		//&nbsp;child<br />		//&nbsp;grab&nbsp;EPROCESS&nbsp;struct<br />		PsLookupProcessByProcessId(process_id,&nbsp;&amp;process_info);<br />		//&nbsp;grab&nbsp;process&nbsp;name&nbsp;from&nbsp;EPROCESS&nbsp;struct&nbsp;(undocumented)<br />		SeLocateProcessImageName(process_info,&nbsp;&amp;process_name);<br /><br />		DbgPrint(&quot;PARENT&nbsp;%d&nbsp;%wZ&nbsp;CREATED:\n\t\tCHILD&nbsp;%d&nbsp;%wZ&nbsp;\n&quot;,&nbsp;parent_id,&nbsp;parent_name,&nbsp;process_id,&nbsp;process_name);<br />	}<br />	else&nbsp;if&nbsp;(process_created&nbsp;==&nbsp;FALSE)<br />	{<br />		DbgPrint(&quot;parent&nbsp;%d&nbsp;deleted&nbsp;%d&nbsp;\n&quot;,&nbsp;parent_id,&nbsp;process_id);<br />	}<br /><br />	return;<br />}<br /><br />void&nbsp;DriverUnload(PDRIVER_OBJECT&nbsp;DriverObject)<br />{<br />	UNREFERENCED_PARAMETER(DriverObject);<br /><br />	//&nbsp;remove&nbsp;set&nbsp;notifications<br />	PsSetCreateProcessNotifyRoutine(notify_CreateProcess,&nbsp;TRUE);<br /><br />	DbgPrint(&quot;driver&nbsp;unloaded&nbsp;\n&quot;);<br /><br />	return;<br />}<br /><br />NTSTATUS&nbsp;DriverEntry(PDRIVER_OBJECT&nbsp;DriverObject,&nbsp;PUNICODE_STRING&nbsp;RegistryPath)<br /><span style="color:#000000;font-weight:400">{</span><br />	UNREFERENCED_PARAMETER(DriverObject);<br />	UNREFERENCED_PARAMETER(RegistryPath);<br />	NTSTATUS&nbsp;nt_status&nbsp;=&nbsp;STATUS_SUCCESS;<br /><br />	DriverObject-&gt;DriverUnload&nbsp;=&nbsp;DriverUnload;<br /><br />	//&nbsp;start<br />	DbgPrint(&quot;driver&nbsp;loaded&nbsp;\n&quot;);<br /><br />	//&nbsp;notifications<br />	nt_status&nbsp;=&nbsp;PsSetCreateProcessNotifyRoutine(notify_CreateProcess,&nbsp;FALSE);<br /><br />	return&nbsp;nt_status;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><br /></div>
</body>
</html>
