<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Empty DACL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Empty DACL</h1></strong><br />Source:<br /><a href="https://stackoverflow.com/questions/6185975/prevent-user-process-from-being-killed-with-end-process-from-process-explorer">https://stackoverflow.com/questions/6185975/prevent-user-process-from-being-killed-with-end-process-from-process-explorer</a><br /><br />In the Windows access control model, if a DACL exists but contains no matching ACE, <a href="http://msdn.microsoft.com/en-us/library/aa446683%28v=vs.85%29">access is implicitly denied</a>.<br /><br />Therefore, you can protect your process by creating an empty DACL.<br />This prevents non-Administrative users from terminating your process.<br /><br /><strong><h2>## Status as of Windows 10 1809</h2></strong><br />It seems to work.<br />You can run and protect your .exe without needing Administrator privileges.<br />It prevents normal users from terminating the process, but Administrators from an Administrator task manager can terminate the process. (as Administrator, task manager opens as Admin by default).<br /><br /><strong><h2>## Notes</h2></strong><br />MSDN says <code>SetSecurityInfo</code> needs <code>SE_SECURITY_NAME</code> privilege (<code>SeSecurityPrivilege</code>) to be able to change the SACL of an object. So you might need to run an enablePrivilge function first to enable <code>SE_SECURITY_NAME</code>.<br /><br />• The process requires <code>SeSecurityPrivilege</code> (might or might not be a bother)<br /><br /><strong><h2>## Demo</h2></strong><br />• Windows 10 1809<br /><br />Upon attempting to terminate the process, we get an <code>Access is denied</code> error.<br /><a href=""><img src="images/1744-1.png" alt="images/1744-1.png" /></a><br /><br /><strong><h2>## Code</h2></strong><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br />#include&nbsp;&lt;AclAPI.h&gt;<br /><br />int&nbsp;protectProcess()<br />{<br />	BOOL&nbsp;bRet;<br />	DWORD&nbsp;dwRet;<br />	<br />	//&nbsp;creat&nbsp;empty&nbsp;DACL<br />	PACL&nbsp;pEmptyDACL&nbsp;=&nbsp;(PACL)malloc(sizeof(ACL));<br /><br />	bRet&nbsp;=&nbsp;InitializeAcl(pEmptyDACL,&nbsp;sizeof(ACL),&nbsp;ACL_REVISION);<br />	if&nbsp;(bRet&nbsp;==&nbsp;FALSE)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;to&nbsp;initialise&nbsp;a&nbsp;new&nbsp;ACL&nbsp;structure:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br /><br />	HANDLE&nbsp;hProcess&nbsp;=&nbsp;GetCurrentProcess();<br />	dwRet&nbsp;=&nbsp;SetSecurityInfo(hProcess,&nbsp;SE_KERNEL_OBJECT,&nbsp;DACL_SECURITY_INFORMATION,&nbsp;NULL,&nbsp;NULL,&nbsp;pEmptyDACL,&nbsp;NULL);<br />	if&nbsp;(dwRet&nbsp;!=&nbsp;ERROR_SUCCESS)<br />	{<br />		fprintf(stderr,&nbsp;&quot;[error]&nbsp;failed&nbsp;to&nbsp;set&nbsp;SACL&nbsp;of&nbsp;process:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		return&nbsp;1;<br />	}<br />	<br />	free(pEmptyDACL);<br />	return&nbsp;0;<br />}<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span><br />	printf(&quot;[*]&nbsp;protecting&nbsp;process...&nbsp;&quot;);<br />	if&nbsp;(protectProcess()&nbsp;!=&nbsp;0)<br />		return&nbsp;1;<br />	printf(&quot;DONE!&nbsp;\n&quot;);<br />	<br />	printf(&quot;Hello&nbsp;:)&nbsp;\n&quot;);<br />	getchar();<br />	<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
