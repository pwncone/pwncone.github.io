<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PowerShell Remoting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># WinRM - PowerShell Remoting</h1></strong><br />PowerShell Remoting uses the WS-Management Protocol.<br />Microsoft&#39;s implemetation of the WS-Management Protocol is WinRM.<br />i.e. PowerShell Remoting uses WinRM<br /><br />WS-Management protocol - <code>wsman</code> - runs on port 5895 and SSL port 5896.<br /><br />PowerShell Remoting is enabled by default on Server 2012 machines onwards.<br />If on a non Windows server OS - PowerShell Remoting isn&#39;t enabled by default<br />   ◇ Your have to run <code>Enable-PSRemoting</code> to enable it which requires Administrator privs<br /><br /><strong><h2>## Enable &amp; Test PSRemoting</h2></strong><br /><strong><h3>### On a non Windows Server OS</h3></strong><br />You must have Admin privileges to enable PowerShell Remoting - Local Administrator, Domain Admin etc. <br /><code>Enable-PSRemoting -Force</code><br /><br />After enabling, &#39;trust all hosts&#39; so that other hosts can connect.<br />This step might not be necessary, try without it first.<br />Be careful with what &#39;trust all hosts&#39; might entail<br /><code>Set-Item wsman:\localhost\client\trustedhosts *</code><br /><br /><strong><h3>### Test if remote target is configured for WinRM / PowerShell remoting</h3></strong><br />• Doesn&#39;t require authentication<br />• Can be used as a port scanner (sweep an enterprise network for boxes listening on WinRM)<br /><br /><code>Test-WSMan &lt;hostname&gt;</code><br /><code>Test-WSMan 192.168.88.12</code><br /><br /><strong><h3>### Target not configured for WinRM / PowerShell Remoting? - Enable it on target machine</h3></strong><br />This requires Administrator credentials (Domain Admin, local Administrator, etc.) on target machine to enable.<br />Not recommended for some reason (noisy? irresponsible because makes network vulnerable?)<br /><br />But if you already have Administrator credentials for the remote machine, just go log in via RDP or something??<br /><br /><code>PsExec.exe \\ordws04 -u cscou\jarrieta -p nastyCutt3r -h -d powershell.exe &quot;enable-psre<br />moting -force&quot;</code><br /><br /><strong><h2>## Execute Commands</h2></strong><br /><strong><h3>### Notes</h3></strong><br />• You get prompted for passwords with dialog box pop-up -&gt; so will require an interactive shell<br />   ◇ OR you can provide a password on the powershell cmdline. REFER HERE -&gt; PowerShell - Storing passwords/creds for use on cmdline<br />• Credentials<br />   ◇ <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_remote_requirements?view=powershell-7#user-permissions">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_remote_requirements?view=powershell-7#user-permissions</a><br />   ◇ To execute commands remotely:<br />      ▪ the current user executing the command must be an Administrator (Local Admin, Domain Admin, Enterprise Admin, etc.) on the remote machine<br />      ▪ OR credentials of a user with Administrator privileges on the remote machine must be provided<br />• Execute commands against mulitple hosts with: <br />   ◇ <code>-Computer (Get-Content hosts.txt)</code><br /><br /><strong><h3>### Tips</h3></strong><br /><strong>Store session in variable</strong><br /><code>$session1 = New-PSSession -Computer &lt;hostname&gt;</code><br /><br />Can now use <code>-Session $session1</code> to specify that session<br /><br /><strong><h3>### Execute Commands</h3></strong><br /><div class="codebox"><div class="codebox">#&nbsp;single&nbsp;host<br />Invoke-Command&nbsp;-Computer&nbsp;&lt;hostname&gt;&nbsp;-Credential&nbsp;UMBRELLA\Administrator&nbsp;-ScriptBlock&nbsp;{ipconfig&nbsp;/all}<br /><br />#&nbsp;single&nbsp;host&nbsp;via&nbsp;variable<br />Invoke-Command&nbsp;-Session&nbsp;$session1&nbsp;-Credential&nbsp;UMBRELLA\Administrator&nbsp;-ScriptBlock&nbsp;{ipconfig&nbsp;/all}<br /><br />#&nbsp;multiple&nbsp;hosts<br />Invoke-Command&nbsp;-Computer&nbsp;(Get-Content&nbsp;hosts.txt)&nbsp;-Credential&nbsp;UMBRELLA\Administrator&nbsp;-ScriptBlock&nbsp;{ipconfig&nbsp;/all}</div></div><br /><br /><strong><h3>### Execute Script</h3></strong><br /><div class="codebox"><div class="codebox">#&nbsp;against&nbsp;single&nbsp;host<br />Invoke-Command&nbsp;-Computer&nbsp;&lt;hostname&gt;&nbsp;-Credential&nbsp;UMBRELLA\Administrator&nbsp;-C:\scripts\Get-PassHashes.ps1<br /><br />#&nbsp;Script&nbsp;fails&nbsp;/&nbsp;get&nbsp;lots&nbsp;of&nbsp;errors?&nbsp;The&nbsp;machine&nbsp;might&nbsp;be&nbsp;in&nbsp;ConstrainedLanguage&nbsp;mode&nbsp;-&gt;&nbsp;change&nbsp;and&nbsp;re-execute<br />Invoke-Command&nbsp;-ComputerName&nbsp;&lt;hostname&gt;&nbsp;-ScriptBlock&nbsp;{$ExecutionContext.SessionState.LanguageMode}</div></div><br /><br /><strong><h3>### Execute Function from Script</h3></strong><br />1. Load the script - <code>.\pwn.ps1</code><br />2. List locally loaded functions - <code>ls function:</code><br />3. Execute locally loaded functions against remote host<br /><br /><div class="codebox"><div class="codebox">#&nbsp;no&nbsp;arguments<br />Invoke-Command&nbsp;-ComputerName&nbsp;&lt;hostname&gt;&nbsp;-ScriptBlock&nbsp;${function:Get-PassHashes}<br /><br />#&nbsp;with&nbsp;arguments<br />Invoke-Command&nbsp;-ComputerName&nbsp;&lt;hostname&gt;&nbsp;-ScriptBlock&nbsp;${function:Get-PassHashes}&nbsp;-ArgumentList<br /><br />#&nbsp;against&nbsp;multiple&nbsp;hosts<br />Invoke-Command&nbsp;-ComputerName&nbsp;(Get-Content&nbsp;hosts.txt)&nbsp;-ScriptBlock&nbsp;${function:Get-PassHashes}</div></div><br /><br /><strong><h3>### Drop into Interactive Shell</h3></strong><br /><div class="codebox"><div class="codebox">#&nbsp;via&nbsp;hostname<br />Enter-PSSession&nbsp;-Computer&nbsp;&lt;hostname&gt;&nbsp;-Credential&nbsp;UMBRELLA\Administrator<br /><br />#&nbsp;via&nbsp;variable<br />Enter-PSSession&nbsp;-Session&nbsp;$session1</div></div><br /><br /><br /><br /></div>
</body>
</html>
