<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>List Processes</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><h1># List Processes</h1><br />List / get process information in the kernel.<br /><br /><h2>## PsInitialSystemProcess + ActiveProcessLinks</h2><br />â€¢ <a href="https://www.unknowncheats.me/forum/c-and-c-/351894-kernel-driver-pid-process-name.html">https://www.unknowncheats.me/forum/c-and-c-/351894-kernel-driver-pid-process-name.html</a><br /><br /><h2>## ZwQuerySystemInformation</h2><br />Exactly the same as you would in userland.<br />However, ZwQuerySystemInformation isn&#39;t defined in a header anywhere so you have to do it yourself.<br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&quot;ntdll.h&quot;<br /><br />DWORD64&nbsp;GetProcessPID(wchar_t*&nbsp;process_name)<br /><span style="color:#000000;font-weight:400">{</span><br />	DWORD64&nbsp;pid&nbsp;=&nbsp;0;<br />	SYSTEM_PROCESS_INFORMATION*&nbsp;info&nbsp;=&nbsp;NULL;<br />	<br />	//&nbsp;Get&nbsp;size<br />	ULONG&nbsp;size_needed&nbsp;=&nbsp;0;<br />	NTSTATUS&nbsp;status&nbsp;=&nbsp;ZwQuerySystemInformation(SystemProcessInformation,&nbsp;NULL,&nbsp;0,&nbsp;&amp;size_needed);<br />	if&nbsp;(status&nbsp;==&nbsp;(NTSTATUS)0xC0000004L)&nbsp;{&nbsp;//&nbsp;STATUS_INFO_LENGTH_MISMATCH<br />		info&nbsp;=&nbsp;ExAllocatePool2(POOL_FLAG_NON_PAGED,&nbsp;size_needed,&nbsp;&#39;1gaT&#39;);<br />	}<br />	else&nbsp;if&nbsp;(!NT_SUCCESS(status))&nbsp;{<br />		Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;ZwQuerySystemInformation:&nbsp;0x%lx&nbsp;(%d)&nbsp;\n&quot;,&nbsp;status,&nbsp;size_needed);<br />		return&nbsp;0;<br />	}<br /><br />	//&nbsp;Query&nbsp;system&nbsp;for&nbsp;processes<br />	if&nbsp;(info&nbsp;==&nbsp;NULL)&nbsp;return&nbsp;0;<br />	status&nbsp;=&nbsp;ZwQuerySystemInformation(SystemProcessInformation,&nbsp;info,&nbsp;size_needed,&nbsp;&amp;size_needed);<br />	if&nbsp;(!NT_SUCCESS(status))&nbsp;{<br />		Dbg(&quot;-&nbsp;Failed&nbsp;to&nbsp;ZwQuerySystemInformation:&nbsp;0x%lx&nbsp;(%d)&nbsp;\n&quot;,&nbsp;status,&nbsp;size_needed);<br />		ExFreePool(info);<br />		return&nbsp;0;<br />	}<br /><br />	SYSTEM_PROCESS_INFORMATION*&nbsp;process&nbsp;=&nbsp;(SYSTEM_PROCESS_INFORMATION*)((size_t)info&nbsp;+&nbsp;info-&gt;NextEntryOffset);<br />	do<br />	{<br />		if&nbsp;(_wcsicmp(process-&gt;ImageName.Buffer,&nbsp;process_name)&nbsp;==&nbsp;0)&nbsp;{<br />			pid&nbsp;=&nbsp;(DWORD64)process-&gt;UniqueProcessId;<br />			Dbg(&quot;Found&nbsp;%ws:&nbsp;%lld&nbsp;\n&quot;,&nbsp;process-&gt;ImageName.Buffer,&nbsp;pid);<br />			break;<br />		}<br /><br />		//&nbsp;Advance&nbsp;to&nbsp;next&nbsp;process<br />		//&nbsp;For&nbsp;the&nbsp;last&nbsp;item&nbsp;in&nbsp;the&nbsp;array,&nbsp;NextEntryOffset&nbsp;is&nbsp;0<br />		process&nbsp;=&nbsp;(SYSTEM_PROCESS_INFORMATION*)((size_t)process&nbsp;+&nbsp;process-&gt;NextEntryOffset);<br />	}&nbsp;while&nbsp;(process-&gt;NextEntryOffset&nbsp;!=&nbsp;0);<br /><br />	ExFreePool(info);<br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><div class="codebox"><div class="codebox">#pragma&nbsp;once<br />&nbsp;//#include&nbsp;&lt;Windows.h&gt;<br /><br />typedef&nbsp;enum&nbsp;_SYSTEM_INFORMATION_CLASS<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemBasicInformation,&nbsp;//&nbsp;q:&nbsp;SYSTEM_BASIC_INFORMATION<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemProcessorInformation,&nbsp;//&nbsp;q:&nbsp;SYSTEM_PROCESSOR_INFORMATION<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemPerformanceInformation,&nbsp;//&nbsp;q:&nbsp;SYSTEM_PERFORMANCE_INFORMATION<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemTimeOfDayInformation,&nbsp;//&nbsp;q:&nbsp;SYSTEM_TIMEOFDAY_INFORMATION<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemPathInformation,&nbsp;//&nbsp;not&nbsp;implemented<br />&nbsp;&nbsp;&nbsp;&nbsp;SystemProcessInformation,&nbsp;//&nbsp;q:&nbsp;SYSTEM_PROCESS_INFORMATION<br />}&nbsp;SYSTEM_INFORMATION_CLASS;<br /><br />typedef&nbsp;struct&nbsp;_SYSTEM_THREAD_INFORMATION<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;KernelTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;UserTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;CreateTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;WaitTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;StartAddress;<br />&nbsp;&nbsp;&nbsp;&nbsp;CLIENT_ID&nbsp;ClientId;<br />&nbsp;&nbsp;&nbsp;&nbsp;KPRIORITY&nbsp;Priority;<br />&nbsp;&nbsp;&nbsp;&nbsp;LONG&nbsp;BasePriority;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;ContextSwitches;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;ThreadState;<br />&nbsp;&nbsp;&nbsp;&nbsp;KWAIT_REASON&nbsp;WaitReason;<br />}&nbsp;SYSTEM_THREAD_INFORMATION,&nbsp;*&nbsp;PSYSTEM_THREAD_INFORMATION;<br /><br />typedef&nbsp;struct&nbsp;_SYSTEM_PROCESS_INFORMATION<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;NextEntryOffset;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;NumberOfThreads;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;WorkingSetPrivateSize;&nbsp;//&nbsp;Since&nbsp;Vista<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;HardFaultCount;&nbsp;//&nbsp;Since&nbsp;Windows&nbsp;7<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;NumberOfThreadsHighWatermark;&nbsp;//&nbsp;Since&nbsp;Windows&nbsp;7<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONGLONG&nbsp;CycleTime;&nbsp;//&nbsp;Since&nbsp;Windows&nbsp;7<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;CreateTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;UserTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;KernelTime;<br />&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;ImageName;<br />&nbsp;&nbsp;&nbsp;&nbsp;KPRIORITY&nbsp;BasePriority;<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;UniqueProcessId;<br />&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;InheritedFromUniqueProcessId;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;HandleCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;SessionId;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG_PTR&nbsp;UniqueProcessKey;&nbsp;//&nbsp;Since&nbsp;Vista&nbsp;(requires&nbsp;SystemExtendedProcessInformation)<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;PeakVirtualSize;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;VirtualSize;<br />&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;PageFaultCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;PeakWorkingSetSize;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;WorkingSetSize;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;QuotaPeakPagedPoolUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;QuotaPagedPoolUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;QuotaPeakNonPagedPoolUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;QuotaNonPagedPoolUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;PagefileUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;PeakPagefileUsage;<br />&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;PrivatePageCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;ReadOperationCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;WriteOperationCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;OtherOperationCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;ReadTransferCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;WriteTransferCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;OtherTransferCount;<br />&nbsp;&nbsp;&nbsp;&nbsp;SYSTEM_THREAD_INFORMATION&nbsp;Threads[1];<br />}&nbsp;SYSTEM_PROCESS_INFORMATION,&nbsp;*&nbsp;PSYSTEM_PROCESS_INFORMATION;<br /><br />NTSTATUS&nbsp;WINAPI&nbsp;ZwQuerySystemInformation(<br />	_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SYSTEM_INFORMATION_CLASS&nbsp;SystemInformationClass,<br />	_Inout_&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemInformation,<br />	_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemInformationLength,<br />	_Out_opt_&nbsp;PULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReturnLength<br />);</div></div></div>
</body>
</html>
